<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>VaultPro ‚Äì Investment Platform</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;800&family=DM+Sans:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">
<style>
/* ===== DESIGN TOKENS ===== */
:root {
  --gold: #C9A84C;
  --gold-light: #E8C96B;
  --gold-dark: #A07834;
  --bg: #0A0C10;
  --bg2: #111318;
  --bg3: #181C24;
  --surface: #1E2330;
  --surface2: #252B3A;
  --border: rgba(201, 168, 76, 0.15);
  --border-subtle: rgba(255,255,255,0.06);
  --text: #F0EDE6;
  --text-muted: #7E8899;
  --text-dim: #4A5166;
  --green: #1DB87F;
  --red: #E8445A;
  --blue: #4A7CF7;
  --r: 14px;
  --r-sm: 8px;
  --shadow: 0 8px 32px rgba(0,0,0,0.5);
  --gold-glow: 0 0 30px rgba(201,168,76,0.2);
}

* { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
html { height:100%; }
body {
  font-family: 'DM Sans', sans-serif;
  background: var(--bg);
  color: var(--text);
  min-height: 100vh;
  max-width: 480px;
  margin: 0 auto;
  position: relative;
  overflow-x: hidden;
}

/* Grain overlay */
body::before {
  content: '';
  position: fixed;
  inset: 0;
  background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.03'/%3E%3C/svg%3E");
  pointer-events: none;
  z-index: 9998;
  opacity: 0.4;
}

.hidden { display: none !important; }

/* ===== TYPOGRAPHY ===== */
.display { font-family: 'Playfair Display', serif; }
.mono { font-family: 'JetBrains Mono', monospace; }

/* ===== BUTTONS ===== */
.btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  padding: 14px 24px;
  border-radius: var(--r-sm);
  border: none;
  cursor: pointer;
  font-family: 'DM Sans', sans-serif;
  font-weight: 600;
  font-size: 0.9rem;
  letter-spacing: 0.01em;
  transition: all 0.2s ease;
  position: relative;
  overflow: hidden;
}
.btn:disabled { opacity: 0.5; cursor: not-allowed; }
.btn:active:not(:disabled) { transform: scale(0.97); }

.btn-gold {
  background: linear-gradient(135deg, var(--gold), var(--gold-dark));
  color: #0A0C10;
  font-weight: 700;
  box-shadow: 0 4px 20px rgba(201,168,76,0.35);
}
.btn-gold:hover:not(:disabled) { box-shadow: 0 6px 28px rgba(201,168,76,0.5); }

.btn-outline {
  background: transparent;
  border: 1px solid var(--border);
  color: var(--gold);
}
.btn-outline:hover { background: rgba(201,168,76,0.08); border-color: var(--gold); }

.btn-surface {
  background: var(--surface2);
  color: var(--text);
  border: 1px solid var(--border-subtle);
}
.btn-surface:hover { background: var(--surface); }

.btn-green {
  background: linear-gradient(135deg, var(--green), #158B5F);
  color: #fff;
}
.btn-red {
  background: linear-gradient(135deg, var(--red), #B02040);
  color: #fff;
}
.btn-full { width: 100%; }

/* ===== CARDS ===== */
.card {
  background: var(--surface);
  border: 1px solid var(--border-subtle);
  border-radius: var(--r);
  padding: 20px;
  margin-bottom: 12px;
}
.card-gold {
  background: linear-gradient(135deg, rgba(201,168,76,0.12), rgba(201,168,76,0.04));
  border: 1px solid var(--border);
}
.card-dark { background: var(--bg2); }

/* ===== FORMS ===== */
.form-group { margin-bottom: 16px; }
.form-group label {
  display: block;
  font-size: 0.78rem;
  font-weight: 600;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 0.08em;
  margin-bottom: 8px;
}
.form-group input, .form-group select {
  width: 100%;
  padding: 14px 16px;
  background: var(--bg3);
  border: 1px solid var(--border-subtle);
  border-radius: var(--r-sm);
  color: var(--text);
  font-family: 'DM Sans', sans-serif;
  font-size: 0.95rem;
  transition: border-color 0.2s;
  appearance: none;
  -webkit-appearance: none;
}
.form-group input:focus, .form-group select:focus {
  outline: none;
  border-color: var(--gold);
  box-shadow: 0 0 0 3px rgba(201,168,76,0.12);
}
.form-group input::placeholder { color: var(--text-dim); }

/* ===== ALERTS ===== */
.alert {
  padding: 12px 16px;
  border-radius: var(--r-sm);
  margin-bottom: 12px;
  font-size: 0.875rem;
  font-weight: 500;
  display: flex;
  align-items: flex-start;
  gap: 10px;
}
.alert-success { background: rgba(29,184,127,0.12); border: 1px solid rgba(29,184,127,0.3); color: #4DEBA0; }
.alert-error { background: rgba(232,68,90,0.12); border: 1px solid rgba(232,68,90,0.3); color: #F07285; }
.alert-warning { background: rgba(201,168,76,0.12); border: 1px solid rgba(201,168,76,0.3); color: var(--gold-light); }
.alert-info { background: rgba(74,124,247,0.12); border: 1px solid rgba(74,124,247,0.3); color: #7FA8FF; }

/* ===== STATUS BADGES ===== */
.badge {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  padding: 4px 10px;
  border-radius: 20px;
  font-size: 0.72rem;
  font-weight: 700;
  letter-spacing: 0.04em;
  text-transform: uppercase;
}
.badge-success { background: rgba(29,184,127,0.15); color: var(--green); border: 1px solid rgba(29,184,127,0.3); }
.badge-error { background: rgba(232,68,90,0.15); color: var(--red); border: 1px solid rgba(232,68,90,0.3); }
.badge-warning { background: rgba(201,168,76,0.15); color: var(--gold); border: 1px solid var(--border); }
.badge-blue { background: rgba(74,124,247,0.15); color: #7FA8FF; border: 1px solid rgba(74,124,247,0.3); }

/* ===== LOADING SCREEN ===== */
#loadingScreen {
  position: fixed;
  inset: 0;
  background: var(--bg);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  z-index: 9999;
}
.loader-logo {
  font-family: 'Playfair Display', serif;
  font-size: 2.5rem;
  font-weight: 800;
  color: var(--gold);
  letter-spacing: -0.02em;
  margin-bottom: 8px;
}
.loader-tagline { font-size: 0.8rem; color: var(--text-muted); letter-spacing: 0.15em; text-transform: uppercase; margin-bottom: 48px; }
.loader-ring {
  width: 44px;
  height: 44px;
  border: 3px solid rgba(201,168,76,0.2);
  border-top-color: var(--gold);
  border-radius: 50%;
  animation: spin 0.9s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }

/* ===== AUTH PAGES ===== */
.auth-page {
  min-height: 100vh;
  display: flex;
  flex-direction: column;
  padding: 0;
}
.auth-header {
  background: linear-gradient(180deg, rgba(201,168,76,0.08) 0%, transparent 100%);
  padding: 60px 24px 40px;
  text-align: center;
  border-bottom: 1px solid var(--border-subtle);
}
.auth-logo { font-family: 'Playfair Display', serif; font-size: 2rem; font-weight: 800; color: var(--gold); }
.auth-logo span { color: var(--text-muted); }
.auth-subtitle { font-size: 0.85rem; color: var(--text-muted); margin-top: 6px; letter-spacing: 0.05em; }
.auth-body { flex: 1; padding: 28px 20px; }

/* ===== REFERRAL LANDING ===== */
.landing-page {
  min-height: 100vh;
  background: var(--bg);
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 0 20px 40px;
}
.landing-hero {
  width: 100%;
  background: linear-gradient(180deg, rgba(201,168,76,0.1) 0%, transparent 100%);
  padding: 60px 20px 40px;
  text-align: center;
  border-bottom: 1px solid var(--border-subtle);
  margin-bottom: 28px;
}
.landing-icon { font-size: 3.5rem; margin-bottom: 16px; }
.landing-title { font-family: 'Playfair Display', serif; font-size: 2rem; font-weight: 800; color: var(--text); margin-bottom: 8px; }
.landing-subtitle { color: var(--text-muted); font-size: 0.9rem; line-height: 1.6; }
.invite-code-box {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--r);
  padding: 20px;
  text-align: center;
  width: 100%;
  max-width: 360px;
  margin: 0 auto 24px;
  box-shadow: var(--gold-glow);
}
.invite-code-label { font-size: 0.72rem; font-weight: 700; letter-spacing: 0.12em; text-transform: uppercase; color: var(--text-muted); margin-bottom: 10px; }
.invite-code-value { font-family: 'JetBrains Mono', monospace; font-size: 1.8rem; font-weight: 600; color: var(--gold); letter-spacing: 0.12em; }

/* ===== DASHBOARD ===== */
.dashboard-header {
  position: sticky;
  top: 0;
  z-index: 100;
  background: rgba(10,12,16,0.92);
  backdrop-filter: blur(16px);
  -webkit-backdrop-filter: blur(16px);
  border-bottom: 1px solid var(--border-subtle);
  padding: 14px 20px;
  display: flex;
  align-items: center;
  justify-content: space-between;
}
.header-brand { font-family: 'Playfair Display', serif; font-size: 1.2rem; color: var(--gold); font-weight: 700; }
.header-user { font-size: 0.78rem; color: var(--text-muted); }
.header-user strong { color: var(--text); display: block; font-size: 0.9rem; }
.header-actions { display: flex; gap: 8px; }
.icon-btn {
  width: 38px;
  height: 38px;
  border-radius: 50%;
  border: 1px solid var(--border-subtle);
  background: var(--surface);
  color: var(--text-muted);
  font-size: 1rem;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  position: relative;
  transition: all 0.2s;
}
.icon-btn:hover { border-color: var(--border); color: var(--text); }
.notif-dot {
  position: absolute;
  top: 2px;
  right: 2px;
  width: 16px;
  height: 16px;
  background: var(--red);
  border-radius: 50%;
  font-size: 10px;
  font-weight: 700;
  color: #fff;
  display: flex;
  align-items: center;
  justify-content: center;
  border: 2px solid var(--bg);
}

/* ===== BOTTOM NAV ===== */
.bottom-nav {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  max-width: 480px;
  margin: 0 auto;
  background: rgba(14,16,24,0.97);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border-top: 1px solid var(--border-subtle);
  display: flex;
  z-index: 100;
  padding-bottom: env(safe-area-inset-bottom);
}
.nav-item {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 3px;
  padding: 10px 4px 8px;
  cursor: pointer;
  border: none;
  background: none;
  color: var(--text-dim);
  font-size: 0.6rem;
  font-weight: 600;
  letter-spacing: 0.05em;
  text-transform: uppercase;
  transition: color 0.2s;
  font-family: 'DM Sans', sans-serif;
}
.nav-item .nav-icon { font-size: 1.25rem; transition: transform 0.2s; }
.nav-item.active { color: var(--gold); }
.nav-item.active .nav-icon { transform: translateY(-2px); }

/* ===== CONTENT AREA ===== */
.content { padding: 16px; padding-bottom: 90px; }

/* ===== HERO BALANCE CARD ===== */
.balance-hero {
  background: linear-gradient(135deg, var(--bg3) 0%, var(--surface) 100%);
  border: 1px solid var(--border);
  border-radius: var(--r);
  padding: 24px 20px;
  margin-bottom: 12px;
  position: relative;
  overflow: hidden;
}
.balance-hero::before {
  content: '';
  position: absolute;
  top: -40px;
  right: -40px;
  width: 160px;
  height: 160px;
  background: radial-gradient(circle, rgba(201,168,76,0.12) 0%, transparent 70%);
  pointer-events: none;
}
.balance-label { font-size: 0.72rem; font-weight: 700; letter-spacing: 0.12em; text-transform: uppercase; color: var(--text-muted); margin-bottom: 8px; }
.balance-value { font-family: 'Playfair Display', serif; font-size: 2.4rem; font-weight: 800; color: var(--gold); line-height: 1; margin-bottom: 4px; }
.balance-currency { font-size: 0.78rem; color: var(--text-muted); font-weight: 500; }

/* ===== STAT GRID ===== */
.stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 12px; }
.stat-tile {
  background: var(--surface);
  border: 1px solid var(--border-subtle);
  border-radius: var(--r);
  padding: 16px;
  position: relative;
  overflow: hidden;
}
.stat-tile-icon { font-size: 1.4rem; margin-bottom: 10px; }
.stat-tile-value { font-family: 'JetBrains Mono', monospace; font-size: 1.1rem; font-weight: 600; color: var(--text); margin-bottom: 3px; }
.stat-tile-label { font-size: 0.72rem; color: var(--text-muted); font-weight: 500; letter-spacing: 0.03em; }

/* ===== REFERRAL LINK ===== */
.ref-link-box {
  background: var(--bg3);
  border: 1px solid var(--border-subtle);
  border-radius: var(--r-sm);
  padding: 12px 14px;
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.72rem;
  color: var(--text-muted);
  word-break: break-all;
  margin-bottom: 12px;
  line-height: 1.6;
}

/* ===== PLAN CARDS ===== */
.plan-card {
  background: var(--surface);
  border: 1px solid var(--border-subtle);
  border-radius: var(--r);
  padding: 18px;
  margin-bottom: 10px;
  cursor: pointer;
  transition: all 0.2s ease;
  position: relative;
  overflow: hidden;
}
.plan-card:active { transform: scale(0.98); }
.plan-card:hover, .plan-card.selected {
  border-color: var(--gold);
  box-shadow: 0 0 0 1px rgba(201,168,76,0.3);
  background: linear-gradient(135deg, rgba(201,168,76,0.06), var(--surface));
}
.plan-card.owned {
  border-color: var(--green);
  box-shadow: 0 0 0 1px rgba(29,184,127,0.2);
  background: linear-gradient(135deg, rgba(29,184,127,0.06), var(--surface));
}
.plan-card::before {
  content: '';
  position: absolute;
  top: 0; right: 0;
  width: 80px; height: 80px;
  background: radial-gradient(circle at top right, rgba(201,168,76,0.08), transparent 70%);
  pointer-events: none;
}
.plan-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px; }
.plan-name { font-family: 'Playfair Display', serif; font-size: 1.1rem; font-weight: 700; color: var(--text); }
.plan-amount { font-family: 'JetBrains Mono', monospace; font-size: 1rem; font-weight: 600; color: var(--gold); }
.plan-stats { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; }
.plan-stat {
  background: var(--bg3);
  border-radius: 6px;
  padding: 8px 10px;
}
.plan-stat-val { font-size: 0.82rem; font-weight: 700; color: var(--text); }
.plan-stat-label { font-size: 0.65rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em; margin-top: 2px; }

/* ===== PURCHASE SUMMARY ===== */
.purchase-summary {
  background: linear-gradient(135deg, rgba(201,168,76,0.08), rgba(201,168,76,0.03));
  border: 1px solid var(--border);
  border-radius: var(--r);
  padding: 20px;
  margin-bottom: 12px;
}
.summary-row { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid var(--border-subtle); }
.summary-row:last-of-type { border-bottom: none; font-weight: 700; }
.summary-row .label { color: var(--text-muted); font-size: 0.875rem; }
.summary-row .value { font-family: 'JetBrains Mono', monospace; font-size: 0.9rem; color: var(--text); }
.summary-row .value.highlight { color: var(--green); font-size: 1.1rem; }

/* ===== TASKS ===== */
.task-card {
  background: var(--surface);
  border: 1px solid var(--border-subtle);
  border-radius: var(--r);
  padding: 16px;
  margin-bottom: 10px;
  transition: border-color 0.2s;
}
.task-card.completed { border-color: rgba(29,184,127,0.3); opacity: 0.7; }
.task-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; gap: 10px; }
.task-title { font-weight: 600; font-size: 0.9rem; line-height: 1.4; }
.task-reward { font-family: 'JetBrains Mono', monospace; font-size: 0.85rem; font-weight: 600; color: var(--green); white-space: nowrap; }
.task-desc { font-size: 0.8rem; color: var(--text-muted); margin-bottom: 12px; line-height: 1.5; }

/* ===== PROGRESS BAR ===== */
.progress-bar-wrap { background: var(--bg3); border-radius: 100px; height: 6px; overflow: hidden; margin-top: 8px; }
.progress-bar-fill { height: 100%; background: linear-gradient(90deg, var(--gold-dark), var(--gold-light)); border-radius: 100px; transition: width 0.4s ease; }

/* ===== WALLET TABS ===== */
.tab-bar {
  display: flex;
  background: var(--bg3);
  border: 1px solid var(--border-subtle);
  border-radius: var(--r-sm);
  padding: 4px;
  margin-bottom: 16px;
  gap: 4px;
}
.tab-btn {
  flex: 1;
  padding: 10px;
  border: none;
  border-radius: 6px;
  font-family: 'DM Sans', sans-serif;
  font-size: 0.85rem;
  font-weight: 600;
  cursor: pointer;
  background: none;
  color: var(--text-muted);
  transition: all 0.2s;
}
.tab-btn.active {
  background: var(--surface2);
  color: var(--gold);
  border: 1px solid var(--border);
}

/* ===== TABLE ===== */
table { width: 100%; border-collapse: collapse; font-size: 0.825rem; }
th {
  text-align: left;
  padding: 10px 12px;
  color: var(--text-muted);
  font-size: 0.7rem;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.07em;
  border-bottom: 1px solid var(--border-subtle);
}
td { padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.04); color: var(--text); }
tr:last-child td { border-bottom: none; }

/* ===== LEADERBOARD ===== */
.lb-item {
  display: flex;
  align-items: center;
  gap: 14px;
  padding: 14px 0;
  border-bottom: 1px solid var(--border-subtle);
}
.lb-item:last-child { border-bottom: none; }
.lb-rank { font-family: 'JetBrains Mono', monospace; font-size: 1.1rem; font-weight: 700; width: 32px; text-align: center; }
.lb-rank.top { color: var(--gold); }
.lb-info { flex: 1; }
.lb-name { font-weight: 600; font-size: 0.9rem; }
.lb-total { font-size: 0.75rem; color: var(--text-muted); }
.lb-count { font-family: 'JetBrains Mono', monospace; font-size: 1.1rem; font-weight: 700; color: var(--gold); }

/* ===== STREAK ===== */
.streak-grid { display: flex; gap: 8px; justify-content: center; margin: 16px 0; flex-wrap: wrap; }
.streak-dot {
  width: 38px;
  height: 38px;
  border-radius: 50%;
  border: 2px solid var(--border-subtle);
  background: var(--bg3);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 0.75rem;
  font-weight: 700;
  color: var(--text-dim);
}
.streak-dot.done { background: var(--green); border-color: var(--green); color: #fff; }
.streak-dot.today { background: var(--gold); border-color: var(--gold-light); color: #0A0C10; animation: pulse 1.5s ease-in-out infinite; }
@keyframes pulse { 0%,100%{transform:scale(1)} 50%{transform:scale(1.08)} }

/* ===== PROFILE ===== */
.profile-hero {
  background: linear-gradient(135deg, var(--bg3), var(--surface));
  border: 1px solid var(--border-subtle);
  border-radius: var(--r);
  padding: 28px 20px;
  text-align: center;
  margin-bottom: 12px;
}
.avatar {
  width: 80px;
  height: 80px;
  border-radius: 50%;
  background: linear-gradient(135deg, var(--gold-dark), var(--gold));
  display: flex;
  align-items: center;
  justify-content: center;
  font-family: 'Playfair Display', serif;
  font-size: 1.8rem;
  font-weight: 700;
  color: #0A0C10;
  margin: 0 auto 14px;
  position: relative;
  border: 3px solid rgba(201,168,76,0.3);
}
.avatar-img {
  width: 80px;
  height: 80px;
  border-radius: 50%;
  object-fit: cover;
  border: 3px solid var(--border);
}
.avatar-edit-btn {
  position: absolute;
  bottom: 0;
  right: 0;
  width: 26px;
  height: 26px;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 0.7rem;
  cursor: pointer;
}
.profile-name { font-family: 'Playfair Display', serif; font-size: 1.4rem; font-weight: 700; margin-bottom: 4px; }
.profile-email { font-size: 0.8rem; color: var(--text-muted); }

/* ===== MODAL ===== */
.modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.75);
  z-index: 1000;
  display: flex;
  align-items: flex-end;
  justify-content: center;
  backdrop-filter: blur(4px);
  -webkit-backdrop-filter: blur(4px);
}
.modal-sheet {
  background: var(--bg2);
  border: 1px solid var(--border-subtle);
  border-radius: 20px 20px 0 0;
  width: 100%;
  max-width: 480px;
  max-height: 90vh;
  overflow-y: auto;
  padding: 8px 20px 40px;
  animation: slideUp 0.3s ease-out;
}
@keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
.modal-handle {
  width: 40px;
  height: 4px;
  background: var(--border);
  border-radius: 100px;
  margin: 12px auto 20px;
}
.modal-title { font-family: 'Playfair Display', serif; font-size: 1.3rem; font-weight: 700; margin-bottom: 8px; }

/* ===== TOAST NOTIFICATIONS ===== */
#toastContainer {
  position: fixed;
  top: 16px;
  left: 50%;
  transform: translateX(-50%);
  z-index: 9999;
  display: flex;
  flex-direction: column;
  gap: 8px;
  width: calc(100% - 32px);
  max-width: 440px;
  pointer-events: none;
}
.toast {
  background: var(--surface);
  border: 1px solid var(--border-subtle);
  border-radius: var(--r-sm);
  padding: 14px 16px;
  display: flex;
  align-items: flex-start;
  gap: 12px;
  box-shadow: 0 12px 40px rgba(0,0,0,0.6);
  animation: toastIn 0.3s ease-out;
  pointer-events: auto;
}
@keyframes toastIn { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
.toast-icon { font-size: 1.2rem; flex-shrink: 0; }
.toast-content { flex: 1; }
.toast-title { font-weight: 700; font-size: 0.875rem; margin-bottom: 2px; }
.toast-msg { font-size: 0.8rem; color: var(--text-muted); }
.toast-close { font-size: 1rem; cursor: pointer; color: var(--text-dim); flex-shrink: 0; background: none; border: none; color: var(--text-dim); }

/* ===== NOTIFICATION CENTER ===== */
.notif-center {
  position: fixed;
  top: 0;
  right: 0;
  bottom: 0;
  width: min(360px, 100%);
  background: var(--bg2);
  border-left: 1px solid var(--border-subtle);
  z-index: 1001;
  display: flex;
  flex-direction: column;
  transform: translateX(100%);
  transition: transform 0.3s ease;
}
.notif-center.open { transform: translateX(0); }
.notif-header { padding: 20px; border-bottom: 1px solid var(--border-subtle); display: flex; justify-content: space-between; align-items: center; }
.notif-list { flex: 1; overflow-y: auto; }
.notif-item { padding: 16px 20px; border-bottom: 1px solid var(--border-subtle); }
.notif-item.unread { background: rgba(201,168,76,0.04); border-left: 3px solid var(--gold); }
.notif-item-title { font-weight: 600; font-size: 0.875rem; margin-bottom: 3px; }
.notif-item-msg { font-size: 0.8rem; color: var(--text-muted); }
.notif-item-time { font-size: 0.7rem; color: var(--text-dim); margin-top: 4px; }

/* ===== ADMIN ===== */
.admin-wrapper { min-height: 100vh; }
.admin-header {
  background: var(--bg2);
  border-bottom: 1px solid var(--border-subtle);
  padding: 16px 20px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  position: sticky;
  top: 0;
  z-index: 100;
}
.admin-tabs {
  display: flex;
  gap: 6px;
  overflow-x: auto;
  padding: 12px 16px;
  background: var(--bg2);
  border-bottom: 1px solid var(--border-subtle);
  scrollbar-width: none;
}
.admin-tabs::-webkit-scrollbar { display: none; }
.admin-tab {
  white-space: nowrap;
  padding: 8px 16px;
  border-radius: var(--r-sm);
  border: 1px solid var(--border-subtle);
  background: var(--surface);
  color: var(--text-muted);
  font-size: 0.8rem;
  font-weight: 600;
  cursor: pointer;
  font-family: 'DM Sans', sans-serif;
  transition: all 0.2s;
}
.admin-tab.active { background: var(--gold); color: #0A0C10; border-color: var(--gold); }
.admin-content { padding: 16px; }
.admin-stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 16px; }
.admin-stat-card { background: var(--surface); border: 1px solid var(--border-subtle); border-radius: var(--r); padding: 16px; text-align: center; }
.admin-stat-val { font-family: 'JetBrains Mono', monospace; font-size: 1.5rem; font-weight: 700; color: var(--gold); }
.admin-stat-label { font-size: 0.72rem; color: var(--text-muted); margin-top: 4px; letter-spacing: 0.04em; text-transform: uppercase; }

/* ===== SECTION HEADINGS ===== */
.section-title {
  font-family: 'Playfair Display', serif;
  font-size: 1.3rem;
  font-weight: 700;
  color: var(--text);
  margin-bottom: 4px;
}
.section-sub { font-size: 0.8rem; color: var(--text-muted); margin-bottom: 16px; }

/* ===== INFO ROWS ===== */
.info-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 14px 0;
  border-bottom: 1px solid var(--border-subtle);
}
.info-row:last-child { border-bottom: none; }
.info-label { font-size: 0.82rem; color: var(--text-muted); }
.info-value { font-size: 0.875rem; font-weight: 600; text-align: right; max-width: 60%; word-break: break-word; }

/* ===== PAYMENT METHOD OPTION ===== */
.pay-option {
  background: var(--surface);
  border: 1px solid var(--border-subtle);
  border-radius: var(--r);
  padding: 16px;
  margin-bottom: 10px;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 14px;
  transition: all 0.2s;
}
.pay-option:hover { border-color: var(--gold); background: rgba(201,168,76,0.05); }
.pay-option.disabled { opacity: 0.4; cursor: not-allowed; }
.pay-icon { font-size: 2rem; }
.pay-info { flex: 1; }
.pay-title { font-weight: 700; font-size: 0.9rem; }
.pay-subtitle { font-size: 0.78rem; color: var(--text-muted); margin-top: 2px; }
.pay-check { font-size: 1.1rem; }

/* ===== ANIMATIONS ===== */
@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
.fade-in { animation: fadeIn 0.3s ease-out; }

/* ===== SCROLLBAR ===== */
::-webkit-scrollbar { width: 4px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--border); border-radius: 100px; }

/* ===== PLAN TABLE ===== */
.plan-overview-table { overflow-x: auto; }
.plan-overview-table table th:first-child,
.plan-overview-table table td:first-child { padding-left: 4px; }

/* ===== DIVIDER ===== */
.divider { height: 1px; background: var(--border-subtle); margin: 16px 0; }

/* ===== WEB SEARCH CARD === */
.search-note { font-size:0.75rem; color: var(--text-dim); text-align:center; margin-top:8px; }
</style>
</head>
<body>

<!-- ===== LOADING SCREEN ===== -->
<div id="loadingScreen">
  <div class="loader-logo">VaultPro</div>
  <div class="loader-tagline">Investment Platform</div>
  <div class="loader-ring"></div>
</div>

<!-- ===== TOAST CONTAINER ===== -->
<div id="toastContainer"></div>

<!-- ===== NOTIFICATION CENTER ===== -->
<div class="notif-center hidden" id="notifCenter">
  <div class="notif-header">
    <span class="section-title" style="font-size:1.1rem">Notifications</span>
    <button class="icon-btn" onclick="closeNotifCenter()">‚úï</button>
  </div>
  <div class="notif-list" id="notifList">
    <div style="padding:32px;text-align:center;color:var(--text-muted)">No notifications</div>
  </div>
</div>

<!-- ===== REFERRAL LANDING ===== -->
<div id="referralLandingPage" class="landing-page hidden">
  <div class="landing-hero" style="width:100%;margin-bottom:28px">
    <div class="landing-icon">üè¶</div>
    <div class="landing-title">You've been invited!</div>
    <div class="landing-subtitle">Join Uganda's premier investment platform and start earning today.</div>
  </div>
  <div class="invite-code-box">
    <div class="invite-code-label">Your Invitation Code</div>
    <div class="invite-code-value" id="landingReferralCode">‚Äî‚Äî</div>
  </div>
  <div style="display:flex;flex-direction:column;gap:10px;width:100%;max-width:360px">
    <button class="btn btn-gold btn-full" onclick="showRegisterFromReferral()">Create Account ‚Üí</button>
    <button class="btn btn-outline btn-full" onclick="showLogin()">Already have an account</button>
  </div>
  <div style="margin-top:32px;display:flex;flex-direction:column;gap:10px;width:100%">
    <div class="card" style="display:flex;gap:12px;align-items:center;padding:14px 16px">
      <span style="font-size:1.4rem">‚úÖ</span>
      <div>
        <div style="font-weight:600;font-size:0.875rem">Daily Task Rewards</div>
        <div style="font-size:0.78rem;color:var(--text-muted)">Complete tasks, earn UGX every day</div>
      </div>
    </div>
    <div class="card" style="display:flex;gap:12px;align-items:center;padding:14px 16px">
      <span style="font-size:1.4rem">üíé</span>
      <div>
        <div style="font-weight:600;font-size:0.875rem">Vault Investment Plans</div>
        <div style="font-size:0.78rem;color:var(--text-muted)">Grow your capital with structured plans</div>
      </div>
    </div>
    <div class="card" style="display:flex;gap:12px;align-items:center;padding:14px 16px">
      <span style="font-size:1.4rem">üë•</span>
      <div>
        <div style="font-weight:600;font-size:0.875rem">10% Referral Bonus</div>
        <div style="font-size:0.78rem;color:var(--text-muted)">Earn when your referrals invest</div>
      </div>
    </div>
  </div>
</div>

<!-- ===== REGISTER PAGE ===== -->
<div id="registerPage" class="auth-page hidden">
  <div class="auth-header">
    <div class="auth-logo">Vault<span>Pro</span></div>
    <div class="auth-subtitle">Create your account</div>
  </div>
  <div class="auth-body">
    <div id="registerAlert"></div>
    <div class="form-group">
      <label>Invitation Code</label>
      <input type="text" id="inviteCode" placeholder="Enter your code" style="text-transform:uppercase;letter-spacing:0.1em">
    </div>
    <div class="form-group">
      <label>Full Name</label>
      <input type="text" id="fullName" placeholder="Your full name">
    </div>
    <div class="form-group">
      <label>Email Address</label>
      <input type="email" id="email" placeholder="you@example.com">
    </div>
    <div class="form-group">
      <label>Password</label>
      <input type="password" id="password" placeholder="At least 6 characters">
    </div>
    <div class="form-group">
      <label>Confirm Password</label>
      <input type="password" id="confirmPassword" placeholder="Repeat password">
    </div>
    <button class="btn btn-gold btn-full" id="registerBtn" onclick="register()">Create Account</button>
    <p style="text-align:center;margin-top:20px;font-size:0.875rem;color:var(--text-muted)">
      Already have an account? <a href="#" onclick="showLogin()" style="color:var(--gold);text-decoration:none;font-weight:600">Sign in</a>
    </p>
  </div>
</div>

<!-- ===== LOGIN PAGE ===== -->
<div id="loginPage" class="auth-page hidden">
  <div class="auth-header">
    <div class="auth-logo">Vault<span>Pro</span></div>
    <div class="auth-subtitle">Sign in to your account</div>
  </div>
  <div class="auth-body">
    <div id="loginAlert"></div>
    <div class="form-group">
      <label>Email Address</label>
      <input type="email" id="loginEmail" placeholder="you@example.com">
    </div>
    <div class="form-group">
      <label>Password</label>
      <input type="password" id="loginPassword" placeholder="Your password">
    </div>
    <button class="btn btn-gold btn-full" id="loginBtn" onclick="login()" style="margin-top:8px">Sign In</button>
    <p style="text-align:center;margin-top:20px;font-size:0.875rem;color:var(--text-muted)">
      Don't have an account? <a href="#" onclick="showRegister()" style="color:var(--gold);text-decoration:none;font-weight:600">Join now</a>
    </p>
  </div>
</div>

<!-- ===== USER DASHBOARD ===== -->
<div id="userDashboard" class="hidden">
  <div class="dashboard-header">
    <div>
      <div class="header-brand">VaultPro</div>
      <div class="header-user" id="headerUserInfo">Loading...</div>
    </div>
    <div class="header-actions">
      <button class="icon-btn" onclick="openNotifCenter()" title="Notifications">
        üîî
        <span class="notif-dot hidden" id="notifBadge"></span>
      </button>
    </div>
  </div>

  <div id="homeSection" class="content hidden fade-in">
    <div id="homeAlert"></div>

    <div class="balance-hero">
      <div class="balance-label">Total Balance</div>
      <div class="balance-value" id="totalBalance">0</div>
      <div class="balance-currency">UGX ¬∑ <span id="activationBadge" class="badge badge-success hidden">Active</span></div>
    </div>

    <div class="stat-grid">
      <div class="stat-tile">
        <div class="stat-tile-icon">üë•</div>
        <div class="stat-tile-value" id="statReferrals">0</div>
        <div class="stat-tile-label">Referrals</div>
      </div>
      <div class="stat-tile">
        <div class="stat-tile-icon">‚úÖ</div>
        <div class="stat-tile-value" id="statTaskEarnings">0</div>
        <div class="stat-tile-label">Task Earnings</div>
      </div>
      <div class="stat-tile">
        <div class="stat-tile-icon">üí∏</div>
        <div class="stat-tile-value" id="statRefEarnings">0</div>
        <div class="stat-tile-label">Referral Earn.</div>
      </div>
      <div class="stat-tile">
        <div class="stat-tile-icon">üíé</div>
        <div class="stat-tile-value" id="statLevel">‚Äî</div>
        <div class="stat-tile-label">Vault Level</div>
      </div>
    </div>

    <div class="card" id="taskAllocCard">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
        <span style="font-weight:700;font-size:0.9rem">Today's Tasks</span>
        <button class="btn btn-outline" style="padding:6px 14px;font-size:0.78rem" onclick="showSection('tasks')">View ‚Üí</button>
      </div>
      <div id="taskAllocContent" style="color:var(--text-muted);font-size:0.85rem">Loading‚Ä¶</div>
    </div>

    <div class="card">
      <div style="font-weight:700;font-size:0.9rem;margin-bottom:12px">üîó Your Referral Link</div>
      <div class="ref-link-box" id="userReferralLink">Loading‚Ä¶</div>
      <div style="display:flex;gap:8px">
        <button class="btn btn-gold" style="flex:1;padding:12px" onclick="copyReferralLink()">Copy</button>
        <button class="btn btn-outline" style="flex:1;padding:12px" onclick="shareReferralLink()">Share</button>
      </div>
    </div>

    <div class="card">
      <div style="font-weight:700;font-size:0.9rem;margin-bottom:4px">üèÜ Weekly Leaderboard</div>
      <div style="font-size:0.78rem;color:var(--text-muted);margin-bottom:4px">Top referrer wins <strong style="color:var(--gold)">50,000 UGX</strong> weekly</div>
      <div style="font-size:0.75rem;color:var(--text-dim);margin-bottom:14px">Resets in: <strong id="timeUntilReset">‚Äî</strong></div>
      <div id="leaderboardList"><div style="text-align:center;color:var(--text-muted);padding:16px">Loading‚Ä¶</div></div>
    </div>

    <div class="card" style="background:linear-gradient(135deg,rgba(37,211,102,0.08),rgba(18,140,126,0.06));border-color:rgba(37,211,102,0.2);text-align:center">
      <div style="font-size:1.5rem;margin-bottom:8px">üí¨</div>
      <div style="font-weight:700;margin-bottom:4px">Join Our WhatsApp Group</div>
      <div style="font-size:0.8rem;color:var(--text-muted);margin-bottom:14px">Get updates & connect with investors</div>
      <a href="https://chat.whatsapp.com/KBvY0dutPIcHPLNzjBcJZQ" target="_blank" class="btn btn-green btn-full">Join Now</a>
    </div>

    <div class="card">
      <div style="font-weight:700;font-size:0.9rem;margin-bottom:14px">üìä Vault Plans Overview</div>
      <div class="plan-overview-table">
        <table>
          <thead><tr><th>Plan</th><th>Amount</th><th>Tasks</th><th>Reward</th></tr></thead>
          <tbody>
            <tr><td>üå± Beginner</td><td>45K</td><td>2/day</td><td>750</td></tr>
            <tr><td>üåø Seed</td><td>180K</td><td>3/day</td><td>2,000</td></tr>
            <tr><td>üåÖ Rising</td><td>600K</td><td>4/day</td><td>5,000</td></tr>
            <tr><td>üí° Nova</td><td>1.35M</td><td>5/day</td><td>9,000</td></tr>
            <tr><td>üß† Mastermind</td><td>4.05M</td><td>6/day</td><td>22,500</td></tr>
            <tr><td>üí™ Titan</td><td>8.775M</td><td>7/day</td><td>42,000</td></tr>
            <tr><td>üëë King</td><td>16.65M</td><td>8/day</td><td>69,375</td></tr>
            <tr><td>ü¶Ö Emperor</td><td>29.7M</td><td>9/day</td><td>110K</td></tr>
            <tr><td>‚≠ê Icon</td><td>48.6M</td><td>10/day</td><td>162K</td></tr>
            <tr><td>üëë Supreme</td><td>81M</td><td>11/day</td><td>245K</td></tr>
            <tr><td>üèÜ Legendary</td><td>110M</td><td>12/day</td><td>305K</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div id="vaultSection" class="content hidden fade-in">
    <div class="section-title">Vault Plans</div>
    <div class="section-sub">Select a plan to unlock daily task rewards</div>
    <div id="vaultAlert"></div>
    <div id="plansList"></div>

    <div id="selectedPlanDetails" class="hidden">
      <div class="purchase-summary" id="purchaseSummaryContent"></div>
      <button class="btn btn-gold btn-full" id="purchaseBtn" onclick="purchaseVault()">Confirm Purchase</button>
    </div>
  </div>

  <div id="referralsSection" class="content hidden fade-in">
    <div class="section-title">Referrals</div>
    <div class="section-sub">Earn 10% on vault purchases + weekly prizes</div>
    <div id="referralsAlert"></div>

    <div class="balance-hero" style="margin-bottom:12px">
      <div class="balance-label">Total Referral Earnings</div>
      <div class="balance-value" id="totalReferralEarnings">0</div>
      <div class="balance-currency">UGX</div>
    </div>

    <div class="card" id="referralLevelCard"></div>

    <div class="card">
      <div style="font-weight:700;margin-bottom:14px">How it works</div>
      <div style="display:flex;flex-direction:column;gap:10px">
        <div style="display:flex;gap:12px;align-items:flex-start">
          <span style="font-size:1.2rem;flex-shrink:0">üéØ</span>
          <div><div style="font-weight:600;font-size:0.875rem">Vault Purchase Bonus</div><div style="font-size:0.78rem;color:var(--text-muted);margin-top:2px">Earn 10% of every vault plan your referral purchases</div></div>
        </div>
        <div style="display:flex;gap:12px;align-items:flex-start">
          <span style="font-size:1.2rem;flex-shrink:0">üå≥</span>
          <div><div style="font-weight:600;font-size:0.875rem">Second-Level Bonus</div><div style="font-size:0.78rem;color:var(--text-muted);margin-top:2px">Earn 2,000 UGX when your referral recruits someone</div></div>
        </div>
        <div style="display:flex;gap:12px;align-items:flex-start">
          <span style="font-size:1.2rem;flex-shrink:0">üèÜ</span>
          <div><div style="font-weight:600;font-size:0.875rem">Weekly Prize</div><div style="font-size:0.78rem;color:var(--text-muted);margin-top:2px">Top referrer each week wins 50,000 UGX</div></div>
        </div>
      </div>
    </div>

    <div class="card">
      <div style="font-weight:700;margin-bottom:14px">Your Referrals</div>
      <div id="referralsList" style="color:var(--text-muted);text-align:center;padding:16px">Loading‚Ä¶</div>
    </div>
  </div>

  <div id="tasksSection" class="content hidden fade-in">
    <div class="section-title">Daily Tasks</div>
    <div class="section-sub">Complete tasks to earn your daily rewards</div>
    <div id="tasksAlert"></div>
    <div class="card" style="padding:16px">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <span style="font-size:0.8rem;font-weight:600;color:var(--text-muted)">Today's Progress</span>
        <span id="taskProgressText" style="font-family:'JetBrains Mono',monospace;font-size:0.9rem;font-weight:700;color:var(--gold)">0 / 0</span>
      </div>
      <div class="progress-bar-wrap"><div class="progress-bar-fill" id="taskProgressBar" style="width:0%"></div></div>
    </div>
    <div id="tasksList"><div style="text-align:center;padding:40px;color:var(--text-muted)">Loading tasks‚Ä¶</div></div>
  </div>

  <div id="walletSection" class="content hidden fade-in">
    <div class="section-title">Wallet</div>
    <div class="section-sub">Deposits, withdrawals & transactions</div>
    <div id="walletAlert"></div>

    <div class="balance-hero" style="margin-bottom:12px">
      <div class="balance-label">Available Balance</div>
      <div class="balance-value" id="walletBalance">0</div>
      <div class="balance-currency">UGX ¬∑ Points: <strong id="walletPointsBalance">0</strong></div>
    </div>

    <div class="tab-bar">
      <button class="tab-btn active" id="depositTab" onclick="showWalletTab('deposit')">Deposit</button>
      <button class="tab-btn" id="withdrawTab" onclick="showWalletTab('withdraw')">Withdraw</button>
      <button class="tab-btn" id="historyTab" onclick="showWalletTab('history')">History</button>
    </div>

    <div id="depositPanel">
      <div class="card">
        <div style="font-weight:700;margin-bottom:14px">Deposit Funds</div>
        <div id="depositAlert"></div>
        <div class="form-group"><label>Amount (UGX)</label><input type="number" id="depositAmount" placeholder="Minimum 1,000"></div>
        <div class="form-group"><label>Payment Method</label>
          <select id="depositMethod">
            <option value="">Select method</option>
            <option value="mtn">MTN Mobile Money</option>
            <option value="airtel">Airtel Money</option>
          </select>
        </div>
        <div class="form-group"><label>Your Phone Number</label><input type="tel" id="depositPhone" placeholder="07XXXXXXXX"></div>
        <div class="card" style="background:rgba(201,168,76,0.06);border-color:var(--border);padding:14px;margin-bottom:14px">
          <div style="font-size:0.8rem;line-height:1.7;color:var(--text-muted)">
            <strong style="color:var(--gold);display:block;margin-bottom:4px">üì± Payment Instructions</strong>
            1. Send money to: <strong onclick="navigator.clipboard.writeText('0785000000')" style="cursor:pointer;color:var(--gold)">0785 000 000</strong><br>
            2. Fill in the amount and your number below<br>
            3. Submit ‚Äî admin approves within 1 hour
          </div>
        </div>
        <button class="btn btn-green btn-full" onclick="submitDeposit()">Submit Deposit Request</button>
      </div>
    </div>

    <div id="withdrawPanel" class="hidden">
      <div class="card">
        <div style="font-weight:700;margin-bottom:14px">Withdraw Funds</div>
        <div id="withdrawAlert"></div>
        <div class="form-group"><label>Earnings Category</label>
          <select id="withdrawCategory">
            <option value="">Select category</option>
            <option value="referral">Referral Earnings</option>
            <option value="task">Task Earnings (Fri‚ÄìSat only)</option>
            <option value="vault">Vault Earnings</option>
          </select>
        </div>
        <div class="form-group"><label>Amount (UGX)</label><input type="number" id="withdrawAmount" placeholder="Minimum 5,000"></div>
        <div class="form-group"><label>Mobile Money Number</label><input type="tel" id="withdrawPhone" placeholder="07XXXXXXXX"></div>
        <div class="card" style="background:rgba(232,68,90,0.06);border-color:rgba(232,68,90,0.2);padding:14px;margin-bottom:14px">
          <div style="font-size:0.8rem;color:var(--text-muted);line-height:1.7">
            <strong style="color:var(--red);display:block;margin-bottom:4px">‚ö†Ô∏è Withdrawal Rules</strong>
            Task earnings: Friday &amp; Saturday only<br>
            Admin fee: 5% | Minimum: 5,000 UGX
          </div>
        </div>
        <button class="btn btn-gold btn-full" onclick="submitWithdrawal()">Request Withdrawal</button>
      </div>
    </div>

    <div id="historyPanel" class="hidden">
      <div class="card" style="padding:0;overflow:hidden">
        <div style="padding:16px;border-bottom:1px solid var(--border-subtle);font-weight:700">Transaction History</div>
        <table>
          <thead><tr><th>Date</th><th>Type</th><th>Amount</th><th>Status</th></tr></thead>
          <tbody id="walletTxHistory"><tr><td colspan="4" style="text-align:center;color:var(--text-muted)">No transactions yet</td></tr></tbody>
        </table>
      </div>
    </div>
  </div>

  <div id="streakSection" class="content hidden fade-in">
    <div class="section-title">Daily Streak</div>
    <div class="section-sub">Login every day to earn bonus points</div>
    <div id="streakAlert"></div>

    <div class="card" style="text-align:center;padding:28px">
      <div style="font-size:3.5rem;margin-bottom:8px">üî•</div>
      <div style="font-family:'Playfair Display',serif;font-size:3rem;font-weight:800;color:var(--gold)" id="currentStreak">0</div>
      <div style="color:var(--text-muted);margin-bottom:16px">Day Streak</div>
      <div class="streak-grid" id="streakDays"></div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:16px">
        <div class="stat-tile"><div class="stat-tile-value" id="streakPoints">0</div><div class="stat-tile-label">Points Balance</div></div>
        <div class="stat-tile"><div class="stat-tile-value" id="longestStreakDisplay">0</div><div class="stat-tile-label">Best Streak</div></div>
      </div>
    </div>

    <div class="card">
      <div style="font-weight:700;margin-bottom:6px">Convert Points</div>
      <div style="font-size:0.8rem;color:var(--text-muted);margin-bottom:14px">100 points = 1,000 UGX</div>
      <div style="display:flex;gap:10px;margin-bottom:14px">
        <div style="flex:1">
          <label style="font-size:0.72rem;font-weight:700;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.08em;display:block;margin-bottom:6px">Points</label>
          <input type="number" id="pointsToConvert" placeholder="Min 100" style="width:100%;padding:12px;background:var(--bg3);border:1px solid var(--border-subtle);border-radius:var(--r-sm);color:var(--text);font-family:'DM Sans',sans-serif;font-size:0.9rem" oninput="document.getElementById('pointsConversionPreview').textContent=((parseInt(this.value)||0)*10).toLocaleString()+' UGX'">
        </div>
        <div style="flex:1">
          <label style="font-size:0.72rem;font-weight:700;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.08em;display:block;margin-bottom:6px">You Receive</label>
          <div style="padding:12px;background:var(--bg3);border-radius:var(--r-sm);font-family:'JetBrains Mono',monospace;font-weight:700;color:var(--green)" id="pointsConversionPreview">0 UGX</div>
        </div>
      </div>
      <button class="btn btn-green btn-full" onclick="convertPoints()">Convert Points</button>
    </div>
  </div>

  <div id="profileSection" class="content hidden fade-in">
    <div id="profileAlert"></div>
    <div class="profile-hero">
      <div class="avatar" id="profileAvatar">
        <span id="profileInitials">?</span>
        <img id="profileImage" class="avatar-img" style="display:none;position:absolute;inset:0;width:100%;height:100%;border-radius:50%">
        <label class="avatar-edit-btn" title="Change photo">
          üì∑<input type="file" accept="image/*" style="display:none" onchange="uploadProfilePicture(event)">
        </label>
      </div>
      <div class="profile-name" id="profileName">‚Äî</div>
      <div class="profile-email" id="profileEmail">‚Äî</div>
      <div style="margin-top:12px" id="profileLevelBadge"></div>
    </div>

    <div class="card">
      <div style="font-weight:700;margin-bottom:14px">Account Information</div>
      <div class="info-row">
        <span class="info-label">Full Name</span>
        <div style="display:flex;align-items:center;gap:8px">
          <span class="info-value" id="profileFullNameVal">‚Äî</span>
          <button onclick="toggleNameEdit()" style="background:none;border:none;color:var(--gold);cursor:pointer;font-size:0.8rem">Edit</button>
        </div>
      </div>
      <div id="nameEditContainer" class="hidden">
        <input type="text" id="nameEditInput" style="width:100%;padding:10px 12px;background:var(--bg3);border:1px solid var(--gold);border-radius:var(--r-sm);color:var(--text);font-family:'DM Sans',sans-serif;margin-bottom:8px">
        <div style="display:flex;gap:8px">
          <button class="btn btn-green" style="flex:1;padding:10px" onclick="saveNameEdit()">Save</button>
          <button class="btn btn-surface" style="flex:1;padding:10px" onclick="cancelNameEdit()">Cancel</button>
        </div>
      </div>
      <div class="info-row"><span class="info-label">Email</span><span class="info-value" id="profileEmailVal">‚Äî</span></div>
      <div class="info-row"><span class="info-label">Joined</span><span class="info-value" id="profileJoinedVal">‚Äî</span></div>
      <div class="info-row"><span class="info-label">Status</span><span class="info-value" id="profileStatusVal">‚Äî</span></div>
    </div>

    <div class="card">
      <div style="font-weight:700;margin-bottom:14px">Statistics</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
        <div class="stat-tile"><div class="stat-tile-value" id="profileActiveVaults">0</div><div class="stat-tile-label">Vaults</div></div>
        <div class="stat-tile"><div class="stat-tile-value" id="profileAccountLevel">‚Äî</div><div class="stat-tile-label">Level</div></div>
        <div class="stat-tile"><div class="stat-tile-value" id="profilePoints">0</div><div class="stat-tile-label">Points</div></div>
        <div class="stat-tile"><div class="stat-tile-value" id="profileStreak">0</div><div class="stat-tile-label">Streak</div></div>
      </div>
    </div>

    <div class="card card-gold">
      <div style="font-weight:700;margin-bottom:10px">Your Referral Code</div>
      <div style="font-family:'JetBrains Mono',monospace;font-size:1.8rem;font-weight:700;color:var(--gold);text-align:center;letter-spacing:0.12em;margin-bottom:14px" id="profileReferralCode">‚Äî</div>
      <button class="btn btn-outline btn-full" onclick="copyReferralCode()">üìã Copy Code</button>
    </div>

    <div class="card" style="padding:0">
      <button class="btn btn-full" onclick="logout()" style="background:rgba(232,68,90,0.12);color:var(--red);border:1px solid rgba(232,68,90,0.3);border-radius:var(--r);padding:16px;font-weight:700">üö™ Sign Out</button>
    </div>
  </div>

  <nav class="bottom-nav">
    <button class="nav-item active" data-section="home" onclick="showSection('home')"><span class="nav-icon">üè†</span>Home</button>
    <button class="nav-item" data-section="vault" onclick="showSection('vault')"><span class="nav-icon">üè¶</span>Vault</button>
    <button class="nav-item" data-section="referrals" onclick="showSection('referrals')"><span class="nav-icon">üë•</span>Refer</button>
    <button class="nav-item" data-section="tasks" onclick="showSection('tasks')"><span class="nav-icon">‚úÖ</span>Tasks</button>
    <button class="nav-item" data-section="wallet" onclick="showSection('wallet')"><span class="nav-icon">üíº</span>Wallet</button>
    <button class="nav-item" data-section="streak" onclick="showSection('streak')"><span class="nav-icon">üî•</span>Streak</button>
    <button class="nav-item" data-section="profile" onclick="showSection('profile')"><span class="nav-icon">üë§</span>Profile</button>
  </nav>
</div>

<!-- ===== ADMIN DASHBOARD ===== -->
<div id="adminDashboard" class="admin-wrapper hidden">
  <div class="admin-header">
    <span style="font-family:'Playfair Display',serif;font-size:1.2rem;color:var(--gold)">VaultPro Admin</span>
    <button class="btn btn-surface" style="padding:8px 16px;font-size:0.8rem" onclick="logout()">Sign Out</button>
  </div>
  <div class="admin-tabs">
    <button class="admin-tab active" onclick="showAdminSection('stats')">üìä Stats</button>
    <button class="admin-tab" onclick="showAdminSection('users')">üë• Users</button>
    <button class="admin-tab" onclick="showAdminSection('tasks')">‚úÖ Tasks</button>
    <button class="admin-tab" onclick="showAdminSection('transactions')">üìã Transactions</button>
    <button class="admin-tab" onclick="showAdminSection('deposits')">üí∞ Deposits</button>
    <button class="admin-tab" onclick="showAdminSection('withdrawals')">üí∏ Withdrawals</button>
  </div>
  <div class="admin-content">
    <div id="adminStatsSection">
      <div class="admin-stats-grid">
        <div class="admin-stat-card"><div class="admin-stat-val" id="adminTotalUsers">0</div><div class="admin-stat-label">Total Users</div></div>
        <div class="admin-stat-card"><div class="admin-stat-val" id="adminTotalBalance">0</div><div class="admin-stat-label">Total Balance</div></div>
        <div class="admin-stat-card"><div class="admin-stat-val" id="adminTotalDeposits">0</div><div class="admin-stat-label">Deposits</div></div>
        <div class="admin-stat-card"><div class="admin-stat-val" id="adminTotalWithdrawals">0</div><div class="admin-stat-label">Withdrawals</div></div>
        <div class="admin-stat-card"><div class="admin-stat-val" id="adminActivatedUsers">0</div><div class="admin-stat-label">Active Users</div></div>
        <div class="admin-stat-card"><div class="admin-stat-val" id="adminPendingWithdrawals">0</div><div class="admin-stat-label">Pending W/D</div></div>
      </div>
      <div class="card">
        <div style="font-weight:700;margin-bottom:8px">üèÜ Weekly Prize</div>
        <div style="font-size:0.8rem;color:var(--text-muted);margin-bottom:14px">Award 50,000 UGX to the week's top referrer (min 8 referrals)</div>
        <button class="btn btn-gold" onclick="awardWeeklyWinner().then(w=>toast(w?'Winner: '+w.userData.fullName:'No winner ‚Äì min 8 referrals required','üèÜ',w?'success':'warning'))">Award Weekly Winner</button>
      </div>
    </div>
    <div id="adminUsersSection" class="hidden"><div class="card" style="padding:0;overflow:hidden"><div style="padding:16px;font-weight:700;border-bottom:1px solid var(--border-subtle)">All Users</div><div id="adminUsersList" style="padding:16px;color:var(--text-muted)">Loading‚Ä¶</div></div></div>
    <div id="adminTasksSection" class="hidden">
      <div class="card" style="margin-bottom:12px">
        <div style="font-weight:700;margin-bottom:14px">Add YouTube Task</div>
        <div class="form-group"><label>YouTube URL</label><input type="url" id="newTaskUrl" placeholder="https://youtube.com/watch?v=..."></div>
        <div class="form-group"><label>Title</label><input type="text" id="newTaskTitle" placeholder="Task title"></div>
        <div class="form-group"><label>Description</label><input type="text" id="newTaskDescription" placeholder="Watch and like this video"></div>
        <div class="form-group"><label>Reward (UGX)</label><input type="number" id="newTaskReward" placeholder="1000"></div>
        <button class="btn btn-green btn-full" onclick="addTask()">Add YouTube Task</button>
      </div>
      <div class="card" style="margin-bottom:12px">
        <div style="font-weight:700;margin-bottom:14px">Add External Link Task</div>
        <div class="form-group"><label>URL</label><input type="url" id="newExternalTaskUrl" placeholder="https://..."></div>
        <div class="form-group"><label>Title</label><input type="text" id="newExternalTaskTitle" placeholder="Task title"></div>
        <div class="form-group"><label>Description</label><input type="text" id="newExternalTaskDescription" placeholder="Visit this website"></div>
        <div class="form-group"><label>Reward (UGX)</label><input type="number" id="newExternalTaskReward" placeholder="1000"></div>
        <button class="btn btn-green btn-full" onclick="addExternalTask()">Add External Task</button>
      </div>
      <div class="card" style="padding:0;overflow:hidden"><div style="padding:16px;font-weight:700;border-bottom:1px solid var(--border-subtle)">YouTube Tasks</div><div id="adminTasksList" style="padding:16px;color:var(--text-muted)">Loading‚Ä¶</div></div>
      <div class="card" style="padding:0;overflow:hidden;margin-top:12px"><div style="padding:16px;font-weight:700;border-bottom:1px solid var(--border-subtle)">External Tasks</div><div id="adminExternalTasksList" style="padding:16px;color:var(--text-muted)">Loading‚Ä¶</div></div>
    </div>
    <div id="adminTransactionsSection" class="hidden"><div class="card" style="padding:0;overflow:hidden"><div style="padding:16px;font-weight:700;border-bottom:1px solid var(--border-subtle)">All Transactions</div><div style="overflow-x:auto"><table><thead><tr><th>User</th><th>Type</th><th>Amount</th><th>Date</th></tr></thead><tbody id="adminTransactionsList"><tr><td colspan="4" style="text-align:center;color:var(--text-muted)">Loading‚Ä¶</td></tr></tbody></table></div></div></div>
    <div id="adminDepositsSection" class="hidden"><div class="card"><div style="font-weight:700;margin-bottom:14px">Deposit Requests</div><div id="adminDepositsList" style="color:var(--text-muted)">Loading‚Ä¶</div></div></div>
    <div id="adminWithdrawalsSection" class="hidden"><div class="card"><div style="font-weight:700;margin-bottom:14px">Withdrawal Requests</div><div id="adminWithdrawalsList" style="color:var(--text-muted)">Loading‚Ä¶</div></div></div>
  </div>
</div>

<!-- ===== PAYMENT MODAL ===== -->
<div id="paymentModal" class="modal-overlay hidden">
  <div class="modal-sheet">
    <div class="modal-handle"></div>
    <div class="modal-title">üí≥ Select Payment Source</div>
    <div style="color:var(--text-muted);font-size:0.875rem;margin-bottom:20px" id="paymentModalDesc"></div>
    <div id="paymentModalOptions"></div>
  </div>
</div>

<!-- ===== FIREBASE + LOGIC ===== -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script>
// ============================================================
//  ‚ö†Ô∏è  REPLACE WITH YOUR REAL FIREBASE CONFIG BELOW
// ============================================================
const firebaseConfig = {
  apiKey: "AIzaSyCnMj0_eJEaD2dZNSoeZ_ijsl8ETt4BFhY",
  authDomain: "vaultpro-app.firebaseapp.com",
  projectId: "vaultpro-app",
  storageBucket: "vaultpro-app.firebasestorage.app",
  messagingSenderId: "272074672947",
  appId: "1:272074672947:web:c2459af0c1480f0474cc46",
  measurementId: "G-8XFB9L9H4L"
};
// ============================================================

let db, auth, firebaseReady = false;
try {
  firebase.initializeApp(firebaseConfig);
  db = firebase.firestore();
  auth = firebase.auth();
  firebaseReady = true;
} catch(e) { console.error('Firebase init failed:', e); }

// ===== GLOBALS =====
let currentUser = null;
let selectedPlan = null;
let isPurchasing = false;
let statsCache = { data: null, ts: 0, ttl: 30000 };
let weeklyTimerInterval = null;

// ===== VAULT PLANS =====
const PLANS = {
  beginner:   { name:'Beginner',   emoji:'üå±', amount:45000,      days:30, dailyTasks:2,  taskReward:750,    level:1 },
  seed:       { name:'Seed',       emoji:'üåø', amount:180000,     days:30, dailyTasks:3,  taskReward:2000,   level:2 },
  rising:     { name:'Rising',     emoji:'üåÖ', amount:600000,     days:30, dailyTasks:4,  taskReward:5000,   level:3 },
  nova:       { name:'Nova',       emoji:'üí°', amount:1350000,    days:30, dailyTasks:5,  taskReward:9000,   level:4 },
  mastermind: { name:'Mastermind', emoji:'üß†', amount:4050000,    days:30, dailyTasks:6,  taskReward:22500,  level:5 },
  titan:      { name:'Titan',      emoji:'üí™', amount:8775000,    days:30, dailyTasks:7,  taskReward:42000,  level:6 },
  king:       { name:'King',       emoji:'üëë', amount:16650000,   days:30, dailyTasks:8,  taskReward:69375,  level:7 },
  emperor:    { name:'Emperor',    emoji:'ü¶Ö', amount:29700000,   days:30, dailyTasks:9,  taskReward:110000, level:8 },
  icon:       { name:'Icon',       emoji:'‚≠ê', amount:48600000,   days:30, dailyTasks:10, taskReward:162000, level:9 },
  supreme:    { name:'Supreme',    emoji:'üëë', amount:81000000,   days:30, dailyTasks:11, taskReward:245000, level:10 },
  legendary:  { name:'Legendary',  emoji:'üèÜ', amount:110000000,  days:30, dailyTasks:12, taskReward:305556, level:11 },
};

const REFERRAL_LEVELS = [
  { title:'Member',     icon:'üå±', color:'#1DB87F', min:0    },
  { title:'Ambassador', icon:'‚≠ê', color:'#f59e0b', min:10   },
  { title:'Executive',  icon:'üíº', color:'#6366f1', min:50   },
  { title:'Director',   icon:'üéØ', color:'#8b5cf6', min:100  },
  { title:'VP',         icon:'ü¶Ö', color:'#ec4899', min:500  },
  { title:'Admin',      icon:'üëë', color:'#C9A84C', min:1000 },
  { title:'Shareholder',icon:'üíé', color:'#06b6d4', min:5000 },
];

// ===== TOAST =====
function toast(msg, icon = '‚ÑπÔ∏è', type = 'info', dur = 4000) {
  const c = document.getElementById('toastContainer');
  const t = document.createElement('div');
  t.className = 'toast';
  const colors = { success:'#1DB87F', error:'#E8445A', warning:'#C9A84C', info:'#4A7CF7' };
  t.style.borderLeftColor = colors[type] || colors.info;
  t.style.borderLeftWidth = '3px';
  t.innerHTML = `<span class="toast-icon">${icon}</span><div class="toast-content"><div class="toast-title">${msg}</div></div><button class="toast-close" onclick="this.parentElement.remove()">‚úï</button>`;
  c.appendChild(t);
  setTimeout(() => t.remove(), dur);
}

function showAlert(id, msg, type) {
  const el = document.getElementById(id);
  if (!el) return;
  const icons = { success:'‚úÖ', error:'‚ùå', warning:'‚ö†Ô∏è', info:'‚ÑπÔ∏è' };
  el.innerHTML = `<div class="alert alert-${type}">${icons[type]||''} ${msg}</div>`;
  setTimeout(() => { if(el) el.innerHTML = ''; }, 6000);
}

// ===== REFERRAL LINK HELPERS =====
function storeRef(code) {
  if (!code) return;
  localStorage.setItem('vp_ref', JSON.stringify({ code, exp: Date.now() + 86400000 }));
  sessionStorage.setItem('vp_ref_s', code);
}
function getStoredRef() {
  const s = sessionStorage.getItem('vp_ref_s');
  if (s) return s;
  try {
    const p = JSON.parse(localStorage.getItem('vp_ref') || '{}');
    if (p.code && Date.now() < p.exp) return p.code;
    localStorage.removeItem('vp_ref');
  } catch(e) {}
  return null;
}
function clearRef() { localStorage.removeItem('vp_ref'); sessionStorage.removeItem('vp_ref_s'); }

// ===== PAGE VISIBILITY =====
function hideAll() {
  ['loadingScreen','referralLandingPage','registerPage','loginPage','userDashboard','adminDashboard']
    .forEach(id => { const e = document.getElementById(id); if(e) e.classList.add('hidden'); });
}

// ===== INIT =====
async function init() {
  document.getElementById('loadingScreen').classList.remove('hidden');
  if (!firebaseReady) {
    document.getElementById('loadingScreen').classList.add('hidden');
    document.getElementById('loginPage').classList.remove('hidden');
    toast('Firebase not configured. Add your config to connect.', '‚ö†Ô∏è', 'warning', 8000);
    return;
  }

  const urlRef = new URLSearchParams(window.location.search).get('ref');
  if (urlRef) {
    storeRef(urlRef);
    window.history.replaceState({}, '', window.location.pathname);
  }

  auth.onAuthStateChanged(async user => {
    if (user) {
      try {
        const d = await db.collection('users').doc(user.uid).get();
        if (d.exists) {
          currentUser = { id: user.uid, ...d.data() };
          document.getElementById('loadingScreen').classList.add('hidden');
          if (currentUser.isAdmin) showAdminDashboard();
          else { showUserDashboard(); initNotifications(); }
          return;
        }
      } catch(e) { console.error('Auth state error:', e); }
    }
    document.getElementById('loadingScreen').classList.add('hidden');
    const stored = getStoredRef();
    if (stored) { showReferralLanding(stored); }
    else { showLogin(); }
  });
}

function showReferralLanding(code) {
  hideAll();
  document.getElementById('referralLandingPage').classList.remove('hidden');
  document.getElementById('landingReferralCode').textContent = code;
  storeRef(code);
}

// ===== AUTH =====
async function register() {
  const btn = document.getElementById('registerBtn');
  btn.disabled = true; btn.textContent = 'Creating account‚Ä¶';
  try {
    const code = document.getElementById('inviteCode').value.trim().toUpperCase();
    const name = document.getElementById('fullName').value.trim();
    const email = document.getElementById('email').value.trim();
    const pwd = document.getElementById('password').value;
    const cpwd = document.getElementById('confirmPassword').value;

    if (!code || !name || !email || !pwd) { showAlert('registerAlert', 'Please fill in all fields', 'error'); return; }
    if (pwd.length < 6) { showAlert('registerAlert', 'Password must be at least 6 characters', 'error'); return; }
    if (pwd !== cpwd) { showAlert('registerAlert', 'Passwords do not match', 'error'); return; }

    const refQ = await db.collection('users').where('referralCode', '==', code).get();
    if (refQ.empty) { showAlert('registerAlert', 'Invalid invitation code', 'error'); return; }
    const refId = refQ.docs[0].id;

    const cred = await auth.createUserWithEmailAndPassword(email, pwd);
    const uid = cred.user.uid;
    const newUser = {
      id: uid, fullName: name, email,
      balance: 0, referredBy: refId,
      referralCode: Math.random().toString(36).substring(2, 8).toUpperCase(),
      joinedDate: new Date().toISOString(),
      isAdmin: false, isActivated: true,
      activationDate: new Date().toISOString(),
      currentStreak: 0, longestStreak: 0,
      lastLoginDate: null, totalPoints: 0, pointsBalance: 0,
      totalTaskEarnings: 0,
    };
    await db.collection('users').doc(uid).set(newUser);
    await db.collection('users').doc(refId).collection('referrals').doc(uid).set({
      userId: uid, name, email, date: new Date().toISOString(), earnings: 0
    });
    clearRef();
    showAlert('registerAlert', 'üéâ Account created! Signing you in‚Ä¶', 'success');
  } catch(e) {
    const msgs = {
      'auth/email-already-in-use': 'Email already registered ‚Äî try logging in',
      'auth/weak-password': 'Password too weak',
      'auth/invalid-email': 'Invalid email address',
    };
    showAlert('registerAlert', msgs[e.code] || 'Registration failed: ' + e.message, 'error');
  } finally {
    btn.disabled = false; btn.textContent = 'Create Account';
  }
}

async function login() {
  const btn = document.getElementById('loginBtn');
  btn.disabled = true; btn.textContent = 'Signing in‚Ä¶';
  try {
    const email = document.getElementById('loginEmail').value.trim();
    const pwd = document.getElementById('loginPassword').value;
    if (!email || !pwd) { showAlert('loginAlert', 'Please enter your email and password', 'error'); return; }

    const cred = await auth.signInWithEmailAndPassword(email, pwd);
    const d = await db.collection('users').doc(cred.user.uid).get();
    if (!d.exists) {
      showAlert('loginAlert', 'Account not found', 'error');
      await auth.signOut(); return;
    }
    currentUser = { id: cred.user.uid, ...d.data() };
    await updateStreak(cred.user.uid, currentUser);
  } catch(e) {
    const msgs = {
      'auth/user-not-found': 'No account with this email',
      'auth/wrong-password': 'Incorrect password',
      'auth/too-many-requests': 'Too many attempts. Please try again later.',
      'auth/invalid-credential': 'Invalid email or password',
    };
    showAlert('loginAlert', msgs[e.code] || 'Login failed', 'error');
  } finally {
    btn.disabled = false; btn.textContent = 'Sign In';
  }
}

async function logout() {
  if (!confirm('Sign out of VaultPro?')) return;
  await auth.signOut();
  currentUser = null;
  clearInterval(weeklyTimerInterval);
  showLogin();
}

// ===== NAVIGATION =====
function showLogin() {
  hideAll();
  document.getElementById('loginPage').classList.remove('hidden');
}
function showRegister() {
  hideAll();
  document.getElementById('registerPage').classList.remove('hidden');
}
function showRegisterFromReferral() {
  showRegister();
  const code = getStoredRef();
  if (code) {
    const f = document.getElementById('inviteCode');
    f.value = code; f.readOnly = true; f.style.borderColor = 'var(--green)';
  }
}

function showUserDashboard() {
  hideAll();
  document.getElementById('userDashboard').classList.remove('hidden');
  setTimeout(() => showSection('home'), 50);
  updateUserStats();
  updateLeaderboard();
  startWeeklyTimer();
  if (weeklyTimerInterval) clearInterval(weeklyTimerInterval);
  weeklyTimerInterval = setInterval(updateWeekTimer, 60000);
}

function showAdminDashboard() {
  hideAll();
  document.getElementById('adminDashboard').classList.remove('hidden');
  updateAdminStats();
  showAdminSection('stats');
}

function showSection(s) {
  if (!currentUser) return;
  ['home','vault','referrals','tasks','wallet','streak','profile'].forEach(x => {
    const e = document.getElementById(x + 'Section');
    if (e) e.classList.add('hidden');
  });
  const el = document.getElementById(s + 'Section');
  if (el) el.classList.remove('hidden');
  document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
  const nav = document.querySelector(`[data-section="${s}"]`);
  if (nav) nav.classList.add('active');

  if (s === 'home') { updateUserStats(); displayTaskAlloc(); }
  else if (s === 'vault') { updateVaultSection(); }
  else if (s === 'referrals') { updateReferralsSection(); }
  else if (s === 'tasks') { updateTasksSection(); }
  else if (s === 'wallet') { updateWalletSection(); }
  else if (s === 'streak') { updateStreakSection(); }
  else if (s === 'profile') { refreshUser().then(() => updateProfileSection()); }
}

function showAdminSection(s) {
  ['Stats','Users','Tasks','Transactions','Deposits','Withdrawals'].forEach(x => {
    const e = document.getElementById('admin' + x + 'Section');
    if (e) e.classList.add('hidden');
  });
  document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
  const el = document.getElementById('admin' + s.charAt(0).toUpperCase() + s.slice(1) + 'Section');
  if (el) el.classList.remove('hidden');
  event.target.classList.add('active');
  if (s === 'users') updateAdminUsers();
  else if (s === 'tasks') { updateAdminTasks(); updateAdminExternalTasks(); }
  else if (s === 'transactions') updateAdminTransactions();
  else if (s === 'deposits') updateAdminDeposits();
  else if (s === 'withdrawals') updateAdminWithdrawals();
}

// ===== STREAK =====
async function updateStreak(uid, user) {
  try {
    if (user.isAdmin) { await db.collection('users').doc(uid).update({ lastLoginDate: new Date().toISOString() }); return; }
    const today = new Date().toISOString().split('T')[0];
    const last = user.lastLoginDate ? new Date(user.lastLoginDate).toISOString().split('T')[0] : null;
    if (last === today) return;
    let streak = user.currentStreak || 0, longest = user.longestStreak || 0;
    let pts = user.totalPoints || 0, bal = user.pointsBalance || 0;
    const yest = new Date(); yest.setDate(yest.getDate() - 1);
    const yestStr = yest.toISOString().split('T')[0];
    streak = (last === yestStr) ? streak + 1 : 1;
    if (streak > longest) longest = streak;
    const award = streak >= 30 ? 100 : streak >= 21 ? 75 : streak >= 14 ? 50 : streak >= 7 ? 25 : streak >= 3 ? 15 : streak >= 2 ? 10 : 5;
    pts += award; bal += award;
    await db.collection('users').doc(uid).update({ currentStreak: streak, longestStreak: longest, lastLoginDate: new Date().toISOString(), totalPoints: pts, pointsBalance: bal });
    if (currentUser) Object.assign(currentUser, { currentStreak: streak, longestStreak: longest, pointsBalance: bal });
    if (award > 0) setTimeout(() => toast(`üî• ${streak} day streak! +${award} points earned`, 'üî•', 'success'), 1200);
  } catch(e) { console.error('Streak:', e); }
}

// ===== USER STATS =====
async function updateUserStats(force = false) {
  try {
    const now = Date.now();
    if (!force && statsCache.data && (now - statsCache.ts) < statsCache.ttl) { applyStats(statsCache.data); return; }
    const [ud, vs, rs, cb] = await Promise.all([
      db.collection('users').doc(currentUser.id).get(),
      db.collection('users').doc(currentUser.id).collection('vaults').get(),
      db.collection('users').doc(currentUser.id).collection('referrals').get(),
      getCategoryBalances(currentUser.id),
    ]);
    currentUser = { id: currentUser.id, ...ud.data() };
    const data = { balance: currentUser.balance || 0, refs: rs.size, cb, user: currentUser, vaults: vs.docs.map(d => d.data()) };
    statsCache = { data, ts: now, ttl: 30000 };
    applyStats(data);
    // Update header
    document.getElementById('headerUserInfo').innerHTML = `<strong>${currentUser.fullName}</strong>`;
    const link = document.getElementById('userReferralLink');
    if (link) link.textContent = `${window.location.origin}${window.location.pathname}?ref=${currentUser.referralCode}`;
    const ab = document.getElementById('activationBadge');
    if (ab) { if (currentUser.isActivated) ab.classList.remove('hidden'); else ab.classList.add('hidden'); }
  } catch(e) { console.error('Stats:', e); }
}

function applyStats({ balance, refs, cb, user, vaults }) {
  const set = (id, v) => { const e = document.getElementById(id); if(e) e.textContent = v; };
  set('totalBalance', (balance || 0).toLocaleString());
  set('statReferrals', refs);
  set('statTaskEarnings', (cb.taskEarnings || 0).toLocaleString());
  set('statRefEarnings', (cb.referralEarnings || 0).toLocaleString());
  const active = vaults.filter(v => v.status === 'active');
  set('statLevel', calcVaultLevel(active).level);
  set('walletBalance', (balance || 0).toLocaleString());
  set('walletPointsBalance', (user.pointsBalance || 0).toLocaleString());
}

function clearStatsCache() { statsCache = { data: null, ts: 0, ttl: 30000 }; }

async function getCategoryBalances(uid) {
  try {
    const snap = await db.collection('transactions').where('userId', '==', uid).get();
    const b = { taskEarnings: 0, referralEarnings: 0, vaultEarnings: 0, depositEarnings: 0 };
    snap.docs.forEach(d => {
      const t = d.data(), a = t.amount || 0;
      if (t.type === 'task_completion') b.taskEarnings += a;
      else if (t.type === 'referral') b.referralEarnings += a;
      else if (t.type === 'vault_maturity') b.vaultEarnings += a;
      else if (t.type === 'deposit') b.depositEarnings += a;
      else if (['withdrawal','withdrawal_approved'].includes(t.type)) {
        const k = t.sourceCategory || 'depositEarnings';
        b[k] = Math.max(0, (b[k] || 0) - Math.abs(a));
      }
    });
    Object.keys(b).forEach(k => { b[k] = Math.max(0, b[k]); });
    return b;
  } catch(e) { return { taskEarnings:0, referralEarnings:0, vaultEarnings:0, depositEarnings:0 }; }
}

async function getUserVaultLevel(uid) {
  try {
    const snap = await db.collection('users').doc(uid).collection('vaults').get();
    const active = snap.docs.map(d => d.data()).filter(v => v.status === 'active');
    if (!active.length) return { planName: 'None', level: 0, dailyTasks: 0, taskReward: 0 };
    const top = active.sort((a,b) => b.amount - a.amount)[0];
    const pk = Object.keys(PLANS).find(k => PLANS[k].name === top.planName);
    if (!pk) return { planName: 'None', level: 0, dailyTasks: 0, taskReward: 0 };
    return { planName: PLANS[pk].name, level: PLANS[pk].level, dailyTasks: PLANS[pk].dailyTasks, taskReward: PLANS[pk].taskReward };
  } catch(e) { return { planName:'None', level:0, dailyTasks:0, taskReward:0 }; }
}

function calcVaultLevel(vaults) {
  const t = vaults.reduce((s,v) => s + (v.amount||0), 0);
  if (t >= 110000000) return { level:'Legendary', icon:'üèÜ' };
  if (t >= 81000000)  return { level:'Supreme',   icon:'üëë' };
  if (t >= 48600000)  return { level:'Icon',       icon:'‚≠ê' };
  if (t >= 29700000)  return { level:'Emperor',    icon:'ü¶Ö' };
  if (t >= 16650000)  return { level:'King',       icon:'üëë' };
  if (t >= 8775000)   return { level:'Titan',      icon:'üí™' };
  if (t >= 4050000)   return { level:'Mastermind', icon:'üß†' };
  if (t >= 1350000)   return { level:'Nova',       icon:'üí°' };
  if (t >= 600000)    return { level:'Rising',     icon:'üåÖ' };
  if (t >= 180000)    return { level:'Seed',       icon:'üåø' };
  if (t >= 45000)     return { level:'Beginner',   icon:'üå±' };
  return { level:'Newcomer', icon:'‚Äî' };
}

function getUserRefLevel(refs) {
  for (let i = REFERRAL_LEVELS.length - 1; i >= 0; i--)
    if (refs >= REFERRAL_LEVELS[i].min) return REFERRAL_LEVELS[i];
  return REFERRAL_LEVELS[0];
}

// ===== TASK ALLOCATION DISPLAY =====
async function displayTaskAlloc() {
  try {
    const vi = await getUserVaultLevel(currentUser.id);
    const today = new Date().toDateString();
    const [yt, et] = await Promise.all([
      db.collection('taskSubmissions').where('userId','==',currentUser.id).where('date','==',today).get(),
      db.collection('externalTaskSubmissions').where('userId','==',currentUser.id).where('date','==',today).get(),
    ]);
    const done = yt.size + et.size;
    const el = document.getElementById('taskAllocContent');
    if (!el) return;
    if (vi.dailyTasks === 0) {
      el.innerHTML = `<div style="color:var(--text-muted);font-size:0.85rem">No active vault plan. <a href="#" onclick="showSection('vault')" style="color:var(--gold)">Purchase a plan ‚Üí</a></div>`;
    } else {
      const pct = Math.min(100, (done / vi.dailyTasks) * 100);
      el.innerHTML = `<div style="font-size:0.875rem;color:var(--text)"><span style="color:var(--gold);font-weight:700">${vi.planName}</span> plan ¬∑ ${done}/${vi.dailyTasks} tasks ¬∑ ${vi.taskReward.toLocaleString()} UGX each</div><div class="progress-bar-wrap" style="margin-top:10px"><div class="progress-bar-fill" style="width:${pct}%"></div></div>${done >= vi.dailyTasks ? '<div style="font-size:0.78rem;color:var(--green);margin-top:8px">‚úÖ All tasks complete for today!</div>' : `<div style="font-size:0.78rem;color:var(--text-muted);margin-top:8px">${vi.dailyTasks - done} task${vi.dailyTasks-done>1?'s':''} remaining</div>`}`;
    }
  } catch(e) { console.error('TaskAlloc:', e); }
}

// ===== VAULT SECTION =====
async function updateVaultSection() {
  const vi = await getUserVaultLevel(currentUser.id);
  const el = document.getElementById('plansList');
  if (!el) return;
  el.innerHTML = Object.entries(PLANS).map(([key, p]) => {
    const isOwned = vi.planName === p.name;
    const isLower = vi.level > 0 && p.level < vi.level;
    const monthEarn = p.dailyTasks * p.taskReward * 30;
    let badge = '';
    if (isOwned) badge = `<span class="badge badge-success">‚úì Owned</span>`;
    else if (p.level === 2) badge = `<span class="badge badge-blue">Popular</span>`;
    else if (p.level === 11) badge = `<span class="badge" style="background:rgba(201,168,76,0.15);color:var(--gold);border:1px solid var(--border)">Ultimate</span>`;
    return `<div class="plan-card ${isOwned?'owned':''} ${isLower?'':''}` + (isLower ? ` style="opacity:0.5;pointer-events:none"` : ` onclick="selectPlan('${key}')"`) + `>
      <div class="plan-header">
        <div>
          <div class="plan-name">${p.emoji} ${p.name}</div>
          <div class="plan-amount">${p.amount.toLocaleString()} UGX</div>
        </div>
        ${badge}
      </div>
      <div class="plan-stats">
        <div class="plan-stat"><div class="plan-stat-val">${p.dailyTasks}/day</div><div class="plan-stat-label">Tasks</div></div>
        <div class="plan-stat"><div class="plan-stat-val">${p.taskReward.toLocaleString()}</div><div class="plan-stat-label">UGX/Task</div></div>
        <div class="plan-stat"><div class="plan-stat-val">${monthEarn.toLocaleString()}</div><div class="plan-stat-label">Monthly Max</div></div>
        <div class="plan-stat"><div class="plan-stat-val">30 days</div><div class="plan-stat-label">Duration</div></div>
      </div>
    </div>`;
  }).join('');
}

async function selectPlan(key) {
  if (isPurchasing) return;
  const p = PLANS[key];
  const vi = await getUserVaultLevel(currentUser.id);
  if (vi.planName === p.name) { toast('You already own this plan', 'üí°', 'warning'); return; }
  if (vi.level > p.level) { toast('You already have a higher plan', 'üí°', 'warning'); return; }
  selectedPlan = key;
  const monthEarn = p.dailyTasks * p.taskReward * 30;
  document.querySelectorAll('.plan-card').forEach(c => c.classList.remove('selected'));
  event.currentTarget.classList.add('selected');
  const det = document.getElementById('selectedPlanDetails');
  det.classList.remove('hidden');
  document.getElementById('purchaseSummaryContent').innerHTML = `
    <div style="font-family:'Playfair Display',serif;font-size:1.1rem;font-weight:700;margin-bottom:14px">${p.emoji} ${p.name} Plan</div>
    <div class="summary-row"><span class="label">Investment</span><span class="value">${p.amount.toLocaleString()} UGX</span></div>
    <div class="summary-row"><span class="label">Duration</span><span class="value">${p.days} days</span></div>
    <div class="summary-row"><span class="label">Daily Tasks</span><span class="value">${p.dailyTasks} tasks</span></div>
    <div class="summary-row"><span class="label">Per Task</span><span class="value">${p.taskReward.toLocaleString()} UGX</span></div>
    <div class="summary-row"><span class="label">Daily Max</span><span class="value">${(p.dailyTasks*p.taskReward).toLocaleString()} UGX</span></div>
    <div class="summary-row"><span class="label">Monthly Max</span><span class="value highlight">+${monthEarn.toLocaleString()} UGX</span></div>
  `;
  det.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

async function purchaseVault() {
  if (!selectedPlan || isPurchasing) return;
  const p = PLANS[selectedPlan];
  try {
    const vi = await getUserVaultLevel(currentUser.id);
    if (vi.planName === p.name) { toast('Already owned', 'üí°', 'warning'); return; }
    if (vi.level > p.level) { toast('You have a higher plan', 'üí°', 'warning'); return; }
  } catch(e) {}
  showPaymentModal(p.amount, p.name);
}

async function showPaymentModal(amount, planName) {
  const modal = document.getElementById('paymentModal');
  document.getElementById('paymentModalDesc').textContent = `Choose how to pay ${amount.toLocaleString()} UGX`;
  const optEl = document.getElementById('paymentModalOptions');
  const bal = currentUser.balance || 0;
  const ok = bal >= amount;
  optEl.innerHTML = `
    <div class="pay-option ${ok?'':'disabled'}" ${ok?`onclick="closePaymentModal();processVaultWithWallet(${amount},'${planName}')"`:''}>
      <span class="pay-icon">üí∞</span>
      <div class="pay-info">
        <div class="pay-title">Wallet Balance</div>
        <div class="pay-subtitle">Available: ${bal.toLocaleString()} UGX ${!ok?'¬∑ Insufficient':''}</div>
      </div>
      <span class="pay-check" style="color:${ok?'var(--green)':'var(--red)'}">${ok?'‚úì':'‚úó'}</span>
    </div>
    <div class="pay-option" onclick="closePaymentModal();showSection('wallet')">
      <span class="pay-icon">üì±</span>
      <div class="pay-info">
        <div class="pay-title">Mobile Money Deposit</div>
        <div class="pay-subtitle">Deposit funds then purchase</div>
      </div>
      <span class="pay-check" style="color:var(--text-muted)">‚Üí</span>
    </div>
  `;
  modal.classList.remove('hidden');
  modal.onclick = e => { if (e.target === modal) closePaymentModal(); };
}
function closePaymentModal() { document.getElementById('paymentModal').classList.add('hidden'); }

async function processVaultWithWallet(amount, planName) {
  await showCategorySelectModal(amount, (cat, catName) => doVaultPurchase(cat, catName));
}

async function showCategorySelectModal(amount, callback) {
  const b = await getCategoryBalances(currentUser.id);
  const cats = [
    { key:'depositEarnings', label:'üí∞ Deposits',  bal: b.depositEarnings },
    { key:'referralEarnings',label:'üë• Referral',  bal: b.referralEarnings },
    { key:'taskEarnings',    label:'‚úÖ Task',       bal: b.taskEarnings },
    { key:'vaultEarnings',   label:'üè¶ Vault',      bal: b.vaultEarnings },
  ];
  const modal = document.getElementById('paymentModal');
  document.getElementById('paymentModalDesc').textContent = `Select earnings source for ${amount.toLocaleString()} UGX:`;
  document.getElementById('paymentModalOptions').innerHTML = cats.map(c => {
    const ok = c.bal >= amount;
    return `<div class="pay-option ${ok?'':'disabled'}" ${ok?`onclick="closePaymentModal();(${JSON.stringify(callback)})(${JSON.stringify(c.key)},${JSON.stringify(c.label)})"`:''} ${ok?'':'style="pointer-events:none"'}>
      <div class="pay-info"><div class="pay-title">${c.label}</div><div class="pay-subtitle">Available: ${c.bal.toLocaleString()} UGX</div></div>
      <span style="color:${ok?'var(--green)':'var(--red)'}">${ok?'‚úì':'‚úó'}</span>
    </div>`;
  }).join('');
  modal.classList.remove('hidden');
  // store callback globally since we can't serialize it
  window._vaultPurchaseCallback = callback;
  document.getElementById('paymentModalOptions').querySelectorAll('.pay-option:not(.disabled)').forEach((el, i) => {
    if (!el.hasAttribute('onclick')) return;
    // rebuild with actual callback
    const c = cats.filter(x => x.bal >= amount)[i];
    if (c) el.onclick = () => { closePaymentModal(); callback(c.key, c.label); };
  });
}

async function doVaultPurchase(sourceCategory, categoryName) {
  if (isPurchasing) return;
  isPurchasing = true;
  const btn = document.getElementById('purchaseBtn');
  const orig = btn.textContent;
  btn.disabled = true; btn.textContent = 'Processing‚Ä¶';
  try {
    const p = PLANS[selectedPlan];
    const bal = currentUser.balance || 0;
    if (bal < p.amount) { toast('Insufficient funds', '‚ùå', 'error'); return; }
    // Deduct balance
    await db.collection('users').doc(currentUser.id).update({ balance: firebase.firestore.FieldValue.increment(-p.amount) });
    currentUser.balance = (currentUser.balance || 0) - p.amount;
    // Create vault
    const start = new Date(), end = new Date(start.getTime() + p.days * 86400000);
    await db.collection('users').doc(currentUser.id).collection('vaults').add({
      planName: p.name, amount: p.amount, duration: p.days,
      startDate: start.toISOString(), maturityDate: end.toISOString(),
      status: 'active', isMatured: false,
    });
    // Transaction record
    await db.collection('transactions').add({
      userId: currentUser.id, userName: currentUser.fullName,
      type: 'vault_purchase', amount: p.amount,
      sourceCategory, categoryName, planName: p.name,
      date: new Date().toISOString(),
    });
    // 10% referral bonus
    if (currentUser.referredBy) {
      const bonus = Math.floor(p.amount * 0.10);
      const rd = await db.collection('users').doc(currentUser.referredBy).get();
      if (rd.exists) {
        await db.collection('users').doc(currentUser.referredBy).update({ balance: firebase.firestore.FieldValue.increment(bonus) });
        await db.collection('transactions').add({
          userId: currentUser.referredBy, userName: rd.data().fullName,
          type: 'referral', amount: bonus,
          description: `10% vault bonus from ${currentUser.fullName} ‚Äî ${p.name}`,
          date: new Date().toISOString(),
        });
        await sendNotification(currentUser.referredBy, 'referral_bonus', `You earned ${bonus.toLocaleString()} UGX referral bonus!`);
      }
    }
    btn.textContent = '‚úÖ Success!';
    toast(`${p.emoji} ${p.name} vault activated! ${p.dailyTasks} tasks/day at ${p.taskReward.toLocaleString()} UGX each.`, 'üéâ', 'success', 6000);
    clearStatsCache();
    setTimeout(() => {
      document.getElementById('selectedPlanDetails').classList.add('hidden');
      selectedPlan = null;
      document.querySelectorAll('.plan-card').forEach(c => c.classList.remove('selected'));
      updateUserStats(true);
      updateVaultSection();
      showSection('home');
      isPurchasing = false;
      btn.disabled = false; btn.textContent = orig;
    }, 2000);
  } catch(e) {
    toast('Purchase failed: ' + e.message, '‚ùå', 'error');
    isPurchasing = false;
    btn.disabled = false; btn.textContent = orig;
  }
}

// ===== REFERRALS =====
async function updateReferralsSection() {
  try {
    const snap = await db.collection('users').doc(currentUser.id).collection('referrals').get();
    const refs = snap.docs.map(d => d.data());
    const total = refs.reduce((s,r) => s + (r.earnings||0), 0);
    const el = document.getElementById('totalReferralEarnings');
    if (el) el.textContent = total.toLocaleString();
    // Level
    const lvl = getUserRefLevel(refs.length);
    const ni = REFERRAL_LEVELS.findIndex(l => l.title === lvl.title) + 1;
    const next = ni < REFERRAL_LEVELS.length ? REFERRAL_LEVELS[ni] : null;
    const lc = document.getElementById('referralLevelCard');
    if (lc) {
      let progress = '';
      if (next) {
        const pct = Math.min(100, ((refs.length - lvl.min) / (next.min - lvl.min)) * 100);
        progress = `<div style="margin-top:10px"><div style="font-size:0.75rem;color:var(--text-muted);margin-bottom:6px">Progress to ${next.icon} ${next.title}: ${refs.length}/${next.min}</div><div class="progress-bar-wrap"><div class="progress-bar-fill" style="width:${pct}%"></div></div></div>`;
      }
      lc.innerHTML = `<div style="display:flex;align-items:center;gap:12px;margin-bottom:10px"><div style="font-size:2rem">${lvl.icon}</div><div><div style="font-weight:700;font-size:1rem">${lvl.title}</div><div style="font-size:0.8rem;color:var(--text-muted)">${refs.length} referral${refs.length!==1?'s':''}</div></div></div>${progress}`;
    }
    const rl = document.getElementById('referralsList');
    if (!rl) return;
    if (!refs.length) { rl.innerHTML = `<div style="text-align:center;color:var(--text-muted);padding:16px">No referrals yet ‚Äî share your link!</div>`; return; }
    rl.innerHTML = refs.map(r => `<div class="info-row"><div><div style="font-weight:600">${r.name}</div><div style="font-size:0.75rem;color:var(--text-muted)">${new Date(r.date).toLocaleDateString()}</div></div><span style="color:var(--green);font-weight:700;font-family:'JetBrains Mono',monospace">+${(r.earnings||0).toLocaleString()}</span></div>`).join('');
  } catch(e) { console.error('Referrals:', e); }
}

// ===== TASKS =====
async function updateTasksSection() {
  try {
    const vi = await getUserVaultLevel(currentUser.id);
    const today = new Date().toDateString();
    const [yt, et] = await Promise.all([
      db.collection('taskSubmissions').where('userId','==',currentUser.id).where('date','==',today).get(),
      db.collection('externalTaskSubmissions').where('userId','==',currentUser.id).where('date','==',today).get(),
    ]);
    const done = yt.size + et.size, limit = vi.dailyTasks;
    const ptt = document.getElementById('taskProgressText');
    const ptb = document.getElementById('taskProgressBar');
    if (ptt) ptt.textContent = `${done} / ${limit}`;
    if (ptb) ptb.style.width = limit > 0 ? `${Math.min(100,(done/limit)*100)}%` : '0%';

    if (limit === 0) {
      document.getElementById('tasksList').innerHTML = `<div class="card" style="text-align:center;padding:32px"><div style="font-size:2.5rem;margin-bottom:12px">üè¶</div><div style="font-weight:700;margin-bottom:8px">No Active Plan</div><div style="color:var(--text-muted);font-size:0.875rem;margin-bottom:16px">Purchase a vault plan to unlock daily tasks</div><button class="btn btn-gold btn-full" onclick="showSection('vault')">View Plans</button></div>`;
      return;
    }

    const [ytasks, etasks] = await Promise.all([
      db.collection('tasks').where('isActive','==',true).get(),
      db.collection('externalTasks').where('isActive','==',true).get(),
    ]);
    const doneYt = yt.docs.map(d => d.data().taskId);
    const doneEt = et.docs.map(d => d.data().taskId);
    let html = '';

    ytasks.docs.forEach(doc => {
      const t = doc.data(), comp = doneYt.includes(doc.id), can = done < limit && !comp;
      html += `<div class="task-card ${comp?'completed':''}">
        <div class="task-header">
          <div class="task-title">üì∫ ${t.title || 'YouTube Task'}</div>
          <div class="task-reward">+${(t.reward||vi.taskReward).toLocaleString()}</div>
        </div>
        <div class="task-desc">${t.description || 'Watch and engage with this video'}</div>
        ${comp ? `<span class="badge badge-success">‚úÖ Completed</span>` : can ? `<a href="${t.url}" target="_blank" onclick="markTaskDone('${doc.id}','youtube',${t.reward||vi.taskReward})" class="btn btn-gold btn-full" style="text-decoration:none">‚ñ∂ Watch & Complete</a>` : `<span style="color:var(--text-dim);font-size:0.8rem">Daily limit reached</span>`}
      </div>`;
    });
    etasks.docs.forEach(doc => {
      const t = doc.data(), comp = doneEt.includes(doc.id), can = done < limit && !comp;
      html += `<div class="task-card ${comp?'completed':''}">
        <div class="task-header">
          <div class="task-title">üîó ${t.title || 'External Task'}</div>
          <div class="task-reward">+${(t.reward||vi.taskReward).toLocaleString()}</div>
        </div>
        <div class="task-desc">${t.description || 'Visit this page'}</div>
        ${comp ? `<span class="badge badge-success">‚úÖ Completed</span>` : can ? `<a href="${t.url}" target="_blank" onclick="markTaskDone('${doc.id}','external',${t.reward||vi.taskReward})" class="btn btn-green btn-full" style="text-decoration:none">Visit & Complete</a>` : `<span style="color:var(--text-dim);font-size:0.8rem">Daily limit reached</span>`}
      </div>`;
    });
    if (!html) html = `<div class="card" style="text-align:center;color:var(--text-muted);padding:32px">No tasks available right now. Check back later!</div>`;
    document.getElementById('tasksList').innerHTML = html;
  } catch(e) {
    console.error('Tasks:', e);
    document.getElementById('tasksList').innerHTML = `<div class="card" style="text-align:center;color:var(--red)">Failed to load tasks</div>`;
  }
}

async function markTaskDone(taskId, type, reward) {
  try {
    const today = new Date().toDateString();
    const col = type === 'youtube' ? 'taskSubmissions' : 'externalTaskSubmissions';
    await db.collection(col).add({ userId: currentUser.id, userName: currentUser.fullName, taskId, date: today, reward, completedAt: new Date().toISOString(), type });
    await db.collection('users').doc(currentUser.id).update({ balance: firebase.firestore.FieldValue.increment(reward) });
    currentUser.balance = (currentUser.balance || 0) + reward;
    await db.collection('transactions').add({ userId: currentUser.id, userName: currentUser.fullName, type: 'task_completion', amount: reward, date: new Date().toISOString() });
    clearStatsCache();
    toast(`+${reward.toLocaleString()} UGX earned!`, '‚úÖ', 'success');
    setTimeout(() => updateTasksSection(), 600);
  } catch(e) { toast('Failed to complete task', '‚ùå', 'error'); }
}

// ===== WALLET =====
async function updateWalletSection() {
  try {
    const ud = await db.collection('users').doc(currentUser.id).get();
    const u = ud.data();
    const set = (id,v) => { const e=document.getElementById(id); if(e) e.textContent=v; };
    set('walletBalance', (u.balance||0).toLocaleString());
    set('walletPointsBalance', (u.pointsBalance||0).toLocaleString());
  } catch(e) {}
}

function showWalletTab(t) {
  ['deposit','withdraw','history'].forEach(p => {
    document.getElementById(p+'Panel').classList.add('hidden');
    document.getElementById(p+'Tab').classList.remove('active');
  });
  document.getElementById(t+'Panel').classList.remove('hidden');
  document.getElementById(t+'Tab').classList.add('active');
  if (t === 'history') loadTxHistory();
}

async function submitDeposit() {
  const amt = parseInt(document.getElementById('depositAmount').value);
  const meth = document.getElementById('depositMethod').value;
  const phone = document.getElementById('depositPhone').value.trim();
  if (!amt || amt < 1000) { showAlert('depositAlert','Minimum deposit is 1,000 UGX','error'); return; }
  if (!meth) { showAlert('depositAlert','Please select a payment method','error'); return; }
  if (!phone) { showAlert('depositAlert','Please enter your phone number','error'); return; }
  try {
    await db.collection('depositRequests').add({ userId: currentUser.id, userName: currentUser.fullName, userEmail: currentUser.email, amount: amt, method: meth, phone, status: 'pending', date: new Date().toISOString() });
    showAlert('depositAlert','Request submitted! Admin will approve within 1 hour.','success');
    document.getElementById('depositAmount').value = '';
    document.getElementById('depositPhone').value = '';
  } catch(e) { showAlert('depositAlert','Failed: '+e.message,'error'); }
}

async function submitWithdrawal() {
  const cat = document.getElementById('withdrawCategory').value;
  const amt = parseInt(document.getElementById('withdrawAmount').value);
  const phone = document.getElementById('withdrawPhone').value.trim();
  if (!cat) { showAlert('withdrawAlert','Please select a category','error'); return; }
  if (!amt || amt < 5000) { showAlert('withdrawAlert','Minimum withdrawal is 5,000 UGX','error'); return; }
  if (!phone) { showAlert('withdrawAlert','Please enter your phone number','error'); return; }
  if (cat === 'task') {
    const d = new Date().getDay();
    if (d !== 5 && d !== 6) { showAlert('withdrawAlert','Task earnings can only be withdrawn on Friday and Saturday','error'); return; }
  }
  const b = await getCategoryBalances(currentUser.id);
  const bk = cat === 'referral' ? 'referralEarnings' : cat === 'task' ? 'taskEarnings' : 'vaultEarnings';
  if (b[bk] < amt) { showAlert('withdrawAlert',`Insufficient ${cat} earnings (available: ${(b[bk]||0).toLocaleString()} UGX)`,'error'); return; }
  const fee = Math.floor(amt * 0.05), net = amt - fee;
  try {
    await db.collection('withdrawalRequests').add({ userId: currentUser.id, userName: currentUser.fullName, amount: amt, netAmount: net, adminFee: fee, phone, category: cat, status: 'pending', date: new Date().toISOString() });
    showAlert('withdrawAlert',`Withdrawal of ${net.toLocaleString()} UGX submitted (5% fee: ${fee.toLocaleString()} UGX).`,'success');
    document.getElementById('withdrawAmount').value = '';
  } catch(e) { showAlert('withdrawAlert','Failed: '+e.message,'error'); }
}

async function loadTxHistory() {
  try {
    const snap = await db.collection('transactions').where('userId','==',currentUser.id).orderBy('date','desc').limit(20).get();
    const tb = document.getElementById('walletTxHistory');
    if (!tb) return;
    if (snap.empty) { tb.innerHTML = `<tr><td colspan="4" style="text-align:center;color:var(--text-muted)">No transactions yet</td></tr>`; return; }
    const types = { deposit:'üí∞ Deposit', withdrawal:'üí∏ Withdrawal', referral:'üë• Referral', task_completion:'‚úÖ Task', vault_purchase:'üè¶ Vault Buy', vault_maturity:'üè¶ Matured', points_conversion:'üîÑ Points', withdrawal_approved:'üí∏ Withdrawal' };
    const out = ['withdrawal','vault_purchase','withdrawal_approved'];
    tb.innerHTML = snap.docs.map(d => {
      const t = d.data(), a = t.netAmount || t.amount || 0, isOut = out.includes(t.type);
      return `<tr><td>${new Date(t.date).toLocaleDateString()}</td><td>${types[t.type]||t.type}</td><td style="color:${isOut?'var(--red)':'var(--green)'};font-weight:600;font-family:'JetBrains Mono',monospace">${isOut?'-':'+'} ${Math.abs(a).toLocaleString()}</td><td><span class="badge badge-success">Done</span></td></tr>`;
    }).join('');
  } catch(e) {}
}

// ===== STREAK SECTION =====
async function updateStreakSection() {
  try {
    const ud = await db.collection('users').doc(currentUser.id).get();
    const u = ud.data();
    const s = u.currentStreak || 0, lng = u.longestStreak || 0, pts = u.pointsBalance || 0;
    const set = (id,v) => { const e=document.getElementById(id); if(e) e.textContent=v; };
    set('currentStreak', s);
    set('streakPoints', pts);
    set('longestStreakDisplay', lng);
    const de = document.getElementById('streakDays');
    if (de) {
      let h = '';
      for (let i = 0; i < 7; i++) {
        const a = i < Math.min(s, 7), isToday = i === Math.min(s-1, 6) && s > 0;
        h += `<div class="streak-dot ${isToday?'today':a?'done':''}">${i+1}</div>`;
      }
      de.innerHTML = h;
    }
  } catch(e) {}
}

async function convertPoints() {
  const pts = parseInt(document.getElementById('pointsToConvert').value);
  if (!pts || pts < 100) { showAlert('streakAlert','Minimum 100 points','error'); return; }
  const ud = await db.collection('users').doc(currentUser.id).get();
  const cur = ud.data().pointsBalance || 0;
  if (cur < pts) { showAlert('streakAlert',`Insufficient points (you have ${cur})`,'error'); return; }
  const ugx = pts * 10;
  await db.collection('users').doc(currentUser.id).update({ pointsBalance: firebase.firestore.FieldValue.increment(-pts), balance: firebase.firestore.FieldValue.increment(ugx) });
  await db.collection('transactions').add({ userId: currentUser.id, type: 'points_conversion', amount: ugx, description: `${pts} points converted`, date: new Date().toISOString() });
  currentUser.pointsBalance = cur - pts;
  currentUser.balance = (currentUser.balance || 0) + ugx;
  clearStatsCache();
  toast(`${pts} points ‚Üí ${ugx.toLocaleString()} UGX`, 'üîÑ', 'success');
  updateStreakSection();
}

// ===== PROFILE =====
async function updateProfileSection() {
  const set = (id,v) => { const e=document.getElementById(id); if(e) e.textContent=v; };
  const u = currentUser;
  // Avatar
  const init = document.getElementById('profileInitials');
  const img = document.getElementById('profileImage');
  if (u.profilePicture) { img.src = u.profilePicture; img.style.display = 'block'; if(init) init.style.display = 'none'; }
  else { if(init) { init.textContent = (u.fullName||'U').split(' ').map(n=>n[0]).join('').toUpperCase().substring(0,2); init.style.display = ''; } img.style.display = 'none'; }
  set('profileName', u.fullName || '‚Äî');
  set('profileEmail', u.email || '‚Äî');
  set('profileFullNameVal', u.fullName || '‚Äî');
  set('profileEmailVal', u.email || '‚Äî');
  set('profileJoinedVal', u.joinedDate ? new Date(u.joinedDate).toLocaleDateString() : '‚Äî');
  const sv = document.getElementById('profileStatusVal');
  if (sv) { sv.textContent = u.isActivated ? 'Active' : 'Pending'; sv.style.color = u.isActivated ? 'var(--green)' : 'var(--red)'; }
  set('profileReferralCode', u.referralCode || '‚Äî');
  set('profileStreak', u.currentStreak || 0);
  set('profilePoints', u.pointsBalance || 0);
  const lvl = getUserRefLevel(u.totalReferrals || 0);
  const lb = document.getElementById('profileLevelBadge');
  if (lb) lb.innerHTML = `<span class="badge" style="background:rgba(201,168,76,0.15);border:1px solid var(--border);color:var(--gold);font-size:0.8rem;padding:6px 14px">${lvl.icon} ${lvl.title}</span>`;
  try {
    const vs = await db.collection('users').doc(currentUser.id).collection('vaults').get();
    set('profileActiveVaults', vs.size);
    const active = vs.docs.map(d=>d.data()).filter(v=>v.status==='active');
    set('profileAccountLevel', calcVaultLevel(active).level);
  } catch(e) {}
}

async function refreshUser() {
  if (!currentUser?.id) return;
  try { const d = await db.collection('users').doc(currentUser.id).get(); if(d.exists) currentUser = { id: currentUser.id, ...d.data() }; } catch(e) {}
}

function toggleNameEdit() {
  const c = document.getElementById('nameEditContainer');
  c.classList.toggle('hidden');
  if (!c.classList.contains('hidden')) document.getElementById('nameEditInput').value = currentUser.fullName || '';
}
function cancelNameEdit() { document.getElementById('nameEditContainer').classList.add('hidden'); }
async function saveNameEdit() {
  const n = document.getElementById('nameEditInput').value.trim();
  if (!n || n.length < 2) { showAlert('profileAlert','Name too short','error'); return; }
  await db.collection('users').doc(currentUser.id).update({ fullName: n });
  currentUser.fullName = n;
  document.getElementById('profileName').textContent = n;
  document.getElementById('profileFullNameVal').textContent = n;
  cancelNameEdit();
  toast('Name updated', '‚úÖ', 'success');
}

async function uploadProfilePicture(ev) {
  const f = ev.target.files[0];
  if (!f) return;
  if (f.size > 5*1024*1024) { toast('Max file size is 5MB','‚ùå','error'); return; }
  const reader = new FileReader();
  reader.onload = async e => {
    try {
      const b64 = e.target.result;
      await db.collection('users').doc(currentUser.id).update({ profilePicture: b64 });
      currentUser.profilePicture = b64;
      document.getElementById('profileImage').src = b64;
      document.getElementById('profileImage').style.display = 'block';
      document.getElementById('profileInitials').style.display = 'none';
      toast('Profile picture updated', 'üì∑', 'success');
    } catch(err) { toast('Upload failed','‚ùå','error'); }
  };
  reader.readAsDataURL(f);
}

function copyReferralCode() { navigator.clipboard.writeText(currentUser.referralCode || '').then(() => toast('Code copied!','üìã','success')); }
function copyReferralLink() {
  const el = document.getElementById('userReferralLink');
  if (el) navigator.clipboard.writeText(el.textContent).then(() => toast('Link copied!','üìã','success'));
}
function shareReferralLink() {
  const link = document.getElementById('userReferralLink')?.textContent;
  if (navigator.share && link) navigator.share({ title:'Join VaultPro', text:"Uganda's #1 investment platform", url: link });
  else copyReferralLink();
}

// ===== LEADERBOARD =====
async function updateLeaderboard() {
  try {
    const now = new Date(), dow = now.getDay();
    const d2m = dow === 0 ? 6 : dow - 1;
    const ws = new Date(now); ws.setDate(now.getDate() - d2m); ws.setHours(0,0,0,0);
    const snap = await db.collection('users').where('isAdmin','==',false).get();
    const data = await Promise.all(snap.docs.map(async d => {
      const u = d.data();
      const rs = await db.collection('users').doc(d.id).collection('referrals').get();
      let wk = 0;
      rs.docs.forEach(r => { if(new Date(r.data().date) >= ws) wk++; });
      return { n: u.fullName, wk, tot: rs.size };
    }));
    data.sort((a,b) => b.wk - a.wk);
    const top = data.slice(0,5);
    const el = document.getElementById('leaderboardList');
    if (!el) return;
    if (!top.length || top[0].wk === 0) { el.innerHTML = `<div style="text-align:center;color:var(--text-muted);padding:16px">No referrals this week yet. Be the first!</div>`; return; }
    const medals = ['ü•á','ü•à','ü•â'];
    el.innerHTML = top.map((u,i) => `<div class="lb-item"><div class="lb-rank ${i<3?'top':''}">${i<3?medals[i]:i+1}</div><div class="lb-info"><div class="lb-name">${u.n}</div><div class="lb-total">Total: ${u.tot}</div></div><div class="lb-count">${u.wk}</div></div>`).join('');
    updateWeekTimer();
  } catch(e) { console.error('Leaderboard:', e); }
}

function startWeeklyTimer() { updateWeekTimer(); }
function updateWeekTimer() {
  const now = new Date(), d = now.getDay();
  const su = d === 0 ? 7 : 7 - d;
  const nxt = new Date(now); nxt.setDate(now.getDate() + su); nxt.setHours(23,59,59,999);
  const rem = nxt - now;
  const days = Math.floor(rem/86400000), hrs = Math.floor((rem%86400000)/3600000), mins = Math.floor((rem%3600000)/60000);
  const el = document.getElementById('timeUntilReset');
  if (el) el.textContent = `${days}d ${hrs}h ${mins}m`;
}

async function awardWeeklyWinner() {
  try {
    const now = new Date(), d = now.getDay(), d2m = d===0?6:d-1;
    const ws = new Date(now); ws.setDate(now.getDate()-d2m); ws.setHours(0,0,0,0);
    const snap = await db.collection('users').where('isAdmin','==',false).get();
    let top = null, max = 0;
    for (const doc of snap.docs) {
      const rs = await db.collection('users').doc(doc.id).collection('referrals').get();
      const wk = rs.docs.filter(r => new Date(r.data().date) >= ws).length;
      if (wk > max) { max = wk; top = { userId: doc.id, userData: doc.data(), wk }; }
    }
    if (top && top.wk >= 8) {
      const prize = 50000;
      await db.collection('users').doc(top.userId).update({ balance: firebase.firestore.FieldValue.increment(prize) });
      await db.collection('transactions').add({ userId: top.userId, type:'referral', amount: prize, description:'Weekly Top Referrer Prize', date: new Date().toISOString() });
      await sendNotification(top.userId, 'referral_bonus', `üèÜ You won the weekly referral prize: 50,000 UGX!`);
      return top;
    }
    return null;
  } catch(e) { console.error('Award:', e); return null; }
}

// ===== NOTIFICATIONS =====
const NTYPES = {
  activation_approved: { icon:'üéâ', title:'Account Activated!' },
  withdrawal_approved: { icon:'üí∞', title:'Withdrawal Approved!' },
  withdrawal_rejected: { icon:'‚ùå', title:'Withdrawal Rejected' },
  referral_bonus:      { icon:'üë•', title:'Referral Bonus!' },
  vault_matured:       { icon:'üè¶', title:'Vault Matured!' },
};

async function sendNotification(uid, type, msg = null) {
  try {
    const n = NTYPES[type]; if (!n) return;
    await db.collection('notifications').add({ userId: uid, type, title: n.title, message: msg || n.title, icon: n.icon, read: false, timestamp: new Date(), createdAt: new Date().toISOString() });
  } catch(e) {}
}

async function initNotifications() {
  if (!currentUser) return;
  updateNotifBadge();
  db.collection('notifications').where('userId','==',currentUser.id).where('read','==',false).orderBy('timestamp','desc').onSnapshot(snap => {
    updateNotifBadge(snap.size);
    snap.docChanges().forEach(c => {
      if (c.type === 'added') {
        const n = c.doc.data();
        toast(n.message || n.title, n.icon || 'üîî', 'info');
      }
    });
  });
}

function updateNotifBadge(count) {
  const b = document.getElementById('notifBadge');
  if (!b) return;
  if (count > 0) { b.textContent = count > 99 ? '99+' : count; b.classList.remove('hidden'); }
  else b.classList.add('hidden');
}

function openNotifCenter() {
  document.getElementById('notifCenter').classList.remove('hidden');
  loadNotifications();
}
function closeNotifCenter() { document.getElementById('notifCenter').classList.add('hidden'); }

async function loadNotifications() {
  if (!currentUser) return;
  try {
    const snap = await db.collection('notifications').where('userId','==',currentUser.id).orderBy('timestamp','desc').limit(30).get();
    const el = document.getElementById('notifList');
    if (!el) return;
    if (snap.empty) { el.innerHTML = `<div style="padding:32px;text-align:center;color:var(--text-muted)">No notifications</div>`; return; }
    el.innerHTML = snap.docs.map(doc => {
      const n = { id:doc.id, ...doc.data() };
      const t = n.timestamp?.toDate ? n.timestamp.toDate() : new Date(n.createdAt || Date.now());
      const m = Math.floor((Date.now()-t)/60000);
      const time = m<1?'Just now':m<60?`${m}m ago`:m<1440?`${Math.floor(m/60)}h ago`:`${Math.floor(m/1440)}d ago`;
      return `<div class="notif-item ${n.read?'':'unread'}" onclick="db.collection('notifications').doc('${n.id}').update({read:true});this.classList.remove('unread')">
        <div style="display:flex;gap:12px;align-items:flex-start">
          <span style="font-size:1.2rem">${n.icon||'üîî'}</span>
          <div><div class="notif-item-title">${n.title}</div><div class="notif-item-msg">${n.message||''}</div><div class="notif-item-time">${time}</div></div>
        </div>
      </div>`;
    }).join('');
  } catch(e) {}
}

// ===== ADMIN =====
async function updateAdminStats() {
  try {
    const [us, ts, pw] = await Promise.all([
      db.collection('users').where('isAdmin','==',false).get(),
      db.collection('transactions').get(),
      db.collection('withdrawalRequests').where('status','==','pending').get(),
    ]);
    const users = us.docs.map(d => d.data());
    const tb = users.reduce((s,u) => s+(u.balance||0), 0);
    const act = users.filter(u => u.isActivated).length;
    const dep = ts.docs.filter(d => d.data().type==='deposit').reduce((s,d) => s+(d.data().amount||0), 0);
    const wd = ts.docs.filter(d => ['withdrawal','withdrawal_approved'].includes(d.data().type)).reduce((s,d) => s+(d.data().amount||0), 0);
    const set = (id,v) => { const e=document.getElementById(id); if(e) e.textContent=v; };
    set('adminTotalUsers', users.length);
    set('adminTotalBalance', tb.toLocaleString());
    set('adminTotalDeposits', dep.toLocaleString());
    set('adminTotalWithdrawals', wd.toLocaleString());
    set('adminActivatedUsers', act);
    set('adminPendingWithdrawals', pw.size);
  } catch(e) {}
}

async function updateAdminUsers() {
  try {
    const snap = await db.collection('users').where('isAdmin','==',false).get();
    const el = document.getElementById('adminUsersList');
    if (!el) return;
    if (snap.empty) { el.innerHTML = `<p style="color:var(--text-muted)">No users yet</p>`; return; }
    el.innerHTML = `<div style="overflow-x:auto"><table><thead><tr><th>Name</th><th>Email</th><th>Balance</th><th>Status</th><th>Joined</th></tr></thead><tbody>${snap.docs.map(d=>{const u=d.data();return`<tr><td>${u.fullName}</td><td>${u.email}</td><td style="font-family:'JetBrains Mono',monospace">${(u.balance||0).toLocaleString()}</td><td><span class="badge ${u.isActivated?'badge-success':'badge-warning'}">${u.isActivated?'Active':'Pending'}</span></td><td>${u.joinedDate?new Date(u.joinedDate).toLocaleDateString():'N/A'}</td></tr>`;}).join('')}</tbody></table></div>`;
  } catch(e) {}
}

async function updateAdminTasks() {
  try {
    const snap = await db.collection('tasks').get();
    const el = document.getElementById('adminTasksList');
    if (!el) return;
    if (snap.empty) { el.innerHTML = `<p style="color:var(--text-muted)">No tasks</p>`; return; }
    el.innerHTML = snap.docs.map(d=>{const t={id:d.id,...d.data()};return`<div style="display:flex;justify-content:space-between;align-items:center;padding:12px 0;border-bottom:1px solid var(--border-subtle)"><div><div style="font-weight:600;font-size:0.875rem">${t.title}</div><div style="font-size:0.75rem;color:var(--text-muted)">${t.url}</div></div><div style="display:flex;align-items:center;gap:8px"><span style="color:var(--green);font-size:0.8rem;font-weight:700">${(t.reward||0).toLocaleString()} UGX</span><button class="btn btn-red" style="padding:6px 12px;font-size:0.75rem" onclick="deleteTask('${d.id}')">Del</button></div></div>`;}).join('');
  } catch(e) {}
}

async function updateAdminExternalTasks() {
  try {
    const snap = await db.collection('externalTasks').get();
    const el = document.getElementById('adminExternalTasksList');
    if (!el) return;
    if (snap.empty) { el.innerHTML = `<p style="color:var(--text-muted)">No external tasks</p>`; return; }
    el.innerHTML = snap.docs.map(d=>{const t={id:d.id,...d.data()};return`<div style="display:flex;justify-content:space-between;align-items:center;padding:12px 0;border-bottom:1px solid var(--border-subtle)"><div><div style="font-weight:600;font-size:0.875rem">${t.title}</div><div style="font-size:0.75rem;color:var(--text-muted)">${t.url}</div></div><div style="display:flex;align-items:center;gap:8px"><span style="color:var(--green);font-size:0.8rem;font-weight:700">${(t.reward||0).toLocaleString()} UGX</span><button class="btn btn-red" style="padding:6px 12px;font-size:0.75rem" onclick="deleteExternalTask('${d.id}')">Del</button></div></div>`;}).join('');
  } catch(e) {}
}

async function addTask() {
  const url=document.getElementById('newTaskUrl').value.trim(), title=document.getElementById('newTaskTitle').value.trim(), desc=document.getElementById('newTaskDescription').value.trim(), reward=parseInt(document.getElementById('newTaskReward').value);
  if(!url||!title||!reward){toast('Fill all fields','‚ö†Ô∏è','warning');return;}
  await db.collection('tasks').add({url,title,description:desc,reward,isActive:true,createdAt:new Date().toISOString()});
  toast('YouTube task added','‚úÖ','success');
  ['newTaskUrl','newTaskTitle','newTaskDescription','newTaskReward'].forEach(id=>document.getElementById(id).value='');
  updateAdminTasks();
}

async function addExternalTask() {
  const url=document.getElementById('newExternalTaskUrl').value.trim(), title=document.getElementById('newExternalTaskTitle').value.trim(), desc=document.getElementById('newExternalTaskDescription').value.trim(), reward=parseInt(document.getElementById('newExternalTaskReward').value);
  if(!url||!title||!reward){toast('Fill all fields','‚ö†Ô∏è','warning');return;}
  await db.collection('externalTasks').add({url,title,description:desc,reward,isActive:true,createdAt:new Date().toISOString()});
  toast('External task added','‚úÖ','success');
  ['newExternalTaskUrl','newExternalTaskTitle','newExternalTaskDescription','newExternalTaskReward'].forEach(id=>document.getElementById(id).value='');
  updateAdminExternalTasks();
}

async function deleteTask(id){if(!confirm('Delete this task?'))return;await db.collection('tasks').doc(id).delete();updateAdminTasks();}
async function deleteExternalTask(id){if(!confirm('Delete this task?'))return;await db.collection('externalTasks').doc(id).delete();updateAdminExternalTasks();}

async function updateAdminTransactions() {
  try {
    const snap = await db.collection('transactions').orderBy('date','desc').limit(50).get();
    const tb = document.getElementById('adminTransactionsList');
    if (!tb) return;
    if (snap.empty) { tb.innerHTML=`<tr><td colspan="4" style="text-align:center;color:var(--text-muted)">No transactions</td></tr>`;return;}
    tb.innerHTML=snap.docs.map(d=>{const t=d.data();return`<tr><td>${t.userName||'‚Äî'}</td><td>${t.type}</td><td style="font-family:'JetBrains Mono',monospace">${(t.amount||0).toLocaleString()}</td><td>${new Date(t.date).toLocaleDateString()}</td></tr>`;}).join('');
  } catch(e) {}
}

async function updateAdminDeposits() {
  try {
    const snap = await db.collection('depositRequests').orderBy('date','desc').get();
    const el = document.getElementById('adminDepositsList');
    if (!el) return;
    if (snap.empty) { el.innerHTML=`<p style="text-align:center;color:var(--text-muted)">No deposit requests</p>`;return;}
    el.innerHTML=snap.docs.map(doc=>{const d={id:doc.id,...doc.data()};return`<div class="card" style="margin-bottom:10px"><div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:12px"><div><div style="font-weight:700">${d.userName}</div><div style="font-size:0.78rem;color:var(--text-muted)">${d.phone} ¬∑ ${d.method}</div><div style="font-size:0.75rem;color:var(--text-dim)">${new Date(d.date).toLocaleDateString()}</div></div><div style="text-align:right"><div style="font-family:'JetBrains Mono',monospace;font-size:1.1rem;font-weight:700;color:var(--green)">${(d.amount||0).toLocaleString()} UGX</div><span class="badge ${d.status==='approved'?'badge-success':d.status==='rejected'?'badge-error':'badge-warning'}">${d.status}</span></div></div>${d.status==='pending'?`<div style="display:flex;gap:8px"><button class="btn btn-green" style="flex:1;padding:10px;font-size:0.85rem" onclick="approveDeposit('${doc.id}','${d.userId}',${d.amount})">Approve</button><button class="btn btn-red" style="flex:1;padding:10px;font-size:0.85rem" onclick="rejectDeposit('${doc.id}')">Reject</button></div>`:''}</div>`;}).join('');
  } catch(e) {}
}

async function approveDeposit(depId, uid, amount) {
  if(!confirm(`Approve ${amount.toLocaleString()} UGX?`))return;
  try {
    await db.collection('depositRequests').doc(depId).update({status:'approved',approvedDate:new Date().toISOString()});
    await db.collection('users').doc(uid).update({balance:firebase.firestore.FieldValue.increment(amount)});
    await db.collection('transactions').add({userId:uid,type:'deposit',amount,date:new Date().toISOString()});
    await sendNotification(uid,'activation_approved',`Your deposit of ${amount.toLocaleString()} UGX has been approved!`);
    toast('Deposit approved','‚úÖ','success');
    updateAdminDeposits();updateAdminStats();
  } catch(e){toast('Error: '+e.message,'‚ùå','error');}
}
async function rejectDeposit(id){if(!confirm('Reject this deposit?'))return;await db.collection('depositRequests').doc(id).update({status:'rejected'});toast('Deposit rejected','','warning');updateAdminDeposits();}

async function updateAdminWithdrawals() {
  try {
    const snap = await db.collection('withdrawalRequests').orderBy('date','desc').get();
    const el = document.getElementById('adminWithdrawalsList');
    if (!el) return;
    if (snap.empty) { el.innerHTML=`<p style="text-align:center;color:var(--text-muted)">No withdrawal requests</p>`;return;}
    el.innerHTML=snap.docs.map(doc=>{const w={id:doc.id,...doc.data()};return`<div class="card" style="margin-bottom:10px"><div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:12px"><div><div style="font-weight:700">${w.userName}</div><div style="font-size:0.78rem;color:var(--text-muted)">${w.phone} ¬∑ ${w.category}</div><div style="font-size:0.75rem;color:var(--text-dim)">${new Date(w.date).toLocaleDateString()}</div></div><div style="text-align:right"><div style="font-family:'JetBrains Mono',monospace;font-size:1.1rem;font-weight:700;color:var(--gold)">${(w.amount||0).toLocaleString()} UGX</div><div style="font-size:0.78rem;color:var(--green)">Net: ${(w.netAmount||0).toLocaleString()}</div><span class="badge ${w.status==='approved'?'badge-success':w.status==='rejected'?'badge-error':'badge-warning'}">${w.status}</span></div></div>${w.status==='pending'?`<div style="display:flex;gap:8px"><button class="btn btn-green" style="flex:1;padding:10px;font-size:0.85rem" onclick="approveWithdrawal('${doc.id}','${w.userId}',${w.netAmount||0},${w.adminFee||0})">Approve</button><button class="btn btn-red" style="flex:1;padding:10px;font-size:0.85rem" onclick="rejectWithdrawal('${doc.id}','${w.userId}')">Reject</button></div>`:''}</div>`;}).join('');
  } catch(e) {}
}

async function approveWithdrawal(wdId, uid, net, fee) {
  if(!confirm(`Approve ${net.toLocaleString()} UGX?`))return;
  try {
    await db.collection('withdrawalRequests').doc(wdId).update({status:'approved',approvedDate:new Date().toISOString()});
    await db.collection('users').doc(uid).update({balance:firebase.firestore.FieldValue.increment(-(net+fee))});
    await db.collection('transactions').add({userId:uid,type:'withdrawal_approved',amount:net,adminFee:fee,date:new Date().toISOString()});
    await sendNotification(uid,'withdrawal_approved',`Your withdrawal of ${net.toLocaleString()} UGX has been sent!`);
    toast('Withdrawal approved','‚úÖ','success');
    updateAdminWithdrawals();updateAdminStats();
  } catch(e){toast('Error: '+e.message,'‚ùå','error');}
}
async function rejectWithdrawal(id,uid){if(!confirm('Reject?'))return;await db.collection('withdrawalRequests').doc(id).update({status:'rejected'});await sendNotification(uid,'withdrawal_rejected');toast('Rejected','','warning');updateAdminWithdrawals();}

// ===== BOOT =====
window.addEventListener('load', init);
</script>
</body>
</html>
