<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, viewport-fit=cover">
<title>VaultPro ‚Äì Investment Platform</title>

<!-- PWA Meta -->
<meta name="application-name" content="VaultPro">
<meta name="description" content="Uganda‚Äôs premier investment platform. Earn daily task rewards, grow capital with vault plans, and build your network.">
<meta name="theme-color" content="#C9A84C">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="VaultPro">
<meta name="msapplication-TileColor" content="#C9A84C">
<meta name="format-detection" content="telephone=no">
<meta property="og:title" content="VaultPro ‚Äì Investment Platform">
<meta property="og:description" content="Earn daily rewards and grow your wealth.">

<!-- PWA Icons -->
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' rx='20' fill='%230A0C10'/%3E%3Ctext y='72' x='50' text-anchor='middle' font-size='60'%3E%F0%9F%8F%A6%3C/text%3E%3C/svg%3E">

<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;800&family=DM+Sans:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">
<style>
:root{--gold:#C9A84C;--gold-light:#E8C96B;--gold-dark:#A07834;--bg:#0A0C10;--bg2:#111318;--bg3:#181C24;--surface:#1E2330;--surface2:#252B3A;--border:rgba(201,168,76,0.15);--border-s:rgba(255,255,255,0.06);--text:#F0EDE6;--muted:#7E8899;--dim:#4A5166;--green:#1DB87F;--red:#E8445A;--blue:#4A7CF7;--r:14px;--rs:8px}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body{height:100%}
body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;max-width:480px;margin:0 auto;overflow-x:hidden}
body::before{content:'';position:fixed;inset:0;background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.03'/%3E%3C/svg%3E");pointer-events:none;z-index:9998;opacity:.4}
.hidden{display:none!important}
.btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:13px 22px;border-radius:var(--rs);border:none;cursor:pointer;font-family:'DM Sans',sans-serif;font-weight:600;font-size:.88rem;transition:all .2s;position:relative;overflow:hidden}
.btn:disabled{opacity:.5;cursor:not-allowed}
.btn:active:not(:disabled){transform:scale(.97)}
.btn-gold{background:linear-gradient(135deg,var(--gold),var(--gold-dark));color:#0A0C10;font-weight:700;box-shadow:0 4px 20px rgba(201,168,76,.35)}
.btn-gold:hover:not(:disabled){box-shadow:0 6px 28px rgba(201,168,76,.5)}
.btn-outline{background:transparent;border:1px solid var(--border);color:var(--gold)}
.btn-outline:hover{background:rgba(201,168,76,.08);border-color:var(--gold)}
.btn-surface{background:var(--surface2);color:var(--text);border:1px solid var(--border-s)}
.btn-green{background:linear-gradient(135deg,var(--green),#158B5F);color:#fff}
.btn-red{background:linear-gradient(135deg,var(--red),#B02040);color:#fff}
.btn-blue{background:linear-gradient(135deg,var(--blue),#2E5FD4);color:#fff}
.btn-full{width:100%}
.card{background:var(--surface);border:1px solid var(--border-s);border-radius:var(--r);padding:20px;margin-bottom:12px}
.card-gold{background:linear-gradient(135deg,rgba(201,168,76,.1),rgba(201,168,76,.03));border:1px solid var(--border)}
.fg{margin-bottom:14px}
.fg label{display:block;font-size:.75rem;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.08em;margin-bottom:7px}
.fg input,.fg select,.fg textarea{width:100%;padding:13px 15px;background:var(--bg3);border:1px solid var(--border-s);border-radius:var(--rs);color:var(--text);font-family:'DM Sans',sans-serif;font-size:.92rem;transition:border-color .2s;appearance:none;-webkit-appearance:none}
.fg input:focus,.fg select:focus,.fg textarea:focus{outline:none;border-color:var(--gold);box-shadow:0 0 0 3px rgba(201,168,76,.1)}
.fg input::placeholder,.fg textarea::placeholder{color:var(--dim)}
.fg textarea{resize:vertical;min-height:80px}
.alert{padding:11px 15px;border-radius:var(--rs);margin-bottom:12px;font-size:.85rem;font-weight:500;display:flex;align-items:flex-start;gap:9px}
.alert-success{background:rgba(29,184,127,.12);border:1px solid rgba(29,184,127,.3);color:#4DEBA0}
.alert-error{background:rgba(232,68,90,.12);border:1px solid rgba(232,68,90,.3);color:#F07285}
.alert-warning{background:rgba(201,168,76,.12);border:1px solid rgba(201,168,76,.3);color:var(--gold-light)}
.alert-info{background:rgba(74,124,247,.12);border:1px solid rgba(74,124,247,.3);color:#7FA8FF}
.badge{display:inline-flex;align-items:center;gap:4px;padding:3px 9px;border-radius:20px;font-size:.68rem;font-weight:700;letter-spacing:.04em;text-transform:uppercase}
.badge-success{background:rgba(29,184,127,.15);color:var(--green);border:1px solid rgba(29,184,127,.3)}
.badge-error{background:rgba(232,68,90,.15);color:var(--red);border:1px solid rgba(232,68,90,.3)}
.badge-warning{background:rgba(201,168,76,.15);color:var(--gold);border:1px solid var(--border)}
.badge-blue{background:rgba(74,124,247,.15);color:#7FA8FF;border:1px solid rgba(74,124,247,.3)}
#loadingScreen{position:fixed;inset:0;background:var(--bg);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:9999}
.loader-logo{font-family:'Playfair Display',serif;font-size:2.5rem;font-weight:800;color:var(--gold);letter-spacing:-.02em;margin-bottom:6px}
.loader-tag{font-size:.75rem;color:var(--muted);letter-spacing:.15em;text-transform:uppercase;margin-bottom:48px}
.loader-ring{width:42px;height:42px;border:3px solid rgba(201,168,76,.2);border-top-color:var(--gold);border-radius:50%;animation:spin .9s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.auth-page{min-height:100vh;display:flex;flex-direction:column}
.auth-header{background:linear-gradient(180deg,rgba(201,168,76,.08) 0%,transparent 100%);padding:56px 24px 36px;text-align:center;border-bottom:1px solid var(--border-s)}
.auth-logo{font-family:'Playfair Display',serif;font-size:2rem;font-weight:800;color:var(--gold)}
.auth-sub{font-size:.82rem;color:var(--muted);margin-top:5px;letter-spacing:.05em}
.auth-body{flex:1;padding:26px 20px}
.landing-page{min-height:100vh;background:var(--bg);display:flex;flex-direction:column;align-items:center;padding:0 20px 40px}
.landing-hero{width:100%;background:linear-gradient(180deg,rgba(201,168,76,.1) 0%,transparent 100%);padding:56px 20px 36px;text-align:center;border-bottom:1px solid var(--border-s);margin-bottom:24px}
.landing-title{font-family:'Playfair Display',serif;font-size:1.9rem;font-weight:800;color:var(--text);margin-bottom:8px}
.invite-code-box{background:var(--surface);border:1px solid var(--border);border-radius:var(--r);padding:18px;text-align:center;width:100%;max-width:360px;margin:0 auto 22px;box-shadow:0 0 30px rgba(201,168,76,.15)}
.invite-code-val{font-family:'JetBrains Mono',monospace;font-size:1.7rem;font-weight:600;color:var(--gold);letter-spacing:.12em}
.dash-header{position:sticky;top:0;z-index:100;background:rgba(10,12,16,.93);backdrop-filter:blur(16px);-webkit-backdrop-filter:blur(16px);border-bottom:1px solid var(--border-s);padding:13px 18px;display:flex;align-items:center;justify-content:space-between}
.header-brand{font-family:'Playfair Display',serif;font-size:1.15rem;color:var(--gold);font-weight:700}
.header-user-name{font-weight:700;font-size:.9rem}
.header-user-sub{font-size:.72rem;color:var(--muted)}
.icon-btn{width:38px;height:38px;border-radius:50%;border:1px solid var(--border-s);background:var(--surface);color:var(--muted);font-size:1rem;cursor:pointer;display:flex;align-items:center;justify-content:center;position:relative;transition:all .2s}
.notif-dot{position:absolute;top:1px;right:1px;width:15px;height:15px;background:var(--red);border-radius:50%;font-size:9px;font-weight:700;color:#fff;display:flex;align-items:center;justify-content:center;border:2px solid var(--bg)}
.bottom-nav{position:fixed;bottom:0;left:0;right:0;max-width:480px;margin:0 auto;background:rgba(14,16,24,.97);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);border-top:1px solid var(--border-s);display:flex;z-index:100;padding-bottom:env(safe-area-inset-bottom)}
.nav-item{flex:1;display:flex;flex-direction:column;align-items:center;gap:3px;padding:9px 3px 7px;cursor:pointer;border:none;background:none;color:var(--dim);font-size:.56rem;font-weight:700;letter-spacing:.05em;text-transform:uppercase;transition:color .2s;font-family:'DM Sans',sans-serif}
.nav-icon{font-size:1.2rem;transition:transform .2s}
.nav-item.active{color:var(--gold)}
.nav-item.active .nav-icon{transform:translateY(-2px)}
.content{padding:14px;padding-bottom:88px}
.balance-hero{background:linear-gradient(135deg,var(--bg3) 0%,var(--surface) 100%);border:1px solid var(--border);border-radius:var(--r);padding:22px 18px;margin-bottom:12px;position:relative;overflow:hidden}
.balance-hero::before{content:'';position:absolute;top:-40px;right:-40px;width:150px;height:150px;background:radial-gradient(circle,rgba(201,168,76,.12) 0%,transparent 70%);pointer-events:none}
.balance-label{font-size:.68rem;font-weight:700;letter-spacing:.12em;text-transform:uppercase;color:var(--muted);margin-bottom:7px}
.balance-value{font-family:'Playfair Display',serif;font-size:2.3rem;font-weight:800;color:var(--gold);line-height:1;margin-bottom:3px}
.balance-currency{font-size:.75rem;color:var(--muted)}
.stat-grid{display:grid;grid-template-columns:1fr 1fr;gap:9px;margin-bottom:12px}
.stat-tile{background:var(--surface);border:1px solid var(--border-s);border-radius:var(--r);padding:14px}
.stat-tile-icon{font-size:1.3rem;margin-bottom:8px}
.stat-tile-value{font-family:'JetBrains Mono',monospace;font-size:1rem;font-weight:600;color:var(--text);margin-bottom:2px}
.stat-tile-label{font-size:.68rem;color:var(--muted);letter-spacing:.03em}
.prog-wrap{background:var(--bg3);border-radius:100px;height:5px;overflow:hidden;margin-top:7px}
.prog-fill{height:100%;background:linear-gradient(90deg,var(--gold-dark),var(--gold-light));border-radius:100px;transition:width .4s ease}
.collapsible-header{display:flex;justify-content:space-between;align-items:center;cursor:pointer;user-select:none;padding:0}
.collapsible-header:hover .caret{color:var(--gold)}
.caret{font-size:.8rem;color:var(--muted);transition:transform .25s}
.caret.open{transform:rotate(180deg)}
.collapsible-body{overflow:hidden;max-height:0;transition:max-height .35s ease}
.collapsible-body.open{max-height:2000px}

/* ‚îÄ‚îÄ Plan Cards ‚îÄ‚îÄ */
.plan-card{background:var(--surface);border:1px solid var(--border-s);border-radius:var(--r);padding:16px;margin-bottom:9px;cursor:pointer;transition:all .2s;position:relative;overflow:hidden}
.plan-card:active{transform:scale(.98)}
.plan-card:hover,.plan-card.selected{border-color:var(--gold);box-shadow:0 0 0 1px rgba(201,168,76,.25);background:linear-gradient(135deg,rgba(201,168,76,.05),var(--surface))}
.plan-card.owned{border-color:var(--green);box-shadow:0 0 0 1px rgba(29,184,127,.2);background:linear-gradient(135deg,rgba(29,184,127,.05),var(--surface))}
.plan-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:10px}
.plan-name{font-family:'Playfair Display',serif;font-size:1.05rem;font-weight:700}
.plan-amount{font-family:'JetBrains Mono',monospace;font-size:.95rem;font-weight:600;color:var(--gold)}
.plan-stats{display:grid;grid-template-columns:1fr 1fr;gap:5px}
.plan-stat{background:var(--bg3);border-radius:6px;padding:7px 9px}
.plan-stat-val{font-size:.8rem;font-weight:700}
.plan-stat-lbl{font-size:.62rem;color:var(--muted);text-transform:uppercase;letter-spacing:.05em;margin-top:1px}

/* ‚îÄ‚îÄ Confirm Purchase Panel ‚îÄ‚îÄ */
.purchase-sum{background:linear-gradient(135deg,rgba(201,168,76,.08),rgba(201,168,76,.02));border:1px solid var(--border);border-radius:var(--r);padding:18px;margin-bottom:12px}
.sum-row{display:flex;justify-content:space-between;align-items:center;padding:9px 0;border-bottom:1px solid var(--border-s);font-size:.88rem}
.sum-row:last-child{border-bottom:none;font-weight:700}
.sum-label{color:var(--muted)}
.sum-val{font-family:'JetBrains Mono',monospace}
.sum-val.hi{color:var(--green);font-size:1rem}

.task-card{background:var(--surface);border:1px solid var(--border-s);border-radius:var(--r);overflow:hidden;margin-bottom:12px}
.task-card-body{padding:15px}
.task-type-bar{height:3px;width:100%}
.task-type-yt{background:linear-gradient(90deg,#ff0000,#ff6b6b)}
.task-type-read{background:linear-gradient(90deg,var(--gold),var(--gold-light))}
.task-type-tiktok{background:linear-gradient(90deg,#010101,#fe2c55)}
.task-type-sub{background:linear-gradient(90deg,#ff0000,#282828)}
.task-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:8px;gap:10px}
.task-title{font-weight:700;font-size:.9rem;line-height:1.4}
.task-reward{font-family:'JetBrains Mono',monospace;font-size:.88rem;font-weight:700;color:var(--green);white-space:nowrap}
.task-desc{font-size:.78rem;color:var(--muted);margin-bottom:12px;line-height:1.5}
.task-embed{width:100%;aspect-ratio:16/9;border:none;background:#000;border-radius:var(--rs) var(--rs) 0 0}
.task-timer{display:flex;align-items:center;gap:8px;background:var(--bg3);border-radius:var(--rs);padding:10px 14px;margin-bottom:10px;font-family:'JetBrains Mono',monospace;font-size:.85rem;color:var(--gold)}
.task-timer-circle{width:32px;height:32px;position:relative;flex-shrink:0}
.task-timer-circle svg{transform:rotate(-90deg)}
.timer-bg{fill:none;stroke:var(--border-s);stroke-width:3}
.timer-fill{fill:none;stroke:var(--gold);stroke-width:3;stroke-linecap:round;transition:stroke-dashoffset .9s linear}
.timer-count{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-size:.55rem;font-weight:700;color:var(--gold)}
.tab-bar{display:flex;background:var(--bg3);border:1px solid var(--border-s);border-radius:var(--rs);padding:3px;margin-bottom:14px;gap:3px}
.tab-btn{flex:1;padding:9px;border:none;border-radius:6px;font-family:'DM Sans',sans-serif;font-size:.82rem;font-weight:600;cursor:pointer;background:none;color:var(--muted);transition:all .2s}
.tab-btn.active{background:var(--surface2);color:var(--gold);border:1px solid var(--border)}
.info-row{display:flex;justify-content:space-between;align-items:center;padding:13px 0;border-bottom:1px solid var(--border-s)}
.info-row:last-child{border-bottom:none}
.info-label{font-size:.8rem;color:var(--muted)}
.info-val{font-size:.875rem;font-weight:600;text-align:right;max-width:60%;word-break:break-word}
table{width:100%;border-collapse:collapse;font-size:.8rem}
th{text-align:left;padding:9px 11px;color:var(--muted);font-size:.67rem;font-weight:700;text-transform:uppercase;letter-spacing:.07em;border-bottom:1px solid var(--border-s)}
td{padding:11px;border-bottom:1px solid rgba(255,255,255,.03);color:var(--text)}
tr:last-child td{border-bottom:none}
.lb-item{display:flex;align-items:center;gap:12px;padding:12px 0;border-bottom:1px solid var(--border-s)}
.lb-item:last-child{border-bottom:none}
.lb-rank{font-family:'JetBrains Mono',monospace;font-size:1rem;font-weight:700;width:28px;text-align:center;color:var(--dim)}
.lb-rank.top{color:var(--gold)}
.lb-info{flex:1}
.lb-name{font-weight:600;font-size:.875rem}
.lb-total{font-size:.72rem;color:var(--muted)}
.lb-count{font-family:'JetBrains Mono',monospace;font-size:1.1rem;font-weight:700;color:var(--gold)}
.profile-hero{background:linear-gradient(135deg,var(--bg3),var(--surface));border:1px solid var(--border-s);border-radius:var(--r);padding:26px 18px;text-align:center;margin-bottom:12px}
.avatar{width:76px;height:76px;border-radius:50%;background:linear-gradient(135deg,var(--gold-dark),var(--gold));display:flex;align-items:center;justify-content:center;font-family:'Playfair Display',serif;font-size:1.7rem;font-weight:700;color:#0A0C10;margin:0 auto 12px;position:relative;border:3px solid rgba(201,168,76,.3)}
.avatar-img{width:76px;height:76px;border-radius:50%;object-fit:cover;border:3px solid var(--border);display:none;margin:0 auto 12px}
.avatar-edit{position:absolute;bottom:0;right:0;width:24px;height:24px;background:var(--surface);border:1px solid var(--border);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:.65rem;cursor:pointer}
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.75);z-index:1000;display:flex;align-items:flex-end;justify-content:center;backdrop-filter:blur(4px);-webkit-backdrop-filter:blur(4px)}
.modal-sheet{background:var(--bg2);border:1px solid var(--border-s);border-radius:20px 20px 0 0;width:100%;max-width:480px;max-height:90vh;overflow-y:auto;padding:6px 18px 40px;animation:slideUp .3s ease-out}
@keyframes slideUp{from{transform:translateY(100%)}to{transform:translateY(0)}}
.modal-handle{width:38px;height:4px;background:var(--border);border-radius:100px;margin:10px auto 18px}
.modal-title{font-family:'Playfair Display',serif;font-size:1.25rem;font-weight:700;margin-bottom:6px}
/* SACCO */
.sacco-card{background:var(--surface);border:1px solid var(--border-s);border-radius:var(--r);padding:18px;margin-bottom:10px;cursor:pointer;transition:all .22s;position:relative;overflow:hidden;padding-left:22px}
.sacco-card::before{content:'';position:absolute;top:0;left:0;width:4px;height:100%}
.sacco-card:hover,.sacco-card.selected{border-color:var(--gold);box-shadow:0 0 0 1px rgba(201,168,76,.22);background:linear-gradient(135deg,rgba(201,168,76,.05),var(--surface))}
.sacco-t1::before{background:#1DB87F}.sacco-t2::before{background:#4A7CF7}.sacco-t3::before{background:#C9A84C}
.sacco-t4::before{background:#ec4899}.sacco-t5::before{background:#ef4444}.sacco-t6::before{background:#8b5cf6}
.sacco-return{font-family:'JetBrains Mono',monospace;font-size:1.3rem;font-weight:700}
.sacco-countdown-ring{position:relative;display:inline-flex;align-items:center;justify-content:center}
.sacco-active-card{background:linear-gradient(135deg,rgba(29,184,127,.07),rgba(29,184,127,.02));border:1px solid rgba(29,184,127,.25);border-radius:var(--r);padding:20px;margin-bottom:12px}
@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.08)}}
.pay-opt{background:var(--surface);border:1px solid var(--border-s);border-radius:var(--r);padding:14px;margin-bottom:9px;cursor:pointer;display:flex;align-items:center;gap:12px;transition:all .2s}
.pay-opt:hover{border-color:var(--gold);background:rgba(201,168,76,.04)}
.pay-opt.disabled{opacity:.4;pointer-events:none}
.notif-panel{position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:1001;display:flex;align-items:flex-end;justify-content:center}
.notif-sheet{background:var(--bg2);border-radius:20px 20px 0 0;width:100%;max-width:480px;max-height:80vh;overflow-y:auto;animation:slideUp .3s ease-out}
.notif-item{padding:14px 18px;border-bottom:1px solid var(--border-s);cursor:pointer}
.notif-item.unread{background:rgba(201,168,76,.04);border-left:3px solid var(--gold)}
#toastCont{position:fixed;top:14px;left:50%;transform:translateX(-50%);z-index:9999;display:flex;flex-direction:column;gap:7px;width:calc(100% - 28px);max-width:440px;pointer-events:none}
.toast{background:var(--surface);border:1px solid var(--border-s);border-radius:var(--rs);padding:13px 15px;display:flex;align-items:flex-start;gap:11px;box-shadow:0 12px 40px rgba(0,0,0,.6);animation:toastIn .3s ease-out;pointer-events:auto;border-left-width:3px}
@keyframes toastIn{from{transform:translateY(-18px);opacity:0}to{transform:translateY(0);opacity:1}}
.toast-close{font-size:.95rem;cursor:pointer;color:var(--dim);background:none;border:none;flex-shrink:0;margin-left:auto}
.upload-zone{border:2px dashed var(--border-s);border-radius:var(--rs);padding:20px;text-align:center;cursor:pointer;transition:all .2s;background:var(--bg3)}
.upload-zone:hover{border-color:var(--gold);background:rgba(201,168,76,.04)}
.upload-zone input{display:none}
.upload-preview{max-width:100%;border-radius:var(--rs);margin-top:12px;max-height:200px;object-fit:contain;display:none}
.admin-wrap{min-height:100vh;max-width:100%}
.admin-header{background:var(--bg2);border-bottom:1px solid var(--border-s);padding:14px 18px;display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;z-index:100;max-width:100%}
.admin-tabs{display:flex;gap:5px;overflow-x:auto;padding:11px 14px;background:var(--bg2);border-bottom:1px solid var(--border-s);scrollbar-width:none}
.admin-tabs::-webkit-scrollbar{display:none}
.admin-tab{white-space:nowrap;padding:7px 14px;border-radius:var(--rs);border:1px solid var(--border-s);background:var(--surface);color:var(--muted);font-size:.78rem;font-weight:600;cursor:pointer;font-family:'DM Sans',sans-serif;transition:all .2s}
.admin-tab.active{background:var(--gold);color:#0A0C10;border-color:var(--gold)}
.admin-content{padding:14px;max-width:100%}
.admin-stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(130px,1fr));gap:9px;margin-bottom:14px}
.admin-stat{background:var(--surface);border:1px solid var(--border-s);border-radius:var(--r);padding:14px;text-align:center}
.admin-stat-val{font-family:'JetBrains Mono',monospace;font-size:1.4rem;font-weight:700;color:var(--gold)}
.admin-stat-lbl{font-size:.68rem;color:var(--muted);margin-top:3px;text-transform:uppercase;letter-spacing:.04em}
.dep-card{background:var(--surface);border:1px solid var(--border-s);border-radius:var(--r);padding:16px;margin-bottom:10px}
.dep-card img{max-width:100%;border-radius:var(--rs);margin-top:10px;cursor:pointer}
.section-title{font-family:'Playfair Display',serif;font-size:1.25rem;font-weight:700;color:var(--text);margin-bottom:3px}
.section-sub{font-size:.78rem;color:var(--muted);margin-bottom:14px}
.reading-content{background:var(--bg3);border-radius:var(--rs);padding:14px;font-size:.85rem;line-height:1.75;color:var(--muted);margin-bottom:12px;max-height:200px;overflow-y:auto}
.success-overlay{position:fixed;inset:0;background:rgba(10,12,16,.95);z-index:2000;display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;padding:30px}
.success-icon{font-size:5rem;margin-bottom:20px;animation:bounceIn .5s ease-out}
@keyframes bounceIn{0%{transform:scale(0)}70%{transform:scale(1.1)}100%{transform:scale(1)}}
::-webkit-scrollbar{width:3px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:var(--border);border-radius:100px}
@keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
.fade-in{animation:fadeIn .3s ease-out}

/* ‚îÄ‚îÄ PWA safe area ‚îÄ‚îÄ */
body{padding-top:env(safe-area-inset-top)}
.bottom-nav{padding-bottom:calc(env(safe-area-inset-bottom) + 4px) !important}
.content{padding-bottom:calc(88px + env(safe-area-inset-bottom))}

/* ================================================================
   RESPONSIVE ‚Äî tablet (600px+) and desktop (1024px+)
   ================================================================ */
@media (min-width:600px){
  body{max-width:100%}
  .bottom-nav{display:none !important}
  #sideNav{display:flex !important}
  #userDashboard{display:grid;grid-template-columns:220px 1fr;grid-template-rows:auto 1fr;min-height:100vh}
  .dash-header{grid-column:1/-1;max-width:100%}
  #contentArea{grid-column:2;grid-row:2;overflow-y:auto}
  .content{padding:22px 28px 40px;max-width:820px}
  .balance-value{font-size:3rem}
  .stat-grid{grid-template-columns:repeat(3,1fr)}
  #plansList{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  #plansList .plan-card{margin-bottom:0}
  .modal-sheet{max-width:500px;margin:0 auto;border-radius:20px 20px 0 0}
  .auth-page{align-items:center;justify-content:center;padding:40px 20px}
  .auth-body{max-width:440px;width:100%;background:var(--surface);border:1px solid var(--border-s);border-radius:20px;padding:32px}
  .admin-stats-grid{grid-template-columns:repeat(3,1fr)}
  #toastCont{max-width:500px}
  .landing-page{align-items:center;padding:40px 24px}
}
@media (min-width:1024px){
  #userDashboard{grid-template-columns:260px 1fr}
  .content{max-width:900px;padding:28px 40px 40px}
  .stat-grid{grid-template-columns:repeat(4,1fr)}
  #plansList{grid-template-columns:repeat(3,1fr)}
  .balance-value{font-size:3.6rem}
  .admin-stats-grid{grid-template-columns:repeat(4,1fr)}
  .admin-content{padding:28px 36px}
}

/* Sidebar nav ‚Äî shown on tablet+ */
#sideNav{
  display:none;flex-direction:column;
  background:var(--bg2);border-right:1px solid var(--border-s);
  padding:16px 0;position:sticky;top:60px;
  height:calc(100vh - 60px);overflow-y:auto;
  grid-row:2;grid-column:1;
}
.side-nav-item{
  display:flex;align-items:center;gap:12px;
  padding:12px 20px;cursor:pointer;border:none;background:none;
  color:var(--dim);font-family:'DM Sans',sans-serif;
  font-size:.88rem;font-weight:600;width:100%;text-align:left;
  transition:all .2s;border-left:3px solid transparent;
}
.side-nav-item:hover{color:var(--text);background:rgba(255,255,255,.03)}
.side-nav-item.active{color:var(--gold);border-left-color:var(--gold);background:rgba(201,168,76,.06)}
.side-nav-icon{font-size:1.1rem;width:22px;text-align:center;flex-shrink:0}
.side-nav-label{flex:1}
.side-nav-section{font-size:.6rem;font-weight:700;letter-spacing:.12em;text-transform:uppercase;color:var(--dim);padding:14px 20px 5px;margin-top:6px}
#contentArea{grid-column:2;grid-row:2;overflow-y:auto}

/* Admin sidebar on tablet+ */
@media (min-width:600px){
  .admin-tabs{display:none !important}
  .admin-wrap{display:grid;grid-template-columns:200px 1fr;min-height:calc(100vh - 60px)}
  .admin-header{grid-column:1/-1}
  #adminSideNav{display:flex !important;flex-direction:column;background:var(--bg2);border-right:1px solid var(--border-s);padding:10px 0;position:sticky;top:60px;height:calc(100vh - 60px);overflow-y:auto}
  .admin-content{grid-column:2;padding:22px 24px}
}

/* Install prompt banner */
#installBanner{
  position:fixed;bottom:0;left:0;right:0;max-width:480px;margin:0 auto;
  background:linear-gradient(135deg,var(--bg2),var(--surface));
  border-top:1px solid var(--border);
  padding:14px 18px calc(14px + env(safe-area-inset-bottom));
  display:flex;align-items:center;gap:12px;z-index:9000;
  transform:translateY(100%);transition:transform .4s cubic-bezier(.16,1,.3,1);
}
#installBanner.show{transform:translateY(0)}
@media (min-width:600px){
  #installBanner{
    bottom:auto;top:80px;right:24px;left:auto;border:1px solid var(--border);
    border-radius:16px;max-width:320px;padding:16px;
    transform:translateY(-20px);opacity:0;transition:all .4s cubic-bezier(.16,1,.3,1);
    box-shadow:0 20px 60px rgba(0,0,0,.6);
  }
  #installBanner.show{transform:translateY(0);opacity:1}
}

/* Mobile table font */
@media (max-width:599px){table{font-size:.72rem}th,td{padding:8px 6px}}
</style>
</head>
<body>
<div id="loadingScreen">
  <div class="loader-logo">VaultPro</div>
  <div class="loader-tag">Investment Platform</div>
  <div class="loader-ring"></div>
</div>
<div id="toastCont"></div>

<!-- REFERRAL LANDING -->
<div id="referralLandingPage" class="landing-page hidden">
  <div class="landing-hero" style="width:100%">
    <div style="font-size:3.2rem;margin-bottom:14px">üè¶</div>
    <div class="landing-title">You've been invited!</div>
    <div style="font-size:.88rem;color:var(--muted);margin-top:6px">Join Uganda's premier investment platform</div>
  </div>
  <div class="invite-code-box">
    <div style="font-size:.7rem;font-weight:700;letter-spacing:.12em;text-transform:uppercase;color:var(--muted);margin-bottom:10px">Your Invitation Code</div>
    <div class="invite-code-val" id="landingCode">‚Äî‚Äî</div>
  </div>
  <div style="display:flex;flex-direction:column;gap:9px;width:100%;max-width:360px">
    <button class="btn btn-gold btn-full" onclick="showRegisterFromReferral()">Create Account ‚Üí</button>
    <button class="btn btn-outline btn-full" onclick="showLogin()">Already have an account</button>
  </div>
  <div style="margin-top:24px;display:flex;flex-direction:column;gap:9px;width:100%">
    <div class="card" style="display:flex;gap:12px;align-items:center;padding:13px 15px"><span style="font-size:1.3rem">‚úÖ</span><div><div style="font-weight:700;font-size:.875rem">Daily Task Rewards</div><div style="font-size:.75rem;color:var(--muted)">Earn UGX by completing tasks every day</div></div></div>
    <div class="card" style="display:flex;gap:12px;align-items:center;padding:13px 15px"><span style="font-size:1.3rem">üíé</span><div><div style="font-weight:700;font-size:.875rem">Vault Investment Plans</div><div style="font-size:.75rem;color:var(--muted)">Grow capital with structured plans</div></div></div>
    <div class="card" style="display:flex;gap:12px;align-items:center;padding:13px 15px"><span style="font-size:1.3rem">üë•</span><div><div style="font-weight:700;font-size:.875rem">10% Referral Bonus</div><div style="font-size:.75rem;color:var(--muted)">Earn when your referrals invest</div></div></div>
  </div>
</div>

<!-- REGISTER -->
<div id="registerPage" class="auth-page hidden">
  <div class="auth-header"><div class="auth-logo">VaultPro</div><div class="auth-sub">Create your account</div></div>
  <div class="auth-body">
    <div id="registerAlert"></div>
    <div class="fg"><label>Invitation Code</label><input type="text" id="inviteCode" placeholder="Enter your code" style="text-transform:uppercase;letter-spacing:.1em"></div>
    <div class="fg"><label>Full Name</label><input type="text" id="fullName" placeholder="Your full name"></div>
    <div class="fg"><label>Email Address</label><input type="email" id="email" placeholder="you@example.com"></div>
    <div class="fg"><label>Phone Number (for withdrawals)</label><input type="tel" id="regPhone" placeholder="07XXXXXXXX"></div>
    <div class="fg"><label>Password</label><input type="password" id="password" placeholder="At least 6 characters"></div>
    <div class="fg"><label>Confirm Password</label><input type="password" id="confirmPassword" placeholder="Repeat password"></div>
    <button class="btn btn-gold btn-full" id="registerBtn" onclick="register()">Create Account</button>
    <p style="text-align:center;margin-top:18px;font-size:.875rem;color:var(--muted)">Already have an account? <a href="#" onclick="showLogin()" style="color:var(--gold);text-decoration:none;font-weight:600">Sign in</a></p>
  </div>
</div>

<!-- LOGIN -->
<div id="loginPage" class="auth-page hidden">
  <div class="auth-header"><div class="auth-logo">VaultPro</div><div class="auth-sub">Sign in to your account</div></div>
  <div class="auth-body">
    <div id="loginAlert"></div>
    <div class="fg"><label>Email Address</label><input type="email" id="loginEmail" placeholder="you@example.com"></div>
    <div class="fg"><label>Password</label><input type="password" id="loginPassword" placeholder="Your password"></div>
    <button class="btn btn-gold btn-full" id="loginBtn" onclick="login()" style="margin-top:6px">Sign In</button>
    <p style="text-align:center;margin-top:18px;font-size:.875rem;color:var(--muted)">Don't have an account? <a href="#" onclick="showRegister()" style="color:var(--gold);text-decoration:none;font-weight:600">Join now</a></p>
    <p style="text-align:center;margin-top:10px;font-size:.75rem;color:var(--dim)"><a href="#" onclick="checkAndShowAdminSetup()" style="color:var(--dim);text-decoration:none">First time? ‚öôÔ∏è Admin setup</a></p>
  </div>
</div>

<!-- ADMIN SETUP ‚Äî One-time bootstrap page -->
<div id="adminSetupPage" class="auth-page hidden">
  <div class="auth-header">
    <div class="auth-logo" style="color:var(--red)">‚öôÔ∏è Admin Setup</div>
    <div class="auth-sub" style="color:var(--muted)">One-time setup ‚Äî creates first admin account</div>
  </div>
  <div class="auth-body">
    <div class="alert alert-warning" style="margin-bottom:14px">
      ‚ö†Ô∏è This page is only for the <strong>first time</strong>. After creating the admin, this option disappears.
    </div>
    <div id="adminSetupAlert"></div>
    <div class="fg"><label>Admin Full Name</label><input type="text" id="adminSetupName" placeholder="Your full name"></div>
    <div class="fg"><label>Admin Email</label><input type="email" id="adminSetupEmail" placeholder="admin@example.com"></div>
    <div class="fg"><label>Admin Phone</label><input type="tel" id="adminSetupPhone" placeholder="07XXXXXXXX"></div>
    <div class="fg"><label>Password</label><input type="password" id="adminSetupPass" placeholder="Strong password"></div>
    <div class="fg"><label>Confirm Password</label><input type="password" id="adminSetupPass2" placeholder="Repeat password"></div>
    <button class="btn btn-red btn-full" onclick="createAdminAccount()">üîê Create Admin Account</button>
    <p style="text-align:center;margin-top:14px;font-size:.8rem;color:var(--dim)"><a href="#" onclick="showLogin()" style="color:var(--muted);text-decoration:none">‚Üê Back to Login</a></p>
  </div>
</div>

<!-- USER DASHBOARD -->
<div id="userDashboard" class="hidden">
  <div class="dash-header">
    <div>
      <div class="header-brand">üè¶ VaultPro</div>
      <div class="header-user-sub" id="headerSub">Loading‚Ä¶</div>
    </div>
    <div style="display:flex;gap:7px">
      <button class="icon-btn" onclick="openNotif()" title="Notifications">üîî<span class="notif-dot hidden" id="notifBadge"></span></button>
    </div>
  </div>

  <!-- SIDEBAR ‚Äî shown on tablet/desktop, hidden on mobile -->
  <nav id="sideNav" aria-label="Main navigation">
    <div class="side-nav-section">Menu</div>
    <button class="side-nav-item" onclick="showSection('home')" id="sidenav-home">
      <span class="side-nav-icon">üè†</span><span class="side-nav-label">Home</span>
    </button>
    <button class="side-nav-item" onclick="showSection('vault')" id="sidenav-vault">
      <span class="side-nav-icon">üè¶</span><span class="side-nav-label">Vault Plans</span>
    </button>
    <button class="side-nav-item" onclick="showSection('tasks')" id="sidenav-tasks">
      <span class="side-nav-icon">‚úÖ</span><span class="side-nav-label">Daily Tasks</span>
    </button>
    <button class="side-nav-item" onclick="showSection('referrals')" id="sidenav-referrals">
      <span class="side-nav-icon">üë•</span><span class="side-nav-label">Referrals</span>
    </button>
    <div class="side-nav-section">Account</div>
    <button class="side-nav-item" onclick="showSection('wallet')" id="sidenav-wallet">
      <span class="side-nav-icon">üí∞</span><span class="side-nav-label">Wallet</span>
    </button>
    <button class="side-nav-item" onclick="showSection('sacco')" id="sidenav-sacco">
      <span class="side-nav-icon">üí∞</span><span class="side-nav-label">SACCO</span>
    </button>
    <button class="side-nav-item" onclick="showSection('profile')" id="sidenav-profile">
      <span class="side-nav-icon">üë§</span><span class="side-nav-label">Profile</span>
    </button>
    <div style="margin-top:auto;padding:16px 20px;border-top:1px solid var(--border-s)">
      <button class="btn btn-outline" style="width:100%;padding:10px;font-size:.8rem" onclick="logout()">Sign Out</button>
    </div>
  </nav>

  <!-- CONTENT AREA wrapper for tablet/desktop grid -->
  <div id="contentArea">

  <!-- HOME -->
  <div id="homeSection" class="content hidden fade-in">
    <div class="balance-hero">
      <div class="balance-label">Total Balance</div>
      <div class="balance-value" id="totalBalance">0</div>
      <div class="balance-currency">UGX <span id="activeBadge" class="badge badge-success hidden" style="margin-left:6px">Active</span></div>
    </div>
    <div class="stat-grid">
      <div class="stat-tile"><div class="stat-tile-icon">üë•</div><div class="stat-tile-value" id="statRefs">0</div><div class="stat-tile-label">Referrals</div></div>
      <div class="stat-tile"><div class="stat-tile-icon">‚úÖ</div><div class="stat-tile-value" id="statTask">0</div><div class="stat-tile-label">Task Earnings</div></div>
      <div class="stat-tile"><div class="stat-tile-icon">üí∏</div><div class="stat-tile-value" id="statRef">0</div><div class="stat-tile-label">Referral Earn.</div></div>
      <div class="stat-tile"><div class="stat-tile-icon">üíé</div><div class="stat-tile-value" id="statLevel">‚Äî</div><div class="stat-tile-label">Vault Level</div></div>
      <div class="stat-tile" style="grid-column:span 2;background:linear-gradient(135deg,rgba(201,168,76,.08),rgba(201,168,76,.02));border-color:var(--border)"><div class="stat-tile-icon">üèÜ</div><div class="stat-tile-value" id="statWeeklyPrize" style="color:var(--gold)">0</div><div class="stat-tile-label">Weekly Prize Earnings</div></div>
    </div>

    <div class="card">
      <div class="collapsible-header" onclick="toggleCollapse('vaultOverview')">
        <div style="font-weight:700;font-size:.9rem">üìä Vault Plans Overview</div>
        <span class="caret" id="vaultOverviewCaret">‚ñº</span>
      </div>
      <div class="collapsible-body" id="vaultOverview" style="margin-top:0">
        <div style="margin-top:14px;overflow-x:auto">
          <table>
            <thead><tr><th>Plan</th><th>Amount</th><th>Tasks/day</th><th>UGX/task</th><th>Monthly</th></tr></thead>
            <tbody>
              <tr><td>üå± Beginner</td><td>45K</td><td>1</td><td>450</td><td>13,500</td></tr>
              <tr><td>üå± Seed</td><td>180K</td><td>3</td><td>600</td><td>54,000</td></tr>
              <tr><td>üåÖ Rising</td><td>600K</td><td>6</td><td>3,333</td><td>180,000</td></tr>
              <tr><td>üí° Nova</td><td>1.35M</td><td>11</td><td>4,091</td><td>405,000</td></tr>
              <tr><td>üß† Mastermind</td><td>4.05M</td><td>18</td><td>7,500</td><td>1,215,000</td></tr>
              <tr><td>üí™ Titan</td><td>8.775M</td><td>25</td><td>11,700</td><td>2,632,500</td></tr>
              <tr><td>üëë King</td><td>16.65M</td><td>34</td><td>16,307</td><td>4,995,000</td></tr>
              <tr><td>ü¶Ö Emperor</td><td>29.7M</td><td>44</td><td>22,500</td><td>8,910,000</td></tr>
              <tr><td>‚≠ê Icon</td><td>48.6M</td><td>55</td><td>29,455</td><td>14,580,000</td></tr>
              <tr><td>üëë Supreme</td><td>74.25M</td><td>66</td><td>37,502</td><td>22,275,000</td></tr>
              <tr><td>üèÜ Legendary</td><td>110M</td><td>75</td><td>48,888</td><td>33,000,000</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="collapsible-header" onclick="toggleCollapse('leaderboard')">
        <div>
          <div style="font-weight:700;font-size:.9rem">üèÜ Weekly Leaderboard</div>
          <div style="font-size:.72rem;color:var(--muted);margin-top:2px">Top referrer wins <strong style="color:var(--gold)">50,000 UGX</strong> ¬∑ Resets in: <span id="weekTimer">‚Äî</span></div>
        </div>
        <span class="caret" id="leaderboardCaret">‚ñº</span>
      </div>
      <div class="collapsible-body" id="leaderboard" style="margin-top:0">
        <div id="leaderboardList" style="margin-top:14px"><div style="text-align:center;color:var(--muted);padding:12px">Loading‚Ä¶</div></div>
      </div>
    </div>

    <div class="card" style="background:linear-gradient(135deg,rgba(37,211,102,.08),rgba(18,140,126,.05));border-color:rgba(37,211,102,.2);text-align:center">
      <div style="font-size:1.4rem;margin-bottom:7px">üí¨</div>
      <div style="font-weight:700;margin-bottom:4px">Join Our WhatsApp Group</div>
      <div style="font-size:.78rem;color:var(--muted);margin-bottom:12px">Get updates &amp; connect with investors</div>
      <a href="https://chat.whatsapp.com/KBvY0dutPIcHPLNzjBcJZQ" target="_blank" class="btn btn-green btn-full" style="text-decoration:none">Join Now</a>
    </div>

    <!-- Referral Career Levels -->
    <div class="card" style="background:linear-gradient(135deg,rgba(99,102,241,.06),rgba(201,168,76,.04));border-color:rgba(99,102,241,.2)">
      <div class="collapsible-header" onclick="toggleCollapse('refLevelsHome')">
        <div>
          <div style="font-weight:700;font-size:.9rem">üéñÔ∏è Referral Career Levels</div>
          <div style="font-size:.72rem;color:var(--muted);margin-top:2px">Grow your network ¬∑ Unlock salary &amp; status</div>
        </div>
        <span class="caret" id="refLevelsHomeCaret">‚ñº</span>
      </div>
      <div class="collapsible-body" id="refLevelsHome">
        <div style="margin-top:14px;display:flex;flex-direction:column;gap:9px" id="refLevelsHomeList">
          <!-- Populated by JS -->
        </div>
        <div style="margin-top:14px;padding:11px 13px;background:var(--bg3);border-radius:var(--rs);font-size:.76rem;color:var(--muted);line-height:1.6">
          <strong style="color:var(--gold);display:block;margin-bottom:4px">üìå How it works</strong>
          Referral salary is credited monthly based on your level. Shareholders receive 20% of company funds. All levels require the referred users to have active vault subscriptions.
        </div>
      </div>
    </div>
  </div>

  <!-- VAULT -->
  <div id="vaultSection" class="content hidden fade-in">
    <div class="section-title">Vault Plans</div>
    <div class="section-sub">Select a plan to unlock daily task rewards</div>
    <div id="vaultAlert"></div>
    <div class="balance-hero" style="margin-bottom:14px">
      <div class="balance-label">Available Balance</div>
      <div class="balance-value" id="vaultBalance">0</div>
      <div class="balance-currency">UGX</div>
    </div>
    <div id="plansList"></div>
    <!-- Confirm Purchase Panel ‚Äî shown when user taps a plan with sufficient balance -->
    <div id="selectedPlanDetails" class="hidden">
      <div class="purchase-sum" id="purchaseSumContent"></div>
      <div style="display:flex;gap:9px;margin-bottom:6px">
        <button class="btn btn-surface" style="flex:1" onclick="cancelPlanSelection()">Cancel</button>
        <button class="btn btn-gold" style="flex:2" id="purchaseBtn" onclick="purchaseVault()">‚úÖ Confirm Purchase</button>
      </div>
    </div>
  </div>

  <!-- REFERRALS -->
  <div id="referralsSection" class="content hidden fade-in">
    <div class="section-title">Referrals</div>
    <div class="section-sub">Earn 10% on vault purchases + weekly prizes</div>
    <div id="referralsAlert"></div>
    <div class="balance-hero" style="margin-bottom:12px">
      <div class="balance-label">Total Referral Earnings</div>
      <div class="balance-value" id="totalRefEarnings">0</div>
      <div class="balance-currency">UGX</div>
    </div>
    <div class="card">
      <div style="font-weight:700;margin-bottom:12px">üîó Your Referral Link</div>
      <div style="background:var(--bg3);border:1px solid var(--border-s);border-radius:var(--rs);padding:11px 13px;font-family:'JetBrains Mono',monospace;font-size:.7rem;color:var(--muted);word-break:break-all;margin-bottom:12px;line-height:1.6" id="userRefLink">Loading‚Ä¶</div>
      <div style="display:flex;gap:8px">
        <button class="btn btn-gold" style="flex:1;padding:11px" onclick="copyRefLink()">Copy Link</button>
        <button class="btn btn-outline" style="flex:1;padding:11px" onclick="shareRefLink()">Share</button>
      </div>
    </div>
    <div class="card" id="refLevelCard"></div>
    <div class="card">
      <div style="font-weight:700;margin-bottom:12px">How it works</div>
      <div style="display:flex;flex-direction:column;gap:10px">
        <div style="display:flex;gap:11px"><span style="font-size:1.1rem">üéØ</span><div><div style="font-weight:600;font-size:.875rem">Vault Purchase Bonus</div><div style="font-size:.76rem;color:var(--muted);margin-top:2px">Earn 10% of every vault plan your referral purchases</div></div></div>
        <div style="display:flex;gap:11px"><span style="font-size:1.1rem">üå≥</span><div><div style="font-weight:600;font-size:.875rem">Second-Level Bonus</div><div style="font-size:.76rem;color:var(--muted);margin-top:2px">Earn 2,000 UGX when your referral recruits someone</div></div></div>
        <div style="display:flex;gap:11px"><span style="font-size:1.1rem">üèÜ</span><div><div style="font-weight:600;font-size:.875rem">Weekly Prize</div><div style="font-size:.76rem;color:var(--muted);margin-top:2px">Top referrer each week wins 50,000 UGX</div></div></div>
      </div>
    </div>
    <div class="card">
      <div style="font-weight:700;margin-bottom:12px">Your Referrals</div>
      <div id="referralsList" style="color:var(--muted);text-align:center;padding:14px">Loading‚Ä¶</div>
    </div>
  </div>

  <!-- TASKS -->
  <div id="tasksSection" class="content hidden fade-in">
    <div class="section-title">Daily Tasks</div>
    <div class="section-sub">Complete tasks to earn your daily rewards</div>
    <div id="tasksAlert"></div>
    <div class="card" style="padding:14px">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:7px">
        <span style="font-size:.78rem;font-weight:700;color:var(--muted)">Today's Progress</span>
        <span id="taskProgText" style="font-family:'JetBrains Mono',monospace;font-size:.875rem;font-weight:700;color:var(--gold)">0 / 0</span>
      </div>
      <div class="prog-wrap"><div class="prog-fill" id="taskProgBar" style="width:0%"></div></div>
    </div>
    <div id="tasksList"><div style="text-align:center;padding:40px;color:var(--muted)">Loading tasks‚Ä¶</div></div>
  </div>

  <!-- WALLET -->
  <div id="walletSection" class="content hidden fade-in">
    <div class="section-title">Wallet</div>
    <div class="section-sub">Manage your funds</div>
    <div id="walletAlert"></div>
    <div class="balance-hero" style="margin-bottom:12px">
      <div class="balance-label">Available Balance</div>
      <div class="balance-value" id="walletBal">0</div>
      <div class="balance-currency">UGX ¬∑ Points: <strong id="walletPts">0</strong></div>
    </div>
    <div class="tab-bar">
      <button class="tab-btn active" id="depTab" onclick="showWalletTab('dep')">Deposit</button>
      <button class="tab-btn" id="wdTab" onclick="showWalletTab('wd')">Withdraw</button>
      <button class="tab-btn" id="histTab" onclick="showWalletTab('hist')">History</button>
    </div>

    <!-- Deposit Panel -->
    <div id="depPanel">
      <div class="card">
        <div style="font-weight:700;margin-bottom:14px">üí∞ Deposit Funds</div>
        <div id="depAlert"></div>

        <div class="fg">
          <label>Payment Method</label>
          <select id="depMethod" onchange="onDepMethodChange()">
            <option value="">Select method</option>
            <option value="mtn">MTN Mobile Money</option>
            <option value="airtel">Airtel Money</option>
          </select>
        </div>

        <!-- Instructions shown after method selected -->
        <div id="depInstructions" class="hidden" style="margin-bottom:14px">
          <div id="depMtnInfo" class="hidden" style="background:linear-gradient(135deg,rgba(255,204,0,.08),rgba(255,204,0,.02));border:1px solid rgba(255,204,0,.2);border-radius:var(--rs);padding:14px">
            <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px">
              <div style="width:36px;height:36px;background:#FFCC00;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1rem;font-weight:900;color:#000;flex-shrink:0">M</div>
              <div>
                <div style="font-weight:700;font-size:.88rem">MTN Mobile Money</div>
                <div style="font-size:.72rem;color:var(--muted)">Name: <strong style="color:var(--text)">Wafula Kevin</strong></div>
              </div>
            </div>
            <div style="background:var(--bg3);border-radius:var(--rs);padding:11px 14px;display:flex;align-items:center;justify-content:space-between;margin-bottom:10px">
              <div>
                <div style="font-size:.62rem;color:var(--muted);text-transform:uppercase;letter-spacing:.06em;margin-bottom:2px">Send to</div>
                <div style="font-family:'JetBrains Mono',monospace;font-size:1.25rem;font-weight:700;color:var(--gold)">0779 710 365</div>
              </div>
              <button onclick="navigator.clipboard.writeText('0779710365');toast('Copied!','üìã','success')" style="background:var(--surface);border:1px solid var(--border-s);border-radius:var(--rs);padding:8px 12px;color:var(--gold);font-size:.75rem;font-weight:700;cursor:pointer">Copy</button>
            </div>
            <div style="font-size:.74rem;color:var(--muted);line-height:1.65">Dial <strong style="color:var(--gold)">*165#</strong> ‚Üí Send Money ‚Üí Enter number ‚Üí Enter amount ‚Üí Confirm name <strong style="color:var(--green)">Wafula Kevin</strong> ‚Üí Enter PIN</div>
          </div>

          <div id="depAirtelInfo" class="hidden" style="background:linear-gradient(135deg,rgba(231,0,18,.07),rgba(231,0,18,.02));border:1px solid rgba(231,0,18,.2);border-radius:var(--rs);padding:14px">
            <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px">
              <div style="width:36px;height:36px;background:#E70012;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1rem;font-weight:900;color:#fff;flex-shrink:0">A</div>
              <div>
                <div style="font-weight:700;font-size:.88rem">Airtel Money</div>
                <div style="font-size:.72rem;color:var(--muted)">Name: <strong style="color:var(--text)">Aisha Nangobi</strong></div>
              </div>
            </div>
            <div style="background:var(--bg3);border-radius:var(--rs);padding:11px 14px;display:flex;align-items:center;justify-content:space-between;margin-bottom:10px">
              <div>
                <div style="font-size:.62rem;color:var(--muted);text-transform:uppercase;letter-spacing:.06em;margin-bottom:2px">Send to</div>
                <div style="font-family:'JetBrains Mono',monospace;font-size:1.25rem;font-weight:700;color:var(--gold)">0702 377 999</div>
              </div>
              <button onclick="navigator.clipboard.writeText('0702377999');toast('Copied!','üìã','success')" style="background:var(--surface);border:1px solid var(--border-s);border-radius:var(--rs);padding:8px 12px;color:var(--gold);font-size:.75rem;font-weight:700;cursor:pointer">Copy</button>
            </div>
            <div style="font-size:.74rem;color:var(--muted);line-height:1.65">Dial <strong style="color:var(--gold)">*185#</strong> ‚Üí Send Money ‚Üí Enter number ‚Üí Enter amount ‚Üí Confirm name <strong style="color:var(--green)">Aisha Nangobi</strong> ‚Üí Enter PIN</div>
          </div>

          <div style="margin-top:11px;display:flex;align-items:flex-start;gap:10px;background:rgba(29,184,127,.06);border:1px solid rgba(29,184,127,.2);border-radius:var(--rs);padding:11px 13px">
            <input type="checkbox" id="depNameConfirm" style="margin-top:2px;flex-shrink:0;accent-color:var(--green)">
            <label for="depNameConfirm" style="font-size:.78rem;cursor:pointer;line-height:1.55">I confirmed the name matches and sent to the correct number ‚úÖ</label>
          </div>
        </div>

        <div id="depFormFields" class="hidden">
          <div class="fg"><label>Amount (UGX)</label><input type="number" id="depAmount" placeholder="Minimum 1,000"></div>
          <div class="fg"><label>Your Phone Number</label><input type="tel" id="depPhone" placeholder="07XXXXXXXX"></div>
          <div class="fg">
            <label>Payment Screenshot <span style="font-size:.7rem;color:var(--muted)">(required)</span></label>
            <label class="upload-zone" for="depScreenshot">
              <input type="file" id="depScreenshot" accept="image/*" onchange="previewScreenshot(this,'depPreview')">
              <div style="font-size:1.8rem;margin-bottom:8px">üì∏</div>
              <div style="font-size:.82rem;color:var(--muted)" id="depScreenshotLabel">Tap to upload confirmation screenshot</div>
              <img id="depPreview" class="upload-preview">
            </label>
          </div>
          <button class="btn btn-green btn-full" id="depSubmitBtn" onclick="submitDeposit()">Submit Deposit Request</button>
        </div>
      </div>
    </div>

    <!-- Withdraw Panel -->
    <div id="wdPanel" class="hidden">
      <div class="card">
        <div style="font-weight:700;margin-bottom:14px">üí∏ Withdraw Funds</div>
        <div id="wdAlert"></div>
        <div class="fg"><label>Earnings Category</label>
          <select id="wdCat"><option value="">Select category</option><option value="referral">Referral Earnings</option><option value="task">Task Earnings (Fri‚ÄìSat only)</option><option value="vault">Vault Earnings</option><option value="weeklyPrize">üèÜ Weekly Prize</option>
            <option value="saccoReturn">üí∞ SACCO Return</option></select>
        </div>
        <div class="fg"><label>Amount (UGX)</label><input type="number" id="wdAmount" placeholder="Minimum 5,000"></div>
        <div class="fg">
          <label>Mobile Money Number <span style="color:var(--gold);font-size:.7rem">(auto-filled from profile)</span></label>
          <input type="tel" id="wdPhone" placeholder="07XXXXXXXX">
        </div>
        <div class="card" style="background:rgba(232,68,90,.06);border-color:rgba(232,68,90,.2);padding:13px;margin-bottom:14px">
          <div style="font-size:.78rem;color:var(--muted);line-height:1.7"><strong style="color:var(--red);display:block;margin-bottom:3px">‚ö†Ô∏è Withdrawal Rules</strong>Task earnings: Friday &amp; Saturday only<br>Admin fee: 5% ¬∑ Minimum: 5,000 UGX</div>
        </div>
        <button class="btn btn-gold btn-full" onclick="submitWithdrawal()">Request Withdrawal</button>
      </div>
    </div>

    <!-- History Panel -->
    <div id="histPanel" class="hidden">
      <div class="card" style="padding:0;overflow:hidden">
        <div style="padding:14px;border-bottom:1px solid var(--border-s);font-weight:700">Transaction History</div>
        <div style="overflow-x:auto"><table><thead><tr><th>Date</th><th>Type</th><th>Amount</th><th>Status</th></tr></thead><tbody id="txHistory"><tr><td colspan="4" style="text-align:center;color:var(--muted)">No transactions yet</td></tr></tbody></table></div>
      </div>
    </div>
  </div>

  <!-- SACCO -->
  <div id="saccoSection" class="content hidden fade-in">
    <div class="section-title">üí∞ SACCO Savings</div>
    <div class="section-sub">Save smart. Earn guaranteed returns. Withdraw on Mondays.</div>
    <div id="saccoAlert"></div>

    <!-- Active SACCO plan (shown when user has one) -->
    <div id="saccoActiveWrap" class="hidden"></div>

    <!-- Plans (hidden when active plan exists) -->
    <div id="saccoPlansWrap">
      <div class="balance-hero" style="margin-bottom:14px">
        <div class="balance-label">Available to Invest</div>
        <div class="balance-value" id="saccoBal">0</div>
        <div class="balance-currency">UGX</div>
      </div>

      <!-- Amount input -->
      <div class="card" id="saccoAmtCard" style="display:none">
        <div style="font-weight:700;margin-bottom:4px" id="saccoSelTitle">Selected Plan</div>
        <div style="font-size:.76rem;color:var(--muted);margin-bottom:13px" id="saccoSelSub">Enter your investment amount below</div>
        <div class="fg" style="margin-bottom:10px">
          <label>Amount (UGX)</label>
          <input type="number" id="saccoAmtInput" placeholder="Enter amount" oninput="saccoPreview()">
        </div>
        <div id="saccoPreviewBox" style="display:none;background:var(--bg3);border-radius:var(--rs);padding:14px;margin-bottom:13px">
          <div style="display:flex;justify-content:space-between;margin-bottom:7px;font-size:.84rem">
            <span style="color:var(--muted)">You invest</span><span id="saccoPreviewIn" style="font-family:'JetBrains Mono',monospace;font-weight:700">‚Äî</span>
          </div>
          <div style="display:flex;justify-content:space-between;margin-bottom:7px;font-size:.84rem">
            <span style="color:var(--muted)">Return rate</span><span id="saccoPreviewRate" style="color:var(--green);font-weight:700">‚Äî</span>
          </div>
          <div style="display:flex;justify-content:space-between;margin-bottom:7px;font-size:.84rem">
            <span style="color:var(--muted)">Profit</span><span id="saccoPreviewProfit" style="color:var(--gold);font-weight:700;font-family:'JetBrains Mono',monospace">‚Äî</span>
          </div>
          <div style="height:1px;background:var(--border-s);margin:10px 0"></div>
          <div style="display:flex;justify-content:space-between;font-size:.95rem">
            <span style="font-weight:700">You receive</span><span id="saccoPreviewOut" style="font-family:'JetBrains Mono',monospace;font-weight:800;color:var(--green);font-size:1.05rem">‚Äî</span>
          </div>
          <div style="margin-top:8px;font-size:.74rem;color:var(--muted);text-align:center" id="saccoPreviewDate">‚Äî</div>
        </div>
        <div style="display:flex;gap:8px">
          <button class="btn btn-surface" style="flex:1" onclick="cancelSaccoSelect()">Cancel</button>
          <button class="btn btn-gold" style="flex:2" id="saccoConfirmBtn" onclick="confirmSaccoPurchase()">üí∞ Confirm &amp; Save</button>
        </div>
      </div>

      <div style="font-size:.72rem;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.08em;margin-bottom:10px;margin-top:4px">Choose a Savings Plan</div>
      <div id="saccoModalsList"></div>

      <div class="card" style="background:rgba(74,124,247,.05);border-color:rgba(74,124,247,.2);margin-top:4px">
        <div style="font-weight:700;margin-bottom:8px;font-size:.88rem">üìå SACCO Rules</div>
        <div style="font-size:.76rem;color:var(--muted);line-height:1.75">
          ‚úÖ One active plan at a time<br>
          üìÖ Withdrawals open every <strong style="color:var(--gold)">Monday</strong> after maturity<br>
          üìà Higher duration = higher return rate<br>
          üîí Funds locked until maturity date<br>
          üí≥ Pay from any earnings category
        </div>
      </div>
    </div>
  </div>

  <!-- PROFILE -->
  <div id="profileSection" class="content hidden fade-in">
    <div id="profileAlert"></div>
    <div class="profile-hero">
      <div class="avatar" id="profileAvatar">
        <span id="profileInitials">?</span>
        <label class="avatar-edit" title="Change photo">üì∑<input type="file" accept="image/*" style="display:none" onchange="uploadPic(event)"></label>
      </div>
      <img id="profileImg" class="avatar-img">
      <div style="font-family:'Playfair Display',serif;font-size:1.35rem;font-weight:700" id="profileName">‚Äî</div>
      <div style="font-size:.8rem;color:var(--muted);margin-top:3px" id="profileEmail">‚Äî</div>
      <div style="margin-top:10px" id="profileLvlBadge"></div>
    </div>
    <div class="card">
      <div style="font-weight:700;margin-bottom:13px">Account Information</div>
      <div class="info-row">
        <span class="info-label">Full Name</span>
        <div style="display:flex;align-items:center;gap:8px"><span class="info-val" id="profileNameVal">‚Äî</span><button onclick="toggleNameEdit()" style="background:none;border:none;color:var(--gold);cursor:pointer;font-size:.78rem;font-weight:600">Edit</button></div>
      </div>
      <div id="nameEditBox" class="hidden" style="margin:8px 0 12px">
        <input type="text" id="nameEditInput" style="width:100%;padding:10px 12px;background:var(--bg3);border:1px solid var(--gold);border-radius:var(--rs);color:var(--text);font-family:'DM Sans',sans-serif;margin-bottom:7px">
        <div style="display:flex;gap:7px"><button class="btn btn-green" style="flex:1;padding:9px" onclick="saveName()">Save</button><button class="btn btn-surface" style="flex:1;padding:9px" onclick="cancelName()">Cancel</button></div>
      </div>
      <div class="info-row"><span class="info-label">Email</span><span class="info-val" id="profileEmailVal">‚Äî</span></div>
      <div class="info-row">
        <span class="info-label">Phone Number</span>
        <div style="display:flex;align-items:center;gap:8px"><span class="info-val" id="profilePhoneVal">‚Äî</span><button onclick="togglePhoneEdit()" style="background:none;border:none;color:var(--gold);cursor:pointer;font-size:.78rem;font-weight:600">Edit</button></div>
      </div>
      <div id="phoneEditBox" class="hidden" style="margin:8px 0 12px">
        <input type="tel" id="phoneEditInput" style="width:100%;padding:10px 12px;background:var(--bg3);border:1px solid var(--gold);border-radius:var(--rs);color:var(--text);font-family:'DM Sans',sans-serif;margin-bottom:7px" placeholder="07XXXXXXXX">
        <div style="display:flex;gap:7px"><button class="btn btn-green" style="flex:1;padding:9px" onclick="savePhone()">Save</button><button class="btn btn-surface" style="flex:1;padding:9px" onclick="cancelPhone()">Cancel</button></div>
      </div>
      <div class="info-row"><span class="info-label">Joined</span><span class="info-val" id="profileJoined">‚Äî</span></div>
      <div class="info-row"><span class="info-label">Status</span><span class="info-val" id="profileStatus">‚Äî</span></div>
    </div>
    <div class="card">
      <div style="font-weight:700;margin-bottom:13px">Statistics</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:9px">
        <div class="stat-tile"><div class="stat-tile-value" id="profVaults">0</div><div class="stat-tile-label">Vaults</div></div>
        <div class="stat-tile"><div class="stat-tile-value" id="profLevel">‚Äî</div><div class="stat-tile-label">Level</div></div>
        
        <div class="stat-tile"><div class="stat-tile-value" id="profSacco">‚Äî</div><div class="stat-tile-label">SACCO Status</div></div>
      </div>
    </div>
    <div class="card card-gold">
      <div style="font-weight:700;margin-bottom:9px">Your Referral Code</div>
      <div style="font-family:'JetBrains Mono',monospace;font-size:1.7rem;font-weight:700;color:var(--gold);text-align:center;letter-spacing:.12em;margin-bottom:13px" id="profRefCode">‚Äî</div>
      <button class="btn btn-outline btn-full" onclick="copyRefCode()">üìã Copy Code</button>
    </div>
    <div class="card" style="padding:0"><button class="btn btn-full" onclick="logout()" style="background:rgba(232,68,90,.12);color:var(--red);border:1px solid rgba(232,68,90,.3);border-radius:var(--r);padding:15px;font-weight:700">üö™ Sign Out</button></div>
  </div>

  <nav class="bottom-nav">
    <button class="nav-item active" data-section="home" onclick="showSection('home')"><span class="nav-icon">üè†</span>Home</button>
    <button class="nav-item" data-section="vault" onclick="showSection('vault')"><span class="nav-icon">üè¶</span>Vault</button>
    <button class="nav-item" data-section="referrals" onclick="showSection('referrals')"><span class="nav-icon">üë•</span>Refer</button>
    <button class="nav-item" data-section="tasks" onclick="showSection('tasks')"><span class="nav-icon">‚úÖ</span>Tasks</button>
    <button class="nav-item" data-section="wallet" onclick="showSection('wallet')"><span class="nav-icon">üíº</span>Wallet</button>
    <button class="nav-item" data-section="sacco" onclick="showSection('sacco')"><span class="nav-icon">üí∞</span>SACCO</button>
    <button class="nav-item" data-section="profile" onclick="showSection('profile')"><span class="nav-icon">üë§</span>Profile</button>
  </nav>
  </div><!-- /#contentArea -->
</div><!-- /#userDashboard -->

<!-- INSTALL BANNER -->
<div id="installBanner">
  <div style="font-size:2rem">üè¶</div>
  <div style="flex:1">
    <div style="font-weight:700;font-size:.9rem">Install VaultPro</div>
    <div style="font-size:.75rem;color:var(--muted);margin-top:2px">Add to home screen for the best experience</div>
  </div>
  <button id="installBtn" class="btn btn-gold" style="padding:9px 14px;font-size:.8rem;flex-shrink:0">Install</button>
  <button onclick="dismissInstall()" style="background:none;border:none;color:var(--dim);cursor:pointer;font-size:1.2rem;padding:4px;flex-shrink:0">‚úï</button>
</div>

<!-- ADMIN DASHBOARD -->
<div id="adminDashboard" class="admin-wrap hidden">
  <div class="admin-header" style="max-width:100%;position:sticky;top:0;z-index:100;grid-column:1/-1">
    <span style="font-family:'Playfair Display',serif;font-size:1.15rem;color:var(--gold)">üè¶ VaultPro Admin</span>
    <button class="btn btn-surface" style="padding:7px 14px;font-size:.78rem" onclick="logout()">Sign Out</button>
  </div>
  <!-- Mobile tabs -->
  <div class="admin-tabs">
    <button class="admin-tab active" onclick="showAdmin('stats',this)">üìä Stats</button>
    <button class="admin-tab" onclick="showAdmin('users',this)">üë• Users</button>
    <button class="admin-tab" onclick="showAdmin('tasks',this)">‚úÖ Tasks</button>
    <button class="admin-tab" onclick="showAdmin('deposits',this)">üí∞ Deposits</button>
    <button class="admin-tab" onclick="showAdmin('withdrawals',this)">üí∏ Withdrawals</button>
    <button class="admin-tab" onclick="showAdmin('transactions',this)">üìã Transactions</button>
    <button class="admin-tab" onclick="showAdmin('sacco',this)">üè¶ SACCO</button>
  </div>
  <!-- Desktop sidebar nav -->
  <nav id="adminSideNav" style="display:none">
    <div class="side-nav-section">Admin Panel</div>
    <button class="side-nav-item active" onclick="showAdmin('stats',this)"><span class="side-nav-icon">üìä</span><span class="side-nav-label">Stats</span></button>
    <button class="side-nav-item" onclick="showAdmin('users',this)"><span class="side-nav-icon">üë•</span><span class="side-nav-label">Users</span></button>
    <button class="side-nav-item" onclick="showAdmin('tasks',this)"><span class="side-nav-icon">‚úÖ</span><span class="side-nav-label">Tasks</span></button>
    <button class="side-nav-item" onclick="showAdmin('deposits',this)"><span class="side-nav-icon">üí∞</span><span class="side-nav-label">Deposits</span></button>
    <button class="side-nav-item" onclick="showAdmin('withdrawals',this)"><span class="side-nav-icon">üí∏</span><span class="side-nav-label">Withdrawals</span></button>
    <button class="side-nav-item" onclick="showAdmin('transactions',this)"><span class="side-nav-icon">üìã</span><span class="side-nav-label">Transactions</span></button>
    <button class="side-nav-item" onclick="showAdmin('sacco',this)"><span class="side-nav-icon">üè¶</span><span class="side-nav-label">SACCO</span></button>
    <div style="margin-top:auto;padding:16px 20px;border-top:1px solid var(--border-s)">
      <button class="btn btn-outline" style="width:100%;padding:10px;font-size:.8rem" onclick="logout()">Sign Out</button>
    </div>
  </nav>
  <div class="admin-content">
    <div id="adminStats">
      <div class="admin-stats-grid">
        <div class="admin-stat"><div class="admin-stat-val" id="aTotal">0</div><div class="admin-stat-lbl">Total Users</div></div>
        <div class="admin-stat"><div class="admin-stat-val" id="aBalance">0</div><div class="admin-stat-lbl">Total Balance</div></div>
        <div class="admin-stat"><div class="admin-stat-val" id="aDeposits">0</div><div class="admin-stat-lbl">Deposits</div></div>
        <div class="admin-stat"><div class="admin-stat-val" id="aWithdraws">0</div><div class="admin-stat-lbl">Withdrawals</div></div>
        <div class="admin-stat"><div class="admin-stat-val" id="aActive">0</div><div class="admin-stat-lbl">Active Users</div></div>
        <div class="admin-stat"><div class="admin-stat-val" id="aPending">0</div><div class="admin-stat-lbl">Pending W/D</div></div>
      </div>
      <div class="card">
        <div style="font-weight:700;margin-bottom:7px">üèÜ Weekly Prize System</div>
        <div style="font-size:.78rem;color:var(--muted);margin-bottom:13px">50,000 UGX auto-credited each week to the top referrer who has 8+ referrals <strong style="color:var(--gold)">with active vault plans</strong>. Runs every Monday at midnight.</div>
        <button class="btn btn-gold" onclick="runWeeklyPrize()">‚ñ∂ Run Weekly Prize Now</button>
      </div>
      <div class="card" style="background:linear-gradient(135deg,rgba(201,168,76,.08),rgba(201,168,76,.02));border-color:var(--border)">
        <div style="font-weight:700;margin-bottom:7px">üîó Your Invitation Link</div>
        <div style="font-size:.78rem;color:var(--muted);margin-bottom:10px">Share this link or code to let people register on VaultPro</div>
        <div id="adminRefCodeDisplay" style="background:var(--bg3);border:1px solid var(--border);border-radius:var(--rs);padding:12px 14px;font-family:'JetBrains Mono',monospace;font-size:.85rem;color:var(--gold);word-break:break-all;margin-bottom:10px">Loading‚Ä¶</div>
        <div style="display:flex;gap:8px">
          <button class="btn btn-outline" style="flex:1;padding:10px;font-size:.8rem" onclick="copyAdminRefLink()">üìã Copy Link</button>
          <button class="btn btn-surface" style="flex:1;padding:10px;font-size:.8rem" onclick="shareAdminRefLink()">üì§ Share</button>
        </div>
      </div>
    </div>

    <div id="adminUsers" class="hidden">
      <div class="card" style="padding:0;overflow:hidden">
        <div style="padding:14px;font-weight:700;border-bottom:1px solid var(--border-s)">All Users</div>
        <div id="adminUsersList" style="overflow-x:auto"></div>
      </div>
    </div>

    <div id="adminTasks" class="hidden">
      <div class="card">
        <div style="font-weight:700;margin-bottom:14px">‚ûï Add New Task</div>
        <div class="fg"><label>Task Type</label>
          <select id="taskType" onchange="updateTaskForm()">
            <option value="youtube">üì∫ YouTube Watch</option>
            <option value="youtube_sub">üîî YouTube Subscribe</option>
            <option value="tiktok">üéµ TikTok Watch</option>
            <option value="visit">üåê Visit Website</option>
          </select>
        </div>
        <div class="fg"><label>Task Title</label><input type="text" id="taskTitle" placeholder="e.g. Watch our latest product review"></div>
        <div class="fg"><label>Description</label><textarea id="taskDesc" placeholder="Explain what the user should do‚Ä¶"></textarea></div>
        <div class="fg" id="taskUrlGroup"><label id="taskUrlLabel">YouTube URL</label><input type="url" id="taskUrl" placeholder="https://youtube.com/watch?v=..."></div>
        <div class="fg hidden" id="taskReadingGroup"><label>Reading Content</label><textarea id="taskReading" placeholder="Paste the article/content users should read‚Ä¶" style="min-height:150px"></textarea></div>
        <div class="alert alert-info" style="margin-bottom:12px;font-size:.78rem">‚ÑπÔ∏è Task rewards are automatically determined by each user's active vault plan ‚Äî no manual reward needed.</div>
        <div class="fg"><label>Timer Duration (seconds)</label><input type="number" id="taskTimer" placeholder="e.g. 60" value="60"></div>
        <button class="btn btn-green btn-full" onclick="addTask()">Add Task</button>
      </div>
      <div class="card">
        <div style="font-weight:700;margin-bottom:14px">All Tasks</div>
        <div id="adminTasksList" style="color:var(--muted)">Loading‚Ä¶</div>
      </div>
    </div>

    <div id="adminDeposits" class="hidden">
      <div style="font-weight:700;margin-bottom:12px">Deposit Requests</div>
      <div id="adminDepList" style="color:var(--muted)">Loading‚Ä¶</div>
    </div>

    <div id="adminWithdrawals" class="hidden">
      <div style="font-weight:700;margin-bottom:12px">Withdrawal Requests</div>
      <div id="adminWdList" style="color:var(--muted)">Loading‚Ä¶</div>
    </div>

    <div id="adminTransactions" class="hidden">
      <div class="card" style="padding:0;overflow:hidden">
        <div style="padding:14px;font-weight:700;border-bottom:1px solid var(--border-s)">All Transactions</div>
        <div style="overflow-x:auto"><table><thead><tr><th>User</th><th>Type</th><th>Amount</th><th>Date</th></tr></thead><tbody id="adminTxList"><tr><td colspan="4" style="text-align:center;color:var(--muted)">Loading‚Ä¶</td></tr></tbody></table></div>
      </div>
    </div>

    <!-- ADMIN SACCO PANEL -->
    <div id="adminSacco" class="hidden">
      <div style="font-weight:700;margin-bottom:4px">üè¶ SACCO Plans</div>
      <div style="font-size:.75rem;color:var(--muted);margin-bottom:14px">Review all active plans. Revoke any plan purchased with vault principal (not earnings) ‚Äî funds are returned to the user's balance.</div>

      <!-- Filter bar -->
      <div style="display:flex;gap:8px;margin-bottom:14px;flex-wrap:wrap">
        <button class="btn btn-surface" style="padding:7px 14px;font-size:.78rem" onclick="loadAdminSacco('all')">All</button>
        <button class="btn btn-surface" style="padding:7px 14px;font-size:.78rem" onclick="loadAdminSacco('active')">Active</button>
        <button class="btn btn-surface" style="padding:7px 14px;font-size:.78rem" onclick="loadAdminSacco('invalid')">‚ö†Ô∏è Suspicious</button>
        <button class="btn btn-surface" style="padding:7px 14px;font-size:.78rem" onclick="loadAdminSacco('revoked')">Revoked</button>
      </div>

      <div id="adminSaccoList" style="color:var(--muted)">Loading‚Ä¶</div>
    </div>
  </div>
</div>

<!-- PAYMENT MODAL -->
<div id="payModal" class="modal-overlay hidden">
  <div class="modal-sheet">
    <div class="modal-handle"></div>
    <div class="modal-title">üí≥ Payment Source</div>
    <div style="color:var(--muted);font-size:.875rem;margin-bottom:18px" id="payModalDesc"></div>
    <div id="payModalOpts"></div>
  </div>
</div>

<!-- NOTIFICATION PANEL -->
<div id="notifPanel" class="notif-panel hidden" onclick="if(event.target===this)closeNotif()">
  <div class="notif-sheet">
    <div style="padding:16px 18px;border-bottom:1px solid var(--border-s);display:flex;justify-content:space-between;align-items:center">
      <span style="font-family:'Playfair Display',serif;font-size:1.1rem;font-weight:700">Notifications</span>
      <button onclick="closeNotif()" style="background:none;border:none;color:var(--muted);cursor:pointer;font-size:1.1rem">‚úï</button>
    </div>
    <div id="notifList"><div style="padding:28px;text-align:center;color:var(--muted)">No notifications</div></div>
  </div>
</div>

<!-- SUCCESS OVERLAY -->
<div id="successOverlay" class="success-overlay hidden">
  <div class="success-icon" id="successIcon">üí∞</div>
  <div style="font-family:'Playfair Display',serif;font-size:1.8rem;font-weight:800;color:var(--gold);margin-bottom:10px" id="successTitle">Success!</div>
  <div style="color:var(--muted);font-size:.9rem;margin-bottom:30px" id="successMsg"></div>
  <button class="btn btn-gold" onclick="document.getElementById('successOverlay').classList.add('hidden')">Continue</button>
</div>

<!-- IMAGE LIGHTBOX -->
<div id="imgLightbox" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.9);z-index:3000;align-items:center;justify-content:center" onclick="this.style.display='none'">
  <img id="lightboxImg" style="max-width:90%;max-height:90vh;border-radius:var(--rs)">
</div>

<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
<script>
// ============================================================
// FIREBASE CONFIG
// ============================================================
const firebaseConfig = {
  apiKey: "AIzaSyCnMj0_eJEaD2dZNSoeZ_ijsl8ETt4BFhY",
  authDomain: "vaultpro-app.firebaseapp.com",
  projectId: "vaultpro-app",
  storageBucket: "vaultpro-app.firebasestorage.app",
  messagingSenderId: "272074672947",
  appId: "1:272074672947:web:c2459af0c1480f0474cc46",
  measurementId: "G-8XFB9L9H4L"
};

let db, auth, storage, FS, fbReady = false;
try {
  if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
  db = firebase.firestore();
  auth = firebase.auth();
  storage = firebase.storage();
  FS = firebase.firestore.FieldValue; // safe alias - avoids "firebase is not defined" inside async fns
  fbReady = true;
} catch(e) { console.error('Firebase init error:', e); }

// ============================================================
// GLOBALS
// ============================================================
let CU = null;
let selectedPlan = null;
let isPurchasing = false;
let statsCache = { data:null, ts:0, ttl:30000 };
let activeTimers = {};
let weekTimerInt = null;

// ============================================================
// VAULT PLANS - Matched exactly to first snippet structure
// amount, dailyTasks, taskReward -> monthly = dailyTasks * taskReward * 30
// profitPct is always 30%
// ============================================================
const PLANS = {
  beginner: {
    name:'Beginner', emoji:'üå±', amount:45000,
    days:30, dailyTasks:1, taskReward:450, level:1,
    monthlyEarnings:13500  // 1 * 450 * 30
  },
  seed: {
    name:'Seed', emoji:'üå±', amount:180000,
    days:30, dailyTasks:3, taskReward:600, level:2,
    monthlyEarnings:54000  // 3 * 600 * 30
  },
  rising: {
    name:'Rising', emoji:'üåÖ', amount:600000,
    days:30, dailyTasks:6, taskReward:3333, level:3,
    monthlyEarnings:180000  // rounded from 3333*6*30=599940~=180K
  },
  nova: {
    name:'Nova', emoji:'üí°', amount:1350000,
    days:30, dailyTasks:11, taskReward:4091, level:4,
    monthlyEarnings:405000  // 11*4091*30~=405K
  },
  mastermind: {
    name:'Mastermind', emoji:'üß†', amount:4050000,
    days:30, dailyTasks:18, taskReward:7500, level:5,
    monthlyEarnings:1215000  // 18*7500*30=1,215,000
  },
  titan: {
    name:'Titan', emoji:'üí™', amount:8775000,
    days:30, dailyTasks:25, taskReward:11700, level:6,
    monthlyEarnings:2632500  // 25*11700*30=2,632,500
  },
  king: {
    name:'King', emoji:'üëë', amount:16650000,
    days:30, dailyTasks:34, taskReward:16307, level:7,
    monthlyEarnings:4995000  // 34*16307*30~=4,995,000
  },
  emperor: {
    name:'Emperor', emoji:'ü¶Ö', amount:29700000,
    days:30, dailyTasks:44, taskReward:22500, level:8,
    monthlyEarnings:8910000  // 44*22500*30=8,910,000
  },
  icon: {
    name:'Icon', emoji:'‚≠ê', amount:48600000,
    days:30, dailyTasks:55, taskReward:29455, level:9,
    monthlyEarnings:14580000  // 55*29455*30~=14,580,000
  },
  supreme: {
    name:'Supreme', emoji:'üëë', amount:74250000,
    days:30, dailyTasks:66, taskReward:37502, level:10,
    monthlyEarnings:22275000  // 66*37502*30~=22,275,000
  },
  legendary: {
    name:'Legendary', emoji:'üèÜ', amount:110000000,
    days:30, dailyTasks:75, taskReward:48888, level:11,
    monthlyEarnings:33000000  // 75*48888*30~=33,000,000
  },
};

const REF_LEVELS = [
  {title:'Member',     icon:'üå±',color:'#1DB87F',min:0},
  {title:'Ambassador', icon:'‚≠ê',color:'#f59e0b',min:10},
  {title:'Executive',  icon:'üíº',color:'#6366f1',min:50},
  {title:'Director',   icon:'üéØ',color:'#8b5cf6',min:100},
  {title:'VP',         icon:'ü¶Ö',color:'#ec4899',min:500},
  {title:'Admin',      icon:'üëë',color:'#C9A84C',min:1000},
  {title:'Shareholder',icon:'üíé',color:'#06b6d4',min:5000},
];

// Referral Career Levels - displayed on home page
const CAREER_LEVELS = [
  {level:1, title:'Admin',       referrals:100,  salary:50000,         icon:'1Ô∏è‚É£', color:'#6366f1', description:'Entry-level leadership. Manages user activity and assists support.'},
  {level:2, title:'Partner',     referrals:500,  salary:200000,        icon:'2Ô∏è‚É£', color:'#ec4899', description:'Trusted user with a growing community under them.'},
  {level:3, title:'Manager',     referrals:1000, salary:500000,        icon:'3Ô∏è‚É£', color:'#10b981', description:'Mid-level leader managing multiple partners.'},
  {level:4, title:'Chief',       referrals:2000, salary:1000000,       icon:'4Ô∏è‚É£', color:'#f59e0b', description:'High-ranking official overseeing major sections of the network.'},
  {level:5, title:'Partner King',referrals:5000, salary:2000000,       icon:'5Ô∏è‚É£', color:'#ef4444', description:'Top-tier promoter managing large networks.'},
  {level:6, title:'Shareholder', referrals:10000,salary:'20% of funds',icon:'6Ô∏è‚É£', color:'#8b5cf6', description:'Ultimate recognition - becomes part-owner of the project.'},
];

// ============================================================
// UTILS
// ============================================================
function $(id){ return document.getElementById(id); }
function set(id, v){ const e=$(id); if(e) e.textContent=v; }
function hideAll(){
  ['loadingScreen','referralLandingPage','registerPage','loginPage','adminSetupPage','userDashboard','adminDashboard']
    .forEach(id=>{ const e=$(id); if(e) e.classList.add('hidden'); });
}

function toast(msg, icon='‚ÑπÔ∏è', type='info', dur=4000){
  const c=$('toastCont'), t=document.createElement('div');
  const colors={success:'#1DB87F',error:'#E8445A',warning:'#C9A84C',info:'#4A7CF7'};
  t.className='toast';
  t.style.borderLeftColor=colors[type]||colors.info;
  t.innerHTML=`<span style="font-size:1.1rem">${icon}</span><div style="flex:1;font-size:.85rem;font-weight:600">${msg}</div><button class="toast-close" onclick="this.parentElement.remove()">‚úï</button>`;
  c.appendChild(t);
  setTimeout(()=>t.remove&&t.remove(),dur);
}

function showAlert(id, msg, type){
  const el=$(id); if(!el) return;
  const icons={success:'‚úÖ',error:'‚ùå',warning:'‚ö†Ô∏è',info:'‚ÑπÔ∏è'};
  el.innerHTML=`<div class="alert alert-${type}">${icons[type]||''} ${msg}</div>`;
  setTimeout(()=>{ if(el) el.innerHTML=''; },7000);
}

function toggleCollapse(id){
  const body=$(id), caret=$(id+'Caret');
  body.classList.toggle('open');
  if(caret) caret.classList.toggle('open');
}

function calcVaultLevel(vaults){
  const t=vaults.reduce((s,v)=>s+(v.amount||0),0);
  if(t>=110000000) return {level:'Legendary',icon:'üèÜ'};
  if(t>=74250000)  return {level:'Supreme',  icon:'üëë'};
  if(t>=48600000)  return {level:'Icon',     icon:'‚≠ê'};
  if(t>=29700000)  return {level:'Emperor',  icon:'ü¶Ö'};
  if(t>=16650000)  return {level:'King',     icon:'üëë'};
  if(t>=8775000)   return {level:'Titan',    icon:'üí™'};
  if(t>=4050000)   return {level:'Mastermind',icon:'üß†'};
  if(t>=1350000)   return {level:'Nova',     icon:'üí°'};
  if(t>=600000)    return {level:'Rising',   icon:'üåÖ'};
  if(t>=180000)    return {level:'Seed',     icon:'üå±'};
  if(t>=45000)     return {level:'Beginner', icon:'üå±'};
  return {level:'Newcomer',icon:'-'};
}

function getRefLevel(refs){
  for(let i=REF_LEVELS.length-1;i>=0;i--) if(refs>=REF_LEVELS[i].min) return REF_LEVELS[i];
  return REF_LEVELS[0];
}

function extractYouTubeId(url){
  try{
    const u=new URL(url);
    if(u.hostname.includes('youtu.be')) return u.pathname.slice(1);
    return u.searchParams.get('v')||null;
  }catch(e){ return null; }
}

// ============================================================
// SCREENSHOT - stored as base64 in Firestore (avoids CORS/Storage rules issues)
// ============================================================
function previewScreenshot(input, previewId){
  const f=input.files[0]; if(!f) return;
  const label=$('depScreenshotLabel');
  if(label) label.textContent=f.name;
  const reader=new FileReader();
  reader.onload=e=>{
    const img=$(previewId);
    if(img){ img.src=e.target.result; img.style.display='block'; }
  };
  reader.readAsDataURL(f);
}

/**
 * Reads an image file and returns a compressed base64 data URL.
 * Compresses to max 800px and quality 0.7 to keep Firestore doc under 1MB.
 */
function compressAndGetBase64(file){
  return new Promise((resolve, reject)=>{
    const reader=new FileReader();
    reader.onerror=()=>reject(new Error('File read failed'));
    reader.onload=e=>{
      const img=new Image();
      img.onerror=()=>reject(new Error('Image load failed'));
      img.onload=()=>{
        const MAX=800;
        let w=img.width, h=img.height;
        if(w>MAX||h>MAX){
          if(w>h){ h=Math.round(h*(MAX/w)); w=MAX; }
          else { w=Math.round(w*(MAX/h)); h=MAX; }
        }
        const canvas=document.createElement('canvas');
        canvas.width=w; canvas.height=h;
        canvas.getContext('2d').drawImage(img,0,0,w,h);
        resolve(canvas.toDataURL('image/jpeg',0.7));
      };
      img.src=e.target.result;
    };
    reader.readAsDataURL(file);
  });
}

function showImgLightbox(src){
  $('lightboxImg').src=src;
  $('imgLightbox').style.display='flex';
}

// ============================================================
// REFERRAL LINK STORAGE
// ============================================================
function storeRef(code){ if(!code)return; localStorage.setItem('vp_ref',JSON.stringify({code,exp:Date.now()+86400000})); sessionStorage.setItem('vp_ref_s',code); }
function getStoredRef(){ const s=sessionStorage.getItem('vp_ref_s'); if(s)return s; try{const p=JSON.parse(localStorage.getItem('vp_ref')||'{}'); if(p.code&&Date.now()<p.exp)return p.code; localStorage.removeItem('vp_ref');}catch(e){} return null; }
function clearRef(){ localStorage.removeItem('vp_ref'); sessionStorage.removeItem('vp_ref_s'); }

// ============================================================
// INIT
// ============================================================
async function init(){
  $('loadingScreen').classList.remove('hidden');
  if(!fbReady){ $('loadingScreen').classList.add('hidden'); showLogin(); toast('Firebase not ready','‚ö†Ô∏è','warning'); return; }
  const urlRef=new URLSearchParams(window.location.search).get('ref');
  if(urlRef){ storeRef(urlRef); window.history.replaceState({},'',window.location.pathname); }
  auth.onAuthStateChanged(async user=>{
    if(user){
      try{
        const d=await db.collection('users').doc(user.uid).get();
        if(d.exists){
          CU={id:user.uid,...d.data()};
          $('loadingScreen').classList.add('hidden');
          if(CU.isAdmin) showAdminDashboard();
          else{ showUserDashboard(); initNotifListener(); }
          return;
        }
      }catch(e){ console.error(e); }
    }
    $('loadingScreen').classList.add('hidden');
    const stored=getStoredRef();
    if(stored) showReferralLanding(stored); else showLogin();
  });
}

function showReferralLanding(code){
  hideAll();
  $('referralLandingPage').classList.remove('hidden');
  $('landingCode').textContent=code;
  storeRef(code);
}

// ============================================================
// AUTH
// ============================================================
async function register(){
  const btn=$('registerBtn'); btn.disabled=true; btn.textContent='Creating‚Ä¶';
  try{
    const code=$('inviteCode').value.trim().toUpperCase();
    const name=$('fullName').value.trim();
    const email=$('email').value.trim();
    const phone=$('regPhone').value.trim();
    const pwd=$('password').value;
    const cpwd=$('confirmPassword').value;
    if(!code||!name||!email||!pwd){ showAlert('registerAlert','Please fill in all fields','error'); return; }
    if(pwd.length<6){ showAlert('registerAlert','Password must be at least 6 characters','error'); return; }
    if(pwd!==cpwd){ showAlert('registerAlert','Passwords do not match','error'); return; }
    const refQ=await db.collection('users').where('referralCode','==',code).get();
    if(refQ.empty){ showAlert('registerAlert','Invalid invitation code','error'); return; }
    const refId=refQ.docs[0].id;
    const cred=await auth.createUserWithEmailAndPassword(email,pwd);
    const uid=cred.user.uid;
    const newUser={id:uid,fullName:name,email,phone:phone||'',balance:0,referredBy:refId,
      referralCode:Math.random().toString(36).substring(2,8).toUpperCase(),
      joinedDate:new Date().toISOString(),isAdmin:false,isActivated:true,
      activationDate:new Date().toISOString(),currentStreak:0,longestStreak:0,
      lastLoginDate:null,totalPoints:0,pointsBalance:0,totalTaskEarnings:0};
    await db.collection('users').doc(uid).set(newUser);
    await db.collection('users').doc(refId).collection('referrals').doc(uid).set({userId:uid,name,email,date:new Date().toISOString(),earnings:0});
    clearRef();
    showAlert('registerAlert','üéâ Account created! Signing you in‚Ä¶','success');
  }catch(e){
    const msgs={'auth/email-already-in-use':'Email already registered','auth/weak-password':'Password too weak','auth/invalid-email':'Invalid email'};
    showAlert('registerAlert',msgs[e.code]||'Registration failed: '+e.message,'error');
  }finally{ btn.disabled=false; btn.textContent='Create Account'; }
}

async function login(){
  const btn=$('loginBtn'); btn.disabled=true; btn.textContent='Signing in‚Ä¶';
  try{
    const email=$('loginEmail').value.trim(), pwd=$('loginPassword').value;
    if(!email||!pwd){ showAlert('loginAlert','Please enter email and password','error'); return; }
    const cred=await auth.signInWithEmailAndPassword(email,pwd);
    const d=await db.collection('users').doc(cred.user.uid).get();
    if(!d.exists){ showAlert('loginAlert','Account not found','error'); await auth.signOut(); return; }
    CU={id:cred.user.uid,...d.data()};
    // streak removed
  }catch(e){
    const msgs={'auth/user-not-found':'No account with this email','auth/wrong-password':'Incorrect password','auth/too-many-requests':'Too many attempts - try later','auth/invalid-credential':'Invalid email or password'};
    showAlert('loginAlert',msgs[e.code]||'Login failed','error');
  }finally{ btn.disabled=false; btn.textContent='Sign In'; }
}

async function logout(){ if(!confirm('Sign out?'))return; await auth.signOut(); CU=null; clearInterval(weekTimerInt); Object.values(activeTimers).forEach(clearInterval); showLogin(); }

// ============================================================
// NAVIGATION
// ============================================================
function showLogin(){ hideAll(); $('loginPage').classList.remove('hidden'); }
function showRegister(){ hideAll(); $('registerPage').classList.remove('hidden'); }

// Check if an admin already exists before showing setup
async function checkAndShowAdminSetup(){
  try{
    const snap=await db.collection('users').where('isAdmin','==',true).limit(1).get();
    if(!snap.empty){
      toast('Admin account already exists. Use the login page.','üîí','warning');
      return;
    }
    hideAll();
    $('adminSetupPage').classList.remove('hidden');
  }catch(e){ toast('Error checking admin status: '+e.message,'‚ùå','error'); }
}

async function createAdminAccount(){
  const name=$('adminSetupName').value.trim();
  const email=$('adminSetupEmail').value.trim();
  const phone=$('adminSetupPhone').value.trim();
  const pass=$('adminSetupPass').value;
  const pass2=$('adminSetupPass2').value;
  if(!name||!email||!phone||!pass){ showAlert('adminSetupAlert','Please fill all fields','error'); return; }
  if(pass!==pass2){ showAlert('adminSetupAlert','Passwords do not match','error'); return; }
  if(pass.length<6){ showAlert('adminSetupAlert','Password must be at least 6 characters','error'); return; }
  try{
    // Double-check no admin exists
    const snap=await db.collection('users').where('isAdmin','==',true).limit(1).get();
    if(!snap.empty){ showAlert('adminSetupAlert','Admin already exists. Cannot create another.','error'); return; }

    // Create Firebase Auth account
    const cred=await auth.createUserWithEmailAndPassword(email,pass);
    const uid=cred.user.uid;

    // Generate a referral code for the admin (this is the "invitation link" starter)
    const refCode='ADMIN'+Math.random().toString(36).substring(2,8).toUpperCase();

    await db.collection('users').doc(uid).set({
      fullName:name,
      email,
      phone,
      isAdmin:true,
      isActivated:true,
      referralCode:refCode,
      referredBy:null,
      balance:0,
      pointsBalance:0,
      totalReferrals:0,
      joinedDate:new Date().toISOString(),
      currentStreak:0,
      longestStreak:0,
    });

    // Store invitation code in a global invitations collection so anyone can use it to register
    await db.collection('invitationCodes').doc(refCode).set({
      code:refCode,
      ownerId:uid,
      ownerName:name,
      isActive:true,
      createdAt:new Date().toISOString()
    });

    toast(`‚úÖ Admin account created! Your referral/invite code is: ${refCode}`,'üéâ','success',10000);
    setTimeout(()=>showLogin(),3000);
  }catch(e){
    let msg=e.message;
    if(e.code==='auth/email-already-in-use') msg='That email is already registered. Use the login page.';
    showAlert('adminSetupAlert',msg,'error');
  }
}
function showRegisterFromReferral(){
  showRegister();
  const code=getStoredRef();
  if(code){ const f=$('inviteCode'); f.value=code; f.readOnly=true; f.style.borderColor='var(--green)'; }
}

function showUserDashboard(){
  hideAll();
  $('userDashboard').classList.remove('hidden');
  setTimeout(()=>showSection('home'),50);
  updateUserStats();
  loadLeaderboard();
  renderCareerLevels();
  // Silently auto-revoke any SACCO plans bought with vault principal
  autoRevokeBadSaccoPlans();
  startWeekTimer();
  listenForWithdrawalApproval();
}

function showAdminDashboard(){
  hideAll();
  $('adminDashboard').classList.remove('hidden');
  loadAdminStats();
}

function showSection(s){
  if(!CU) return;
  ['home','vault','referrals','tasks','wallet','sacco','profile'].forEach(x=>{
    const e=$(x+'Section'); if(e) e.classList.add('hidden');
  });
  const el=$(s+'Section');
  if(el){ el.classList.remove('hidden'); el.classList.add('fade-in'); }
  // Sync both bottom nav and sidebar
  updateSidebarActive(s);
  // Scroll content area to top on section change
  const ca=$('contentArea');
  if(ca) ca.scrollTop=0; else window.scrollTo(0,0);
  if(s==='home'){ updateUserStats(); }
  else if(s==='vault'){ loadVaultSection(); }
  else if(s==='referrals'){ loadReferrals(); }
  else if(s==='tasks'){ loadTasks(); }
  else if(s==='wallet'){ loadWallet(); }
  else if(s==='sacco'){ loadSacco(); }
  else if(s==='profile'){ refreshCU().then(()=>loadProfile()); }
}

function showAdmin(s, btn){
  ['stats','users','tasks','deposits','withdrawals','transactions','sacco'].forEach(x=>{
    const e=$('admin'+x.charAt(0).toUpperCase()+x.slice(1));
    if(e) e.classList.add('hidden');
  });
  const el=$('admin'+s.charAt(0).toUpperCase()+s.slice(1));
  if(el) el.classList.remove('hidden');
  // Sync both tab bar and sidebar
  document.querySelectorAll('.admin-tab').forEach(t=>t.classList.remove('active'));
  if(btn) btn.classList.add('active');
  document.querySelectorAll('#adminSideNav .side-nav-item').forEach(t=>t.classList.remove('active'));
  if(btn && btn.closest('#adminSideNav')) btn.classList.add('active');
  if(s==='users') loadAdminUsers();
  else if(s==='tasks') loadAdminTasks();
  else if(s==='deposits') loadAdminDeposits();
  else if(s==='withdrawals') loadAdminWithdrawals();
  else if(s==='transactions') loadAdminTransactions();
  else if(s==='sacco') loadAdminSacco('all');
  else loadAdminStats();
}

// ============================================================
// Streak removed
async function updateStreak(uid, user){ /* no-op */ }

// ============================================================
// USER STATS
// ============================================================
async function updateUserStats(force=false){
  if(!CU) return;
  try{
    const now=Date.now();
    if(!force&&statsCache.data&&(now-statsCache.ts)<statsCache.ttl){ applyStats(statsCache.data); return; }
    const[ud,vs,rs,cb]=await Promise.all([
      db.collection('users').doc(CU.id).get(),
      db.collection('users').doc(CU.id).collection('vaults').get(),
      db.collection('users').doc(CU.id).collection('referrals').get(),
      getCatBalances(CU.id),
    ]);
    CU={id:CU.id,...ud.data()};
    const vaults=vs.docs.map(d=>d.data());
    const data={balance:CU.balance||0,refs:rs.size,cb,user:CU,vaults};
    statsCache={data,ts:now,ttl:30000};
    applyStats(data);
    $('headerSub').textContent=CU.fullName||'User';
    const link=$('userRefLink');
    if(link) link.textContent=`${location.origin}${location.pathname}?ref=${CU.referralCode}`;
    if(CU.isActivated) $('activeBadge').classList.remove('hidden');
    if(CU.phone){ const wp=$('wdPhone'); if(wp) wp.value=CU.phone; }
  }catch(e){ console.error('Stats:',e); }
}

function applyStats({balance,refs,cb,user,vaults}){
  set('totalBalance',(balance||0).toLocaleString());
  set('statRefs',refs);
  set('statTask',(cb.taskEarnings||0).toLocaleString());
  set('statRef',(cb.referralEarnings||0).toLocaleString());
  set('statWeeklyPrize',(cb.weeklyPrize||0).toLocaleString());
  const active=vaults.filter(v=>v.status==='active');
  set('statLevel',calcVaultLevel(active).level);
  set('walletBal',(balance||0).toLocaleString());
  set('walletPts',(user.pointsBalance||0).toLocaleString());
  set('vaultBalance',(balance||0).toLocaleString());
}

function clearStatsCache(){ statsCache={data:null,ts:0,ttl:30000}; }

async function getCatBalances(uid){
  try{
    const snap=await db.collection('transactions').where('userId','==',uid).get();
    const b={taskEarnings:0,referralEarnings:0,vaultEarnings:0,depositEarnings:0,weeklyPrize:0,saccoReturn:0};
    snap.docs.forEach(d=>{
      const t=d.data(),a=t.amount||0;
      if(t.type==='task_completion') b.taskEarnings+=a;
      else if(t.type==='referral') b.referralEarnings+=a;
      else if(t.type==='weekly_prize') b.weeklyPrize+=a;
      // vault_maturity = profit only (30% monthly return credited to balance)
      else if(t.type==='vault_maturity') b.vaultEarnings+=a;
      // vault_purchase is NOT counted as spendable earnings - it's locked principal
      else if(t.type==='deposit') b.depositEarnings+=a;
      else if(t.type==='sacco_return') b.saccoReturn+=a;
      else if(['withdrawal','withdrawal_approved'].includes(t.type)){
        const k=t.sourceCategory||'depositEarnings';
        b[k]=Math.max(0,(b[k]||0)-Math.abs(a));
      }
      // sacco_deposit deducts from the source category it used
      else if(t.type==='sacco_deposit'&&t.sourceCategory){
        b[t.sourceCategory]=Math.max(0,(b[t.sourceCategory]||0)-Math.abs(a));
      }
    });
    Object.keys(b).forEach(k=>{b[k]=Math.max(0,b[k])});
    return b;
  }catch(e){ return {taskEarnings:0,referralEarnings:0,vaultEarnings:0,depositEarnings:0,weeklyPrize:0,saccoReturn:0}; }
}

async function getVaultLevel(uid){
  try{
    const snap=await db.collection('users').doc(uid).collection('vaults').get();
    const active=snap.docs.map(d=>d.data()).filter(v=>v.status==='active');
    if(!active.length) return {planName:'None',level:0,dailyTasks:0,taskReward:0};
    const top=active.sort((a,b)=>b.amount-a.amount)[0];
    const pk=Object.keys(PLANS).find(k=>PLANS[k].name===top.planName);
    if(!pk) return {planName:'None',level:0,dailyTasks:0,taskReward:0};
    const p=PLANS[pk];
    return {planName:p.name,level:p.level,dailyTasks:p.dailyTasks,taskReward:p.taskReward};
  }catch(e){ return {planName:'None',level:0,dailyTasks:0,taskReward:0}; }
}

async function refreshCU(){
  if(!CU?.id) return;
  try{ const d=await db.collection('users').doc(CU.id).get(); if(d.exists) CU={id:CU.id,...d.data()}; }catch(e){}
}

// ============================================================
// VAULT SECTION - Uses PLANS from first snippet
// ============================================================
async function loadVaultSection(){
  const vi=await getVaultLevel(CU.id);
  const bal=CU.balance||0;
  set('vaultBalance',bal.toLocaleString());
  const el=$('plansList'); if(!el) return;

  el.innerHTML=Object.entries(PLANS).map(([key,p])=>{
    const isOwned=vi.planName===p.name;
    const isLower=vi.level>0&&p.level<vi.level;
    const canAfford=bal>=p.amount;
    let badge='';
    if(isOwned) badge=`<span class="badge badge-success">‚úì Owned</span>`;
    else if(p.level===2) badge=`<span class="badge badge-blue">Popular</span>`;
    else if(p.level===11) badge=`<span class="badge badge-warning">Ultimate</span>`;
    const disabled=isLower?'style="opacity:.45;pointer-events:none"':'';
    const affordIndicator=!isOwned&&!isLower
      ? `<div style="margin-top:8px;font-size:.7rem;padding:4px 8px;border-radius:6px;display:inline-block;background:${canAfford?'rgba(29,184,127,.12)':'rgba(232,68,90,.12)'};color:${canAfford?'var(--green)':'var(--red)'};">${canAfford?'‚úì You can afford this':'‚ö° Need '+(p.amount-bal).toLocaleString()+' UGX more'}</div>`
      : '';

    return `<div class="plan-card ${isOwned?'owned':''}" ${disabled} onclick="selectPlan('${key}',event)">
      <div class="plan-header">
        <div><div class="plan-name">${p.emoji} ${p.name}</div><div class="plan-amount">${p.amount.toLocaleString()} UGX</div></div>
        ${badge}
      </div>
      <div class="plan-stats">
        <div class="plan-stat"><div class="plan-stat-val">${p.dailyTasks}/day</div><div class="plan-stat-lbl">Tasks</div></div>
        <div class="plan-stat"><div class="plan-stat-val">${p.taskReward.toLocaleString()}</div><div class="plan-stat-lbl">UGX/Task</div></div>
        <div class="plan-stat"><div class="plan-stat-val">${(p.dailyTasks*p.taskReward).toLocaleString()}</div><div class="plan-stat-lbl">Daily Max</div></div>
        <div class="plan-stat"><div class="plan-stat-val">${p.monthlyEarnings.toLocaleString()}</div><div class="plan-stat-lbl">Monthly (30%)</div></div>
      </div>
      ${affordIndicator}
    </div>`;
  }).join('');
}

// ============================================================
// SELECT PLAN - Shows confirm panel (sufficient) or deposit prompt (insufficient)
// ============================================================
async function selectPlan(key, event){
  if(isPurchasing) return;
  const p=PLANS[key];
  const vi=await getVaultLevel(CU.id);

  if(vi.planName===p.name){ toast('You already own this plan','üí°','warning'); return; }
  if(vi.level>0&&p.level<vi.level){ toast('You have a higher plan already','üí°','warning'); return; }

  // Highlight selected card
  document.querySelectorAll('.plan-card').forEach(c=>c.classList.remove('selected'));
  if(event && event.currentTarget) event.currentTarget.classList.add('selected');

  const bal=CU.balance||0;
  const det=$('selectedPlanDetails');
  det.classList.remove('hidden');

  if(bal < p.amount){
    // ‚îÄ‚îÄ INSUFFICIENT BALANCE: show deposit prompt ‚îÄ‚îÄ
    selectedPlan=null;
    const shortfall=(p.amount-bal).toLocaleString();
    $('purchaseSumContent').innerHTML=`
      <div style="text-align:center;padding:8px 0 4px">
        <div style="font-size:2.5rem;margin-bottom:10px">üí∏</div>
        <div style="font-family:'Playfair Display',serif;font-size:1.1rem;font-weight:700;margin-bottom:6px">${p.emoji} ${p.name} Plan</div>
        <div style="font-size:.85rem;color:var(--muted);margin-bottom:14px">You need <strong style="color:var(--red)">${shortfall} UGX</strong> more to activate this plan.</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
          <div style="background:var(--bg3);border-radius:var(--rs);padding:10px;text-align:center">
            <div style="font-family:'JetBrains Mono',monospace;font-size:.88rem;font-weight:700;color:var(--muted)">${bal.toLocaleString()}</div>
            <div style="font-size:.65rem;color:var(--dim);margin-top:2px">Your Balance</div>
          </div>
          <div style="background:var(--bg3);border-radius:var(--rs);padding:10px;text-align:center">
            <div style="font-family:'JetBrains Mono',monospace;font-size:.88rem;font-weight:700;color:var(--gold)">${p.amount.toLocaleString()}</div>
            <div style="font-size:.65rem;color:var(--dim);margin-top:2px">Plan Cost</div>
          </div>
        </div>
      </div>`;
    const btn=$('purchaseBtn');
    btn.textContent='üí∞ Deposit Funds';
    btn.className='btn btn-green';
    btn.style.flex='2';
    btn.onclick=()=>{
      cancelPlanSelection();
      showSection('wallet');
      showWalletTab('dep');
      toast(`Deposit at least ${shortfall} UGX to activate ${p.name}`,'üí°','info',6000);
    };
  } else {
    // ‚îÄ‚îÄ SUFFICIENT BALANCE: show confirm purchase ‚îÄ‚îÄ
    selectedPlan=key;
    const dailyMax=p.dailyTasks*p.taskReward;
    $('purchaseSumContent').innerHTML=`
      <div style="font-family:'Playfair Display',serif;font-size:1.1rem;font-weight:700;margin-bottom:14px">${p.emoji} ${p.name} Plan - Confirm Purchase</div>
      <div class="sum-row"><span class="sum-label">Investment Cost</span><span class="sum-val">${p.amount.toLocaleString()} UGX</span></div>
      <div class="sum-row"><span class="sum-label">Your Balance</span><span class="sum-val" style="color:var(--green)">${bal.toLocaleString()} UGX ‚úì</span></div>
      <div class="sum-row"><span class="sum-label">Duration</span><span class="sum-val">${p.days} days</span></div>
      <div class="sum-row"><span class="sum-label">Tasks Per Day</span><span class="sum-val">${p.dailyTasks} tasks</span></div>
      <div class="sum-row"><span class="sum-label">Reward Per Task</span><span class="sum-val">${p.taskReward.toLocaleString()} UGX</span></div>
      <div class="sum-row"><span class="sum-label">Daily Maximum</span><span class="sum-val">${dailyMax.toLocaleString()} UGX</span></div>
      <div class="sum-row" style="border-top:2px solid var(--border);margin-top:4px;padding-top:12px"><span class="sum-label" style="font-weight:700;color:var(--text)">Monthly Earnings (30%)</span><span class="sum-val hi">+${p.monthlyEarnings.toLocaleString()} UGX</span></div>`;
    const btn=$('purchaseBtn');
    btn.textContent='‚úÖ Confirm Purchase';
    btn.className='btn btn-gold';
    btn.style.flex='2';
    btn.onclick=purchaseVault;
  }

  det.scrollIntoView({behavior:'smooth',block:'nearest'});
}

function cancelPlanSelection(){
  selectedPlan=null;
  $('selectedPlanDetails').classList.add('hidden');
  document.querySelectorAll('.plan-card').forEach(c=>c.classList.remove('selected'));
}

// ============================================================
// PURCHASE VAULT
// ============================================================
async function purchaseVault(){
  if(!selectedPlan||isPurchasing) return;
  const p=PLANS[selectedPlan];
  showCatSelectModal(p.amount, (cat,catName)=>doVaultPurchase(cat,catName));
}

async function showCatSelectModal(amount, callback){
  const b=await getCatBalances(CU.id);
  const cats=[
    {key:'depositEarnings',label:'üí∞ Deposit Funds',bal:b.depositEarnings},
    {key:'referralEarnings',label:'üë• Referral Earnings',bal:b.referralEarnings},
    {key:'taskEarnings',label:'‚úÖ Task Earnings',bal:b.taskEarnings},
    {key:'vaultEarnings',label:'üè¶ Vault Profits',bal:b.vaultEarnings},
  ];
  const modal=$('payModal');
  $('payModalDesc').textContent=`Select earnings source for ${amount.toLocaleString()} UGX:`;
  const opts=$('payModalOpts');
  opts.innerHTML='';
  let anyAvail=false;
  cats.forEach(c=>{
    const ok=c.bal>=amount;
    if(ok) anyAvail=true;
    const div=document.createElement('div');
    div.className=`pay-opt${ok?'':' disabled'}`;
    div.innerHTML=`<div style="flex:1"><div style="font-weight:700;font-size:.9rem">${c.label}</div><div style="font-size:.78rem;color:var(--muted)">Available: ${c.bal.toLocaleString()} UGX</div></div><span style="color:${ok?'var(--green)':'var(--red)'}">${ok?'‚úì':'‚úó'}</span>`;
    if(ok) div.onclick=()=>{ closePayModal(); callback(c.key,c.label); };
    opts.appendChild(div);
  });
  if(!anyAvail){
    const info=document.createElement('div');
    info.className='alert alert-warning';
    info.textContent='‚ÑπÔ∏è No single earnings category has enough balance. Please deposit more funds.';
    opts.appendChild(info);
  }
  modal.classList.remove('hidden');
  modal.onclick=e=>{ if(e.target===modal) closePayModal(); };
}
function closePayModal(){ $('payModal').classList.add('hidden'); }

async function doVaultPurchase(sourceCategory, categoryName){
  if(isPurchasing) return;
  isPurchasing=true;
  const btn=$('purchaseBtn'); btn.disabled=true; btn.textContent='Processing‚Ä¶';
  try{
    const p=PLANS[selectedPlan];
    if((CU.balance||0)<p.amount){ toast('Insufficient funds','‚ùå','error'); return; }
    await db.collection('users').doc(CU.id).update({balance:FS.increment(-p.amount)});
    CU.balance=(CU.balance||0)-p.amount;
    const start=new Date(), end=new Date(start.getTime()+p.days*86400000);
    await db.collection('users').doc(CU.id).collection('vaults').add({
      planName:p.name,amount:p.amount,duration:p.days,
      dailyTasks:p.dailyTasks,taskReward:p.taskReward,
      startDate:start.toISOString(),maturityDate:end.toISOString(),
      status:'active',isMatured:false
    });
    await db.collection('transactions').add({userId:CU.id,userName:CU.fullName,type:'vault_purchase',amount:p.amount,sourceCategory,categoryName,planName:p.name,date:new Date().toISOString()});
    if(CU.referredBy){
      const bonus=Math.floor(p.amount*0.10);
      const rd=await db.collection('users').doc(CU.referredBy).get();
      if(rd.exists){
        await db.collection('users').doc(CU.referredBy).update({balance:FS.increment(bonus)});
        await db.collection('transactions').add({userId:CU.referredBy,userName:rd.data().fullName,type:'referral',amount:bonus,description:`10% bonus from ${CU.fullName} - ${p.name}`,date:new Date().toISOString()});
        await sendNotif(CU.referredBy,'referral_bonus',`You earned ${bonus.toLocaleString()} UGX referral bonus from ${CU.fullName}!`);
      }
    }
    toast(`${p.emoji} ${p.name} vault activated!`,'üéâ','success',6000);
    clearStatsCache();
    setTimeout(()=>{
      cancelPlanSelection();
      selectedPlan=null;
      updateUserStats(true);
      loadVaultSection();
      showSection('home');
      isPurchasing=false;
      btn.disabled=false; btn.textContent='‚úÖ Confirm Purchase';
    },2000);
  }catch(e){
    toast('Purchase failed: '+e.message,'‚ùå','error');
    isPurchasing=false; btn.disabled=false; btn.textContent='‚úÖ Confirm Purchase';
  }
}

// ============================================================
// TASKS - tasks shown = plan's dailyTasks limit exactly
// Timer starts immediately when user clicks Start Task
// YouTube: hidden iframe revealed + autoplay on click
// TikTok/Subscribe/Visit: link opens + timer starts simultaneously
// ============================================================
async function loadTasks(){
  const vi=await getVaultLevel(CU.id);
  const today=new Date().toDateString();
  const [yt,et]=await Promise.all([
    db.collection('taskSubmissions').where('userId','==',CU.id).where('date','==',today).get(),
    db.collection('externalTaskSubmissions').where('userId','==',CU.id).where('date','==',today).get(),
  ]);
  const done=yt.size+et.size, limit=vi.dailyTasks;
  const doneIds=new Set([...yt.docs.map(d=>d.data().taskId),...et.docs.map(d=>d.data().taskId)]);
  set('taskProgText',`${done} / ${limit}`);
  const pb=$('taskProgBar');
  if(pb) pb.style.width=limit>0?`${Math.min(100,(done/limit)*100)}%`:'0%';

  if(limit===0){
    $('tasksList').innerHTML=`<div class="card" style="text-align:center;padding:30px"><div style="font-size:2.4rem;margin-bottom:10px">üè¶</div><div style="font-weight:700;margin-bottom:7px">No Active Plan</div><div style="color:var(--muted);font-size:.875rem;margin-bottom:14px">Purchase a vault plan to unlock daily tasks</div><button class="btn btn-gold btn-full" onclick="showSection('vault')">View Plans</button></div>`;
    return;
  }

  if(done>=limit){
    $('tasksList').innerHTML=`<div class="card" style="text-align:center;padding:28px"><div style="font-size:2.4rem;margin-bottom:10px">üéâ</div><div style="font-weight:700;color:var(--gold);margin-bottom:7px">All Tasks Complete!</div><div style="color:var(--muted);font-size:.875rem">Come back tomorrow for more rewards</div></div>`;
    return;
  }

  const tasksSnap=await db.collection('tasks').where('isActive','==',true).get();
  // Filter out already-done tasks, then slice to exactly how many remain today
  const remaining=limit-done;
  const availableTasks=tasksSnap.docs
    .map(d=>({id:d.id,...d.data()}))
    .filter(t=>!doneIds.has(t.id))
    .slice(0, remaining); // ‚Üê KEY: only show tasks equal to remaining slots

  if(!availableTasks.length){
    $('tasksList').innerHTML=`<div class="card" style="text-align:center;color:var(--muted);padding:28px">No tasks available right now. Check back later!</div>`;
    return;
  }

  const typeColors={youtube:'task-type-yt',youtube_sub:'task-type-sub',tiktok:'task-type-tiktok',visit:'task-type-read'};
  const typeLabels={youtube:'üì∫ YouTube Watch',youtube_sub:'üîî Subscribe',tiktok:'üéµ TikTok',visit:'üåê Visit Website'};

  const html=availableTasks.map(t=>{
    const reward=t.reward||vi.taskReward;
    const timerSecs=t.timerSeconds||60;
    const typeClass=typeColors[t.type]||'task-type-yt';
    const encodedUrl=encodeURIComponent(t.url||'');
    const circ=(2*Math.PI*13).toFixed(2);

    // YouTube: show thumbnail preview, YT IFrame API player created on click
    let contentHtml='';
    if(t.type==='youtube'){
      const vid=extractYouTubeId(t.url||'');
      if(vid){
        contentHtml=`
          <!-- Thumbnail shown before start -->
          <div id="ytThumb-${t.id}" style="position:relative;cursor:pointer;background:#000;border-radius:var(--rs) var(--rs) 0 0;overflow:hidden" onclick="startTask('${t.id}','youtube',${reward},${timerSecs},'${encodedUrl}')">
            <img src="https://img.youtube.com/vi/${vid}/hqdefault.jpg" style="width:100%;aspect-ratio:16/9;object-fit:cover;display:block;opacity:.85">
            <div style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center">
              <div style="width:64px;height:64px;background:rgba(255,0,0,.92);border-radius:50%;display:flex;align-items:center;justify-content:center;box-shadow:0 4px 24px rgba(0,0,0,.6)">
                <div style="width:0;height:0;border-top:13px solid transparent;border-bottom:13px solid transparent;border-left:20px solid #fff;margin-left:5px"></div>
              </div>
            </div>
            <div style="position:absolute;bottom:0;left:0;right:0;padding:10px 14px;background:linear-gradient(transparent,rgba(0,0,0,.85));font-size:.76rem;color:rgba(255,255,255,.9);font-weight:600">‚ñ∂ Tap to play - timer starts automatically</div>
          </div>
          <!-- YT player container - hidden until start -->
          <div id="ytPlayer-${t.id}" class="hidden" style="border-radius:var(--rs) var(--rs) 0 0;overflow:hidden;aspect-ratio:16/9;background:#000"></div>
          <!-- Pause warning -->
          <div id="ytPauseWarn-${t.id}" class="hidden" style="background:rgba(232,68,90,.12);border-bottom:2px solid var(--red);padding:9px 14px;font-size:.78rem;color:var(--red);font-weight:600;text-align:center">
            ‚è∏Ô∏è Timer paused - resume the video to continue earning
          </div>`;
      }
    } else if(t.type==='youtube_sub'){
      contentHtml=`<div style="background:linear-gradient(135deg,rgba(255,0,0,.08),rgba(0,0,0,.03));border-radius:var(--rs) var(--rs) 0 0;padding:20px;text-align:center;border-bottom:1px solid var(--border-s)">
        <div style="font-size:2rem;margin-bottom:6px">üì∫</div>
        <div style="font-weight:700;font-size:.88rem;margin-bottom:3px">${t.title}</div>
        <div style="font-size:.74rem;color:var(--muted);margin-bottom:6px">Tap <strong style="color:var(--gold)">Start Task</strong> - the channel opens &amp; timer begins</div>
      </div>`;
    } else if(t.type==='tiktok'){
      contentHtml=`<div style="background:linear-gradient(135deg,rgba(0,0,0,.25),rgba(105,201,208,.05));border-radius:var(--rs) var(--rs) 0 0;padding:20px;text-align:center;border-bottom:1px solid var(--border-s)">
        <div style="font-size:2rem;margin-bottom:6px">üéµ</div>
        <div style="font-weight:700;font-size:.88rem;margin-bottom:3px">${t.title}</div>
        <div style="font-size:.74rem;color:var(--muted);margin-bottom:6px">Tap <strong style="color:var(--gold)">Start Task</strong> - video opens &amp; timer begins</div>
      </div>`;
    } else if(t.type==='visit'){
      contentHtml=`<div style="background:linear-gradient(135deg,rgba(74,124,247,.07),rgba(0,0,0,.02));border-radius:var(--rs) var(--rs) 0 0;padding:20px;text-align:center;border-bottom:1px solid var(--border-s)">
        <div style="font-size:2rem;margin-bottom:6px">üåê</div>
        <div style="font-weight:700;font-size:.88rem;margin-bottom:3px">${t.title}</div>
        <div style="font-size:.74rem;color:var(--muted);margin-bottom:6px">Tap <strong style="color:var(--gold)">Start Task</strong> - site opens &amp; timer begins</div>
      </div>`;
    }

    return `<div class="task-card" id="task-${t.id}">
      <div class="task-type-bar ${typeClass}"></div>
      ${contentHtml}
      <div class="task-card-body">
        <div class="task-header">
          <div class="task-title">${typeLabels[t.type]||'Task'}: ${t.title||'Untitled'}</div>
          <div class="task-reward">+${reward.toLocaleString()} UGX</div>
        </div>
        ${t.description?`<div class="task-desc">${t.description}</div>`:''}

        <!-- Timer - hidden until started -->
        <div class="task-timer hidden" id="timer-${t.id}" style="margin-bottom:11px">
          <div class="task-timer-circle">
            <svg width="32" height="32" viewBox="0 0 32 32">
              <circle class="timer-bg" cx="16" cy="16" r="13"/>
              <circle class="timer-fill" id="timerCircle-${t.id}" cx="16" cy="16" r="13" stroke-dasharray="${circ}" stroke-dashoffset="0"/>
            </svg>
            <div class="timer-count" id="timerNum-${t.id}">${timerSecs}</div>
          </div>
          <span>Counting down‚Ä¶ <strong id="timerSec-${t.id}">${timerSecs}s</strong></span>
        </div>

        <!-- Claim button - hidden until timer done -->
        <div id="claimWrap-${t.id}" class="hidden" style="margin-bottom:8px">
          <button class="btn btn-green btn-full" onclick="completeTask('${t.id}','${t.type}',${reward})">
            ‚úÖ Claim ${reward.toLocaleString()} UGX
          </button>
        </div>

        <!-- START button - clicking this does everything at once -->
        ${t.type==='youtube'
          ? '' /* YouTube uses thumbnail click above as the trigger */
          : `<button class="btn btn-gold btn-full" id="taskBtn-${t.id}"
              onclick="startTask('${t.id}','${t.type}',${reward},${timerSecs},'${encodedUrl}')">
              ${t.type==='youtube_sub'?'üîî Subscribe & Start Timer':
                t.type==='tiktok'?'üéµ Watch & Start Timer':
                'üåê Visit & Start Timer'}
            </button>`
        }
      </div>
    </div>`;
  }).join('');

  $('tasksList').innerHTML=html;
}

// YT IFrame API setup
const ytPlayers={};
const ytTimerPaused={};
let ytApiReady=false;

function loadYTApi(){
  if(window.YT&&window.YT.Player){ ytApiReady=true; return; }
  if(document.getElementById('yt-api-script')) return;
  const s=document.createElement('script');
  s.id='yt-api-script';
  s.src='https://www.youtube.com/iframe_api';
  document.head.appendChild(s);
}
window.onYouTubeIframeAPIReady=function(){ ytApiReady=true; };

function startTask(taskId, type, reward, timerSecs, encodedUrl){
  const url=decodeURIComponent(encodedUrl||'');

  if(type==='youtube'){
    // Show player container, hide thumbnail
    const thumb=$(`ytThumb-${taskId}`);
    const playerDiv=$(`ytPlayer-${taskId}`);
    if(thumb) thumb.style.display='none';
    if(playerDiv) playerDiv.classList.remove('hidden');

    const vidId=extractYouTubeId(url);
    if(!vidId){ toast('Could not load video','‚ùå','error'); return; }

    // Start timer immediately - pause/resume tied to YT player state
    startCountdownTimer(taskId, type, reward, timerSecs, true);

    // Create YT player
    loadYTApi();
    const tryCreate=()=>{
      if(!window.YT||!window.YT.Player){ setTimeout(tryCreate,300); return; }
      ytPlayers[taskId]=new YT.Player(`ytPlayer-${taskId}`,{
        videoId:vidId,
        playerVars:{autoplay:1,rel:0,modestbranding:1,playsinline:1},
        events:{
          onStateChange:(e)=>{
            const warn=$(`ytPauseWarn-${taskId}`);
            if(e.data===YT.PlayerState.PLAYING){
              // Video playing - resume timer
              ytTimerPaused[taskId]=false;
              if(warn) warn.classList.add('hidden');
            } else if(e.data===YT.PlayerState.PAUSED||e.data===YT.PlayerState.BUFFERING){
              // Paused or buffering - freeze timer
              ytTimerPaused[taskId]=true;
              if(e.data===YT.PlayerState.PAUSED&&warn) warn.classList.remove('hidden');
            } else if(e.data===YT.PlayerState.ENDED){
              // Video ended before timer - keep timer running
              ytTimerPaused[taskId]=false;
              if(warn) warn.classList.add('hidden');
            }
          }
        }
      });
    };
    tryCreate();

  } else {
    // TikTok / Subscribe / Visit
    // Show in-app overlay for mobile instead of leaving the tab
    if(type==='tiktok'||type==='visit'){
      showInAppBrowser(url, taskId);
    } else {
      // youtube_sub - must open externally (YouTube blocks iframes)
      window.open(url,'_blank');
    }
    // Hide start button
    const btn=$(`taskBtn-${taskId}`);
    if(btn) btn.style.display='none';
    // Start timer immediately
    startCountdownTimer(taskId, type, reward, timerSecs, false);
  }
}

function startCountdownTimer(taskId, type, reward, timerSecs, useYTPause){
  const timer=$(`timer-${taskId}`);
  if(timer) timer.classList.remove('hidden');

  const circle=$(`timerCircle-${taskId}`);
  const numEl=$(`timerNum-${taskId}`);
  const secEl=$(`timerSec-${taskId}`);
  const circ=2*Math.PI*13;
  let remaining=timerSecs;
  if(circle) circle.style.strokeDashoffset='0';
  ytTimerPaused[taskId]= useYTPause ? true : false;

  // Sync in-app browser at start
  if(type==='tiktok'||type==='visit') updateInAppBrowserProgress(remaining, timerSecs);

  const interval=setInterval(()=>{
    if(useYTPause && ytTimerPaused[taskId]) return;

    remaining--;
    const pct=1-(remaining/timerSecs);
    if(circle) circle.style.strokeDashoffset=`${circ*pct}`;
    if(numEl) numEl.textContent=remaining;
    if(secEl) secEl.textContent=`${remaining}s`;

    // Keep in-app browser progress in sync
    if(type==='tiktok'||type==='visit') updateInAppBrowserProgress(remaining, timerSecs);

    if(remaining<=0){
      clearInterval(interval);
      delete activeTimers[taskId];
      if(timer) timer.classList.add('hidden');
      if(ytPlayers[taskId]&&ytPlayers[taskId].pauseVideo) ytPlayers[taskId].pauseVideo();
      // Show claim button behind the overlay - user will see it when they close
      const claimWrap=$(`claimWrap-${taskId}`);
      if(claimWrap){
        claimWrap.classList.remove('hidden');
        // Don't scroll yet - user is in the overlay; they'll close and see it
      }
    }
  },1000);
  activeTimers[taskId]=interval;
}

// ‚îÄ‚îÄ In-App Browser overlay (keeps user in the app) ‚îÄ‚îÄ
function showInAppBrowser(url, taskId){
  const existing=document.getElementById('inAppBrowser');
  if(existing) existing.remove();

  const overlay=document.createElement('div');
  overlay.id='inAppBrowser';
  overlay.style.cssText='position:fixed;inset:0;z-index:5000;background:#0A0C10;display:flex;flex-direction:column;opacity:0;transform:translateY(20px);transition:opacity .3s,transform .3s';

  overlay.innerHTML=`
    <div id="iab-topbar" style="background:#111318;border-bottom:1px solid rgba(255,255,255,.07);flex-shrink:0">
      <div style="display:flex;align-items:center;gap:10px;padding:10px 12px">
        <button id="iab-close-btn" disabled onclick="closeInAppBrowser()"
          title="Complete the timer to unlock"
          style="width:44px;height:44px;border-radius:50%;border:2.5px solid #E8445A;
                 background:rgba(232,68,90,.12);color:#E8445A;font-size:1.2rem;font-weight:900;
                 cursor:not-allowed;display:flex;align-items:center;justify-content:center;
                 flex-shrink:0;transition:all .3s;opacity:.35">&#x2715;</button>
        <div style="flex:1;background:#181C24;border-radius:20px;padding:6px 12px;
                    font-size:.72rem;color:#7E8899;overflow:hidden;white-space:nowrap;text-overflow:ellipsis">${url}</div>
        <div id="iab-badge" style="background:#C9A84C;color:#0A0C10;font-family:monospace;
                                    font-size:.82rem;font-weight:800;padding:5px 11px;
                                    border-radius:20px;flex-shrink:0;min-width:54px;text-align:center">--s</div>
      </div>
      <div style="height:4px;background:rgba(255,255,255,.06)">
        <div id="iab-progress" style="height:4px;background:linear-gradient(90deg,#C9A84C,#E8C96B);width:0%;transition:width 1s linear;border-radius:0 2px 2px 0"></div>
      </div>
      <div id="iab-status" style="padding:5px 14px 8px;font-size:.7rem;color:#7E8899;text-align:center">
        ‚è≥ Stay on this page until the timer completes to earn your reward
      </div>
    </div>
    <iframe src="${url}" style="flex:1;border:none;width:100%;background:#fff"
            allow="autoplay;clipboard-write"
            sandbox="allow-scripts allow-same-origin allow-forms allow-popups allow-popups-to-escape-sandbox"></iframe>
    <div style="background:#111318;border-top:1px solid rgba(255,255,255,.07);padding:10px 14px;text-align:center;flex-shrink:0">
      <div id="iab-bottom" style="font-size:.74rem;color:#7E8899">&#x23F1;&#xFE0F; Do not close ‚Äî timer is counting down</div>
    </div>`;

  document.body.appendChild(overlay);
  requestAnimationFrame(()=>{ overlay.style.opacity='1'; overlay.style.transform='translateY(0)'; });
}

function updateInAppBrowserProgress(remaining, totalSecs){
  const badge=document.getElementById('iab-badge');
  const progress=document.getElementById('iab-progress');
  const closeBtn=document.getElementById('iab-close-btn');
  const status=document.getElementById('iab-status');
  const bottom=document.getElementById('iab-bottom');
  if(!badge) return;

  const pct=Math.min(100,((totalSecs-remaining)/totalSecs)*100);
  if(progress) progress.style.width=pct+'%';

  if(remaining>0){
    badge.textContent=remaining+'s';
    const col=remaining<=10?'#E8445A':remaining<=30?'#f59e0b':'#C9A84C';
    badge.style.background=col;
    badge.style.color=remaining<=10?'#fff':'#0A0C10';
    if(progress) progress.style.background=`linear-gradient(90deg,${col},#E8C96B)`;
  } else {
    // Timer done - UNLOCK the close button
    badge.textContent='Done!';
    badge.style.background='#1DB87F';
    badge.style.color='#fff';
    if(progress){ progress.style.width='100%'; progress.style.background='#1DB87F'; }

    if(closeBtn){
      closeBtn.disabled=false;
      closeBtn.style.cursor='pointer';
      closeBtn.style.opacity='1';
      closeBtn.style.background='#E8445A';
      closeBtn.style.color='#fff';
      closeBtn.style.border='2.5px solid #E8445A';
      closeBtn.style.boxShadow='0 0 0 6px rgba(232,68,90,.35),0 0 20px rgba(232,68,90,.5)';
      closeBtn.style.animation='pulse 1s ease-in-out infinite';
      closeBtn.title='Task complete! Tap to close';
      // Pulse attention
      closeBtn.animate([
        {transform:'scale(1)',boxShadow:'0 0 0 4px rgba(232,68,90,.4)'},
        {transform:'scale(1.12)',boxShadow:'0 0 0 8px rgba(232,68,90,.0)'},
        {transform:'scale(1)',boxShadow:'0 0 0 4px rgba(232,68,90,.4)'}
      ],{duration:900,iterations:Infinity});
    }
    if(status){ status.style.color='#1DB87F'; status.textContent='Task complete! Tap the ‚úï to close and claim your reward.'; }
    if(bottom){ bottom.style.color='#1DB87F'; bottom.textContent='Your reward is ready - close this browser to claim it!'; }
  }
}

function closeInAppBrowser(){
  const closeBtn=document.getElementById('iab-close-btn');
  // Hard block - cannot close while timer is running
  if(closeBtn && closeBtn.disabled) return;
  const el=document.getElementById('inAppBrowser');
  if(el){
    el.style.opacity='0';
    el.style.transform='translateY(20px)';
    el.style.transition='opacity .25s,transform .25s';
    setTimeout(()=>el.remove(),260);
  }
}

const claimingTasks = new Set(); // Prevent double-claim

async function completeTask(taskId, type, reward){
  // Block if already being claimed
  if(claimingTasks.has(taskId)) return;
  claimingTasks.add(taskId);

  // Immediately disable claim button to prevent re-tap
  const claimBtn = document.querySelector(`#claimWrap-${taskId} button`);
  if(claimBtn){ claimBtn.disabled=true; claimBtn.textContent='Processing‚Ä¶'; }

  try{
    // Double-check: make sure not already submitted today
    const today = new Date().toDateString();
    const col = type==='youtube'||type==='youtube_sub'?'taskSubmissions':'externalTaskSubmissions';
    const existing = await db.collection(col)
      .where('userId','==',CU.id).where('taskId','==',taskId).where('date','==',today).limit(1).get();
    if(!existing.empty){
      toast('Task already completed today!','‚ÑπÔ∏è','info');
      claimingTasks.delete(taskId);
      return;
    }

    await db.collection(col).add({userId:CU.id,userName:CU.fullName,taskId,date:today,reward,completedAt:new Date().toISOString(),type});
    await db.collection('users').doc(CU.id).update({balance:FS.increment(reward)});
    CU.balance=(CU.balance||0)+reward;
    await db.collection('transactions').add({userId:CU.id,userName:CU.fullName,type:'task_completion',amount:reward,date:new Date().toISOString()});

    const card=$(`task-${taskId}`);
    if(card){ card.style.opacity='0'; card.style.transition='opacity .4s'; setTimeout(()=>card.remove(),400); }
    clearStatsCache();
    toast(`+${reward.toLocaleString()} UGX earned! üéâ`,'‚úÖ','success');
    setTimeout(()=>loadTasks(),600);
  }catch(e){
    toast('Failed to complete task','‚ùå','error');
    claimingTasks.delete(taskId);
    if(claimBtn){ claimBtn.disabled=false; claimBtn.textContent=`‚úÖ Claim ${reward.toLocaleString()} UGX`; }
  }
}

// ============================================================
// REFERRALS
// ============================================================
async function loadReferrals(){
  try{
    const snap=await db.collection('users').doc(CU.id).collection('referrals').get();
    const refs=snap.docs.map(d=>d.data());
    const total=refs.reduce((s,r)=>s+(r.earnings||0),0);
    set('totalRefEarnings',total.toLocaleString());
    const link=$('userRefLink');
    if(link) link.textContent=`${location.origin}${location.pathname}?ref=${CU.referralCode}`;
    const lvl=getRefLevel(refs.length);
    const ni=REF_LEVELS.findIndex(l=>l.title===lvl.title)+1;
    const next=ni<REF_LEVELS.length?REF_LEVELS[ni]:null;
    const lc=$('refLevelCard');
    if(lc){
      let progress='';
      if(next){
        const pct=Math.min(100,((refs.length-lvl.min)/(next.min-lvl.min))*100);
        progress=`<div style="margin-top:10px"><div style="font-size:.72rem;color:var(--muted);margin-bottom:5px">To ${next.icon} ${next.title}: ${refs.length}/${next.min}</div><div class="prog-wrap"><div class="prog-fill" style="width:${pct}%"></div></div></div>`;
      }
      lc.innerHTML=`<div style="display:flex;align-items:center;gap:12px;margin-bottom:8px"><div style="font-size:1.8rem">${lvl.icon}</div><div><div style="font-weight:700">${lvl.title}</div><div style="font-size:.78rem;color:var(--muted)">${refs.length} referral${refs.length!==1?'s':''}</div></div></div>${progress}`;
    }
    const rl=$('referralsList');
    if(!rl) return;
    if(!refs.length){ rl.innerHTML=`<div style="text-align:center;color:var(--muted);padding:14px">No referrals yet - share your link!</div>`; return; }
    rl.innerHTML=refs.map(r=>`<div class="info-row"><div><div style="font-weight:600">${r.name}</div><div style="font-size:.72rem;color:var(--muted)">${new Date(r.date).toLocaleDateString()}</div></div><span style="color:var(--green);font-weight:700;font-family:'JetBrains Mono',monospace">+${(r.earnings||0).toLocaleString()}</span></div>`).join('');
  }catch(e){ console.error('Referrals:',e); }
}

function copyRefLink(){ const el=$('userRefLink'); if(el) navigator.clipboard.writeText(el.textContent).then(()=>toast('Link copied!','üìã','success')); }
function shareRefLink(){ const link=$('userRefLink')?.textContent; if(navigator.share&&link) navigator.share({title:'Join VaultPro',text:"Uganda's #1 investment platform",url:link}); else copyRefLink(); }
function copyRefCode(){ navigator.clipboard.writeText(CU.referralCode||'').then(()=>toast('Code copied!','üìã','success')); }

// ============================================================
// WALLET
// ============================================================
async function loadWallet(){
  const ud=await db.collection('users').doc(CU.id).get();
  const u=ud.data();
  set('walletBal',(u.balance||0).toLocaleString());
  set('walletPts',(u.pointsBalance||0).toLocaleString());
  if(u.phone){ const wp=$('wdPhone'); if(wp) wp.value=u.phone; }
}

function showWalletTab(t){
  ['dep','wd','hist'].forEach(p=>{ $(`${p}Panel`).classList.add('hidden'); $(`${p}Tab`).classList.remove('active'); });
  $(`${t}Panel`).classList.remove('hidden');
  $(`${t}Tab`).classList.add('active');
  if(t==='hist') loadTxHistory();
}

// ============================================================
// DEPOSIT - base64 screenshot stored in Firestore (fixes admin-side display)
// ============================================================
function onDepMethodChange(){
  const meth = $('depMethod').value;
  const instr = $('depInstructions');
  const fields = $('depFormFields');
  const mtnInfo = $('depMtnInfo');
  const airtelInfo = $('depAirtelInfo');
  const confirm = $('depNameConfirm');
  if(!meth){ instr.classList.add('hidden'); fields.classList.add('hidden'); return; }
  instr.classList.remove('hidden');
  mtnInfo.classList.toggle('hidden', meth !== 'mtn');
  airtelInfo.classList.toggle('hidden', meth !== 'airtel');
  if(confirm) confirm.checked = false;
  fields.classList.remove('hidden');
}

async function submitDeposit(){
  const amt=parseInt($('depAmount').value);
  const meth=$('depMethod').value;
  const phone=$('depPhone').value.trim();
  const screenshotInput=$('depScreenshot');
  const submitBtn=$('depSubmitBtn');
  const nameConfirm=$('depNameConfirm');

  if(!meth){ showAlert('depAlert','Please select a payment method','error'); return; }
  if(!nameConfirm||!nameConfirm.checked){ showAlert('depAlert','Please confirm the recipient name first','warning'); return; }
  if(!amt||amt<1000){ showAlert('depAlert','Minimum deposit is 1,000 UGX','error'); return; }
  if(!phone){ showAlert('depAlert','Please enter your phone number','error'); return; }
  if(!screenshotInput.files[0]){ showAlert('depAlert','Please upload a payment screenshot','error'); return; }

  submitBtn.disabled=true; submitBtn.textContent='Uploading‚Ä¶';
  try{
    // Convert screenshot to compressed base64 - stored directly in Firestore
    // This avoids Firebase Storage CORS issues and ensures admin can always see it
    let screenshotData=null;
    const file=screenshotInput.files[0];
    if(file.size>5*1024*1024){ showAlert('depAlert','Screenshot must be under 5MB','error'); return; }

    try{
      screenshotData=await compressAndGetBase64(file);
    }catch(imgErr){
      console.warn('Image compression failed, storing raw base64:', imgErr);
      screenshotData=await new Promise((res,rej)=>{
        const r=new FileReader();
        r.onload=e=>res(e.target.result);
        r.onerror=()=>rej(new Error('Read failed'));
        r.readAsDataURL(file);
      });
    }

    await db.collection('depositRequests').add({
      userId:CU.id,
      userName:CU.fullName,
      userEmail:CU.email,
      amount:amt,
      method:meth,
      phone,
      screenshotBase64:screenshotData,  // stored as base64 string
      screenshotUrl:null,               // legacy field - null for new submissions
      status:'pending',
      date:new Date().toISOString()
    });

    showAlert('depAlert','‚úÖ Deposit request submitted! Admin will approve shortly.','success');
    $('depAmount').value='';
    $('depPhone').value='';
    screenshotInput.value='';
    $('depPreview').style.display='none';
    $('depScreenshotLabel').textContent='Tap to upload payment screenshot';
  }catch(e){
    showAlert('depAlert','Failed to submit: '+e.message,'error');
  }finally{
    submitBtn.disabled=false; submitBtn.textContent='Submit Deposit Request';
  }
}

async function submitWithdrawal(){
  const cat=$('wdCat').value, amt=parseInt($('wdAmount').value), phone=$('wdPhone').value.trim();
  if(!cat){ showAlert('wdAlert','Please select a category','error'); return; }
  if(!amt||amt<5000){ showAlert('wdAlert','Minimum withdrawal is 5,000 UGX','error'); return; }
  if(!phone){ showAlert('wdAlert','Please enter your phone number','error'); return; }
  if(cat==='task'){ const d=new Date().getDay(); if(d!==5&&d!==6){ showAlert('wdAlert','Task earnings only withdrawable on Friday & Saturday','error'); return; } }
  const b=await getCatBalances(CU.id);
  const bk=cat==='referral'?'referralEarnings':cat==='task'?'taskEarnings':cat==='weeklyPrize'?'weeklyPrize':'vaultEarnings';
  if(b[bk]<amt){ showAlert('wdAlert',`Insufficient ${cat} earnings (available: ${(b[bk]||0).toLocaleString()} UGX)`,'error'); return; }
  const fee=Math.floor(amt*0.05), net=amt-fee;
  try{
    await db.collection('withdrawalRequests').add({
      userId:CU.id,userName:CU.fullName,phone,
      amount:amt,netAmount:net,adminFee:fee,
      category:cat,status:'pending',date:new Date().toISOString()
    });
    showAlert('wdAlert',`Withdrawal of ${net.toLocaleString()} UGX requested (5% fee: ${fee.toLocaleString()} UGX). Processing soon.`,'success');
    $('wdAmount').value='';
  }catch(e){ showAlert('wdAlert','Failed: '+e.message,'error'); }
}

async function loadTxHistory(){
  try{
    const snap=await db.collection('transactions').where('userId','==',CU.id).orderBy('date','desc').limit(25).get();
    const tb=$('txHistory');
    if(!tb) return;
    if(snap.empty){ tb.innerHTML=`<tr><td colspan="4" style="text-align:center;color:var(--muted)">No transactions yet</td></tr>`; return; }
    const types={deposit:'üí∞ Deposit',withdrawal:'üí∏ Withdrawal',referral:'üë• Referral',task_completion:'‚úÖ Task',vault_purchase:'üè¶ Vault',vault_maturity:'üè¶ Matured',points_conversion:'üîÑ Points',withdrawal_approved:'üí∏ Withdrawal',weekly_prize:'üèÜ Weekly Prize'};
    const out=['withdrawal','vault_purchase','withdrawal_approved'];
    tb.innerHTML=snap.docs.map(d=>{
      const t=d.data(), a=t.netAmount||t.amount||0, isOut=out.includes(t.type);
      return `<tr><td>${new Date(t.date).toLocaleDateString()}</td><td>${types[t.type]||t.type}</td><td style="color:${isOut?'var(--red)':'var(--green)'};font-weight:700;font-family:'JetBrains Mono',monospace">${isOut?'-':'+'} ${Math.abs(a).toLocaleString()}</td><td><span class="badge badge-success">Done</span></td></tr>`;
    }).join('');
  }catch(e){ console.error(e); }
}

// ============================================================
// ============================================================
// SACCO - Savings & Credit Co-operative
// ============================================================
const SACCO_PLANS = [
  { id:'s14',  days:14,  label:'14 Days',  emoji:'üå±', tier:'sacco-t1', rate:0.08, minAmount:3000000,   color:'#1DB87F', desc:'Quick save, fast return' },
  { id:'s30',  days:30,  label:'30 Days',  emoji:'üìÖ', tier:'sacco-t2', rate:0.14, minAmount:1500000,   color:'#4A7CF7', desc:'One month, solid growth' },
  { id:'s60',  days:60,  label:'60 Days',  emoji:'üìà', tier:'sacco-t3', rate:0.22, minAmount:600000,    color:'#C9A84C', desc:'Two months of steady gains' },
  { id:'s90',  days:90,  label:'90 Days',  emoji:'üíé', tier:'sacco-t4', rate:0.30, minAmount:600000,    color:'#ec4899', desc:'90-day premium saver' },
  { id:'s120', days:120, label:'120 Days', emoji:'üöÄ', tier:'sacco-t5', rate:0.40, minAmount:290000,    color:'#ef4444', desc:'4 months, high reward' },
  { id:'s365', days:365, label:'1 Year',   emoji:'üëë', tier:'sacco-t6', rate:0.50, minAmount:80000,     color:'#8b5cf6', desc:'Maximum return, ultimate growth' },
];

let selectedSaccoPlan = null;
let saccoTimerInterval = null;

function nextMonday(fromDate){
  const d = new Date(fromDate);
  const day = d.getDay(); // 0=Sun,1=Mon...
  const daysUntilMonday = day===1 ? 7 : (8 - day) % 7 || 7;
  d.setDate(d.getDate() + daysUntilMonday);
  d.setHours(0,0,0,0);
  return d;
}

async function loadSacco(){
  try{
    const ud = await db.collection('users').doc(CU.id).get();
    const u = ud.data();
    // Check for active SACCO
    const snap = await db.collection('saccoPlans')
      .where('userId','==',CU.id).where('status','==','active').limit(1).get();

    if(!snap.empty){
      const plan = {id:snap.docs[0].id, ...snap.docs[0].data()};
      showSaccoActivePlan(plan);
      return;
    }

    // Check for matured SACCO awaiting withdrawal
    const matSnap = await db.collection('saccoPlans')
      .where('userId','==',CU.id).where('status','==','matured').limit(1).get();
    if(!matSnap.empty){
      const plan = {id:matSnap.docs[0].id, ...matSnap.docs[0].data()};
      showSaccoMatured(plan);
      return;
    }

    // No active plan - show plan picker
    $('saccoActiveWrap').classList.add('hidden');
    $('saccoPlansWrap').style.display='';
    renderSaccoPlans();

    // Show available balance
    const b = await getCatBalances(CU.id);
    // Available = deposits + referral + task earnings + vault PROFITS (not vault principal)
    const total = (b.depositEarnings||0)+(b.taskEarnings||0)+(b.referralEarnings||0)+(b.vaultEarnings||0)+(b.saccoReturn||0);
    set('saccoBal', total.toLocaleString());

    // Check for any SACCO that finished countdown but not yet processed
    await checkSaccoMaturity();
  }catch(e){ console.error('SACCO load:',e); }
}

async function checkSaccoMaturity(){
  try{
    const snap = await db.collection('saccoPlans')
      .where('userId','==',CU.id).where('status','==','active').get();
    for(const doc of snap.docs){
      const plan = doc.data();
      const matDate = new Date(plan.maturityDate);
      if(new Date() >= matDate){
        await db.collection('saccoPlans').doc(doc.id).update({status:'matured'});
      }
    }
  }catch(e){}
}

function renderSaccoPlans(){
  const el = $('saccoModalsList'); if(!el) return;
  el.innerHTML = SACCO_PLANS.map(p => {
    const exampleAmt = p.minAmount;
    const profit = Math.floor(exampleAmt * p.rate);
    return `<div class="sacco-card ${p.tier}" onclick="selectSaccoPlan('${p.id}')">
      <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:9px">
        <div>
          <div style="font-size:1.1rem;margin-bottom:2px">${p.emoji} <strong style="font-size:.95rem">${p.label}</strong></div>
          <div style="font-size:.73rem;color:var(--muted)">${p.desc}</div>
        </div>
        <div style="text-align:right;flex-shrink:0">
          <div class="sacco-return" style="color:${p.color}">${(p.rate*100).toFixed(0)}%</div>
          <div style="font-size:.65rem;color:var(--muted);font-weight:600;letter-spacing:.04em">RETURN</div>
        </div>
      </div>
      <div style="display:flex;gap:8px;font-size:.75rem">
        <div style="flex:1;background:var(--bg3);border-radius:6px;padding:7px 10px">
          <div style="color:var(--muted);margin-bottom:2px">Min. Amount</div>
          <div style="font-weight:700;font-family:'JetBrains Mono',monospace">${(p.minAmount/1000).toFixed(0)}K UGX</div>
        </div>
        <div style="flex:1;background:var(--bg3);border-radius:6px;padding:7px 10px">
          <div style="color:var(--muted);margin-bottom:2px">Example profit</div>
          <div style="font-weight:700;color:${p.color};font-family:'JetBrains Mono',monospace">+${(profit/1000).toFixed(0)}K</div>
        </div>
        <div style="flex:1;background:var(--bg3);border-radius:6px;padding:7px 10px">
          <div style="color:var(--muted);margin-bottom:2px">Duration</div>
          <div style="font-weight:700">${p.days}d</div>
        </div>
      </div>
    </div>`;
  }).join('');
}

function selectSaccoPlan(id){
  selectedSaccoPlan = SACCO_PLANS.find(p=>p.id===id);
  if(!selectedSaccoPlan) return;
  document.querySelectorAll('.sacco-card').forEach(c=>c.classList.remove('selected'));
  const cards = document.querySelectorAll('.sacco-card');
  const idx = SACCO_PLANS.findIndex(p=>p.id===id);
  if(cards[idx]) cards[idx].classList.add('selected');

  const p = selectedSaccoPlan;
  const amtCard = $('saccoAmtCard');
  amtCard.style.display='';
  $('saccoSelTitle').textContent = `${p.emoji} ${p.label} - ${(p.rate*100).toFixed(0)}% return`;
  $('saccoSelSub').textContent = `Minimum: ${p.minAmount.toLocaleString()} UGX ¬∑ Lock period: ${p.days} days`;
  $('saccoAmtInput').value='';
  $('saccoPreviewBox').style.display='none';
  amtCard.scrollIntoView({behavior:'smooth',block:'nearest'});
}

function cancelSaccoSelect(){
  selectedSaccoPlan = null;
  $('saccoAmtCard').style.display='none';
  document.querySelectorAll('.sacco-card').forEach(c=>c.classList.remove('selected'));
}

function saccoPreview(){
  const p = selectedSaccoPlan; if(!p) return;
  const amt = parseInt($('saccoAmtInput').value)||0;
  if(amt < p.minAmount){
    $('saccoPreviewBox').style.display='none';
    return;
  }
  const profit = Math.floor(amt * p.rate);
  const total = amt + profit;
  const matDate = new Date(); matDate.setDate(matDate.getDate()+p.days);
  const withdrawDate = nextMonday(matDate);
  const withdrawStr = withdrawDate.toLocaleDateString('en-UG',{weekday:'long',day:'numeric',month:'long',year:'numeric'});

  $('saccoPreviewIn').textContent = amt.toLocaleString()+' UGX';
  $('saccoPreviewRate').textContent = (p.rate*100).toFixed(0)+'% return';
  $('saccoPreviewProfit').textContent = '+'+profit.toLocaleString()+' UGX';
  $('saccoPreviewOut').textContent = total.toLocaleString()+' UGX';
  $('saccoPreviewDate').innerHTML = `üìÖ Matures: <strong>${matDate.toLocaleDateString()}</strong> &nbsp;¬∑&nbsp; üí∞ Withdrawable from: <strong style="color:var(--green)">${withdrawStr}</strong>`;
  $('saccoPreviewBox').style.display='';
}

let saccoConfirming = false;
async function confirmSaccoPurchase(){
  if(saccoConfirming) return;
  const p = selectedSaccoPlan; if(!p) return;
  const amt = parseInt($('saccoAmtInput').value)||0;
  if(amt < p.minAmount){
    showAlert('saccoAlert',`Minimum amount for ${p.label} is ${p.minAmount.toLocaleString()} UGX`,'error');
    return;
  }
  // Show payment source modal
  showCatSelectModal(amt, (cat,catName)=>doSaccoPurchase(p,amt,cat,catName));
}

async function doSaccoPurchase(p, amt, sourceCategory, categoryName){
  if(saccoConfirming) return;
  saccoConfirming = true;
  const btn = $('saccoConfirmBtn');
  if(btn){ btn.disabled=true; btn.textContent='Processing‚Ä¶'; }
  try{
    // ‚îÄ‚îÄ STRICT SOURCE CHECK ‚îÄ‚îÄ
    // Re-fetch live category balances to prevent spending vault principal
    const liveBalances = await getCatBalances(CU.id);
    const allowedKeys = ['depositEarnings','referralEarnings','taskEarnings','vaultEarnings','saccoReturn'];
    if(!allowedKeys.includes(sourceCategory)){
      toast('Invalid payment source. Only earnings may be used for SACCO.','‚ùå','error');
      return;
    }
    const catBal = liveBalances[sourceCategory]||0;
    if(catBal < amt){
      toast(`Insufficient ${categoryName} balance. You have ${catBal.toLocaleString()} UGX available.`,'‚ùå','error');
      return;
    }
    // Also verify raw balance is sufficient (sanity check)
    if((CU.balance||0) < amt){
      toast('Insufficient total balance.','‚ùå','error');
      return;
    }

    // Deduct from user total balance
    await db.collection('users').doc(CU.id).update({balance:FS.increment(-amt)});
    CU.balance = (CU.balance||0)-amt;

    const start = new Date();
    const matDate = new Date(start.getTime()+p.days*86400000);
    const withdrawDate = nextMonday(matDate);
    const profit = Math.floor(amt*p.rate);

    await db.collection('saccoPlans').add({
      userId: CU.id,
      userName: CU.fullName,
      planId: p.id,
      planLabel: p.label,
      days: p.days,
      rate: p.rate,
      principal: amt,
      profit: profit,
      totalReturn: amt+profit,
      sourceCategory,
      categoryName,
      startDate: start.toISOString(),
      maturityDate: matDate.toISOString(),
      withdrawableFrom: withdrawDate.toISOString(),
      status: 'active',
      // Flag to verify this used legitimate earnings
      sourceCategoryVerified: true,
      sourceCategoryBalanceAtPurchase: catBal,
    });

    // Record the debit against the correct earnings category
    await db.collection('transactions').add({
      userId: CU.id,
      userName: CU.fullName,
      type: 'sacco_deposit',
      amount: amt,
      description: `SACCO ${p.label} savings plan`,
      planId: p.id,
      sourceCategory,
      categoryName,
      date: start.toISOString()
    });

    clearStatsCache();
    toast(`${p.emoji} SACCO ${p.label} activated! ${amt.toLocaleString()} UGX from ${categoryName} locked in.`,'üí∞','success',6000);
    cancelSaccoSelect();
    loadSacco();
  }catch(e){
    toast('Failed: '+e.message,'‚ùå','error');
  }finally{
    saccoConfirming=false;
    if(btn){ btn.disabled=false; btn.textContent='üí∞ Confirm & Save'; }
  }
}

function showSaccoActivePlan(plan){
  $('saccoPlansWrap').style.display='none';
  const wrap = $('saccoActiveWrap');
  wrap.classList.remove('hidden');
  renderSaccoCountdown(plan, wrap);
}

function renderSaccoCountdown(plan, container){
  if(saccoTimerInterval) clearInterval(saccoTimerInterval);
  const planInfo = SACCO_PLANS.find(p=>p.id===plan.planId)||{emoji:'üí∞',label:plan.planLabel,color:'#C9A84C'};
  const matDate = new Date(plan.maturityDate);
  const withdrawDate = new Date(plan.withdrawableFrom);
  const totalMs = matDate - new Date(plan.startDate);

  function getTimeLeft(){
    const now = new Date();
    const diff = matDate - now;
    if(diff<=0) return null;
    const d=Math.floor(diff/86400000), h=Math.floor((diff%86400000)/3600000);
    const m=Math.floor((diff%3600000)/60000), s=Math.floor((diff%60000)/1000);
    return {d,h,m,s,diff,pct:Math.max(0,Math.min(100,(1-(diff/totalMs))*100))};
  }

  function render(){
    const tl = getTimeLeft();
    const pct = tl ? tl.pct : 100;
    const circumference = 2*Math.PI*54;
    const offset = circumference*(1-(pct/100));

    container.innerHTML = `
      <div class="sacco-active-card">
        <div style="display:flex;align-items:center;gap:10px;margin-bottom:16px">
          <span style="font-size:1.6rem">${planInfo.emoji}</span>
          <div style="flex:1">
            <div style="font-weight:700;font-size:1rem">${plan.planLabel} SACCO</div>
            <div style="font-size:.74rem;color:var(--muted)">Active ¬∑ ${(plan.rate*100).toFixed(0)}% return</div>
          </div>
          <span class="badge badge-success">üîí Active</span>
        </div>

        <!-- Circular progress -->
        <div style="display:flex;justify-content:center;margin-bottom:18px">
          <div style="position:relative;width:128px;height:128px">
            <svg width="128" height="128" style="transform:rotate(-90deg)">
              <circle cx="64" cy="64" r="54" fill="none" stroke="rgba(255,255,255,.06)" stroke-width="10"/>
              <circle id="saccoRingFill" cx="64" cy="64" r="54" fill="none" stroke="${planInfo.color}" stroke-width="10"
                stroke-linecap="round" stroke-dasharray="${circumference.toFixed(2)}"
                stroke-dashoffset="${offset.toFixed(2)}" style="transition:stroke-dashoffset 1s linear"/>
            </svg>
            <div style="position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center">
              ${tl
                ? `<div style="font-family:'JetBrains Mono',monospace;font-size:1rem;font-weight:700;color:${planInfo.color}">${tl.d}d</div>
                   <div style="font-size:.68rem;color:var(--muted)">${tl.h}h ${tl.m}m</div>`
                : `<div style="font-size:1.5rem">üéâ</div><div style="font-size:.68rem;color:var(--green);font-weight:700">Matured!</div>`
              }
            </div>
          </div>
        </div>

        <!-- Stats row -->
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:14px">
          <div style="background:var(--bg3);border-radius:var(--rs);padding:10px;text-align:center">
            <div style="font-size:.65rem;color:var(--muted);text-transform:uppercase;letter-spacing:.05em;margin-bottom:3px">Saved</div>
            <div style="font-family:'JetBrains Mono',monospace;font-size:.82rem;font-weight:700">${(plan.principal/1000).toFixed(0)}K</div>
          </div>
          <div style="background:var(--bg3);border-radius:var(--rs);padding:10px;text-align:center">
            <div style="font-size:.65rem;color:var(--muted);text-transform:uppercase;letter-spacing:.05em;margin-bottom:3px">Profit</div>
            <div style="font-family:'JetBrains Mono',monospace;font-size:.82rem;font-weight:700;color:var(--green)">+${(plan.profit/1000).toFixed(0)}K</div>
          </div>
          <div style="background:var(--bg3);border-radius:var(--rs);padding:10px;text-align:center">
            <div style="font-size:.65rem;color:var(--muted);text-transform:uppercase;letter-spacing:.05em;margin-bottom:3px">Total</div>
            <div style="font-family:'JetBrains Mono',monospace;font-size:.82rem;font-weight:700;color:var(--gold)">${(plan.totalReturn/1000).toFixed(0)}K</div>
          </div>
        </div>

        <!-- Timeline -->
        <div style="background:var(--bg3);border-radius:var(--rs);padding:12px;font-size:.76rem;line-height:1.75">
          <div style="display:flex;justify-content:space-between"><span style="color:var(--muted)">Started</span><span>${new Date(plan.startDate).toLocaleDateString()}</span></div>
          <div style="display:flex;justify-content:space-between"><span style="color:var(--muted)">Matures</span><span style="font-weight:700">${matDate.toLocaleDateString()}</span></div>
          <div style="display:flex;justify-content:space-between"><span style="color:var(--muted)">Withdrawable</span><span style="color:var(--green);font-weight:700">${withdrawDate.toLocaleDateString('en-UG',{weekday:'short',day:'numeric',month:'short',year:'numeric'})}</span></div>
        </div>

        ${!tl ? `
        <div class="alert alert-success" style="margin-top:12px;margin-bottom:0">
          üéâ Your savings have matured! You will receive <strong>${plan.totalReturn.toLocaleString()} UGX</strong> on <strong>${withdrawDate.toLocaleDateString('en-UG',{weekday:'long',day:'numeric',month:'long'})}</strong>.
        </div>` : `
        <div style="margin-top:12px;font-size:.74rem;color:var(--dim);text-align:center">
          ‚è≥ ${tl.d}d ${tl.h}h ${tl.m}m ${tl.s}s remaining
        </div>`}
      </div>
    `;

    // Update ring dynamically after render
    if(tl){
      saccoTimerInterval = setInterval(()=>{
        const t=getTimeLeft();
        if(!t){ clearInterval(saccoTimerInterval); loadSacco(); return; }
        const o=circumference*(1-(t.pct/100));
        const ring=document.getElementById('saccoRingFill');
        const timeEl=container.querySelector('[data-sacco-time]');
        if(ring) ring.setAttribute('stroke-dashoffset',o.toFixed(2));
        // Update the inner text
        const inner=container.querySelector('.sacco-inner-time');
        if(inner) inner.innerHTML=`<div style="font-family:'JetBrains Mono',monospace;font-size:1rem;font-weight:700;color:${planInfo.color}">${t.d}d</div><div style="font-size:.68rem;color:var(--muted)">${t.h}h ${t.m}m</div>`;
        const footer=container.querySelector('.sacco-footer-time');
        if(footer) footer.textContent=`‚è≥ ${t.d}d ${t.h}h ${t.m}m ${t.s}s remaining`;
      },1000);
    }
  }

  render();
}

function showSaccoMatured(plan){
  $('saccoPlansWrap').style.display='none';
  const wrap=$('saccoActiveWrap');
  wrap.classList.remove('hidden');
  const planInfo=SACCO_PLANS.find(p=>p.id===plan.planId)||{emoji:'üí∞',label:plan.planLabel,color:'#C9A84C'};
  const withdrawDate=new Date(plan.withdrawableFrom);
  const now=new Date();
  const canWithdrawNow=now>=withdrawDate;

  wrap.innerHTML=`
    <div class="sacco-active-card" style="border-color:rgba(29,184,127,.4)">
      <div style="text-align:center;padding:10px 0 16px">
        <div style="font-size:3rem;margin-bottom:8px">üéâ</div>
        <div style="font-family:'Playfair Display',serif;font-size:1.3rem;font-weight:700;color:var(--green)">Plan Matured!</div>
        <div style="font-size:.8rem;color:var(--muted);margin-top:4px">${planInfo.emoji} ${plan.planLabel} ¬∑ ${(plan.rate*100).toFixed(0)}% return</div>
      </div>
      <div style="background:var(--bg3);border-radius:var(--rs);padding:16px;margin-bottom:14px;text-align:center">
        <div style="font-size:.72rem;color:var(--muted);margin-bottom:4px">Total payout</div>
        <div style="font-family:'Playfair Display',serif;font-size:2rem;font-weight:800;color:var(--gold)">${plan.totalReturn.toLocaleString()}</div>
        <div style="font-size:.72rem;color:var(--muted)">UGX &nbsp;¬∑&nbsp; Principal: ${plan.principal.toLocaleString()} + Profit: <span style="color:var(--green)">+${plan.profit.toLocaleString()}</span></div>
      </div>
      ${canWithdrawNow
        ? `<button class="btn btn-green btn-full" onclick="claimSaccoReturn('${plan.id}',${plan.totalReturn})">üí∞ Claim ${plan.totalReturn.toLocaleString()} UGX</button>`
        : `<div class="alert alert-warning" style="margin-bottom:12px">‚è≥ Withdrawable from <strong>${withdrawDate.toLocaleDateString('en-UG',{weekday:'long',day:'numeric',month:'long',year:'numeric'})}</strong></div>
           <button class="btn btn-surface btn-full" disabled>üìÖ Come back on Monday</button>`
      }
    </div>`;
}

let saccoClaimPending=false;
async function claimSaccoReturn(planId, amount){
  if(saccoClaimPending) return;
  saccoClaimPending=true;
  try{
    await db.collection('saccoPlans').doc(planId).update({status:'completed',completedAt:new Date().toISOString()});
    await db.collection('users').doc(CU.id).update({balance:FS.increment(amount)});
    CU.balance=(CU.balance||0)+amount;
    await db.collection('transactions').add({
      userId:CU.id, userName:CU.fullName,
      type:'sacco_return', amount,
      description:'SACCO savings plan return',
      date:new Date().toISOString()
    });
    clearStatsCache();
    toast(`üéâ ${amount.toLocaleString()} UGX added to your balance!`,'üí∞','success',7000);
    loadSacco();
  }catch(e){ toast('Claim failed: '+e.message,'‚ùå','error'); }
  finally{ saccoClaimPending=false; }
}

// stub to avoid errors from old references
function loadStreak(){}
function convertPoints(){}

// ============================================================
// PROFILE
// ============================================================
async function loadProfile(){
  const u=CU;
  const init=$('profileInitials'), img=$('profileImg'), av=$('profileAvatar');
  if(u.profilePicture){ img.src=u.profilePicture; img.style.display='block'; if(av) av.style.display='none'; }
  else { if(init) init.textContent=(u.fullName||'U').split(' ').map(n=>n[0]).join('').toUpperCase().substring(0,2); if(av) av.style.display='flex'; img.style.display='none'; }
  set('profileName',u.fullName||'-'); set('profileEmail',u.email||'-');
  set('profileNameVal',u.fullName||'-'); set('profileEmailVal',u.email||'-');
  set('profilePhoneVal',u.phone||'Not set');
  set('profileJoined',u.joinedDate?new Date(u.joinedDate).toLocaleDateString():'-');
  const sv=$('profileStatus');
  if(sv){ sv.textContent=u.isActivated?'Active':'Pending'; sv.style.color=u.isActivated?'var(--green)':'var(--red)'; }
  set('profRefCode',u.referralCode||'-');
  // streak removed
  // points removed
  const lvl=getRefLevel(u.totalReferrals||0);
  const lb=$('profileLvlBadge');
  if(lb) lb.innerHTML=`<span class="badge badge-warning" style="font-size:.78rem;padding:5px 12px">${lvl.icon} ${lvl.title}</span>`;
  try{
    const vs=await db.collection('users').doc(CU.id).collection('vaults').get();
    set('profVaults',vs.size);
    const active=vs.docs.map(d=>d.data()).filter(v=>v.status==='active');
    set('profLevel',calcVaultLevel(active).level);
  }catch(e){}
}

function toggleNameEdit(){ $('nameEditBox').classList.toggle('hidden'); $('nameEditInput').value=CU.fullName||''; }
function cancelName(){ $('nameEditBox').classList.add('hidden'); }
async function saveName(){
  const n=$('nameEditInput').value.trim();
  if(!n||n.length<2){ showAlert('profileAlert','Name too short','error'); return; }
  await db.collection('users').doc(CU.id).update({fullName:n});
  CU.fullName=n; set('profileName',n); set('profileNameVal',n);
  cancelName(); toast('Name updated','‚úÖ','success');
}
function togglePhoneEdit(){ $('phoneEditBox').classList.toggle('hidden'); $('phoneEditInput').value=CU.phone||''; }
function cancelPhone(){ $('phoneEditBox').classList.add('hidden'); }
async function savePhone(){
  const p=$('phoneEditInput').value.trim();
  if(!p){ showAlert('profileAlert','Please enter a phone number','error'); return; }
  await db.collection('users').doc(CU.id).update({phone:p});
  CU.phone=p; set('profilePhoneVal',p);
  const wp=$('wdPhone'); if(wp) wp.value=p;
  cancelPhone(); toast('Phone number saved','‚úÖ','success');
}

async function uploadPic(ev){
  const f=ev.target.files[0]; if(!f) return;
  if(f.size>5*1024*1024){ toast('Max 5MB','‚ùå','error'); return; }
  const reader=new FileReader();
  reader.onload=async e=>{
    try{
      const b64=e.target.result;
      await db.collection('users').doc(CU.id).update({profilePicture:b64});
      CU.profilePicture=b64;
      const img=$('profileImg'); img.src=b64; img.style.display='block';
      const av=$('profileAvatar'); if(av) av.style.display='none';
      toast('Profile picture updated','üì∑','success');
    }catch(err){ toast('Upload failed','‚ùå','error'); }
  };
  reader.readAsDataURL(f);
}

// ============================================================
// CAREER LEVELS - Renders the referral career progression on home
// ============================================================
function renderCareerLevels(){
  const el=$('refLevelsHomeList'); if(!el) return;
  el.innerHTML=CAREER_LEVELS.map(c=>{
    const salaryStr=typeof c.salary==='number'?c.salary.toLocaleString()+' UGX/mo':c.salary;
    return `<div style="border:1px solid ${c.color}30;border-radius:10px;padding:13px 14px;background:linear-gradient(135deg,${c.color}0A,transparent);position:relative;overflow:hidden">
      <div style="position:absolute;top:0;left:0;width:3px;height:100%;background:${c.color};border-radius:3px 0 0 3px"></div>
      <div style="display:flex;align-items:center;gap:10px;margin-bottom:6px">
        <span style="font-size:1.3rem">${c.icon}</span>
        <div style="flex:1">
          <div style="font-weight:700;font-size:.9rem">Level ${c.level} - ${c.title}</div>
          <div style="font-size:.7rem;color:var(--muted);margin-top:1px">${c.referrals.toLocaleString()}+ referrals with active plans</div>
        </div>
        <div style="text-align:right;flex-shrink:0">
          <div style="font-family:'JetBrains Mono',monospace;font-size:.8rem;font-weight:700;color:${c.color}">${salaryStr}</div>
          <div style="font-size:.62rem;color:var(--dim)">monthly salary</div>
        </div>
      </div>
      <div style="font-size:.74rem;color:var(--muted);line-height:1.5;padding-left:2px">${c.description}</div>
    </div>`;
  }).join('');
}

// ============================================================
// LEADERBOARD
// ============================================================
async function loadLeaderboard(){
  try{
    const now=new Date(), dow=now.getDay(), d2m=dow===0?6:dow-1;
    const ws=new Date(now); ws.setDate(now.getDate()-d2m); ws.setHours(0,0,0,0);
    const snap=await db.collection('users').where('isAdmin','==',false).get();
    const data=await Promise.all(snap.docs.map(async d=>{
      const u=d.data();
      const rs=await db.collection('users').doc(d.id).collection('referrals').get();
      let wk=0; rs.docs.forEach(r=>{ if(new Date(r.data().date)>=ws) wk++; });
      return {n:u.fullName,wk,tot:rs.size};
    }));
    data.sort((a,b)=>b.wk-a.wk);
    const top=data.slice(0,5);
    const el=$('leaderboardList'); if(!el) return;
    const medals=['ü•á','ü•à','ü•â'];
    if(!top.length||top[0].wk===0){ el.innerHTML=`<div style="text-align:center;color:var(--muted);padding:12px">No referrals this week yet</div>`; return; }
    el.innerHTML=top.map((u,i)=>`<div class="lb-item"><div class="lb-rank ${i<3?'top':''}">${i<3?medals[i]:i+1}</div><div class="lb-info"><div class="lb-name">${u.n}</div><div class="lb-total">Total: ${u.tot}</div></div><div class="lb-count">${u.wk}</div></div>`).join('');
  }catch(e){ console.error('LB:',e); }
}

function startWeekTimer(){ updateWeekTimer(); clearInterval(weekTimerInt); weekTimerInt=setInterval(updateWeekTimer,60000); }
function updateWeekTimer(){
  const now=new Date(), d=now.getDay(), su=d===0?7:7-d;
  const nxt=new Date(now); nxt.setDate(now.getDate()+su); nxt.setHours(23,59,59,999);
  const rem=nxt-now, days=Math.floor(rem/86400000), hrs=Math.floor((rem%86400000)/3600000), mins=Math.floor((rem%3600000)/60000);
  set('weekTimer',`${days}d ${hrs}h ${mins}m`);
}

// ============================================================
// WEEKLY PRIZE - fully automatic
// Requires 8+ referrals THIS WEEK where each referred user has an active vault plan
// Prize auto-credited to balance; user can then request withdrawal
// Admin only approves the withdrawal request - not the prize itself
// ============================================================
async function runWeeklyPrize(){ await awardWeeklyWinner(true); }

async function awardWeeklyWinner(manual=false){
  try{
    const now=new Date(), d=now.getDay(), d2m=d===0?6:d-1;
    const ws=new Date(now); ws.setDate(now.getDate()-d2m); ws.setHours(0,0,0,0);
    const PRIZE=50000, MIN_REFS=8;

    const snap=await db.collection('users').where('isAdmin','==',false).get();
    let topCandidate=null, topCount=0;

    for(const doc of snap.docs){
      const rs=await db.collection('users').doc(doc.id).collection('referrals').get();
      let qualifiedCount=0;
      for(const ref of rs.docs){
        const refDate=new Date(ref.data().date||0);
        if(refDate<ws) continue; // must be this week
        // Referred user must have an active vault plan
        const vSnap=await db.collection('users').doc(ref.data().userId).collection('vaults')
          .where('status','==','active').limit(1).get();
        if(!vSnap.empty) qualifiedCount++;
      }
      if(qualifiedCount>topCount){ topCount=qualifiedCount; topCandidate={userId:doc.id,userName:doc.data().fullName,count:qualifiedCount}; }
    }

    if(!topCandidate||topCount<MIN_REFS){
      if(manual) toast(`No qualified winner - need ${MIN_REFS}+ referrals with active plans`,'‚ö†Ô∏è','warning');
      return;
    }

    // Prevent double-awarding within same week
    const alreadySnap=await db.collection('transactions')
      .where('userId','==',topCandidate.userId)
      .where('type','==','weekly_prize').get();
    const alreadyThisWeek=alreadySnap.docs.some(d=>new Date(d.data().date||0)>=ws);
    if(alreadyThisWeek){
      if(manual) toast(`${topCandidate.userName} already received the prize this week`,'‚ÑπÔ∏è','info');
      return;
    }

    await db.collection('users').doc(topCandidate.userId).update({balance:FS.increment(PRIZE)});
    await db.collection('transactions').add({
      userId:topCandidate.userId, userName:topCandidate.userName,
      type:'weekly_prize', amount:PRIZE, qualifiedReferrals:topCount,
      description:`üèÜ Weekly Top Referrer - ${topCount} qualified referrals`,
      date:new Date().toISOString()
    });
    await sendNotif(topCandidate.userId,'referral_bonus',
      `üèÜ You won this week's referral prize: ${PRIZE.toLocaleString()} UGX! (${topCount} qualified referrals) - go to Wallet -> Withdraw to claim it.`
    );
    if(manual) toast(`üèÜ ${PRIZE.toLocaleString()} UGX auto-credited to ${topCandidate.userName}`,'üèÜ','success',7000);
    if(manual) loadAdminStats();
  }catch(e){ console.error('Weekly prize:',e); if(manual) toast('Error: '+e.message,'‚ùå','error'); }
}

// ============================================================
// NOTIFICATIONS
// ============================================================
async function sendNotif(uid, type, msg){
  const icons={activation_approved:'üéâ',withdrawal_approved:'üí∞',withdrawal_rejected:'‚ùå',referral_bonus:'üë•',vault_matured:'üè¶'};
  const titles={activation_approved:'Account Activated!',withdrawal_approved:'Withdrawal Approved!',withdrawal_rejected:'Withdrawal Rejected',referral_bonus:'Referral Bonus!',vault_matured:'Vault Matured!'};
  try{
    await db.collection('notifications').add({userId:uid,type,title:titles[type]||'Notification',message:msg||titles[type],icon:icons[type]||'üîî',read:false,timestamp:FS.serverTimestamp(),createdAt:new Date().toISOString()});
  }catch(e){}
}

function initNotifListener(){
  if(!CU) return;
  db.collection('notifications').where('userId','==',CU.id).where('read','==',false)
    .orderBy('timestamp','desc').onSnapshot(snap=>{
      const cnt=snap.size;
      const b=$('notifBadge');
      if(b){ if(cnt>0){ b.textContent=cnt>99?'99+':cnt; b.classList.remove('hidden'); } else b.classList.add('hidden'); }
    });
}

function openNotif(){ $('notifPanel').classList.remove('hidden'); loadNotifList(); }
function closeNotif(){ $('notifPanel').classList.add('hidden'); }

async function loadNotifList(){
  if(!CU) return;
  try{
    const snap=await db.collection('notifications').where('userId','==',CU.id).orderBy('timestamp','desc').limit(30).get();
    const el=$('notifList');
    if(!el) return;
    if(snap.empty){ el.innerHTML=`<div style="padding:28px;text-align:center;color:var(--muted)">No notifications</div>`; return; }
    el.innerHTML=snap.docs.map(doc=>{
      const n={id:doc.id,...doc.data()};
      const t=n.timestamp?.toDate?n.timestamp.toDate():new Date(n.createdAt||Date.now());
      const m=Math.floor((Date.now()-t)/60000);
      const time=m<1?'Just now':m<60?`${m}m ago`:m<1440?`${Math.floor(m/60)}h ago`:`${Math.floor(m/1440)}d ago`;
      return `<div class="notif-item ${n.read?'':'unread'}" onclick="db.collection('notifications').doc('${n.id}').update({read:true});this.classList.remove('unread')">
        <div style="display:flex;gap:11px;align-items:flex-start">
          <span style="font-size:1.1rem;flex-shrink:0">${n.icon||'üîî'}</span>
          <div><div style="font-weight:700;font-size:.875rem">${n.title}</div><div style="font-size:.78rem;color:var(--muted)">${n.message||''}</div><div style="font-size:.7rem;color:var(--dim);margin-top:3px">${time}</div></div>
        </div>
      </div>`;
    }).join('');
  }catch(e){}
}

// ============================================================
// ADMIN
// ============================================================
async function loadAdminStats(){
  try{
    const[us,ts,pw]=await Promise.all([
      db.collection('users').where('isAdmin','==',false).get(),
      db.collection('transactions').get(),
      db.collection('withdrawalRequests').where('status','==','pending').get(),
    ]);
    const users=us.docs.map(d=>d.data());
    const tb=users.reduce((s,u)=>s+(u.balance||0),0);
    const act=users.filter(u=>u.isActivated).length;
    const dep=ts.docs.filter(d=>d.data().type==='deposit').reduce((s,d)=>s+(d.data().amount||0),0);
    const wd=ts.docs.filter(d=>['withdrawal','withdrawal_approved'].includes(d.data().type)).reduce((s,d)=>s+(d.data().amount||0),0);
    set('aTotal',users.length); set('aBalance',tb.toLocaleString());
    set('aDeposits',dep.toLocaleString()); set('aWithdraws',wd.toLocaleString());
    set('aActive',act); set('aPending',pw.size);
    // Show admin's referral/invite link
    const refEl=$('adminRefCodeDisplay');
    if(refEl&&CU&&CU.referralCode){
      const link=`${location.origin}${location.pathname}?ref=${CU.referralCode}`;
      refEl.textContent=link;
      refEl._link=link;
    }
  }catch(e){}
}

function copyAdminRefLink(){
  const el=$('adminRefCodeDisplay');
  const link=el?el._link||el.textContent:'';
  navigator.clipboard.writeText(link).then(()=>toast('Link copied!','üìã','success'));
}
function shareAdminRefLink(){
  const el=$('adminRefCodeDisplay');
  const link=el?el._link||el.textContent:'';
  if(navigator.share) navigator.share({title:'Join VaultPro',text:'Join Uganda\'s premier investment platform!',url:link});
  else copyAdminRefLink();
}

async function loadAdminUsers(){
  try{
    const snap=await db.collection('users').where('isAdmin','==',false).get();
    const el=$('adminUsersList');
    if(!el) return;
    if(snap.empty){ el.innerHTML=`<p style="padding:14px;color:var(--muted)">No users yet</p>`; return; }
    el.innerHTML=`<table><thead><tr><th>Name</th><th>Email</th><th>Phone</th><th>Balance</th><th>Status</th><th>Joined</th></tr></thead><tbody>${snap.docs.map(d=>{const u=d.data();return`<tr><td>${u.fullName}</td><td>${u.email}</td><td>${u.phone||'-'}</td><td style="font-family:'JetBrains Mono',monospace">${(u.balance||0).toLocaleString()}</td><td><span class="badge ${u.isActivated?'badge-success':'badge-warning'}">${u.isActivated?'Active':'Pending'}</span></td><td>${u.joinedDate?new Date(u.joinedDate).toLocaleDateString():'N/A'}</td></tr>`;}).join('')}</tbody></table>`;
  }catch(e){}
}

function updateTaskForm(){
  const type=$('taskType').value;
  const urlGroup=$('taskUrlGroup'), readGroup=$('taskReadingGroup');
  const urlLabel=$('taskUrlLabel');
  // visit/tiktok/youtube/youtube_sub all use a URL field
  urlGroup.classList.remove('hidden');
  if(readGroup) readGroup.classList.add('hidden');
  if(type==='youtube') urlLabel.textContent='YouTube Video URL';
  else if(type==='youtube_sub') urlLabel.textContent='YouTube Channel URL (e.g. https://youtube.com/@channelname)';
  else if(type==='tiktok') urlLabel.textContent='TikTok Video URL';
  else if(type==='visit') urlLabel.textContent='Website URL';
}

async function addTask(){
  const type=$('taskType').value, title=$('taskTitle').value.trim(), desc=$('taskDesc').value.trim();
  const url=$('taskUrl').value.trim();
  const timer=parseInt($('taskTimer').value)||60;
  if(!title){ toast('Please enter a task title','‚ö†Ô∏è','warning'); return; }
  if(!url){ toast('Please enter a URL','‚ö†Ô∏è','warning'); return; }
  try{
    await db.collection('tasks').add({
      type,title,description:desc,url,
      reward:null, // reward determined by user's vault plan
      timerSeconds:timer,isActive:true,createdAt:new Date().toISOString()
    });
    toast('Task added!','‚úÖ','success');
    ['taskTitle','taskDesc','taskUrl'].forEach(id=>{ const e=$(id); if(e) e.value=''; });
    $('taskTimer').value='60';
    loadAdminTasks();
  }catch(e){ toast('Failed: '+e.message,'‚ùå','error'); }
}

async function loadAdminTasks(){
  try{
    const snap=await db.collection('tasks').orderBy('createdAt','desc').get();
    const el=$('adminTasksList');
    if(!el) return;
    if(snap.empty){ el.innerHTML=`<p style="color:var(--muted)">No tasks yet</p>`; return; }
    const typeIcons={youtube:'üì∫',youtube_sub:'üîî',tiktok:'üéµ',reading:'üìñ'};
    el.innerHTML=snap.docs.map(doc=>{
      const t={id:doc.id,...doc.data()};
      return `<div style="border:1px solid var(--border-s);border-radius:var(--rs);padding:14px;margin-bottom:9px;background:var(--bg3)">
        <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:10px;margin-bottom:10px">
          <div style="flex:1">
            <div style="font-weight:700;font-size:.875rem">${typeIcons[t.type]||'üìã'} ${t.title}</div>
            <div style="font-size:.72rem;color:var(--muted);margin-top:2px">${t.description||''}</div>
            ${t.url?`<div style="font-size:.7rem;color:var(--dim);margin-top:2px;word-break:break-all">${t.url}</div>`:''}
            <div style="font-size:.72rem;color:var(--gold);margin-top:4px">‚è± ${t.timerSeconds||60}s timer ¬∑ Reward: determined by user's vault plan</div>
          </div>
          <span class="badge ${t.isActive?'badge-success':'badge-error'}">${t.isActive?'Active':'Off'}</span>
        </div>
        <div style="display:flex;gap:6px;flex-wrap:wrap">
          <button class="btn btn-surface" style="padding:6px 11px;font-size:.75rem" onclick="editTask('${doc.id}')">‚úèÔ∏è Edit</button>
          <button class="btn" style="padding:6px 11px;font-size:.75rem;background:${t.isActive?'rgba(232,68,90,.12)':'rgba(29,184,127,.12)'};color:${t.isActive?'var(--red)':'var(--green)'};border:1px solid ${t.isActive?'rgba(232,68,90,.3)':'rgba(29,184,127,.3)'}" onclick="toggleTask('${doc.id}',${!t.isActive})">${t.isActive?'Deactivate':'Activate'}</button>
          <button class="btn btn-red" style="padding:6px 11px;font-size:.75rem" onclick="deleteTask('${doc.id}')">üóë Delete</button>
        </div>
      </div>`;
    }).join('');
  }catch(e){ console.error(e); }
}

async function toggleTask(id, active){ await db.collection('tasks').doc(id).update({isActive:active}); toast(active?'Task activated':'Task deactivated','‚úÖ','success'); loadAdminTasks(); }
async function deleteTask(id){ if(!confirm('Delete this task?'))return; await db.collection('tasks').doc(id).delete(); toast('Task deleted','üóë','warning'); loadAdminTasks(); }

function editTask(id){
  db.collection('tasks').doc(id).get().then(d=>{
    const t=d.data();
    const newTitle=prompt('Task Title:',t.title||'');
    if(newTitle===null) return;
    const newDesc=prompt('Description:',t.description||'');
    if(newDesc===null) return;
    const newTimer=parseInt(prompt('Timer (seconds):',t.timerSeconds||60));
    db.collection('tasks').doc(id).update({title:newTitle,description:newDesc,timerSeconds:isNaN(newTimer)?60:newTimer})
      .then(()=>{ toast('Task updated','‚úÖ','success'); loadAdminTasks(); })
      .catch(e=>toast('Update failed: '+e.message,'‚ùå','error'));
  });
}

// ============================================================
// ADMIN DEPOSITS - pending on top, history in collapsible dropdown
// ============================================================
async function loadAdminDeposits(){
  try{
    const snap=await db.collection('depositRequests').orderBy('date','desc').get();
    const el=$('adminDepList');
    if(!el) return;
    if(snap.empty){ el.innerHTML=`<p style="color:var(--muted);padding:10px 0">No deposit requests yet</p>`; return; }

    const all=snap.docs.map(doc=>({id:doc.id,...doc.data()}));
    const pending=all.filter(d=>d.status==='pending');
    const history=all.filter(d=>d.status!=='pending');

    function depCard(d, showActions){
      const imgSrc=d.screenshotBase64||d.screenshotUrl||null;
      const imgHtml=imgSrc
        ? `<img src="${imgSrc}" onclick="showImgLightbox(this.src)" style="max-width:100%;border-radius:var(--rs);margin-top:10px;cursor:pointer;border:1px solid var(--border-s)" title="Tap to enlarge">`
        : '<div style="font-size:.73rem;color:var(--dim);font-style:italic;margin-top:6px">‚ö†Ô∏è No screenshot</div>';
      const statusColor=d.status==='approved'?'badge-success':d.status==='rejected'?'badge-error':'badge-warning';
      return `<div class="dep-card">
        <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:8px">
          <div>
            <div style="font-weight:700">${d.userName||'-'}</div>
            <div style="font-size:.73rem;color:var(--muted)">${d.phone||''} ¬∑ ${d.method||''} ¬∑ ${new Date(d.date).toLocaleDateString()}</div>
          </div>
          <div style="text-align:right;flex-shrink:0">
            <div style="font-family:'JetBrains Mono',monospace;font-size:1rem;font-weight:700;color:var(--green)">${(d.amount||0).toLocaleString()} UGX</div>
            <span class="badge ${statusColor}">${d.status}</span>
          </div>
        </div>
        ${imgHtml}
        ${showActions?`<div style="display:flex;gap:7px;margin-top:12px">
          <button class="btn btn-green" style="flex:1;padding:9px;font-size:.82rem" onclick="approveDeposit('${d.id}','${d.userId}',${d.amount})">‚úÖ Approve</button>
          <button class="btn btn-red" style="flex:1;padding:9px;font-size:.82rem" onclick="rejectDeposit('${d.id}','${d.userId}')">‚ùå Reject</button>
        </div>`:''}
      </div>`;
    }

    const pendingHtml = pending.length
      ? pending.map(d=>depCard(d,true)).join('')
      : `<div style="background:rgba(29,184,127,.06);border:1px solid rgba(29,184,127,.2);border-radius:var(--rs);padding:14px;text-align:center;margin-bottom:12px;color:var(--green);font-size:.85rem">‚úÖ No pending deposits</div>`;

    const historyHtml = history.length
      ? `<div class="card" style="padding:0;overflow:hidden;margin-top:4px">
          <div style="display:flex;justify-content:space-between;align-items:center;padding:13px 16px;cursor:pointer;user-select:none" onclick="toggleDepHistory()">
            <div>
              <div style="font-weight:700;font-size:.88rem">üìã History</div>
              <div style="font-size:.72rem;color:var(--muted);margin-top:1px">${history.length} processed deposit${history.length!==1?'s':''}</div>
            </div>
            <span id="depHistCaret" style="color:var(--muted);font-size:.8rem;transition:transform .25s">‚ñº</span>
          </div>
          <div id="depHistBody" style="overflow:hidden;max-height:0;transition:max-height .35s ease">
            <div style="padding:0 12px 12px">
              ${history.map(d=>depCard(d,false)).join('')}
            </div>
          </div>
        </div>`
      : '';

    el.innerHTML = pendingHtml + historyHtml;
  }catch(e){ console.error(e); }
}

function toggleDepHistory(){
  const body=$('depHistBody'), caret=$('depHistCaret');
  if(!body) return;
  const isOpen=body.style.maxHeight&&body.style.maxHeight!=='0px';
  body.style.maxHeight=isOpen?'0px':'3000px';
  if(caret) caret.style.transform=isOpen?'':'rotate(180deg)';
}

// Same collapsible pattern for admin withdrawals
async function loadAdminWithdrawals(){
  try{
    const snap=await db.collection('withdrawalRequests').orderBy('date','desc').get();
    const el=$('adminWdList');
    if(!el) return;
    if(snap.empty){ el.innerHTML=`<p style="color:var(--muted)">No withdrawal requests</p>`; return; }

    const all=snap.docs.map(doc=>({id:doc.id,...doc.data()}));
    const pending=all.filter(w=>w.status==='pending');
    const history=all.filter(w=>w.status!=='pending');

    function wdCard(w, showActions){
      const statusColor=w.status==='approved'?'badge-success':w.status==='rejected'?'badge-error':'badge-warning';
      return `<div class="dep-card">
        <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:8px">
          <div>
            <div style="font-weight:700">${w.userName||'-'}</div>
            <div style="font-size:.73rem;color:var(--muted)">${w.phone||''} ¬∑ ${w.category||''} ¬∑ ${new Date(w.date).toLocaleDateString()}</div>
          </div>
          <div style="text-align:right;flex-shrink:0">
            <div style="font-family:'JetBrains Mono',monospace;font-size:1rem;font-weight:700;color:var(--gold)">${(w.amount||0).toLocaleString()} UGX</div>
            <div style="font-size:.72rem;color:var(--green)">Net: ${(w.netAmount||0).toLocaleString()}</div>
            <span class="badge ${statusColor}">${w.status}</span>
          </div>
        </div>
        <div style="font-size:.75rem;color:var(--muted);margin-bottom:${showActions?'10px':'0'}">Send to: <strong style="color:var(--text)">${w.phone}</strong></div>
        ${showActions?`<div style="display:flex;gap:7px">
          <button class="btn btn-green" style="flex:1;padding:9px;font-size:.82rem" onclick="approveWithdrawal('${w.id}','${w.userId}',${w.netAmount||0},${w.adminFee||0})">‚úÖ Approve</button>
          <button class="btn btn-red" style="flex:1;padding:9px;font-size:.82rem" onclick="rejectWithdrawal('${w.id}','${w.userId}')">‚ùå Reject</button>
        </div>`:''}
      </div>`;
    }

    const pendingHtml = pending.length
      ? pending.map(w=>wdCard(w,true)).join('')
      : `<div style="background:rgba(29,184,127,.06);border:1px solid rgba(29,184,127,.2);border-radius:var(--rs);padding:14px;text-align:center;margin-bottom:12px;color:var(--green);font-size:.85rem">‚úÖ No pending withdrawals</div>`;

    const historyHtml = history.length
      ? `<div class="card" style="padding:0;overflow:hidden;margin-top:4px">
          <div style="display:flex;justify-content:space-between;align-items:center;padding:13px 16px;cursor:pointer;user-select:none" onclick="toggleWdHistory()">
            <div>
              <div style="font-weight:700;font-size:.88rem">üìã History</div>
              <div style="font-size:.72rem;color:var(--muted);margin-top:1px">${history.length} processed withdrawal${history.length!==1?'s':''}</div>
            </div>
            <span id="wdHistCaret" style="color:var(--muted);font-size:.8rem;transition:transform .25s">‚ñº</span>
          </div>
          <div id="wdHistBody" style="overflow:hidden;max-height:0;transition:max-height .35s ease">
            <div style="padding:0 12px 12px">
              ${history.map(w=>wdCard(w,false)).join('')}
            </div>
          </div>
        </div>`
      : '';

    el.innerHTML = pendingHtml + historyHtml;
  }catch(e){ console.error(e); }
}

function toggleWdHistory(){
  const body=$('wdHistBody'), caret=$('wdHistCaret');
  if(!body) return;
  const isOpen=body.style.maxHeight&&body.style.maxHeight!=='0px';
  body.style.maxHeight=isOpen?'0px':'3000px';
  if(caret) caret.style.transform=isOpen?'':'rotate(180deg)';
}

// Lightbox - handles both base64 and URL
function showImgLightbox(src){
  $('lightboxImg').src=src;
  $('imgLightbox').style.display='flex';
}

async function approveDeposit(depId, uid, amount){
  if(!confirm(`Approve ${amount.toLocaleString()} UGX deposit?`)) return;
  try{
    await db.collection('depositRequests').doc(depId).update({status:'approved',approvedDate:new Date().toISOString()});
    await db.collection('users').doc(uid).update({balance:FS.increment(amount)});
    await db.collection('transactions').add({userId:uid,type:'deposit',amount,date:new Date().toISOString()});
    await sendNotif(uid,'activation_approved',`Your deposit of ${amount.toLocaleString()} UGX has been approved! üéâ`);
    toast('Deposit approved','‚úÖ','success');
    loadAdminDeposits(); loadAdminStats();
  }catch(e){ toast('Error: '+e.message,'‚ùå','error'); }
}

async function rejectDeposit(id, uid){
  if(!confirm('Reject this deposit?')) return;
  await db.collection('depositRequests').doc(id).update({status:'rejected'});
  await sendNotif(uid,'withdrawal_rejected','Your deposit request was rejected. Please contact support.');
  toast('Deposit rejected','','warning');
  loadAdminDeposits();
}


async function approveWithdrawal(wdId, uid, net, fee){
  if(!confirm(`Approve withdrawal of ${net.toLocaleString()} UGX?`)) return;
  try{
    await db.collection('withdrawalRequests').doc(wdId).update({status:'approved',approvedDate:new Date().toISOString()});
    await db.collection('users').doc(uid).update({balance:FS.increment(-(net+fee))});
    await db.collection('transactions').add({userId:uid,type:'withdrawal_approved',amount:net,adminFee:fee,date:new Date().toISOString()});
    await sendNotif(uid,'withdrawal_approved',`Your withdrawal of ${net.toLocaleString()} UGX has been processed! üí∞`);
    toast('Withdrawal approved','‚úÖ','success');
    loadAdminWithdrawals(); loadAdminStats();
  }catch(e){ toast('Error: '+e.message,'‚ùå','error'); }
}

async function rejectWithdrawal(id, uid){
  if(!confirm('Reject this withdrawal?')) return;
  await db.collection('withdrawalRequests').doc(id).update({status:'rejected'});
  await sendNotif(uid,'withdrawal_rejected','Your withdrawal request was rejected. Please contact support.');
  toast('Rejection sent','','warning');
  loadAdminWithdrawals();
}

async function loadAdminTransactions(){
  try{
    const snap=await db.collection('transactions').orderBy('date','desc').limit(50).get();
    const tb=$('adminTxList');
    if(!tb) return;
    if(snap.empty){ tb.innerHTML=`<tr><td colspan="4" style="text-align:center;color:var(--muted)">No transactions</td></tr>`; return; }
    tb.innerHTML=snap.docs.map(d=>{const t=d.data();return`<tr><td>${t.userName||'-'}</td><td>${t.type}</td><td style="font-family:'JetBrains Mono',monospace">${(t.amount||0).toLocaleString()}</td><td>${new Date(t.date).toLocaleDateString()}</td></tr>`;}).join('');
  }catch(e){}
}

// ============================================================
// REALTIME: Withdrawal approval listener for user
// ============================================================
function listenForWithdrawalApproval(){
  if(!CU||CU.isAdmin) return;
  db.collection('withdrawalRequests').where('userId','==',CU.id).where('status','==','approved')
    .onSnapshot(snap=>{
      snap.docChanges().forEach(change=>{
        if(change.type==='modified'||change.type==='added'){
          const w=change.doc.data();
          if(w.approvedDate&&(Date.now()-new Date(w.approvedDate).getTime())<300000){
            $('successIcon').textContent='üí∞';
            $('successTitle').textContent='Withdrawal Approved!';
            $('successMsg').textContent=`${(w.netAmount||0).toLocaleString()} UGX has been sent to ${w.phone}.`;
            $('successOverlay').classList.remove('hidden');
            clearStatsCache();
            updateUserStats(true);
          }
        }
      });
    });
}

// ============================================================
// AUTO-REVOKE ‚Äî runs on every login, voids any SACCO plan
// that was purchased using vault principal (not earnings)
// ============================================================
async function autoRevokeBadSaccoPlans(){
  if(!CU||!CU.id) return;
  try{
    const snap = await db.collection('saccoPlans')
      .where('userId','==',CU.id)
      .where('status','==','active')
      .get();
    if(snap.empty) return;

    const VALID = ['depositEarnings','referralEarnings','taskEarnings','vaultEarnings','saccoReturn'];
    const badPlans = snap.docs.filter(d=>{
      const src = d.data().sourceCategory;
      // Invalid if: no source, source is raw balance, or source is vault_purchase
      return !src || !VALID.includes(src) || src === 'vaultBalance' || src === 'vault_purchase';
    });

    if(!badPlans.length) return;

    for(const doc of badPlans){
      const plan = doc.data();
      const principal = plan.principal || 0;

      // Revoke the plan
      await db.collection('saccoPlans').doc(doc.id).update({
        status: 'revoked',
        revokedAt: new Date().toISOString(),
        revokedBy: 'system_auto',
        revokeReason: 'Purchased with vault principal ‚Äî only earnings allowed',
      });

      // Refund principal to user
      await db.collection('users').doc(CU.id).update({
        balance: FS.increment(principal)
      });
      CU.balance = (CU.balance||0) + principal;

      // Log the reversal
      await db.collection('transactions').add({
        userId: CU.id,
        userName: CU.fullName,
        type: 'sacco_revoke_refund',
        amount: principal,
        description: 'SACCO plan auto-revoked: vault principal cannot fund SACCO. Principal refunded.',
        date: new Date().toISOString()
      });

      // Remove the erroneous sacco_deposit transaction so category balances are clean
      const badTxSnap = await db.collection('transactions')
        .where('userId','==',CU.id)
        .where('type','==','sacco_deposit')
        .where('planId','==',plan.planId)
        .limit(1).get();
      if(!badTxSnap.empty){
        await db.collection('transactions').doc(badTxSnap.docs[0].id).delete();
      }

      console.log(`[Auto-revoke] SACCO plan ${doc.id} revoked, ${principal} UGX refunded`);
    }

    if(badPlans.length > 0){
      // Notify user
      toast(
        `${badPlans.length} SACCO plan(s) revoked: only deposit, referral, task, and vault profit earnings can fund SACCO. Your principal has been refunded.`,
        '‚ö†Ô∏è','warning', 9000
      );
      clearStatsCache();
      updateUserStats(true);
    }
  }catch(e){
    console.error('autoRevokeBadSaccoPlans error:', e);
  }
}

// ============================================================
// ADMIN SACCO ‚Äî Review and Revoke fraudulent plans
// ============================================================
// Legitimate source categories for SACCO (no vault_purchase principal)
const SACCO_VALID_SOURCES = ['depositEarnings','referralEarnings','taskEarnings','vaultEarnings','saccoReturn'];

async function loadAdminSacco(filter='all'){
  const el=$('adminSaccoList');
  if(!el) return;
  el.innerHTML='<div style="color:var(--muted);padding:10px">Loading‚Ä¶</div>';
  try{
    let q=db.collection('saccoPlans').orderBy('startDate','desc');
    const snap=await q.get();
    if(snap.empty){ el.innerHTML='<p style="color:var(--muted)">No SACCO plans found.</p>'; return; }

    // Categorise: suspicious = sourceCategory not in valid list OR not set
    const all=snap.docs.map(d=>({id:d.id,...d.data()}));
    const filtered = filter==='all' ? all
      : filter==='active' ? all.filter(p=>p.status==='active')
      : filter==='invalid' ? all.filter(p=>!SACCO_VALID_SOURCES.includes(p.sourceCategory)||!p.sourceCategory||p.sourceCategory==='vaultBalance')
      : filter==='revoked' ? all.filter(p=>p.status==='revoked')
      : all;

    if(!filtered.length){ el.innerHTML='<p style="color:var(--muted)">No plans in this filter.</p>'; return; }

    const isInvalid = p => !SACCO_VALID_SOURCES.includes(p.sourceCategory)||!p.sourceCategory||p.sourceCategory==='vaultBalance';

    el.innerHTML=filtered.map(p=>{
      const bad=isInvalid(p)&&p.status==='active';
      const matDate=new Date(p.maturityDate);
      const srcLabel=p.categoryName||p.sourceCategory||'Unknown';
      return `<div class="dep-card" style="${bad?'border-color:rgba(232,68,90,.4);background:rgba(232,68,90,.04)':''}">
        <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:8px">
          <div>
            <div style="font-weight:700">${p.userName||'‚Äî'}</div>
            <div style="font-size:.73rem;color:var(--muted)">${p.planLabel} ¬∑ ${p.days} days ¬∑ Started ${new Date(p.startDate).toLocaleDateString()}</div>
            <div style="font-size:.72rem;margin-top:3px">
              Source: <strong style="color:${SACCO_VALID_SOURCES.includes(p.sourceCategory)?'var(--green)':'var(--red)'}">${srcLabel}</strong>
              ${bad?'<span style="color:var(--red);margin-left:6px;font-weight:700">‚ö†Ô∏è INVALID SOURCE</span>':''}
            </div>
          </div>
          <div style="text-align:right;flex-shrink:0">
            <div style="font-family:'JetBrains Mono',monospace;font-size:.95rem;font-weight:700;color:var(--gold)">${(p.principal||0).toLocaleString()} UGX</div>
            <div style="font-size:.7rem;color:var(--muted)">+${(p.profit||0).toLocaleString()} profit</div>
            <span class="badge ${p.status==='active'?'badge-success':p.status==='revoked'?'badge-error':'badge-warning'}">${p.status}</span>
          </div>
        </div>
        <div style="font-size:.72rem;color:var(--muted);margin-bottom:${p.status==='active'?'10px':'0'}">
          Matures: ${matDate.toLocaleDateString()} ¬∑ Withdrawable: ${new Date(p.withdrawableFrom).toLocaleDateString()}
        </div>
        ${p.status==='active'?`<div style="display:flex;gap:7px">
          ${bad?`<button class="btn btn-red" style="flex:1;padding:8px;font-size:.8rem;font-weight:700"
            onclick="revokeSaccoPlan('${p.id}','${p.userId}',${p.principal},'${(p.userName||'').replace(/'/g,"\'")}')">
            üö´ Revoke &amp; Refund
          </button>`:''}
          <button class="btn btn-surface" style="flex:1;padding:8px;font-size:.8rem"
            onclick="revokeSaccoPlan('${p.id}','${p.userId}',${p.principal},'${(p.userName||'').replace(/'/g,"\'")}')">
            Revoke Plan
          </button>
        </div>`:''}
      </div>`;
    }).join('');
  }catch(e){ el.innerHTML=`<p style="color:var(--red)">Error: ${e.message}</p>`; }
}

async function revokeSaccoPlan(planId, userId, principal, userName){
  if(!confirm(`Revoke this SACCO plan and refund ${(+principal).toLocaleString()} UGX to ${userName}?`)) return;
  try{
    // Void the plan
    await db.collection('saccoPlans').doc(planId).update({
      status:'revoked',
      revokedAt:new Date().toISOString(),
      revokedBy:'admin',
      revokeReason:'Invalid source ‚Äî vault principal used instead of earnings',
    });
    // Refund the principal back to user balance
    await db.collection('users').doc(userId).update({balance:FS.increment(+principal)});
    // Record the reversal transaction
    await db.collection('transactions').add({
      userId, type:'sacco_revoke_refund',
      amount:+principal,
      description:`SACCO plan revoked by admin ‚Äî principal refunded`,
      date:new Date().toISOString()
    });
    // Notify user
    await sendNotif(userId,'withdrawal_rejected',
      `Your SACCO savings plan has been reviewed and revoked by admin. Your principal of ${(+principal).toLocaleString()} UGX has been refunded to your balance. Only earnings (deposits, referrals, task rewards, vault profits) may be used for SACCO plans.`
    );
    toast(`Plan revoked. ${(+principal).toLocaleString()} UGX refunded to ${userName}.`,'‚úÖ','success',6000);
    loadAdminSacco('all');
  }catch(e){ toast('Revoke failed: '+e.message,'‚ùå','error'); }
}

// ============================================================
// BOOT
// ============================================================
window.addEventListener('load', ()=>{ init(); loadYTApi(); });

// ============================================================
// PWA - Service Worker + Install Prompt
// ============================================================
let deferredInstallPrompt = null;

window.addEventListener('beforeinstallprompt', e => {
  e.preventDefault();
  deferredInstallPrompt = e;
  // Show banner after 3 seconds if not dismissed
  if(!localStorage.getItem('vp_install_dismissed')){
    setTimeout(()=>{
      const b=$('installBanner');
      if(b) b.classList.add('show');
    }, 3000);
  }
});

window.addEventListener('appinstalled', () => {
  const b=$('installBanner');
  if(b) b.classList.remove('show');
  deferredInstallPrompt = null;
  toast('VaultPro installed! üéâ','üè¶','success',5000);
});

const installBtn=$('installBtn');
if(installBtn){
  installBtn.addEventListener('click', async () => {
    if(!deferredInstallPrompt) return;
    deferredInstallPrompt.prompt();
    const {outcome} = await deferredInstallPrompt.userChoice;
    if(outcome === 'accepted') toast('Installing VaultPro‚Ä¶','üì≤','success');
    deferredInstallPrompt = null;
    const b=$('installBanner');
    if(b) b.classList.remove('show');
  });
}

function dismissInstall(){
  const b=$('installBanner');
  if(b) b.classList.remove('show');
  localStorage.setItem('vp_install_dismissed','1');
}

// Register Service Worker (inline via blob URL - works in single-file apps)
if('serviceWorker' in navigator){
  const swCode = `
const CACHE='vaultpro-v1';
const PRECACHE=['/'];
self.addEventListener('install', e=>{
  e.waitUntil(caches.open(CACHE).then(c=>c.addAll(PRECACHE)).then(()=>self.skipWaiting()));
});
self.addEventListener('activate', e=>{
  e.waitUntil(caches.keys().then(keys=>Promise.all(keys.filter(k=>k!==CACHE).map(k=>caches.delete(k)))).then(()=>self.clients.claim()));
});
self.addEventListener('fetch', e=>{
  // Network-first for Firebase, cache-first for everything else
  const isFirebase = e.request.url.includes('firebaseio.com') || e.request.url.includes('googleapis.com') || e.request.url.includes('gstatic.com');
  if(isFirebase){
    e.respondWith(fetch(e.request).catch(()=>caches.match(e.request)));
    return;
  }
  e.respondWith(
    caches.match(e.request).then(cached=>{
      if(cached) return cached;
      return fetch(e.request).then(response=>{
        if(response && response.status===200 && response.type!=='opaque'){
          const clone = response.clone();
          caches.open(CACHE).then(c=>c.put(e.request,clone));
        }
        return response;
      }).catch(()=>cached);
    })
  );
});
self.addEventListener('push', e=>{
  const data = e.data ? e.data.json() : {};
  e.waitUntil(self.registration.showNotification(data.title||'VaultPro', {
    body: data.body||'You have a new notification',
    icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect width="100" height="100" rx="20" fill="%230A0C10"/><text y="72" x="50" text-anchor="middle" font-size="60">üè¶</text></svg>',
    badge: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y="80" x="50" text-anchor="middle" font-size="80">üè¶</text></svg>',
    tag: 'vaultpro',
    renotify: true,
    data: data
  }));
});
self.addEventListener('notificationclick', e=>{
  e.notification.close();
  e.waitUntil(clients.openWindow('/'));
});
  `;
  const blob = new Blob([swCode], {type:'application/javascript'});
  const swUrl = URL.createObjectURL(blob);
  navigator.serviceWorker.register(swUrl, {scope:'/'})
    .then(reg => {
      console.log('VaultPro SW registered');
      // Check for updates periodically
      setInterval(()=>reg.update(), 60*60*1000);
    })
    .catch(err => console.warn('SW registration failed:', err));
}

// ============================================================
// SIDEBAR - sync active state with current section
// ============================================================
function updateSidebarActive(section){
  // User sidebar
  document.querySelectorAll('[id^="sidenav-"]').forEach(el=>{
    el.classList.remove('active');
  });
  const active = $(`sidenav-${section}`) || $(`sidenav-sacco`);
  if($(`sidenav-${section}`)) $(`sidenav-${section}`).classList.add('active');

  // Bottom nav
  document.querySelectorAll('.nav-item').forEach(el=>{
    const s=el.getAttribute('data-section');
    el.classList.toggle('active', s===section);
  });
}
</script>
</body>
</html>
