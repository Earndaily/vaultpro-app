<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>VaultPro ‚Äì Investment Platform</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;800&family=DM+Sans:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">
<style>
:root{--gold:#C9A84C;--gold-light:#E8C96B;--gold-dark:#A07834;--bg:#0A0C10;--bg2:#111318;--bg3:#181C24;--surface:#1E2330;--surface2:#252B3A;--border:rgba(201,168,76,0.15);--border-s:rgba(255,255,255,0.06);--text:#F0EDE6;--muted:#7E8899;--dim:#4A5166;--green:#1DB87F;--red:#E8445A;--blue:#4A7CF7;--r:14px;--rs:8px}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body{height:100%}
body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;max-width:480px;margin:0 auto;overflow-x:hidden}
body::before{content:'';position:fixed;inset:0;background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.03'/%3E%3C/svg%3E");pointer-events:none;z-index:9998;opacity:.4}
.hidden{display:none!important}
/* Buttons */
.btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:13px 22px;border-radius:var(--rs);border:none;cursor:pointer;font-family:'DM Sans',sans-serif;font-weight:600;font-size:.88rem;transition:all .2s;position:relative;overflow:hidden}
.btn:disabled{opacity:.5;cursor:not-allowed}
.btn:active:not(:disabled){transform:scale(.97)}
.btn-gold{background:linear-gradient(135deg,var(--gold),var(--gold-dark));color:#0A0C10;font-weight:700;box-shadow:0 4px 20px rgba(201,168,76,.35)}
.btn-gold:hover:not(:disabled){box-shadow:0 6px 28px rgba(201,168,76,.5)}
.btn-outline{background:transparent;border:1px solid var(--border);color:var(--gold)}
.btn-outline:hover{background:rgba(201,168,76,.08);border-color:var(--gold)}
.btn-surface{background:var(--surface2);color:var(--text);border:1px solid var(--border-s)}
.btn-green{background:linear-gradient(135deg,var(--green),#158B5F);color:#fff}
.btn-red{background:linear-gradient(135deg,var(--red),#B02040);color:#fff}
.btn-blue{background:linear-gradient(135deg,var(--blue),#2E5FD4);color:#fff}
.btn-full{width:100%}
/* Cards */
.card{background:var(--surface);border:1px solid var(--border-s);border-radius:var(--r);padding:20px;margin-bottom:12px}
.card-gold{background:linear-gradient(135deg,rgba(201,168,76,.1),rgba(201,168,76,.03));border:1px solid var(--border)}
/* Forms */
.fg{margin-bottom:14px}
.fg label{display:block;font-size:.75rem;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.08em;margin-bottom:7px}
.fg input,.fg select,.fg textarea{width:100%;padding:13px 15px;background:var(--bg3);border:1px solid var(--border-s);border-radius:var(--rs);color:var(--text);font-family:'DM Sans',sans-serif;font-size:.92rem;transition:border-color .2s;appearance:none;-webkit-appearance:none}
.fg input:focus,.fg select:focus,.fg textarea:focus{outline:none;border-color:var(--gold);box-shadow:0 0 0 3px rgba(201,168,76,.1)}
.fg input::placeholder,.fg textarea::placeholder{color:var(--dim)}
.fg textarea{resize:vertical;min-height:80px}
/* Alerts */
.alert{padding:11px 15px;border-radius:var(--rs);margin-bottom:12px;font-size:.85rem;font-weight:500;display:flex;align-items:flex-start;gap:9px}
.alert-success{background:rgba(29,184,127,.12);border:1px solid rgba(29,184,127,.3);color:#4DEBA0}
.alert-error{background:rgba(232,68,90,.12);border:1px solid rgba(232,68,90,.3);color:#F07285}
.alert-warning{background:rgba(201,168,76,.12);border:1px solid rgba(201,168,76,.3);color:var(--gold-light)}
.alert-info{background:rgba(74,124,247,.12);border:1px solid rgba(74,124,247,.3);color:#7FA8FF}
/* Badges */
.badge{display:inline-flex;align-items:center;gap:4px;padding:3px 9px;border-radius:20px;font-size:.68rem;font-weight:700;letter-spacing:.04em;text-transform:uppercase}
.badge-success{background:rgba(29,184,127,.15);color:var(--green);border:1px solid rgba(29,184,127,.3)}
.badge-error{background:rgba(232,68,90,.15);color:var(--red);border:1px solid rgba(232,68,90,.3)}
.badge-warning{background:rgba(201,168,76,.15);color:var(--gold);border:1px solid var(--border)}
.badge-blue{background:rgba(74,124,247,.15);color:#7FA8FF;border:1px solid rgba(74,124,247,.3)}
/* Loading */
#loadingScreen{position:fixed;inset:0;background:var(--bg);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:9999}
.loader-logo{font-family:'Playfair Display',serif;font-size:2.5rem;font-weight:800;color:var(--gold);letter-spacing:-.02em;margin-bottom:6px}
.loader-tag{font-size:.75rem;color:var(--muted);letter-spacing:.15em;text-transform:uppercase;margin-bottom:48px}
.loader-ring{width:42px;height:42px;border:3px solid rgba(201,168,76,.2);border-top-color:var(--gold);border-radius:50%;animation:spin .9s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
/* Auth */
.auth-page{min-height:100vh;display:flex;flex-direction:column}
.auth-header{background:linear-gradient(180deg,rgba(201,168,76,.08) 0%,transparent 100%);padding:56px 24px 36px;text-align:center;border-bottom:1px solid var(--border-s)}
.auth-logo{font-family:'Playfair Display',serif;font-size:2rem;font-weight:800;color:var(--gold)}
.auth-sub{font-size:.82rem;color:var(--muted);margin-top:5px;letter-spacing:.05em}
.auth-body{flex:1;padding:26px 20px}
/* Landing */
.landing-page{min-height:100vh;background:var(--bg);display:flex;flex-direction:column;align-items:center;padding:0 20px 40px}
.landing-hero{width:100%;background:linear-gradient(180deg,rgba(201,168,76,.1) 0%,transparent 100%);padding:56px 20px 36px;text-align:center;border-bottom:1px solid var(--border-s);margin-bottom:24px}
.landing-title{font-family:'Playfair Display',serif;font-size:1.9rem;font-weight:800;color:var(--text);margin-bottom:8px}
.invite-code-box{background:var(--surface);border:1px solid var(--border);border-radius:var(--r);padding:18px;text-align:center;width:100%;max-width:360px;margin:0 auto 22px;box-shadow:0 0 30px rgba(201,168,76,.15)}
.invite-code-val{font-family:'JetBrains Mono',monospace;font-size:1.7rem;font-weight:600;color:var(--gold);letter-spacing:.12em}
/* Dashboard header */
.dash-header{position:sticky;top:0;z-index:100;background:rgba(10,12,16,.93);backdrop-filter:blur(16px);-webkit-backdrop-filter:blur(16px);border-bottom:1px solid var(--border-s);padding:13px 18px;display:flex;align-items:center;justify-content:space-between}
.header-brand{font-family:'Playfair Display',serif;font-size:1.15rem;color:var(--gold);font-weight:700}
.header-user-name{font-weight:700;font-size:.9rem}
.header-user-sub{font-size:.72rem;color:var(--muted)}
.icon-btn{width:38px;height:38px;border-radius:50%;border:1px solid var(--border-s);background:var(--surface);color:var(--muted);font-size:1rem;cursor:pointer;display:flex;align-items:center;justify-content:center;position:relative;transition:all .2s}
.notif-dot{position:absolute;top:1px;right:1px;width:15px;height:15px;background:var(--red);border-radius:50%;font-size:9px;font-weight:700;color:#fff;display:flex;align-items:center;justify-content:center;border:2px solid var(--bg)}
/* Bottom nav */
.bottom-nav{position:fixed;bottom:0;left:0;right:0;max-width:480px;margin:0 auto;background:rgba(14,16,24,.97);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);border-top:1px solid var(--border-s);display:flex;z-index:100;padding-bottom:env(safe-area-inset-bottom)}
.nav-item{flex:1;display:flex;flex-direction:column;align-items:center;gap:3px;padding:9px 3px 7px;cursor:pointer;border:none;background:none;color:var(--dim);font-size:.56rem;font-weight:700;letter-spacing:.05em;text-transform:uppercase;transition:color .2s;font-family:'DM Sans',sans-serif}
.nav-icon{font-size:1.2rem;transition:transform .2s}
.nav-item.active{color:var(--gold)}
.nav-item.active .nav-icon{transform:translateY(-2px)}
/* Content */
.content{padding:14px;padding-bottom:88px}
/* Balance hero */
.balance-hero{background:linear-gradient(135deg,var(--bg3) 0%,var(--surface) 100%);border:1px solid var(--border);border-radius:var(--r);padding:22px 18px;margin-bottom:12px;position:relative;overflow:hidden}
.balance-hero::before{content:'';position:absolute;top:-40px;right:-40px;width:150px;height:150px;background:radial-gradient(circle,rgba(201,168,76,.12) 0%,transparent 70%);pointer-events:none}
.balance-label{font-size:.68rem;font-weight:700;letter-spacing:.12em;text-transform:uppercase;color:var(--muted);margin-bottom:7px}
.balance-value{font-family:'Playfair Display',serif;font-size:2.3rem;font-weight:800;color:var(--gold);line-height:1;margin-bottom:3px}
.balance-currency{font-size:.75rem;color:var(--muted)}
/* Stat grid */
.stat-grid{display:grid;grid-template-columns:1fr 1fr;gap:9px;margin-bottom:12px}
.stat-tile{background:var(--surface);border:1px solid var(--border-s);border-radius:var(--r);padding:14px}
.stat-tile-icon{font-size:1.3rem;margin-bottom:8px}
.stat-tile-value{font-family:'JetBrains Mono',monospace;font-size:1rem;font-weight:600;color:var(--text);margin-bottom:2px}
.stat-tile-label{font-size:.68rem;color:var(--muted);letter-spacing:.03em}
/* Progress bar */
.prog-wrap{background:var(--bg3);border-radius:100px;height:5px;overflow:hidden;margin-top:7px}
.prog-fill{height:100%;background:linear-gradient(90deg,var(--gold-dark),var(--gold-light));border-radius:100px;transition:width .4s ease}
/* Collapsible */
.collapsible-header{display:flex;justify-content:space-between;align-items:center;cursor:pointer;user-select:none;padding:0}
.collapsible-header:hover .caret{color:var(--gold)}
.caret{font-size:.8rem;color:var(--muted);transition:transform .25s}
.caret.open{transform:rotate(180deg)}
.collapsible-body{overflow:hidden;max-height:0;transition:max-height .35s ease}
.collapsible-body.open{max-height:2000px}
/* Plan cards */
.plan-card{background:var(--surface);border:1px solid var(--border-s);border-radius:var(--r);padding:16px;margin-bottom:9px;cursor:pointer;transition:all .2s;position:relative;overflow:hidden}
.plan-card:active{transform:scale(.98)}
.plan-card:hover,.plan-card.selected{border-color:var(--gold);box-shadow:0 0 0 1px rgba(201,168,76,.25);background:linear-gradient(135deg,rgba(201,168,76,.05),var(--surface))}
.plan-card.owned{border-color:var(--green);box-shadow:0 0 0 1px rgba(29,184,127,.2);background:linear-gradient(135deg,rgba(29,184,127,.05),var(--surface))}
.plan-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:10px}
.plan-name{font-family:'Playfair Display',serif;font-size:1.05rem;font-weight:700}
.plan-amount{font-family:'JetBrains Mono',monospace;font-size:.95rem;font-weight:600;color:var(--gold)}
.plan-stats{display:grid;grid-template-columns:1fr 1fr;gap:5px}
.plan-stat{background:var(--bg3);border-radius:6px;padding:7px 9px}
.plan-stat-val{font-size:.8rem;font-weight:700}
.plan-stat-lbl{font-size:.62rem;color:var(--muted);text-transform:uppercase;letter-spacing:.05em;margin-top:1px}
/* Purchase summary */
.purchase-sum{background:linear-gradient(135deg,rgba(201,168,76,.08),rgba(201,168,76,.02));border:1px solid var(--border);border-radius:var(--r);padding:18px;margin-bottom:12px}
.sum-row{display:flex;justify-content:space-between;align-items:center;padding:9px 0;border-bottom:1px solid var(--border-s);font-size:.88rem}
.sum-row:last-child{border-bottom:none;font-weight:700}
.sum-label{color:var(--muted)}
.sum-val{font-family:'JetBrains Mono',monospace}
.sum-val.hi{color:var(--green);font-size:1rem}
/* Task cards */
.task-card{background:var(--surface);border:1px solid var(--border-s);border-radius:var(--r);overflow:hidden;margin-bottom:12px}
.task-card-body{padding:15px}
.task-type-bar{height:3px;width:100%}
.task-type-yt{background:linear-gradient(90deg,#ff0000,#ff6b6b)}
.task-type-read{background:linear-gradient(90deg,var(--gold),var(--gold-light))}
.task-type-tiktok{background:linear-gradient(90deg,#010101,#fe2c55)}
.task-type-sub{background:linear-gradient(90deg,#ff0000,#282828)}
.task-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:8px;gap:10px}
.task-title{font-weight:700;font-size:.9rem;line-height:1.4}
.task-reward{font-family:'JetBrains Mono',monospace;font-size:.88rem;font-weight:700;color:var(--green);white-space:nowrap}
.task-desc{font-size:.78rem;color:var(--muted);margin-bottom:12px;line-height:1.5}
.task-embed{width:100%;aspect-ratio:16/9;border:none;background:#000;border-radius:var(--rs) var(--rs) 0 0}
/* Timer */
.task-timer{display:flex;align-items:center;gap:8px;background:var(--bg3);border-radius:var(--rs);padding:10px 14px;margin-bottom:10px;font-family:'JetBrains Mono',monospace;font-size:.85rem;color:var(--gold)}
.task-timer-circle{width:32px;height:32px;position:relative;flex-shrink:0}
.task-timer-circle svg{transform:rotate(-90deg)}
.timer-bg{fill:none;stroke:var(--border-s);stroke-width:3}
.timer-fill{fill:none;stroke:var(--gold);stroke-width:3;stroke-linecap:round;transition:stroke-dashoffset .9s linear}
.timer-count{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-size:.55rem;font-weight:700;color:var(--gold)}
/* Wallet tabs */
.tab-bar{display:flex;background:var(--bg3);border:1px solid var(--border-s);border-radius:var(--rs);padding:3px;margin-bottom:14px;gap:3px}
.tab-btn{flex:1;padding:9px;border:none;border-radius:6px;font-family:'DM Sans',sans-serif;font-size:.82rem;font-weight:600;cursor:pointer;background:none;color:var(--muted);transition:all .2s}
.tab-btn.active{background:var(--surface2);color:var(--gold);border:1px solid var(--border)}
/* Info rows */
.info-row{display:flex;justify-content:space-between;align-items:center;padding:13px 0;border-bottom:1px solid var(--border-s)}
.info-row:last-child{border-bottom:none}
.info-label{font-size:.8rem;color:var(--muted)}
.info-val{font-size:.875rem;font-weight:600;text-align:right;max-width:60%;word-break:break-word}
/* Table */
table{width:100%;border-collapse:collapse;font-size:.8rem}
th{text-align:left;padding:9px 11px;color:var(--muted);font-size:.67rem;font-weight:700;text-transform:uppercase;letter-spacing:.07em;border-bottom:1px solid var(--border-s)}
td{padding:11px;border-bottom:1px solid rgba(255,255,255,.03);color:var(--text)}
tr:last-child td{border-bottom:none}
/* Leaderboard */
.lb-item{display:flex;align-items:center;gap:12px;padding:12px 0;border-bottom:1px solid var(--border-s)}
.lb-item:last-child{border-bottom:none}
.lb-rank{font-family:'JetBrains Mono',monospace;font-size:1rem;font-weight:700;width:28px;text-align:center;color:var(--dim)}
.lb-rank.top{color:var(--gold)}
.lb-info{flex:1}
.lb-name{font-weight:600;font-size:.875rem}
.lb-total{font-size:.72rem;color:var(--muted)}
.lb-count{font-family:'JetBrains Mono',monospace;font-size:1.1rem;font-weight:700;color:var(--gold)}
/* Profile */
.profile-hero{background:linear-gradient(135deg,var(--bg3),var(--surface));border:1px solid var(--border-s);border-radius:var(--r);padding:26px 18px;text-align:center;margin-bottom:12px}
.avatar{width:76px;height:76px;border-radius:50%;background:linear-gradient(135deg,var(--gold-dark),var(--gold));display:flex;align-items:center;justify-content:center;font-family:'Playfair Display',serif;font-size:1.7rem;font-weight:700;color:#0A0C10;margin:0 auto 12px;position:relative;border:3px solid rgba(201,168,76,.3)}
.avatar-img{width:76px;height:76px;border-radius:50%;object-fit:cover;border:3px solid var(--border);display:none;margin:0 auto 12px}
.avatar-edit{position:absolute;bottom:0;right:0;width:24px;height:24px;background:var(--surface);border:1px solid var(--border);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:.65rem;cursor:pointer}
/* Modal */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.75);z-index:1000;display:flex;align-items:flex-end;justify-content:center;backdrop-filter:blur(4px);-webkit-backdrop-filter:blur(4px)}
.modal-sheet{background:var(--bg2);border:1px solid var(--border-s);border-radius:20px 20px 0 0;width:100%;max-width:480px;max-height:90vh;overflow-y:auto;padding:6px 18px 40px;animation:slideUp .3s ease-out}
@keyframes slideUp{from{transform:translateY(100%)}to{transform:translateY(0)}}
.modal-handle{width:38px;height:4px;background:var(--border);border-radius:100px;margin:10px auto 18px}
.modal-title{font-family:'Playfair Display',serif;font-size:1.25rem;font-weight:700;margin-bottom:6px}
/* Streak */
.streak-grid{display:flex;gap:7px;justify-content:center;flex-wrap:wrap;margin:14px 0}
.streak-dot{width:36px;height:36px;border-radius:50%;border:2px solid var(--border-s);background:var(--bg3);display:flex;align-items:center;justify-content:center;font-size:.72rem;font-weight:700;color:var(--dim)}
.streak-dot.done{background:var(--green);border-color:var(--green);color:#fff}
.streak-dot.today{background:var(--gold);border-color:var(--gold-light);color:#0A0C10;animation:pulse 1.5s ease-in-out infinite}
@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.08)}}
/* Pay option */
.pay-opt{background:var(--surface);border:1px solid var(--border-s);border-radius:var(--r);padding:14px;margin-bottom:9px;cursor:pointer;display:flex;align-items:center;gap:12px;transition:all .2s}
.pay-opt:hover{border-color:var(--gold);background:rgba(201,168,76,.04)}
.pay-opt.disabled{opacity:.4;pointer-events:none}
/* Notif center */
.notif-panel{position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:1001;display:flex;align-items:flex-end;justify-content:center}
.notif-sheet{background:var(--bg2);border-radius:20px 20px 0 0;width:100%;max-width:480px;max-height:80vh;overflow-y:auto;animation:slideUp .3s ease-out}
.notif-item{padding:14px 18px;border-bottom:1px solid var(--border-s);cursor:pointer}
.notif-item.unread{background:rgba(201,168,76,.04);border-left:3px solid var(--gold)}
/* Toast */
#toastCont{position:fixed;top:14px;left:50%;transform:translateX(-50%);z-index:9999;display:flex;flex-direction:column;gap:7px;width:calc(100% - 28px);max-width:440px;pointer-events:none}
.toast{background:var(--surface);border:1px solid var(--border-s);border-radius:var(--rs);padding:13px 15px;display:flex;align-items:flex-start;gap:11px;box-shadow:0 12px 40px rgba(0,0,0,.6);animation:toastIn .3s ease-out;pointer-events:auto;border-left-width:3px}
@keyframes toastIn{from{transform:translateY(-18px);opacity:0}to{transform:translateY(0);opacity:1}}
.toast-close{font-size:.95rem;cursor:pointer;color:var(--dim);background:none;border:none;flex-shrink:0;margin-left:auto}
/* Screenshot upload */
.upload-zone{border:2px dashed var(--border-s);border-radius:var(--rs);padding:20px;text-align:center;cursor:pointer;transition:all .2s;background:var(--bg3)}
.upload-zone:hover{border-color:var(--gold);background:rgba(201,168,76,.04)}
.upload-zone input{display:none}
.upload-preview{max-width:100%;border-radius:var(--rs);margin-top:12px;max-height:200px;object-fit:contain;display:none}
/* Admin */
.admin-wrap{min-height:100vh;max-width:100%}
.admin-header{background:var(--bg2);border-bottom:1px solid var(--border-s);padding:14px 18px;display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;z-index:100;max-width:100%}
.admin-tabs{display:flex;gap:5px;overflow-x:auto;padding:11px 14px;background:var(--bg2);border-bottom:1px solid var(--border-s);scrollbar-width:none}
.admin-tabs::-webkit-scrollbar{display:none}
.admin-tab{white-space:nowrap;padding:7px 14px;border-radius:var(--rs);border:1px solid var(--border-s);background:var(--surface);color:var(--muted);font-size:.78rem;font-weight:600;cursor:pointer;font-family:'DM Sans',sans-serif;transition:all .2s}
.admin-tab.active{background:var(--gold);color:#0A0C10;border-color:var(--gold)}
.admin-content{padding:14px;max-width:100%}
.admin-stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(130px,1fr));gap:9px;margin-bottom:14px}
.admin-stat{background:var(--surface);border:1px solid var(--border-s);border-radius:var(--r);padding:14px;text-align:center}
.admin-stat-val{font-family:'JetBrains Mono',monospace;font-size:1.4rem;font-weight:700;color:var(--gold)}
.admin-stat-lbl{font-size:.68rem;color:var(--muted);margin-top:3px;text-transform:uppercase;letter-spacing:.04em}
/* Deposit card admin */
.dep-card{background:var(--surface);border:1px solid var(--border-s);border-radius:var(--r);padding:16px;margin-bottom:10px}
.dep-card img{max-width:100%;border-radius:var(--rs);margin-top:10px;cursor:pointer}
.section-title{font-family:'Playfair Display',serif;font-size:1.25rem;font-weight:700;color:var(--text);margin-bottom:3px}
.section-sub{font-size:.78rem;color:var(--muted);margin-bottom:14px}
/* Reading task */
.reading-content{background:var(--bg3);border-radius:var(--rs);padding:14px;font-size:.85rem;line-height:1.75;color:var(--muted);margin-bottom:12px;max-height:200px;overflow-y:auto}
/* Success overlay */
.success-overlay{position:fixed;inset:0;background:rgba(10,12,16,.95);z-index:2000;display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;padding:30px}
.success-icon{font-size:5rem;margin-bottom:20px;animation:bounceIn .5s ease-out}
@keyframes bounceIn{0%{transform:scale(0)}70%{transform:scale(1.1)}100%{transform:scale(1)}}
::-webkit-scrollbar{width:3px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:var(--border);border-radius:100px}
@keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
.fade-in{animation:fadeIn .3s ease-out}
</style>
</head>
<body>
<!-- LOADING -->
<div id="loadingScreen">
  <div class="loader-logo">VaultPro</div>
  <div class="loader-tag">Investment Platform</div>
  <div class="loader-ring"></div>
</div>
<!-- TOASTS -->
<div id="toastCont"></div>

<!-- ===== REFERRAL LANDING ===== -->
<div id="referralLandingPage" class="landing-page hidden">
  <div class="landing-hero" style="width:100%">
    <div style="font-size:3.2rem;margin-bottom:14px">üè¶</div>
    <div class="landing-title">You've been invited!</div>
    <div style="font-size:.88rem;color:var(--muted);margin-top:6px">Join Uganda's premier investment platform</div>
  </div>
  <div class="invite-code-box">
    <div style="font-size:.7rem;font-weight:700;letter-spacing:.12em;text-transform:uppercase;color:var(--muted);margin-bottom:10px">Your Invitation Code</div>
    <div class="invite-code-val" id="landingCode">‚Äî‚Äî</div>
  </div>
  <div style="display:flex;flex-direction:column;gap:9px;width:100%;max-width:360px">
    <button class="btn btn-gold btn-full" onclick="showRegisterFromReferral()">Create Account ‚Üí</button>
    <button class="btn btn-outline btn-full" onclick="showLogin()">Already have an account</button>
  </div>
  <div style="margin-top:24px;display:flex;flex-direction:column;gap:9px;width:100%">
    <div class="card" style="display:flex;gap:12px;align-items:center;padding:13px 15px"><span style="font-size:1.3rem">‚úÖ</span><div><div style="font-weight:700;font-size:.875rem">Daily Task Rewards</div><div style="font-size:.75rem;color:var(--muted)">Earn UGX by completing tasks every day</div></div></div>
    <div class="card" style="display:flex;gap:12px;align-items:center;padding:13px 15px"><span style="font-size:1.3rem">üíé</span><div><div style="font-weight:700;font-size:.875rem">Vault Investment Plans</div><div style="font-size:.75rem;color:var(--muted)">Grow capital with structured plans</div></div></div>
    <div class="card" style="display:flex;gap:12px;align-items:center;padding:13px 15px"><span style="font-size:1.3rem">üë•</span><div><div style="font-weight:700;font-size:.875rem">10% Referral Bonus</div><div style="font-size:.75rem;color:var(--muted)">Earn when your referrals invest</div></div></div>
  </div>
</div>

<!-- ===== REGISTER ===== -->
<div id="registerPage" class="auth-page hidden">
  <div class="auth-header"><div class="auth-logo">VaultPro</div><div class="auth-sub">Create your account</div></div>
  <div class="auth-body">
    <div id="registerAlert"></div>
    <div class="fg"><label>Invitation Code</label><input type="text" id="inviteCode" placeholder="Enter your code" style="text-transform:uppercase;letter-spacing:.1em"></div>
    <div class="fg"><label>Full Name</label><input type="text" id="fullName" placeholder="Your full name"></div>
    <div class="fg"><label>Email Address</label><input type="email" id="email" placeholder="you@example.com"></div>
    <div class="fg"><label>Phone Number (for withdrawals)</label><input type="tel" id="regPhone" placeholder="07XXXXXXXX"></div>
    <div class="fg"><label>Password</label><input type="password" id="password" placeholder="At least 6 characters"></div>
    <div class="fg"><label>Confirm Password</label><input type="password" id="confirmPassword" placeholder="Repeat password"></div>
    <button class="btn btn-gold btn-full" id="registerBtn" onclick="register()">Create Account</button>
    <p style="text-align:center;margin-top:18px;font-size:.875rem;color:var(--muted)">Already have an account? <a href="#" onclick="showLogin()" style="color:var(--gold);text-decoration:none;font-weight:600">Sign in</a></p>
  </div>
</div>

<!-- ===== LOGIN ===== -->
<div id="loginPage" class="auth-page hidden">
  <div class="auth-header"><div class="auth-logo">VaultPro</div><div class="auth-sub">Sign in to your account</div></div>
  <div class="auth-body">
    <div id="loginAlert"></div>
    <div class="fg"><label>Email Address</label><input type="email" id="loginEmail" placeholder="you@example.com"></div>
    <div class="fg"><label>Password</label><input type="password" id="loginPassword" placeholder="Your password"></div>
    <button class="btn btn-gold btn-full" id="loginBtn" onclick="login()" style="margin-top:6px">Sign In</button>
    <p style="text-align:center;margin-top:18px;font-size:.875rem;color:var(--muted)">Don't have an account? <a href="#" onclick="showRegister()" style="color:var(--gold);text-decoration:none;font-weight:600">Join now</a></p>
  </div>
</div>

<!-- ===== USER DASHBOARD ===== -->
<div id="userDashboard" class="hidden">
  <div class="dash-header">
    <div>
      <div class="header-brand">VaultPro</div>
      <div class="header-user-sub" id="headerSub">Loading‚Ä¶</div>
    </div>
    <div style="display:flex;gap:7px">
      <button class="icon-btn" onclick="openNotif()" title="Notifications">üîî<span class="notif-dot hidden" id="notifBadge"></span></button>
    </div>
  </div>

  <!-- HOME -->
  <div id="homeSection" class="content hidden fade-in">
    <div class="balance-hero">
      <div class="balance-label">Total Balance</div>
      <div class="balance-value" id="totalBalance">0</div>
      <div class="balance-currency">UGX <span id="activeBadge" class="badge badge-success hidden" style="margin-left:6px">Active</span></div>
    </div>
    <div class="stat-grid">
      <div class="stat-tile"><div class="stat-tile-icon">üë•</div><div class="stat-tile-value" id="statRefs">0</div><div class="stat-tile-label">Referrals</div></div>
      <div class="stat-tile"><div class="stat-tile-icon">‚úÖ</div><div class="stat-tile-value" id="statTask">0</div><div class="stat-tile-label">Task Earnings</div></div>
      <div class="stat-tile"><div class="stat-tile-icon">üí∏</div><div class="stat-tile-value" id="statRef">0</div><div class="stat-tile-label">Referral Earn.</div></div>
      <div class="stat-tile"><div class="stat-tile-icon">üíé</div><div class="stat-tile-value" id="statLevel">‚Äî</div><div class="stat-tile-label">Vault Level</div></div>
    </div>

    <!-- Vault Plans Overview - Collapsible -->
    <div class="card">
      <div class="collapsible-header" onclick="toggleCollapse('vaultOverview')">
        <div style="font-weight:700;font-size:.9rem">üìä Vault Plans Overview</div>
        <span class="caret" id="vaultOverviewCaret">‚ñº</span>
      </div>
      <div class="collapsible-body" id="vaultOverview" style="margin-top:0">
        <div style="margin-top:14px;overflow-x:auto">
          <table>
            <thead><tr><th>Plan</th><th>Amount</th><th>Tasks</th><th>Reward</th></tr></thead>
            <tbody>
              <tr><td>üå± Beginner</td><td>45K</td><td>2/day</td><td>750</td></tr>
              <tr><td>üåø Seed</td><td>180K</td><td>3/day</td><td>2,000</td></tr>
              <tr><td>üåÖ Rising</td><td>600K</td><td>4/day</td><td>5,000</td></tr>
              <tr><td>üí° Nova</td><td>1.35M</td><td>5/day</td><td>9,000</td></tr>
              <tr><td>üß† Mastermind</td><td>4.05M</td><td>6/day</td><td>22,500</td></tr>
              <tr><td>üí™ Titan</td><td>8.775M</td><td>7/day</td><td>42,000</td></tr>
              <tr><td>üëë King</td><td>16.65M</td><td>8/day</td><td>69,375</td></tr>
              <tr><td>ü¶Ö Emperor</td><td>29.7M</td><td>9/day</td><td>110K</td></tr>
              <tr><td>‚≠ê Icon</td><td>48.6M</td><td>10/day</td><td>162K</td></tr>
              <tr><td>üëë Supreme</td><td>81M</td><td>11/day</td><td>245K</td></tr>
              <tr><td>üèÜ Legendary</td><td>110M</td><td>12/day</td><td>305K</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Weekly Leaderboard - Collapsible -->
    <div class="card">
      <div class="collapsible-header" onclick="toggleCollapse('leaderboard')">
        <div>
          <div style="font-weight:700;font-size:.9rem">üèÜ Weekly Leaderboard</div>
          <div style="font-size:.72rem;color:var(--muted);margin-top:2px">Top referrer wins <strong style="color:var(--gold)">50,000 UGX</strong> ¬∑ Resets in: <span id="weekTimer">‚Äî</span></div>
        </div>
        <span class="caret" id="leaderboardCaret">‚ñº</span>
      </div>
      <div class="collapsible-body" id="leaderboard" style="margin-top:0">
        <div id="leaderboardList" style="margin-top:14px"><div style="text-align:center;color:var(--muted);padding:12px">Loading‚Ä¶</div></div>
      </div>
    </div>

    <!-- WhatsApp -->
    <div class="card" style="background:linear-gradient(135deg,rgba(37,211,102,.08),rgba(18,140,126,.05));border-color:rgba(37,211,102,.2);text-align:center">
      <div style="font-size:1.4rem;margin-bottom:7px">üí¨</div>
      <div style="font-weight:700;margin-bottom:4px">Join Our WhatsApp Group</div>
      <div style="font-size:.78rem;color:var(--muted);margin-bottom:12px">Get updates & connect with investors</div>
      <a href="https://chat.whatsapp.com/KBvY0dutPIcHPLNzjBcJZQ" target="_blank" class="btn btn-green btn-full" style="text-decoration:none">Join Now</a>
    </div>
  </div>

  <!-- VAULT -->
  <div id="vaultSection" class="content hidden fade-in">
    <div class="section-title">Vault Plans</div>
    <div class="section-sub">Select a plan to unlock daily task rewards</div>
    <div id="vaultAlert"></div>
    <div class="balance-hero" style="margin-bottom:14px">
      <div class="balance-label">Available Balance</div>
      <div class="balance-value" id="vaultBalance">0</div>
      <div class="balance-currency">UGX</div>
    </div>
    <div id="plansList"></div>
    <div id="selectedPlanDetails" class="hidden">
      <div class="purchase-sum" id="purchaseSumContent"></div>
      <button class="btn btn-gold btn-full" id="purchaseBtn" onclick="purchaseVault()">Confirm Purchase</button>
    </div>
  </div>

  <!-- REFERRALS -->
  <div id="referralsSection" class="content hidden fade-in">
    <div class="section-title">Referrals</div>
    <div class="section-sub">Earn 10% on vault purchases + weekly prizes</div>
    <div id="referralsAlert"></div>
    <div class="balance-hero" style="margin-bottom:12px">
      <div class="balance-label">Total Referral Earnings</div>
      <div class="balance-value" id="totalRefEarnings">0</div>
      <div class="balance-currency">UGX</div>
    </div>
    <div class="card">
      <div style="font-weight:700;margin-bottom:12px">üîó Your Referral Link</div>
      <div style="background:var(--bg3);border:1px solid var(--border-s);border-radius:var(--rs);padding:11px 13px;font-family:'JetBrains Mono',monospace;font-size:.7rem;color:var(--muted);word-break:break-all;margin-bottom:12px;line-height:1.6" id="userRefLink">Loading‚Ä¶</div>
      <div style="display:flex;gap:8px">
        <button class="btn btn-gold" style="flex:1;padding:11px" onclick="copyRefLink()">Copy Link</button>
        <button class="btn btn-outline" style="flex:1;padding:11px" onclick="shareRefLink()">Share</button>
      </div>
    </div>
    <div class="card" id="refLevelCard"></div>
    <div class="card">
      <div style="font-weight:700;margin-bottom:12px">How it works</div>
      <div style="display:flex;flex-direction:column;gap:10px">
        <div style="display:flex;gap:11px"><span style="font-size:1.1rem">üéØ</span><div><div style="font-weight:600;font-size:.875rem">Vault Purchase Bonus</div><div style="font-size:.76rem;color:var(--muted);margin-top:2px">Earn 10% of every vault plan your referral purchases</div></div></div>
        <div style="display:flex;gap:11px"><span style="font-size:1.1rem">üå≥</span><div><div style="font-weight:600;font-size:.875rem">Second-Level Bonus</div><div style="font-size:.76rem;color:var(--muted);margin-top:2px">Earn 2,000 UGX when your referral recruits someone</div></div></div>
        <div style="display:flex;gap:11px"><span style="font-size:1.1rem">üèÜ</span><div><div style="font-weight:600;font-size:.875rem">Weekly Prize</div><div style="font-size:.76rem;color:var(--muted);margin-top:2px">Top referrer each week wins 50,000 UGX</div></div></div>
      </div>
    </div>
    <div class="card">
      <div style="font-weight:700;margin-bottom:12px">Your Referrals</div>
      <div id="referralsList" style="color:var(--muted);text-align:center;padding:14px">Loading‚Ä¶</div>
    </div>
  </div>

  <!-- TASKS -->
  <div id="tasksSection" class="content hidden fade-in">
    <div class="section-title">Daily Tasks</div>
    <div class="section-sub">Complete tasks to earn your daily rewards</div>
    <div id="tasksAlert"></div>
    <div class="card" style="padding:14px">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:7px">
        <span style="font-size:.78rem;font-weight:700;color:var(--muted)">Today's Progress</span>
        <span id="taskProgText" style="font-family:'JetBrains Mono',monospace;font-size:.875rem;font-weight:700;color:var(--gold)">0 / 0</span>
      </div>
      <div class="prog-wrap"><div class="prog-fill" id="taskProgBar" style="width:0%"></div></div>
    </div>
    <div id="tasksList"><div style="text-align:center;padding:40px;color:var(--muted)">Loading tasks‚Ä¶</div></div>
  </div>

  <!-- WALLET -->
  <div id="walletSection" class="content hidden fade-in">
    <div class="section-title">Wallet</div>
    <div class="section-sub">Manage your funds</div>
    <div id="walletAlert"></div>
    <div class="balance-hero" style="margin-bottom:12px">
      <div class="balance-label">Available Balance</div>
      <div class="balance-value" id="walletBal">0</div>
      <div class="balance-currency">UGX ¬∑ Points: <strong id="walletPts">0</strong></div>
    </div>
    <div class="tab-bar">
      <button class="tab-btn active" id="depTab" onclick="showWalletTab('dep')">Deposit</button>
      <button class="tab-btn" id="wdTab" onclick="showWalletTab('wd')">Withdraw</button>
      <button class="tab-btn" id="histTab" onclick="showWalletTab('hist')">History</button>
    </div>

    <!-- Deposit Panel -->
    <div id="depPanel">
      <div class="card">
        <div style="font-weight:700;margin-bottom:14px">üí∞ Deposit Funds</div>
        <div id="depAlert"></div>
        <div class="card" style="background:rgba(201,168,76,.06);border-color:var(--border);padding:13px;margin-bottom:14px">
          <div style="font-size:.78rem;line-height:1.75;color:var(--muted)">
            <strong style="color:var(--gold);display:block;margin-bottom:4px">üì± Payment Instructions</strong>
            1. Send money to: <strong onclick="navigator.clipboard.writeText('0785000000');toast('Number copied!','üìã','info')" style="cursor:pointer;color:var(--gold)">0785 000 000</strong><br>
            2. Enter amount, select method, enter your number<br>
            3. Upload a screenshot of your payment confirmation<br>
            4. Submit ‚Äî admin approves within 1 hour
          </div>
        </div>
        <div class="fg"><label>Amount (UGX)</label><input type="number" id="depAmount" placeholder="Minimum 1,000"></div>
        <div class="fg"><label>Payment Method</label>
          <select id="depMethod"><option value="">Select method</option><option value="mtn">MTN Mobile Money</option><option value="airtel">Airtel Money</option></select>
        </div>
        <div class="fg"><label>Your Phone Number</label><input type="tel" id="depPhone" placeholder="07XXXXXXXX"></div>
        <div class="fg">
          <label>Payment Screenshot (Required)</label>
          <label class="upload-zone" for="depScreenshot">
            <input type="file" id="depScreenshot" accept="image/*" onchange="previewScreenshot(this,'depPreview')">
            <div style="font-size:1.8rem;margin-bottom:8px">üì∏</div>
            <div style="font-size:.82rem;color:var(--muted)">Tap to upload payment screenshot</div>
            <img id="depPreview" class="upload-preview">
          </label>
        </div>
        <button class="btn btn-green btn-full" onclick="submitDeposit()">Submit Deposit Request</button>
      </div>
    </div>

    <!-- Withdraw Panel -->
    <div id="wdPanel" class="hidden">
      <div class="card">
        <div style="font-weight:700;margin-bottom:14px">üí∏ Withdraw Funds</div>
        <div id="wdAlert"></div>
        <div class="fg"><label>Earnings Category</label>
          <select id="wdCat"><option value="">Select category</option><option value="referral">Referral Earnings</option><option value="task">Task Earnings (Fri‚ÄìSat only)</option><option value="vault">Vault Earnings</option></select>
        </div>
        <div class="fg"><label>Amount (UGX)</label><input type="number" id="wdAmount" placeholder="Minimum 5,000"></div>
        <div class="fg">
          <label>Mobile Money Number <span style="color:var(--gold);font-size:.7rem">(auto-filled from profile)</span></label>
          <input type="tel" id="wdPhone" placeholder="07XXXXXXXX">
        </div>
        <div class="card" style="background:rgba(232,68,90,.06);border-color:rgba(232,68,90,.2);padding:13px;margin-bottom:14px">
          <div style="font-size:.78rem;color:var(--muted);line-height:1.7"><strong style="color:var(--red);display:block;margin-bottom:3px">‚ö†Ô∏è Withdrawal Rules</strong>Task earnings: Friday &amp; Saturday only<br>Admin fee: 5% ¬∑ Minimum: 5,000 UGX</div>
        </div>
        <button class="btn btn-gold btn-full" onclick="submitWithdrawal()">Request Withdrawal</button>
      </div>
    </div>

    <!-- History Panel -->
    <div id="histPanel" class="hidden">
      <div class="card" style="padding:0;overflow:hidden">
        <div style="padding:14px;border-bottom:1px solid var(--border-s);font-weight:700">Transaction History</div>
        <div style="overflow-x:auto"><table><thead><tr><th>Date</th><th>Type</th><th>Amount</th><th>Status</th></tr></thead><tbody id="txHistory"><tr><td colspan="4" style="text-align:center;color:var(--muted)">No transactions yet</td></tr></tbody></table></div>
      </div>
    </div>
  </div>

  <!-- STREAK -->
  <div id="streakSection" class="content hidden fade-in">
    <div class="section-title">Daily Streak</div>
    <div class="section-sub">Login every day to earn bonus points</div>
    <div id="streakAlert"></div>
    <div class="card" style="text-align:center;padding:26px">
      <div style="font-size:3.2rem;margin-bottom:7px">üî•</div>
      <div style="font-family:'Playfair Display',serif;font-size:2.8rem;font-weight:800;color:var(--gold)" id="streakCount">0</div>
      <div style="color:var(--muted);margin-bottom:14px">Day Streak</div>
      <div class="streak-grid" id="streakDots"></div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:9px;margin-top:14px">
        <div class="stat-tile"><div class="stat-tile-value" id="streakPts">0</div><div class="stat-tile-label">Points Balance</div></div>
        <div class="stat-tile"><div class="stat-tile-value" id="bestStreak">0</div><div class="stat-tile-label">Best Streak</div></div>
      </div>
    </div>
    <div class="card">
      <div style="font-weight:700;margin-bottom:5px">Convert Points</div>
      <div style="font-size:.78rem;color:var(--muted);margin-bottom:13px">100 points = 1,000 UGX</div>
      <div style="display:flex;gap:10px;margin-bottom:13px">
        <div style="flex:1"><label style="font-size:.7rem;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.08em;display:block;margin-bottom:6px">Points</label><input type="number" id="ptsConvert" placeholder="Min 100" style="width:100%;padding:11px;background:var(--bg3);border:1px solid var(--border-s);border-radius:var(--rs);color:var(--text);font-family:'DM Sans',sans-serif;font-size:.9rem" oninput="document.getElementById('ptsPreview').textContent=((parseInt(this.value)||0)*10).toLocaleString()+' UGX'"></div>
        <div style="flex:1"><label style="font-size:.7rem;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.08em;display:block;margin-bottom:6px">You Receive</label><div style="padding:11px;background:var(--bg3);border-radius:var(--rs);font-family:'JetBrains Mono',monospace;font-weight:700;color:var(--green)" id="ptsPreview">0 UGX</div></div>
      </div>
      <button class="btn btn-green btn-full" onclick="convertPoints()">Convert Points</button>
    </div>
  </div>

  <!-- PROFILE -->
  <div id="profileSection" class="content hidden fade-in">
    <div id="profileAlert"></div>
    <div class="profile-hero">
      <div class="avatar" id="profileAvatar">
        <span id="profileInitials">?</span>
        <label class="avatar-edit" title="Change photo">üì∑<input type="file" accept="image/*" style="display:none" onchange="uploadPic(event)"></label>
      </div>
      <img id="profileImg" class="avatar-img">
      <div style="font-family:'Playfair Display',serif;font-size:1.35rem;font-weight:700" id="profileName">‚Äî</div>
      <div style="font-size:.8rem;color:var(--muted);margin-top:3px" id="profileEmail">‚Äî</div>
      <div style="margin-top:10px" id="profileLvlBadge"></div>
    </div>
    <div class="card">
      <div style="font-weight:700;margin-bottom:13px">Account Information</div>
      <div class="info-row">
        <span class="info-label">Full Name</span>
        <div style="display:flex;align-items:center;gap:8px"><span class="info-val" id="profileNameVal">‚Äî</span><button onclick="toggleNameEdit()" style="background:none;border:none;color:var(--gold);cursor:pointer;font-size:.78rem;font-weight:600">Edit</button></div>
      </div>
      <div id="nameEditBox" class="hidden" style="margin:8px 0 12px">
        <input type="text" id="nameEditInput" style="width:100%;padding:10px 12px;background:var(--bg3);border:1px solid var(--gold);border-radius:var(--rs);color:var(--text);font-family:'DM Sans',sans-serif;margin-bottom:7px">
        <div style="display:flex;gap:7px"><button class="btn btn-green" style="flex:1;padding:9px" onclick="saveName()">Save</button><button class="btn btn-surface" style="flex:1;padding:9px" onclick="cancelName()">Cancel</button></div>
      </div>
      <div class="info-row"><span class="info-label">Email</span><span class="info-val" id="profileEmailVal">‚Äî</span></div>
      <div class="info-row">
        <span class="info-label">Phone Number</span>
        <div style="display:flex;align-items:center;gap:8px"><span class="info-val" id="profilePhoneVal">‚Äî</span><button onclick="togglePhoneEdit()" style="background:none;border:none;color:var(--gold);cursor:pointer;font-size:.78rem;font-weight:600">Edit</button></div>
      </div>
      <div id="phoneEditBox" class="hidden" style="margin:8px 0 12px">
        <input type="tel" id="phoneEditInput" style="width:100%;padding:10px 12px;background:var(--bg3);border:1px solid var(--gold);border-radius:var(--rs);color:var(--text);font-family:'DM Sans',sans-serif;margin-bottom:7px" placeholder="07XXXXXXXX">
        <div style="display:flex;gap:7px"><button class="btn btn-green" style="flex:1;padding:9px" onclick="savePhone()">Save</button><button class="btn btn-surface" style="flex:1;padding:9px" onclick="cancelPhone()">Cancel</button></div>
      </div>
      <div class="info-row"><span class="info-label">Joined</span><span class="info-val" id="profileJoined">‚Äî</span></div>
      <div class="info-row"><span class="info-label">Status</span><span class="info-val" id="profileStatus">‚Äî</span></div>
    </div>
    <div class="card">
      <div style="font-weight:700;margin-bottom:13px">Statistics</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:9px">
        <div class="stat-tile"><div class="stat-tile-value" id="profVaults">0</div><div class="stat-tile-label">Vaults</div></div>
        <div class="stat-tile"><div class="stat-tile-value" id="profLevel">‚Äî</div><div class="stat-tile-label">Level</div></div>
        <div class="stat-tile"><div class="stat-tile-value" id="profPts">0</div><div class="stat-tile-label">Points</div></div>
        <div class="stat-tile"><div class="stat-tile-value" id="profStreak">0</div><div class="stat-tile-label">Streak</div></div>
      </div>
    </div>
    <div class="card card-gold">
      <div style="font-weight:700;margin-bottom:9px">Your Referral Code</div>
      <div style="font-family:'JetBrains Mono',monospace;font-size:1.7rem;font-weight:700;color:var(--gold);text-align:center;letter-spacing:.12em;margin-bottom:13px" id="profRefCode">‚Äî</div>
      <button class="btn btn-outline btn-full" onclick="copyRefCode()">üìã Copy Code</button>
    </div>
    <div class="card" style="padding:0"><button class="btn btn-full" onclick="logout()" style="background:rgba(232,68,90,.12);color:var(--red);border:1px solid rgba(232,68,90,.3);border-radius:var(--r);padding:15px;font-weight:700">üö™ Sign Out</button></div>
  </div>

  <nav class="bottom-nav">
    <button class="nav-item active" data-section="home" onclick="showSection('home')"><span class="nav-icon">üè†</span>Home</button>
    <button class="nav-item" data-section="vault" onclick="showSection('vault')"><span class="nav-icon">üè¶</span>Vault</button>
    <button class="nav-item" data-section="referrals" onclick="showSection('referrals')"><span class="nav-icon">üë•</span>Refer</button>
    <button class="nav-item" data-section="tasks" onclick="showSection('tasks')"><span class="nav-icon">‚úÖ</span>Tasks</button>
    <button class="nav-item" data-section="wallet" onclick="showSection('wallet')"><span class="nav-icon">üíº</span>Wallet</button>
    <button class="nav-item" data-section="streak" onclick="showSection('streak')"><span class="nav-icon">üî•</span>Streak</button>
    <button class="nav-item" data-section="profile" onclick="showSection('profile')"><span class="nav-icon">üë§</span>Profile</button>
  </nav>
</div>

<!-- ===== ADMIN DASHBOARD ===== -->
<div id="adminDashboard" class="admin-wrap hidden">
  <div class="admin-header" style="max-width:100%;position:sticky;top:0;z-index:100">
    <span style="font-family:'Playfair Display',serif;font-size:1.15rem;color:var(--gold)">VaultPro Admin</span>
    <button class="btn btn-surface" style="padding:7px 14px;font-size:.78rem" onclick="logout()">Sign Out</button>
  </div>
  <div class="admin-tabs">
    <button class="admin-tab active" onclick="showAdmin('stats',this)">üìä Stats</button>
    <button class="admin-tab" onclick="showAdmin('users',this)">üë• Users</button>
    <button class="admin-tab" onclick="showAdmin('tasks',this)">‚úÖ Tasks</button>
    <button class="admin-tab" onclick="showAdmin('deposits',this)">üí∞ Deposits</button>
    <button class="admin-tab" onclick="showAdmin('withdrawals',this)">üí∏ Withdrawals</button>
    <button class="admin-tab" onclick="showAdmin('transactions',this)">üìã Transactions</button>
  </div>
  <div class="admin-content">
    <!-- Stats -->
    <div id="adminStats">
      <div class="admin-stats-grid">
        <div class="admin-stat"><div class="admin-stat-val" id="aTotal">0</div><div class="admin-stat-lbl">Total Users</div></div>
        <div class="admin-stat"><div class="admin-stat-val" id="aBalance">0</div><div class="admin-stat-lbl">Total Balance</div></div>
        <div class="admin-stat"><div class="admin-stat-val" id="aDeposits">0</div><div class="admin-stat-lbl">Deposits</div></div>
        <div class="admin-stat"><div class="admin-stat-val" id="aWithdraws">0</div><div class="admin-stat-lbl">Withdrawals</div></div>
        <div class="admin-stat"><div class="admin-stat-val" id="aActive">0</div><div class="admin-stat-lbl">Active Users</div></div>
        <div class="admin-stat"><div class="admin-stat-val" id="aPending">0</div><div class="admin-stat-lbl">Pending W/D</div></div>
      </div>
      <div class="card">
        <div style="font-weight:700;margin-bottom:7px">üèÜ Award Weekly Prize</div>
        <div style="font-size:.78rem;color:var(--muted);margin-bottom:13px">50,000 UGX to top referrer this week (min 8 referrals)</div>
        <button class="btn btn-gold" onclick="awardWeeklyWinner()">Award Weekly Winner</button>
      </div>
    </div>

    <!-- Users -->
    <div id="adminUsers" class="hidden">
      <div class="card" style="padding:0;overflow:hidden">
        <div style="padding:14px;font-weight:700;border-bottom:1px solid var(--border-s)">All Users</div>
        <div id="adminUsersList" style="overflow-x:auto"></div>
      </div>
    </div>

    <!-- Tasks -->
    <div id="adminTasks" class="hidden">
      <!-- Add task form -->
      <div class="card">
        <div style="font-weight:700;margin-bottom:14px">‚ûï Add New Task</div>
        <div class="fg"><label>Task Type</label>
          <select id="taskType" onchange="updateTaskForm()">
            <option value="youtube">üì∫ YouTube Watch</option>
            <option value="youtube_sub">üîî YouTube Subscribe</option>
            <option value="tiktok">üéµ TikTok Watch</option>
            <option value="reading">üìñ Reading Task</option>
          </select>
        </div>
        <div class="fg"><label>Task Title</label><input type="text" id="taskTitle" placeholder="e.g. Watch our latest product review"></div>
        <div class="fg"><label>Description</label><textarea id="taskDesc" placeholder="Explain what the user should do‚Ä¶"></textarea></div>
        <div class="fg" id="taskUrlGroup"><label id="taskUrlLabel">YouTube URL</label><input type="url" id="taskUrl" placeholder="https://youtube.com/watch?v=..."></div>
        <div class="fg hidden" id="taskReadingGroup"><label>Reading Content</label><textarea id="taskReading" placeholder="Paste the article/content users should read‚Ä¶" style="min-height:150px"></textarea></div>
        <div class="fg"><label>Reward (UGX)</label><input type="number" id="taskReward" placeholder="e.g. 1000"></div>
        <div class="fg"><label>Timer Duration (seconds)</label><input type="number" id="taskTimer" placeholder="e.g. 60" value="60"></div>
        <button class="btn btn-green btn-full" onclick="addTask()">Add Task</button>
      </div>
      <!-- Task list -->
      <div class="card">
        <div style="font-weight:700;margin-bottom:14px">All Tasks</div>
        <div id="adminTasksList" style="color:var(--muted)">Loading‚Ä¶</div>
      </div>
    </div>

    <!-- Deposits -->
    <div id="adminDeposits" class="hidden">
      <div style="font-weight:700;margin-bottom:12px">Deposit Requests</div>
      <div id="adminDepList" style="color:var(--muted)">Loading‚Ä¶</div>
    </div>

    <!-- Withdrawals -->
    <div id="adminWithdrawals" class="hidden">
      <div style="font-weight:700;margin-bottom:12px">Withdrawal Requests</div>
      <div id="adminWdList" style="color:var(--muted)">Loading‚Ä¶</div>
    </div>

    <!-- Transactions -->
    <div id="adminTransactions" class="hidden">
      <div class="card" style="padding:0;overflow:hidden">
        <div style="padding:14px;font-weight:700;border-bottom:1px solid var(--border-s)">All Transactions</div>
        <div style="overflow-x:auto"><table><thead><tr><th>User</th><th>Type</th><th>Amount</th><th>Date</th></tr></thead><tbody id="adminTxList"><tr><td colspan="4" style="text-align:center;color:var(--muted)">Loading‚Ä¶</td></tr></tbody></table></div>
      </div>
    </div>
  </div>
</div>

<!-- PAYMENT MODAL -->
<div id="payModal" class="modal-overlay hidden">
  <div class="modal-sheet">
    <div class="modal-handle"></div>
    <div class="modal-title">üí≥ Payment Source</div>
    <div style="color:var(--muted);font-size:.875rem;margin-bottom:18px" id="payModalDesc"></div>
    <div id="payModalOpts"></div>
  </div>
</div>

<!-- NOTIFICATION PANEL -->
<div id="notifPanel" class="notif-panel hidden" onclick="if(event.target===this)closeNotif()">
  <div class="notif-sheet">
    <div style="padding:16px 18px;border-bottom:1px solid var(--border-s);display:flex;justify-content:space-between;align-items:center">
      <span style="font-family:'Playfair Display',serif;font-size:1.1rem;font-weight:700">Notifications</span>
      <button onclick="closeNotif()" style="background:none;border:none;color:var(--muted);cursor:pointer;font-size:1.1rem">‚úï</button>
    </div>
    <div id="notifList"><div style="padding:28px;text-align:center;color:var(--muted)">No notifications</div></div>
  </div>
</div>

<!-- SUCCESS OVERLAY (withdrawal confirmed) -->
<div id="successOverlay" class="success-overlay hidden">
  <div class="success-icon" id="successIcon">üí∞</div>
  <div style="font-family:'Playfair Display',serif;font-size:1.8rem;font-weight:800;color:var(--gold);margin-bottom:10px" id="successTitle">Success!</div>
  <div style="color:var(--muted);font-size:.9rem;margin-bottom:30px" id="successMsg"></div>
  <button class="btn btn-gold" onclick="document.getElementById('successOverlay').classList.add('hidden')">Continue</button>
</div>

<!-- IMAGE LIGHTBOX -->
<div id="imgLightbox" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.9);z-index:3000;align-items:center;justify-content:center" onclick="this.style.display='none'">
  <img id="lightboxImg" style="max-width:90%;max-height:90vh;border-radius:var(--rs)">
</div>

<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
<script>
// ============================================================
// FIREBASE CONFIG
// ============================================================
const firebaseConfig = {
  apiKey: "AIzaSyCnMj0_eJEaD2dZNSoeZ_ijsl8ETt4BFhY",
  authDomain: "vaultpro-app.firebaseapp.com",
  projectId: "vaultpro-app",
  storageBucket: "vaultpro-app.firebasestorage.app",
  messagingSenderId: "272074672947",
  appId: "1:272074672947:web:c2459af0c1480f0474cc46",
  measurementId: "G-8XFB9L9H4L"
};

let db, auth, storage, fbReady = false;
try {
  firebase.initializeApp(firebaseConfig);
  db = firebase.firestore();
  auth = firebase.auth();
  storage = firebase.storage();
  fbReady = true;
} catch(e) { console.error('Firebase:', e); }

// ============================================================
// GLOBALS
// ============================================================
let CU = null; // current user
let selectedPlan = null;
let isPurchasing = false;
let statsCache = { data:null, ts:0, ttl:30000 };
let activeTimers = {}; // taskId -> intervalId
let weekTimerInt = null;

// ============================================================
// VAULT PLANS
// ============================================================
const PLANS = {
  beginner:   {name:'Beginner',   emoji:'üå±',amount:45000,     days:30,dailyTasks:2, taskReward:750,   level:1},
  seed:       {name:'Seed',       emoji:'üåø',amount:180000,    days:30,dailyTasks:3, taskReward:2000,  level:2},
  rising:     {name:'Rising',     emoji:'üåÖ',amount:600000,    days:30,dailyTasks:4, taskReward:5000,  level:3},
  nova:       {name:'Nova',       emoji:'üí°',amount:1350000,   days:30,dailyTasks:5, taskReward:9000,  level:4},
  mastermind: {name:'Mastermind', emoji:'üß†',amount:4050000,   days:30,dailyTasks:6, taskReward:22500, level:5},
  titan:      {name:'Titan',      emoji:'üí™',amount:8775000,   days:30,dailyTasks:7, taskReward:42000, level:6},
  king:       {name:'King',       emoji:'üëë',amount:16650000,  days:30,dailyTasks:8, taskReward:69375, level:7},
  emperor:    {name:'Emperor',    emoji:'ü¶Ö',amount:29700000,  days:30,dailyTasks:9, taskReward:110000,level:8},
  icon:       {name:'Icon',       emoji:'‚≠ê',amount:48600000,  days:30,dailyTasks:10,taskReward:162000,level:9},
  supreme:    {name:'Supreme',    emoji:'üëë',amount:81000000,  days:30,dailyTasks:11,taskReward:245000,level:10},
  legendary:  {name:'Legendary',  emoji:'üèÜ',amount:110000000, days:30,dailyTasks:12,taskReward:305556,level:11},
};

const REF_LEVELS = [
  {title:'Member',     icon:'üå±',color:'#1DB87F',min:0},
  {title:'Ambassador', icon:'‚≠ê',color:'#f59e0b',min:10},
  {title:'Executive',  icon:'üíº',color:'#6366f1',min:50},
  {title:'Director',   icon:'üéØ',color:'#8b5cf6',min:100},
  {title:'VP',         icon:'ü¶Ö',color:'#ec4899',min:500},
  {title:'Admin',      icon:'üëë',color:'#C9A84C',min:1000},
  {title:'Shareholder',icon:'üíé',color:'#06b6d4',min:5000},
];

// ============================================================
// UTILS
// ============================================================
function $(id){ return document.getElementById(id); }
function set(id, v){ const e=$(id); if(e) e.textContent=v; }
function hideAll(){
  ['loadingScreen','referralLandingPage','registerPage','loginPage','userDashboard','adminDashboard']
    .forEach(id=>{ const e=$(id); if(e) e.classList.add('hidden'); });
}

function toast(msg, icon='‚ÑπÔ∏è', type='info', dur=4000){
  const c=$('toastCont'), t=document.createElement('div');
  const colors={success:'#1DB87F',error:'#E8445A',warning:'#C9A84C',info:'#4A7CF7'};
  t.className='toast';
  t.style.borderLeftColor=colors[type]||colors.info;
  t.innerHTML=`<span style="font-size:1.1rem">${icon}</span><div style="flex:1;font-size:.85rem;font-weight:600">${msg}</div><button class="toast-close" onclick="this.parentElement.remove()">‚úï</button>`;
  c.appendChild(t);
  setTimeout(()=>t.remove&&t.remove(),dur);
}

function showAlert(id, msg, type){
  const el=$(id); if(!el) return;
  const icons={success:'‚úÖ',error:'‚ùå',warning:'‚ö†Ô∏è',info:'‚ÑπÔ∏è'};
  el.innerHTML=`<div class="alert alert-${type}">${icons[type]||''} ${msg}</div>`;
  setTimeout(()=>{ if(el) el.innerHTML=''; },7000);
}

function toggleCollapse(id){
  const body=$(id), caret=$(id+'Caret');
  body.classList.toggle('open');
  if(caret) caret.classList.toggle('open');
}

function calcVaultLevel(vaults){
  const t=vaults.reduce((s,v)=>s+(v.amount||0),0);
  if(t>=110000000) return {level:'Legendary',icon:'üèÜ'};
  if(t>=81000000)  return {level:'Supreme',  icon:'üëë'};
  if(t>=48600000)  return {level:'Icon',     icon:'‚≠ê'};
  if(t>=29700000)  return {level:'Emperor',  icon:'ü¶Ö'};
  if(t>=16650000)  return {level:'King',     icon:'üëë'};
  if(t>=8775000)   return {level:'Titan',    icon:'üí™'};
  if(t>=4050000)   return {level:'Mastermind',icon:'üß†'};
  if(t>=1350000)   return {level:'Nova',     icon:'üí°'};
  if(t>=600000)    return {level:'Rising',   icon:'üåÖ'};
  if(t>=180000)    return {level:'Seed',     icon:'üåø'};
  if(t>=45000)     return {level:'Beginner', icon:'üå±'};
  return {level:'Newcomer',icon:'‚Äî'};
}

function getRefLevel(refs){
  for(let i=REF_LEVELS.length-1;i>=0;i--) if(refs>=REF_LEVELS[i].min) return REF_LEVELS[i];
  return REF_LEVELS[0];
}

function extractYouTubeId(url){
  try{
    const u=new URL(url);
    if(u.hostname.includes('youtu.be')) return u.pathname.slice(1);
    return u.searchParams.get('v')||null;
  }catch(e){ return null; }
}

function extractTikTokEmbed(url){ return url; }

function previewScreenshot(input, previewId){
  const f=input.files[0]; if(!f) return;
  const reader=new FileReader();
  reader.onload=e=>{
    const img=$(previewId);
    if(img){ img.src=e.target.result; img.style.display='block'; }
  };
  reader.readAsDataURL(f);
}

function showImgLightbox(src){
  $('lightboxImg').src=src;
  $('imgLightbox').style.display='flex';
}

// ============================================================
// REFERRAL LINK STORAGE
// ============================================================
function storeRef(code){ if(!code)return; localStorage.setItem('vp_ref',JSON.stringify({code,exp:Date.now()+86400000})); sessionStorage.setItem('vp_ref_s',code); }
function getStoredRef(){ const s=sessionStorage.getItem('vp_ref_s'); if(s)return s; try{const p=JSON.parse(localStorage.getItem('vp_ref')||'{}'); if(p.code&&Date.now()<p.exp)return p.code; localStorage.removeItem('vp_ref');}catch(e){} return null; }
function clearRef(){ localStorage.removeItem('vp_ref'); sessionStorage.removeItem('vp_ref_s'); }

// ============================================================
// INIT
// ============================================================
async function init(){
  $('loadingScreen').classList.remove('hidden');
  if(!fbReady){ $('loadingScreen').classList.add('hidden'); showLogin(); toast('Firebase not ready','‚ö†Ô∏è','warning'); return; }
  const urlRef=new URLSearchParams(window.location.search).get('ref');
  if(urlRef){ storeRef(urlRef); window.history.replaceState({},'',window.location.pathname); }
  auth.onAuthStateChanged(async user=>{
    if(user){
      try{
        const d=await db.collection('users').doc(user.uid).get();
        if(d.exists){
          CU={id:user.uid,...d.data()};
          $('loadingScreen').classList.add('hidden');
          if(CU.isAdmin) showAdminDashboard();
          else{ showUserDashboard(); initNotifListener(); }
          return;
        }
      }catch(e){ console.error(e); }
    }
    $('loadingScreen').classList.add('hidden');
    const stored=getStoredRef();
    if(stored) showReferralLanding(stored); else showLogin();
  });
}

function showReferralLanding(code){
  hideAll();
  $('referralLandingPage').classList.remove('hidden');
  $('landingCode').textContent=code;
  storeRef(code);
}

// ============================================================
// AUTH
// ============================================================
async function register(){
  const btn=$('registerBtn'); btn.disabled=true; btn.textContent='Creating‚Ä¶';
  try{
    const code=$('inviteCode').value.trim().toUpperCase();
    const name=$('fullName').value.trim();
    const email=$('email').value.trim();
    const phone=$('regPhone').value.trim();
    const pwd=$('password').value;
    const cpwd=$('confirmPassword').value;
    if(!code||!name||!email||!pwd){ showAlert('registerAlert','Please fill in all fields','error'); return; }
    if(pwd.length<6){ showAlert('registerAlert','Password must be at least 6 characters','error'); return; }
    if(pwd!==cpwd){ showAlert('registerAlert','Passwords do not match','error'); return; }
    const refQ=await db.collection('users').where('referralCode','==',code).get();
    if(refQ.empty){ showAlert('registerAlert','Invalid invitation code','error'); return; }
    const refId=refQ.docs[0].id;
    const cred=await auth.createUserWithEmailAndPassword(email,pwd);
    const uid=cred.user.uid;
    const newUser={id:uid,fullName:name,email,phone:phone||'',balance:0,referredBy:refId,
      referralCode:Math.random().toString(36).substring(2,8).toUpperCase(),
      joinedDate:new Date().toISOString(),isAdmin:false,isActivated:true,
      activationDate:new Date().toISOString(),currentStreak:0,longestStreak:0,
      lastLoginDate:null,totalPoints:0,pointsBalance:0,totalTaskEarnings:0};
    await db.collection('users').doc(uid).set(newUser);
    await db.collection('users').doc(refId).collection('referrals').doc(uid).set({userId:uid,name,email,date:new Date().toISOString(),earnings:0});
    clearRef();
    showAlert('registerAlert','üéâ Account created! Signing you in‚Ä¶','success');
  }catch(e){
    const msgs={'auth/email-already-in-use':'Email already registered','auth/weak-password':'Password too weak','auth/invalid-email':'Invalid email'};
    showAlert('registerAlert',msgs[e.code]||'Registration failed: '+e.message,'error');
  }finally{ btn.disabled=false; btn.textContent='Create Account'; }
}

async function login(){
  const btn=$('loginBtn'); btn.disabled=true; btn.textContent='Signing in‚Ä¶';
  try{
    const email=$('loginEmail').value.trim(), pwd=$('loginPassword').value;
    if(!email||!pwd){ showAlert('loginAlert','Please enter email and password','error'); return; }
    const cred=await auth.signInWithEmailAndPassword(email,pwd);
    const d=await db.collection('users').doc(cred.user.uid).get();
    if(!d.exists){ showAlert('loginAlert','Account not found','error'); await auth.signOut(); return; }
    CU={id:cred.user.uid,...d.data()};
    await updateStreak(cred.user.uid,CU);
  }catch(e){
    const msgs={'auth/user-not-found':'No account with this email','auth/wrong-password':'Incorrect password','auth/too-many-requests':'Too many attempts ‚Äî try later','auth/invalid-credential':'Invalid email or password'};
    showAlert('loginAlert',msgs[e.code]||'Login failed','error');
  }finally{ btn.disabled=false; btn.textContent='Sign In'; }
}

async function logout(){ if(!confirm('Sign out?'))return; await auth.signOut(); CU=null; clearInterval(weekTimerInt); Object.values(activeTimers).forEach(clearInterval); showLogin(); }

// ============================================================
// NAVIGATION
// ============================================================
function showLogin(){ hideAll(); $('loginPage').classList.remove('hidden'); }
function showRegister(){ hideAll(); $('registerPage').classList.remove('hidden'); }
function showRegisterFromReferral(){
  showRegister();
  const code=getStoredRef();
  if(code){ const f=$('inviteCode'); f.value=code; f.readOnly=true; f.style.borderColor='var(--green)'; }
}

function showUserDashboard(){
  hideAll();
  $('userDashboard').classList.remove('hidden');
  setTimeout(()=>showSection('home'),50);
  updateUserStats();
  loadLeaderboard();
  startWeekTimer();
}

function showAdminDashboard(){
  hideAll();
  $('adminDashboard').classList.remove('hidden');
  loadAdminStats();
}

function showSection(s){
  if(!CU) return;
  ['home','vault','referrals','tasks','wallet','streak','profile'].forEach(x=>{
    const e=$(x+'Section'); if(e) e.classList.add('hidden');
  });
  const el=$(s+'Section');
  if(el) el.classList.remove('hidden');
  document.querySelectorAll('.nav-item').forEach(i=>i.classList.remove('active'));
  const nav=document.querySelector(`[data-section="${s}"]`);
  if(nav) nav.classList.add('active');
  if(s==='home'){ updateUserStats(); }
  else if(s==='vault'){ loadVaultSection(); }
  else if(s==='referrals'){ loadReferrals(); }
  else if(s==='tasks'){ loadTasks(); }
  else if(s==='wallet'){ loadWallet(); }
  else if(s==='streak'){ loadStreak(); }
  else if(s==='profile'){ refreshCU().then(()=>loadProfile()); }
}

function showAdmin(s, btn){
  ['stats','users','tasks','deposits','withdrawals','transactions'].forEach(x=>{
    const e=$('admin'+x.charAt(0).toUpperCase()+x.slice(1));
    if(e) e.classList.add('hidden');
  });
  const el=$('admin'+s.charAt(0).toUpperCase()+s.slice(1));
  if(el) el.classList.remove('hidden');
  document.querySelectorAll('.admin-tab').forEach(t=>t.classList.remove('active'));
  if(btn) btn.classList.add('active');
  if(s==='users') loadAdminUsers();
  else if(s==='tasks') loadAdminTasks();
  else if(s==='deposits') loadAdminDeposits();
  else if(s==='withdrawals') loadAdminWithdrawals();
  else if(s==='transactions') loadAdminTransactions();
}

// ============================================================
// STREAK
// ============================================================
async function updateStreak(uid, user){
  try{
    if(user.isAdmin){ await db.collection('users').doc(uid).update({lastLoginDate:new Date().toISOString()}); return; }
    const today=new Date().toISOString().split('T')[0];
    const last=user.lastLoginDate?new Date(user.lastLoginDate).toISOString().split('T')[0]:null;
    if(last===today) return;
    let streak=user.currentStreak||0, longest=user.longestStreak||0, pts=user.totalPoints||0, bal=user.pointsBalance||0;
    const yest=new Date(); yest.setDate(yest.getDate()-1);
    const yestStr=yest.toISOString().split('T')[0];
    streak=(last===yestStr)?streak+1:1;
    if(streak>longest) longest=streak;
    const award=streak>=30?100:streak>=21?75:streak>=14?50:streak>=7?25:streak>=3?15:streak>=2?10:5;
    pts+=award; bal+=award;
    await db.collection('users').doc(uid).update({currentStreak:streak,longestStreak:longest,lastLoginDate:new Date().toISOString(),totalPoints:pts,pointsBalance:bal});
    if(CU) Object.assign(CU,{currentStreak:streak,longestStreak:longest,pointsBalance:bal});
    setTimeout(()=>toast(`üî• ${streak} day streak! +${award} points`,`üî•`,'success'),1200);
  }catch(e){ console.error('Streak:',e); }
}

// ============================================================
// USER STATS
// ============================================================
async function updateUserStats(force=false){
  if(!CU) return;
  try{
    const now=Date.now();
    if(!force&&statsCache.data&&(now-statsCache.ts)<statsCache.ttl){ applyStats(statsCache.data); return; }
    const[ud,vs,rs,cb]=await Promise.all([
      db.collection('users').doc(CU.id).get(),
      db.collection('users').doc(CU.id).collection('vaults').get(),
      db.collection('users').doc(CU.id).collection('referrals').get(),
      getCatBalances(CU.id),
    ]);
    CU={id:CU.id,...ud.data()};
    const vaults=vs.docs.map(d=>d.data());
    const data={balance:CU.balance||0,refs:rs.size,cb,user:CU,vaults};
    statsCache={data,ts:now,ttl:30000};
    applyStats(data);
    $('headerSub').textContent=CU.fullName||'User';
    const link=$('userRefLink');
    if(link) link.textContent=`${location.origin}${location.pathname}?ref=${CU.referralCode}`;
    if(CU.isActivated) $('activeBadge').classList.remove('hidden');
    // auto-fill withdraw phone
    if(CU.phone){ const wp=$('wdPhone'); if(wp) wp.value=CU.phone; }
  }catch(e){ console.error('Stats:',e); }
}

function applyStats({balance,refs,cb,user,vaults}){
  set('totalBalance',(balance||0).toLocaleString());
  set('statRefs',refs);
  set('statTask',(cb.taskEarnings||0).toLocaleString());
  set('statRef',(cb.referralEarnings||0).toLocaleString());
  const active=vaults.filter(v=>v.status==='active');
  set('statLevel',calcVaultLevel(active).level);
  set('walletBal',(balance||0).toLocaleString());
  set('walletPts',(user.pointsBalance||0).toLocaleString());
  set('vaultBalance',(balance||0).toLocaleString());
}

function clearStatsCache(){ statsCache={data:null,ts:0,ttl:30000}; }

async function getCatBalances(uid){
  try{
    const snap=await db.collection('transactions').where('userId','==',uid).get();
    const b={taskEarnings:0,referralEarnings:0,vaultEarnings:0,depositEarnings:0};
    snap.docs.forEach(d=>{
      const t=d.data(),a=t.amount||0;
      if(t.type==='task_completion') b.taskEarnings+=a;
      else if(t.type==='referral') b.referralEarnings+=a;
      else if(t.type==='vault_maturity') b.vaultEarnings+=a;
      else if(t.type==='deposit') b.depositEarnings+=a;
      else if(['withdrawal','withdrawal_approved'].includes(t.type)){
        const k=t.sourceCategory||'depositEarnings';
        b[k]=Math.max(0,(b[k]||0)-Math.abs(a));
      }
    });
    Object.keys(b).forEach(k=>{b[k]=Math.max(0,b[k])});
    return b;
  }catch(e){ return {taskEarnings:0,referralEarnings:0,vaultEarnings:0,depositEarnings:0}; }
}

async function getVaultLevel(uid){
  try{
    const snap=await db.collection('users').doc(uid).collection('vaults').get();
    const active=snap.docs.map(d=>d.data()).filter(v=>v.status==='active');
    if(!active.length) return {planName:'None',level:0,dailyTasks:0,taskReward:0};
    const top=active.sort((a,b)=>b.amount-a.amount)[0];
    const pk=Object.keys(PLANS).find(k=>PLANS[k].name===top.planName);
    if(!pk) return {planName:'None',level:0,dailyTasks:0,taskReward:0};
    return {planName:PLANS[pk].name,level:PLANS[pk].level,dailyTasks:PLANS[pk].dailyTasks,taskReward:PLANS[pk].taskReward};
  }catch(e){ return {planName:'None',level:0,dailyTasks:0,taskReward:0}; }
}

async function refreshCU(){
  if(!CU?.id) return;
  try{ const d=await db.collection('users').doc(CU.id).get(); if(d.exists) CU={id:CU.id,...d.data()}; }catch(e){}
}

// ============================================================
// VAULT SECTION
// ============================================================
async function loadVaultSection(){
  const vi=await getVaultLevel(CU.id);
  const bal=CU.balance||0;
  set('vaultBalance',bal.toLocaleString());
  const el=$('plansList'); if(!el) return;
  el.innerHTML=Object.entries(PLANS).map(([key,p])=>{
    const isOwned=vi.planName===p.name;
    const isLower=vi.level>0&&p.level<vi.level;
    const monthEarn=p.dailyTasks*p.taskReward*30;
    let badge='';
    if(isOwned) badge=`<span class="badge badge-success">‚úì Owned</span>`;
    else if(p.level===2) badge=`<span class="badge badge-blue">Popular</span>`;
    else if(p.level===11) badge=`<span class="badge badge-warning">Ultimate</span>`;
    const disabled=isLower?'style="opacity:.45;pointer-events:none"':'';
    return `<div class="plan-card ${isOwned?'owned':''}" ${disabled} onclick="selectPlan('${key}')">
      <div class="plan-header">
        <div><div class="plan-name">${p.emoji} ${p.name}</div><div class="plan-amount">${p.amount.toLocaleString()} UGX</div></div>
        ${badge}
      </div>
      <div class="plan-stats">
        <div class="plan-stat"><div class="plan-stat-val">${p.dailyTasks}/day</div><div class="plan-stat-lbl">Tasks</div></div>
        <div class="plan-stat"><div class="plan-stat-val">${p.taskReward.toLocaleString()}</div><div class="plan-stat-lbl">UGX/Task</div></div>
        <div class="plan-stat"><div class="plan-stat-val">${monthEarn.toLocaleString()}</div><div class="plan-stat-lbl">Monthly Max</div></div>
        <div class="plan-stat"><div class="plan-stat-val">30 days</div><div class="plan-stat-lbl">Duration</div></div>
      </div>
    </div>`;
  }).join('');
}

async function selectPlan(key){
  if(isPurchasing) return;
  const p=PLANS[key];
  const vi=await getVaultLevel(CU.id);
  if(vi.planName===p.name){ toast('You already own this plan','üí°','warning'); return; }
  if(vi.level>p.level){ toast('You have a higher plan','üí°','warning'); return; }
  selectedPlan=key;
  const monthEarn=p.dailyTasks*p.taskReward*30;
  document.querySelectorAll('.plan-card').forEach(c=>c.classList.remove('selected'));
  event.currentTarget.classList.add('selected');
  const det=$('selectedPlanDetails'); det.classList.remove('hidden');
  $('purchaseSumContent').innerHTML=`
    <div style="font-family:'Playfair Display',serif;font-size:1.05rem;font-weight:700;margin-bottom:13px">${p.emoji} ${p.name} Plan</div>
    <div class="sum-row"><span class="sum-label">Investment</span><span class="sum-val">${p.amount.toLocaleString()} UGX</span></div>
    <div class="sum-row"><span class="sum-label">Duration</span><span class="sum-val">${p.days} days</span></div>
    <div class="sum-row"><span class="sum-label">Daily Tasks</span><span class="sum-val">${p.dailyTasks}</span></div>
    <div class="sum-row"><span class="sum-label">Per Task</span><span class="sum-val">${p.taskReward.toLocaleString()} UGX</span></div>
    <div class="sum-row"><span class="sum-label">Daily Max</span><span class="sum-val">${(p.dailyTasks*p.taskReward).toLocaleString()} UGX</span></div>
    <div class="sum-row"><span class="sum-label">Monthly Max</span><span class="sum-val hi">+${monthEarn.toLocaleString()} UGX</span></div>`;
  det.scrollIntoView({behavior:'smooth',block:'nearest'});
}

async function purchaseVault(){
  if(!selectedPlan||isPurchasing) return;
  const p=PLANS[selectedPlan];
  const vi=await getVaultLevel(CU.id);
  if(vi.planName===p.name){ toast('Already owned','üí°','warning'); return; }
  showPayModal(p.amount, p.name);
}

async function showPayModal(amount, planName){
  const modal=$('payModal');
  $('payModalDesc').textContent=`Choose how to pay ${amount.toLocaleString()} UGX`;
  const opts=$('payModalOpts');
  const bal=CU.balance||0, ok=bal>=amount;
  opts.innerHTML=`
    <div class="pay-opt ${ok?'':'disabled'}" onclick="${ok?`closePayModal();processVaultWallet(${amount},'${planName}')`:''}" ${ok?'':'style="pointer-events:none;opacity:.4"'}>
      <span style="font-size:1.8rem">üí∞</span>
      <div style="flex:1"><div style="font-weight:700;font-size:.9rem">Wallet Balance</div><div style="font-size:.78rem;color:var(--muted)">Available: ${bal.toLocaleString()} UGX ${!ok?'¬∑ Insufficient':''}</div></div>
      <span style="color:${ok?'var(--green)':'var(--red)'}">${ok?'‚úì':'‚úó'}</span>
    </div>
    <div class="pay-opt" onclick="closePayModal();showSection('wallet')">
      <span style="font-size:1.8rem">üì±</span>
      <div style="flex:1"><div style="font-weight:700;font-size:.9rem">Mobile Money Deposit</div><div style="font-size:.78rem;color:var(--muted)">Deposit then purchase</div></div>
      <span style="color:var(--muted)">‚Üí</span>
    </div>`;
  modal.classList.remove('hidden');
  modal.onclick=e=>{ if(e.target===modal) closePayModal(); };
}
function closePayModal(){ $('payModal').classList.add('hidden'); }

async function processVaultWallet(amount, planName){
  await showCatSelectModal(amount,(cat,catName)=>doVaultPurchase(cat,catName));
}

async function showCatSelectModal(amount, callback){
  const b=await getCatBalances(CU.id);
  const cats=[
    {key:'depositEarnings',label:'üí∞ Deposits',bal:b.depositEarnings},
    {key:'referralEarnings',label:'üë• Referral',bal:b.referralEarnings},
    {key:'taskEarnings',label:'‚úÖ Task',bal:b.taskEarnings},
    {key:'vaultEarnings',label:'üè¶ Vault',bal:b.vaultEarnings},
  ];
  const modal=$('payModal');
  $('payModalDesc').textContent=`Select earnings source for ${amount.toLocaleString()} UGX:`;
  const opts=$('payModalOpts');
  opts.innerHTML='';
  cats.forEach(c=>{
    const ok=c.bal>=amount;
    const div=document.createElement('div');
    div.className=`pay-opt${ok?'':' disabled'}`;
    div.innerHTML=`<div style="flex:1"><div style="font-weight:700;font-size:.9rem">${c.label}</div><div style="font-size:.78rem;color:var(--muted)">Available: ${c.bal.toLocaleString()} UGX</div></div><span style="color:${ok?'var(--green)':'var(--red)'}">${ok?'‚úì':'‚úó'}</span>`;
    if(ok) div.onclick=()=>{ closePayModal(); callback(c.key,c.label); };
    opts.appendChild(div);
  });
  modal.classList.remove('hidden');
}

async function doVaultPurchase(sourceCategory, categoryName){
  if(isPurchasing) return;
  isPurchasing=true;
  const btn=$('purchaseBtn'); btn.disabled=true; btn.textContent='Processing‚Ä¶';
  try{
    const p=PLANS[selectedPlan];
    if((CU.balance||0)<p.amount){ toast('Insufficient funds','‚ùå','error'); return; }
    await db.collection('users').doc(CU.id).update({balance:firebase.firestore.FieldValue.increment(-p.amount)});
    CU.balance=(CU.balance||0)-p.amount;
    const start=new Date(), end=new Date(start.getTime()+p.days*86400000);
    await db.collection('users').doc(CU.id).collection('vaults').add({planName:p.name,amount:p.amount,duration:p.days,startDate:start.toISOString(),maturityDate:end.toISOString(),status:'active',isMatured:false});
    await db.collection('transactions').add({userId:CU.id,userName:CU.fullName,type:'vault_purchase',amount:p.amount,sourceCategory,categoryName,planName:p.name,date:new Date().toISOString()});
    if(CU.referredBy){
      const bonus=Math.floor(p.amount*0.10);
      const rd=await db.collection('users').doc(CU.referredBy).get();
      if(rd.exists){
        await db.collection('users').doc(CU.referredBy).update({balance:firebase.firestore.FieldValue.increment(bonus)});
        await db.collection('transactions').add({userId:CU.referredBy,userName:rd.data().fullName,type:'referral',amount:bonus,description:`10% bonus from ${CU.fullName} ‚Äî ${p.name}`,date:new Date().toISOString()});
        await sendNotif(CU.referredBy,'referral_bonus',`You earned ${bonus.toLocaleString()} UGX referral bonus from ${CU.fullName}!`);
      }
    }
    toast(`${p.emoji} ${p.name} vault activated!`,'üéâ','success',6000);
    clearStatsCache();
    setTimeout(()=>{
      $('selectedPlanDetails').classList.add('hidden');
      selectedPlan=null;
      document.querySelectorAll('.plan-card').forEach(c=>c.classList.remove('selected'));
      updateUserStats(true);
      loadVaultSection();
      showSection('home');
      isPurchasing=false;
      btn.disabled=false; btn.textContent='Confirm Purchase';
    },2000);
  }catch(e){ toast('Purchase failed: '+e.message,'‚ùå','error'); isPurchasing=false; btn.disabled=false; btn.textContent='Confirm Purchase'; }
}

// ============================================================
// TASKS
// ============================================================
async function loadTasks(){
  const vi=await getVaultLevel(CU.id);
  const today=new Date().toDateString();
  const [yt,et]=await Promise.all([
    db.collection('taskSubmissions').where('userId','==',CU.id).where('date','==',today).get(),
    db.collection('externalTaskSubmissions').where('userId','==',CU.id).where('date','==',today).get(),
  ]);
  const done=yt.size+et.size, limit=vi.dailyTasks;
  const doneIds=new Set([...yt.docs.map(d=>d.data().taskId),...et.docs.map(d=>d.data().taskId)]);
  set('taskProgText',`${done} / ${limit}`);
  const pb=$('taskProgBar');
  if(pb) pb.style.width=limit>0?`${Math.min(100,(done/limit)*100)}%`:'0%';

  if(limit===0){
    $('tasksList').innerHTML=`<div class="card" style="text-align:center;padding:30px"><div style="font-size:2.4rem;margin-bottom:10px">üè¶</div><div style="font-weight:700;margin-bottom:7px">No Active Plan</div><div style="color:var(--muted);font-size:.875rem;margin-bottom:14px">Purchase a vault plan to unlock daily tasks</div><button class="btn btn-gold btn-full" onclick="showSection('vault')">View Plans</button></div>`;
    return;
  }

  const tasksSnap=await db.collection('tasks').where('isActive','==',true).get();
  const allTasks=tasksSnap.docs.map(d=>({id:d.id,...d.data()}));
  let html='';

  allTasks.forEach(t=>{
    const isCompleted=doneIds.has(t.id);
    if(isCompleted) return; // completed tasks disappear
    const canDo=done<limit;
    const reward=t.reward||vi.taskReward;
    const timerSecs=t.timerSeconds||60;
    const typeColors={youtube:'task-type-yt',youtube_sub:'task-type-sub',tiktok:'task-type-tiktok',reading:'task-type-read'};
    const typeLabels={youtube:'üì∫ YouTube Watch',youtube_sub:'üîî YouTube Sub',tiktok:'üéµ TikTok',reading:'üìñ Reading'};
    const typeClass=typeColors[t.type]||'task-type-yt';

    let embedHtml='';
    if(t.type==='youtube'||t.type==='youtube_sub'){
      const vid=extractYouTubeId(t.url||'');
      if(vid) embedHtml=`<iframe class="task-embed" src="https://www.youtube.com/embed/${vid}?rel=0&modestbranding=1" allowfullscreen allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"></iframe>`;
    } else if(t.type==='tiktok'){
      embedHtml=`<div style="background:var(--bg3);padding:14px;text-align:center;border-radius:var(--rs) var(--rs) 0 0"><a href="${t.url}" target="_blank" class="btn btn-surface" style="display:inline-block;text-decoration:none">üéµ Open TikTok Video</a></div>`;
    } else if(t.type==='reading'){
      embedHtml=`<div class="reading-content">${t.readingContent||'Content will appear here...'}</div>`;
    }

    html+=`<div class="task-card" id="task-${t.id}">
      <div class="task-type-bar ${typeClass}"></div>
      ${embedHtml}
      <div class="task-card-body">
        <div class="task-header">
          <div class="task-title">${typeLabels[t.type]||'Task'}: ${t.title||'Untitled'}</div>
          <div class="task-reward">+${reward.toLocaleString()} UGX</div>
        </div>
        <div class="task-desc">${t.description||''}</div>
        ${canDo
          ? `<div class="task-timer hidden" id="timer-${t.id}">
              <div class="task-timer-circle">
                <svg width="32" height="32" viewBox="0 0 32 32">
                  <circle class="timer-bg" cx="16" cy="16" r="13"/>
                  <circle class="timer-fill" id="timerCircle-${t.id}" cx="16" cy="16" r="13" stroke-dasharray="${2*Math.PI*13}" stroke-dashoffset="0"/>
                </svg>
                <div class="timer-count" id="timerNum-${t.id}">${timerSecs}</div>
              </div>
              <span id="timerMsg-${t.id}">Complete in <strong id="timerSec-${t.id}">${timerSecs}s</strong></span>
            </div>
            <button class="btn btn-gold btn-full" id="taskBtn-${t.id}" onclick="startTask('${t.id}','${t.type||'youtube'}',${reward},${timerSecs})">
              ${t.type==='reading'?'Start Reading':'Start Task'}
            </button>`
          : `<div style="text-align:center;color:var(--dim);font-size:.82rem;padding:8px">Daily limit reached for today</div>`
        }
      </div>
    </div>`;
  });

  if(!html && done >= limit && limit > 0){
    html=`<div class="card" style="text-align:center;padding:28px"><div style="font-size:2.4rem;margin-bottom:10px">üéâ</div><div style="font-weight:700;color:var(--gold);margin-bottom:7px">All Tasks Complete!</div><div style="color:var(--muted);font-size:.875rem">Come back tomorrow for more rewards</div></div>`;
  } else if(!html){
    html=`<div class="card" style="text-align:center;color:var(--muted);padding:28px">No tasks available right now. Check back later!</div>`;
  }
  $('tasksList').innerHTML=html;
}

function startTask(taskId, type, reward, timerSecs){
  const btn=$(`taskBtn-${taskId}`), timer=$(`timer-${taskId}`);
  if(!btn) return;
  btn.style.display='none';
  if(timer) timer.classList.remove('hidden');
  const circle=$(`timerCircle-${taskId}`), numEl=$(`timerNum-${taskId}`), secEl=$(`timerSec-${taskId}`);
  const circ=2*Math.PI*13;
  let remaining=timerSecs;
  if(circle) circle.style.strokeDashoffset='0';
  const interval=setInterval(async()=>{
    remaining--;
    const pct=1-(remaining/timerSecs);
    if(circle) circle.style.strokeDashoffset=`${circ*pct}`;
    if(numEl) numEl.textContent=remaining;
    if(secEl) secEl.textContent=`${remaining}s`;
    if(remaining<=0){
      clearInterval(interval);
      delete activeTimers[taskId];
      if(timer) timer.classList.add('hidden');
      await completeTask(taskId, type, reward);
    }
  },1000);
  activeTimers[taskId]=interval;
}

async function completeTask(taskId, type, reward){
  try{
    const today=new Date().toDateString();
    const col=type==='youtube'||type==='youtube_sub'?'taskSubmissions':'externalTaskSubmissions';
    await db.collection(col).add({userId:CU.id,userName:CU.fullName,taskId,date:today,reward,completedAt:new Date().toISOString(),type});
    await db.collection('users').doc(CU.id).update({balance:firebase.firestore.FieldValue.increment(reward)});
    CU.balance=(CU.balance||0)+reward;
    await db.collection('transactions').add({userId:CU.id,userName:CU.fullName,type:'task_completion',amount:reward,date:new Date().toISOString()});
    // Remove task card from DOM
    const card=$(`task-${taskId}`);
    if(card){ card.style.opacity='0'; card.style.transition='opacity .4s'; setTimeout(()=>card.remove(),400); }
    clearStatsCache();
    toast(`+${reward.toLocaleString()} UGX earned! üéâ`,'‚úÖ','success');
    // Refresh progress
    setTimeout(()=>loadTasks(),600);
  }catch(e){ toast('Failed to complete task','‚ùå','error'); }
}

// ============================================================
// REFERRALS
// ============================================================
async function loadReferrals(){
  try{
    const snap=await db.collection('users').doc(CU.id).collection('referrals').get();
    const refs=snap.docs.map(d=>d.data());
    const total=refs.reduce((s,r)=>s+(r.earnings||0),0);
    set('totalRefEarnings',total.toLocaleString());
    const link=$('userRefLink');
    if(link) link.textContent=`${location.origin}${location.pathname}?ref=${CU.referralCode}`;
    const lvl=getRefLevel(refs.length);
    const ni=REF_LEVELS.findIndex(l=>l.title===lvl.title)+1;
    const next=ni<REF_LEVELS.length?REF_LEVELS[ni]:null;
    const lc=$('refLevelCard');
    if(lc){
      let progress='';
      if(next){
        const pct=Math.min(100,((refs.length-lvl.min)/(next.min-lvl.min))*100);
        progress=`<div style="margin-top:10px"><div style="font-size:.72rem;color:var(--muted);margin-bottom:5px">To ${next.icon} ${next.title}: ${refs.length}/${next.min}</div><div class="prog-wrap"><div class="prog-fill" style="width:${pct}%"></div></div></div>`;
      }
      lc.innerHTML=`<div style="display:flex;align-items:center;gap:12px;margin-bottom:8px"><div style="font-size:1.8rem">${lvl.icon}</div><div><div style="font-weight:700">${lvl.title}</div><div style="font-size:.78rem;color:var(--muted)">${refs.length} referral${refs.length!==1?'s':''}</div></div></div>${progress}`;
    }
    const rl=$('referralsList');
    if(!rl) return;
    if(!refs.length){ rl.innerHTML=`<div style="text-align:center;color:var(--muted);padding:14px">No referrals yet ‚Äî share your link!</div>`; return; }
    rl.innerHTML=refs.map(r=>`<div class="info-row"><div><div style="font-weight:600">${r.name}</div><div style="font-size:.72rem;color:var(--muted)">${new Date(r.date).toLocaleDateString()}</div></div><span style="color:var(--green);font-weight:700;font-family:'JetBrains Mono',monospace">+${(r.earnings||0).toLocaleString()}</span></div>`).join('');
  }catch(e){ console.error('Referrals:',e); }
}

function copyRefLink(){ const el=$('userRefLink'); if(el) navigator.clipboard.writeText(el.textContent).then(()=>toast('Link copied!','üìã','success')); }
function shareRefLink(){ const link=$('userRefLink')?.textContent; if(navigator.share&&link) navigator.share({title:'Join VaultPro',text:"Uganda's #1 investment platform",url:link}); else copyRefLink(); }
function copyRefCode(){ navigator.clipboard.writeText(CU.referralCode||'').then(()=>toast('Code copied!','üìã','success')); }

// ============================================================
// WALLET
// ============================================================
async function loadWallet(){
  const ud=await db.collection('users').doc(CU.id).get();
  const u=ud.data();
  set('walletBal',(u.balance||0).toLocaleString());
  set('walletPts',(u.pointsBalance||0).toLocaleString());
  // auto-fill withdraw phone
  if(u.phone){ const wp=$('wdPhone'); if(wp) wp.value=u.phone; }
}

function showWalletTab(t){
  ['dep','wd','hist'].forEach(p=>{ $(`${p}Panel`).classList.add('hidden'); $(`${p}Tab`).classList.remove('active'); });
  $(`${t}Panel`).classList.remove('hidden');
  $(`${t}Tab`).classList.add('active');
  if(t==='hist') loadTxHistory();
}

async function submitDeposit(){
  const amt=parseInt($('depAmount').value), meth=$('depMethod').value, phone=$('depPhone').value.trim();
  const screenshotInput=$('depScreenshot');
  if(!amt||amt<1000){ showAlert('depAlert','Minimum deposit is 1,000 UGX','error'); return; }
  if(!meth){ showAlert('depAlert','Please select a payment method','error'); return; }
  if(!phone){ showAlert('depAlert','Please enter your phone number','error'); return; }
  if(!screenshotInput.files[0]){ showAlert('depAlert','Please upload a payment screenshot','error'); return; }
  try{
    // Upload screenshot to Firebase Storage
    const file=screenshotInput.files[0];
    const storageRef=storage.ref(`deposit_screenshots/${CU.id}_${Date.now()}`);
    const snap=await storageRef.put(file);
    const screenshotUrl=await snap.ref.getDownloadURL();

    await db.collection('depositRequests').add({
      userId:CU.id,userName:CU.fullName,userEmail:CU.email,
      amount:amt,method:meth,phone,screenshotUrl,
      status:'pending',date:new Date().toISOString()
    });
    showAlert('depAlert','Deposit request submitted! Admin will approve shortly.','success');
    $('depAmount').value=''; $('depPhone').value=''; screenshotInput.value='';
    $('depPreview').style.display='none';
  }catch(e){ showAlert('depAlert','Failed: '+e.message,'error'); }
}

async function submitWithdrawal(){
  const cat=$('wdCat').value, amt=parseInt($('wdAmount').value), phone=$('wdPhone').value.trim();
  if(!cat){ showAlert('wdAlert','Please select a category','error'); return; }
  if(!amt||amt<5000){ showAlert('wdAlert','Minimum withdrawal is 5,000 UGX','error'); return; }
  if(!phone){ showAlert('wdAlert','Please enter your phone number','error'); return; }
  if(cat==='task'){ const d=new Date().getDay(); if(d!==5&&d!==6){ showAlert('wdAlert','Task earnings only withdrawable on Friday & Saturday','error'); return; } }
  const b=await getCatBalances(CU.id);
  const bk=cat==='referral'?'referralEarnings':cat==='task'?'taskEarnings':'vaultEarnings';
  if(b[bk]<amt){ showAlert('wdAlert',`Insufficient ${cat} earnings (available: ${(b[bk]||0).toLocaleString()} UGX)`,'error'); return; }
  const fee=Math.floor(amt*0.05), net=amt-fee;
  try{
    await db.collection('withdrawalRequests').add({
      userId:CU.id,userName:CU.fullName,phone,
      amount:amt,netAmount:net,adminFee:fee,
      category:cat,status:'pending',date:new Date().toISOString()
    });
    showAlert('wdAlert',`Withdrawal of ${net.toLocaleString()} UGX requested (5% fee: ${fee.toLocaleString()} UGX). Processing soon.`,'success');
    $('wdAmount').value='';
  }catch(e){ showAlert('wdAlert','Failed: '+e.message,'error'); }
}

async function loadTxHistory(){
  try{
    const snap=await db.collection('transactions').where('userId','==',CU.id).orderBy('date','desc').limit(25).get();
    const tb=$('txHistory');
    if(!tb) return;
    if(snap.empty){ tb.innerHTML=`<tr><td colspan="4" style="text-align:center;color:var(--muted)">No transactions yet</td></tr>`; return; }
    const types={deposit:'üí∞ Deposit',withdrawal:'üí∏ Withdrawal',referral:'üë• Referral',task_completion:'‚úÖ Task',vault_purchase:'üè¶ Vault',vault_maturity:'üè¶ Matured',points_conversion:'üîÑ Points',withdrawal_approved:'üí∏ Withdrawal'};
    const out=['withdrawal','vault_purchase','withdrawal_approved'];
    tb.innerHTML=snap.docs.map(d=>{
      const t=d.data(), a=t.netAmount||t.amount||0, isOut=out.includes(t.type);
      return `<tr><td>${new Date(t.date).toLocaleDateString()}</td><td>${types[t.type]||t.type}</td><td style="color:${isOut?'var(--red)':'var(--green)'};font-weight:700;font-family:'JetBrains Mono',monospace">${isOut?'-':'+'} ${Math.abs(a).toLocaleString()}</td><td><span class="badge badge-success">Done</span></td></tr>`;
    }).join('');
  }catch(e){ console.error(e); }
}

// ============================================================
// STREAK
// ============================================================
async function loadStreak(){
  try{
    const ud=await db.collection('users').doc(CU.id).get();
    const u=ud.data();
    const s=u.currentStreak||0, lng=u.longestStreak||0, pts=u.pointsBalance||0;
    set('streakCount',s); set('streakPts',pts); set('bestStreak',lng);
    const de=$('streakDots'); if(!de) return;
    let h='';
    for(let i=0;i<7;i++){
      const a=i<Math.min(s,7), isToday=i===Math.min(s-1,6)&&s>0;
      h+=`<div class="streak-dot ${isToday?'today':a?'done':''}">${i+1}</div>`;
    }
    de.innerHTML=h;
  }catch(e){}
}

async function convertPoints(){
  const pts=parseInt($('ptsConvert').value);
  if(!pts||pts<100){ showAlert('streakAlert','Minimum 100 points','error'); return; }
  const ud=await db.collection('users').doc(CU.id).get();
  const cur=ud.data().pointsBalance||0;
  if(cur<pts){ showAlert('streakAlert',`Insufficient points (you have ${cur})`,'error'); return; }
  const ugx=pts*10;
  await db.collection('users').doc(CU.id).update({pointsBalance:firebase.firestore.FieldValue.increment(-pts),balance:firebase.firestore.FieldValue.increment(ugx)});
  await db.collection('transactions').add({userId:CU.id,type:'points_conversion',amount:ugx,description:`${pts} points converted`,date:new Date().toISOString()});
  CU.pointsBalance=cur-pts; CU.balance=(CU.balance||0)+ugx;
  clearStatsCache();
  toast(`${pts} points ‚Üí ${ugx.toLocaleString()} UGX`,'üîÑ','success');
  loadStreak();
}

// ============================================================
// PROFILE
// ============================================================
async function loadProfile(){
  const u=CU;
  const init=$('profileInitials'), img=$('profileImg'), av=$('profileAvatar');
  if(u.profilePicture){ img.src=u.profilePicture; img.style.display='block'; if(av) av.style.display='none'; }
  else { if(init) init.textContent=(u.fullName||'U').split(' ').map(n=>n[0]).join('').toUpperCase().substring(0,2); if(av) av.style.display='flex'; img.style.display='none'; }
  set('profileName',u.fullName||'‚Äî'); set('profileEmail',u.email||'‚Äî');
  set('profileNameVal',u.fullName||'‚Äî'); set('profileEmailVal',u.email||'‚Äî');
  set('profilePhoneVal',u.phone||'Not set');
  set('profileJoined',u.joinedDate?new Date(u.joinedDate).toLocaleDateString():'‚Äî');
  const sv=$('profileStatus');
  if(sv){ sv.textContent=u.isActivated?'Active':'Pending'; sv.style.color=u.isActivated?'var(--green)':'var(--red)'; }
  set('profRefCode',u.referralCode||'‚Äî');
  set('profStreak',u.currentStreak||0);
  set('profPts',u.pointsBalance||0);
  const lvl=getRefLevel(u.totalReferrals||0);
  const lb=$('profileLvlBadge');
  if(lb) lb.innerHTML=`<span class="badge badge-warning" style="font-size:.78rem;padding:5px 12px">${lvl.icon} ${lvl.title}</span>`;
  try{
    const vs=await db.collection('users').doc(CU.id).collection('vaults').get();
    set('profVaults',vs.size);
    const active=vs.docs.map(d=>d.data()).filter(v=>v.status==='active');
    set('profLevel',calcVaultLevel(active).level);
  }catch(e){}
}

function toggleNameEdit(){ $('nameEditBox').classList.toggle('hidden'); $('nameEditInput').value=CU.fullName||''; }
function cancelName(){ $('nameEditBox').classList.add('hidden'); }
async function saveName(){
  const n=$('nameEditInput').value.trim();
  if(!n||n.length<2){ showAlert('profileAlert','Name too short','error'); return; }
  await db.collection('users').doc(CU.id).update({fullName:n});
  CU.fullName=n; set('profileName',n); set('profileNameVal',n);
  cancelName(); toast('Name updated','‚úÖ','success');
}
function togglePhoneEdit(){ $('phoneEditBox').classList.toggle('hidden'); $('phoneEditInput').value=CU.phone||''; }
function cancelPhone(){ $('phoneEditBox').classList.add('hidden'); }
async function savePhone(){
  const p=$('phoneEditInput').value.trim();
  if(!p){ showAlert('profileAlert','Please enter a phone number','error'); return; }
  await db.collection('users').doc(CU.id).update({phone:p});
  CU.phone=p; set('profilePhoneVal',p);
  const wp=$('wdPhone'); if(wp) wp.value=p;
  cancelPhone(); toast('Phone number saved','‚úÖ','success');
}

async function uploadPic(ev){
  const f=ev.target.files[0]; if(!f) return;
  if(f.size>5*1024*1024){ toast('Max 5MB','‚ùå','error'); return; }
  const reader=new FileReader();
  reader.onload=async e=>{
    try{
      const b64=e.target.result;
      await db.collection('users').doc(CU.id).update({profilePicture:b64});
      CU.profilePicture=b64;
      const img=$('profileImg'); img.src=b64; img.style.display='block';
      const av=$('profileAvatar'); if(av) av.style.display='none';
      toast('Profile picture updated','üì∑','success');
    }catch(err){ toast('Upload failed','‚ùå','error'); }
  };
  reader.readAsDataURL(f);
}

// ============================================================
// LEADERBOARD
// ============================================================
async function loadLeaderboard(){
  try{
    const now=new Date(), dow=now.getDay(), d2m=dow===0?6:dow-1;
    const ws=new Date(now); ws.setDate(now.getDate()-d2m); ws.setHours(0,0,0,0);
    const snap=await db.collection('users').where('isAdmin','==',false).get();
    const data=await Promise.all(snap.docs.map(async d=>{
      const u=d.data();
      const rs=await db.collection('users').doc(d.id).collection('referrals').get();
      let wk=0; rs.docs.forEach(r=>{ if(new Date(r.data().date)>=ws) wk++; });
      return {n:u.fullName,wk,tot:rs.size};
    }));
    data.sort((a,b)=>b.wk-a.wk);
    const top=data.slice(0,5);
    const el=$('leaderboardList'); if(!el) return;
    const medals=['ü•á','ü•à','ü•â'];
    if(!top.length||top[0].wk===0){ el.innerHTML=`<div style="text-align:center;color:var(--muted);padding:12px">No referrals this week yet</div>`; return; }
    el.innerHTML=top.map((u,i)=>`<div class="lb-item"><div class="lb-rank ${i<3?'top':''}">${i<3?medals[i]:i+1}</div><div class="lb-info"><div class="lb-name">${u.n}</div><div class="lb-total">Total: ${u.tot}</div></div><div class="lb-count">${u.wk}</div></div>`).join('');
  }catch(e){ console.error('LB:',e); }
}

function startWeekTimer(){ updateWeekTimer(); clearInterval(weekTimerInt); weekTimerInt=setInterval(updateWeekTimer,60000); }
function updateWeekTimer(){
  const now=new Date(), d=now.getDay(), su=d===0?7:7-d;
  const nxt=new Date(now); nxt.setDate(now.getDate()+su); nxt.setHours(23,59,59,999);
  const rem=nxt-now, days=Math.floor(rem/86400000), hrs=Math.floor((rem%86400000)/3600000), mins=Math.floor((rem%3600000)/60000);
  set('weekTimer',`${days}d ${hrs}h ${mins}m`);
}

async function awardWeeklyWinner(){
  try{
    const now=new Date(), d=now.getDay(), d2m=d===0?6:d-1;
    const ws=new Date(now); ws.setDate(now.getDate()-d2m); ws.setHours(0,0,0,0);
    const snap=await db.collection('users').where('isAdmin','==',false).get();
    let top=null, max=0;
    for(const doc of snap.docs){
      const rs=await db.collection('users').doc(doc.id).collection('referrals').get();
      const wk=rs.docs.filter(r=>new Date(r.data().date)>=ws).length;
      if(wk>max){ max=wk; top={userId:doc.id,userData:doc.data(),wk}; }
    }
    if(top&&top.wk>=8){
      const prize=50000;
      await db.collection('users').doc(top.userId).update({balance:firebase.firestore.FieldValue.increment(prize)});
      await db.collection('transactions').add({userId:top.userId,type:'referral',amount:prize,description:'Weekly Top Referrer Prize',date:new Date().toISOString()});
      await sendNotif(top.userId,'referral_bonus',`üèÜ You won the weekly referral prize: ${prize.toLocaleString()} UGX!`);
      toast(`Winner: ${top.userData.fullName}`,'üèÜ','success');
    } else {
      toast('No winner ‚Äî min 8 referrals required','‚ö†Ô∏è','warning');
    }
  }catch(e){ console.error(e); }
}

// ============================================================
// NOTIFICATIONS
// ============================================================
async function sendNotif(uid, type, msg){
  const icons={activation_approved:'üéâ',withdrawal_approved:'üí∞',withdrawal_rejected:'‚ùå',referral_bonus:'üë•',vault_matured:'üè¶'};
  const titles={activation_approved:'Account Activated!',withdrawal_approved:'Withdrawal Approved!',withdrawal_rejected:'Withdrawal Rejected',referral_bonus:'Referral Bonus!',vault_matured:'Vault Matured!'};
  try{
    await db.collection('notifications').add({userId:uid,type,title:titles[type]||'Notification',message:msg||titles[type],icon:icons[type]||'üîî',read:false,timestamp:firebase.firestore.FieldValue.serverTimestamp(),createdAt:new Date().toISOString()});
  }catch(e){}
}

function initNotifListener(){
  if(!CU) return;
  db.collection('notifications').where('userId','==',CU.id).where('read','==',false)
    .orderBy('timestamp','desc').onSnapshot(snap=>{
      const cnt=snap.size;
      const b=$('notifBadge');
      if(b){ if(cnt>0){ b.textContent=cnt>99?'99+':cnt; b.classList.remove('hidden'); } else b.classList.add('hidden'); }
    });
}

function openNotif(){ $('notifPanel').classList.remove('hidden'); loadNotifList(); }
function closeNotif(){ $('notifPanel').classList.add('hidden'); }

async function loadNotifList(){
  if(!CU) return;
  try{
    const snap=await db.collection('notifications').where('userId','==',CU.id).orderBy('timestamp','desc').limit(30).get();
    const el=$('notifList');
    if(!el) return;
    if(snap.empty){ el.innerHTML=`<div style="padding:28px;text-align:center;color:var(--muted)">No notifications</div>`; return; }
    el.innerHTML=snap.docs.map(doc=>{
      const n={id:doc.id,...doc.data()};
      const t=n.timestamp?.toDate?n.timestamp.toDate():new Date(n.createdAt||Date.now());
      const m=Math.floor((Date.now()-t)/60000);
      const time=m<1?'Just now':m<60?`${m}m ago`:m<1440?`${Math.floor(m/60)}h ago`:`${Math.floor(m/1440)}d ago`;
      return `<div class="notif-item ${n.read?'':'unread'}" onclick="db.collection('notifications').doc('${n.id}').update({read:true});this.classList.remove('unread')">
        <div style="display:flex;gap:11px;align-items:flex-start">
          <span style="font-size:1.1rem;flex-shrink:0">${n.icon||'üîî'}</span>
          <div><div style="font-weight:700;font-size:.875rem">${n.title}</div><div style="font-size:.78rem;color:var(--muted)">${n.message||''}</div><div style="font-size:.7rem;color:var(--dim);margin-top:3px">${time}</div></div>
        </div>
      </div>`;
    }).join('');
  }catch(e){}
}

// ============================================================
// ADMIN
// ============================================================
async function loadAdminStats(){
  try{
    const[us,ts,pw]=await Promise.all([
      db.collection('users').where('isAdmin','==',false).get(),
      db.collection('transactions').get(),
      db.collection('withdrawalRequests').where('status','==','pending').get(),
    ]);
    const users=us.docs.map(d=>d.data());
    const tb=users.reduce((s,u)=>s+(u.balance||0),0);
    const act=users.filter(u=>u.isActivated).length;
    const dep=ts.docs.filter(d=>d.data().type==='deposit').reduce((s,d)=>s+(d.data().amount||0),0);
    const wd=ts.docs.filter(d=>['withdrawal','withdrawal_approved'].includes(d.data().type)).reduce((s,d)=>s+(d.data().amount||0),0);
    set('aTotal',users.length); set('aBalance',tb.toLocaleString());
    set('aDeposits',dep.toLocaleString()); set('aWithdraws',wd.toLocaleString());
    set('aActive',act); set('aPending',pw.size);
  }catch(e){}
}

async function loadAdminUsers(){
  try{
    const snap=await db.collection('users').where('isAdmin','==',false).get();
    const el=$('adminUsersList');
    if(!el) return;
    if(snap.empty){ el.innerHTML=`<p style="padding:14px;color:var(--muted)">No users yet</p>`; return; }
    el.innerHTML=`<table><thead><tr><th>Name</th><th>Email</th><th>Phone</th><th>Balance</th><th>Status</th><th>Joined</th></tr></thead><tbody>${snap.docs.map(d=>{const u=d.data();return`<tr><td>${u.fullName}</td><td>${u.email}</td><td>${u.phone||'‚Äî'}</td><td style="font-family:'JetBrains Mono',monospace">${(u.balance||0).toLocaleString()}</td><td><span class="badge ${u.isActivated?'badge-success':'badge-warning'}">${u.isActivated?'Active':'Pending'}</span></td><td>${u.joinedDate?new Date(u.joinedDate).toLocaleDateString():'N/A'}</td></tr>`;}).join('')}</tbody></table>`;
  }catch(e){}
}

// Admin task form dynamic
function updateTaskForm(){
  const type=$('taskType').value;
  const urlGroup=$('taskUrlGroup'), readGroup=$('taskReadingGroup');
  const urlLabel=$('taskUrlLabel');
  if(type==='reading'){ urlGroup.classList.add('hidden'); readGroup.classList.remove('hidden'); }
  else{ urlGroup.classList.remove('hidden'); readGroup.classList.add('hidden'); }
  if(type==='youtube'||type==='youtube_sub') urlLabel.textContent='YouTube URL';
  else if(type==='tiktok') urlLabel.textContent='TikTok Video URL';
}

async function addTask(){
  const type=$('taskType').value, title=$('taskTitle').value.trim(), desc=$('taskDesc').value.trim();
  const url=$('taskUrl').value.trim(), reading=$('taskReading').value.trim();
  const reward=parseInt($('taskReward').value), timer=parseInt($('taskTimer').value)||60;
  if(!title||!reward){ toast('Fill title and reward','‚ö†Ô∏è','warning'); return; }
  if(type!=='reading'&&!url){ toast('Please enter a URL','‚ö†Ô∏è','warning'); return; }
  if(type==='reading'&&!reading){ toast('Please enter reading content','‚ö†Ô∏è','warning'); return; }
  try{
    await db.collection('tasks').add({type,title,description:desc,url:url||'',readingContent:reading||'',reward,timerSeconds:timer,isActive:true,createdAt:new Date().toISOString()});
    toast('Task added!','‚úÖ','success');
    ['taskTitle','taskDesc','taskUrl','taskReading','taskReward'].forEach(id=>{ const e=$(id); if(e) e.value=''; });
    $('taskTimer').value='60';
    loadAdminTasks();
  }catch(e){ toast('Failed: '+e.message,'‚ùå','error'); }
}

async function loadAdminTasks(){
  try{
    const snap=await db.collection('tasks').orderBy('createdAt','desc').get();
    const el=$('adminTasksList');
    if(!el) return;
    if(snap.empty){ el.innerHTML=`<p style="color:var(--muted)">No tasks yet</p>`; return; }
    const typeIcons={youtube:'üì∫',youtube_sub:'üîî',tiktok:'üéµ',reading:'üìñ'};
    el.innerHTML=snap.docs.map(doc=>{
      const t={id:doc.id,...doc.data()};
      return `<div style="border:1px solid var(--border-s);border-radius:var(--rs);padding:14px;margin-bottom:9px;background:var(--bg3)">
        <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:10px;margin-bottom:10px">
          <div style="flex:1">
            <div style="font-weight:700;font-size:.875rem">${typeIcons[t.type]||'üìã'} ${t.title}</div>
            <div style="font-size:.72rem;color:var(--muted);margin-top:2px">${t.description||''}</div>
            ${t.url?`<div style="font-size:.7rem;color:var(--dim);margin-top:2px;word-break:break-all">${t.url}</div>`:''}
            <div style="font-size:.72rem;color:var(--gold);margin-top:4px">‚è± ${t.timerSeconds||60}s timer ¬∑ +${(t.reward||0).toLocaleString()} UGX</div>
          </div>
          <div style="display:flex;flex-direction:column;gap:5px;flex-shrink:0">
            <span class="badge ${t.isActive?'badge-success':'badge-error'}">${t.isActive?'Active':'Off'}</span>
          </div>
        </div>
        <div style="display:flex;gap:6px;flex-wrap:wrap">
          <button class="btn btn-surface" style="padding:6px 11px;font-size:.75rem" onclick="editTask('${doc.id}')">‚úèÔ∏è Edit</button>
          <button class="btn" style="padding:6px 11px;font-size:.75rem;background:${t.isActive?'rgba(232,68,90,.12)':'rgba(29,184,127,.12)'};color:${t.isActive?'var(--red)':'var(--green)'};border:1px solid ${t.isActive?'rgba(232,68,90,.3)':'rgba(29,184,127,.3)'}" onclick="toggleTask('${doc.id}',${!t.isActive})">${t.isActive?'Deactivate':'Activate'}</button>
          <button class="btn btn-red" style="padding:6px 11px;font-size:.75rem" onclick="deleteTask('${doc.id}')">üóë Delete</button>
        </div>
      </div>`;
    }).join('');
  }catch(e){ console.error(e); }
}

async function toggleTask(id, active){ await db.collection('tasks').doc(id).update({isActive:active}); toast(active?'Task activated':'Task deactivated','‚úÖ','success'); loadAdminTasks(); }
async function deleteTask(id){ if(!confirm('Delete this task?'))return; await db.collection('tasks').doc(id).delete(); toast('Task deleted','üóë','warning'); loadAdminTasks(); }

function editTask(id){
  // Inline edit - open a simple prompt-based flow
  db.collection('tasks').doc(id).get().then(d=>{
    const t=d.data();
    const newTitle=prompt('Task Title:',t.title||'');
    if(newTitle===null) return;
    const newDesc=prompt('Description:',t.description||'');
    if(newDesc===null) return;
    const newReward=parseInt(prompt('Reward (UGX):',t.reward||1000));
    if(isNaN(newReward)) return;
    const newTimer=parseInt(prompt('Timer (seconds):',t.timerSeconds||60));
    db.collection('tasks').doc(id).update({title:newTitle,description:newDesc,reward:newReward,timerSeconds:isNaN(newTimer)?60:newTimer})
      .then(()=>{ toast('Task updated','‚úÖ','success'); loadAdminTasks(); })
      .catch(e=>toast('Update failed: '+e.message,'‚ùå','error'));
  });
}

// Admin Deposits
async function loadAdminDeposits(){
  try{
    const snap=await db.collection('depositRequests').orderBy('date','desc').get();
    const el=$('adminDepList');
    if(!el) return;
    if(snap.empty){ el.innerHTML=`<p style="color:var(--muted)">No deposit requests</p>`; return; }
    el.innerHTML=snap.docs.map(doc=>{
      const d={id:doc.id,...doc.data()};
      return `<div class="dep-card">
        <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:10px">
          <div>
            <div style="font-weight:700">${d.userName}</div>
            <div style="font-size:.75rem;color:var(--muted)">${d.phone} ¬∑ ${d.method} ¬∑ ${new Date(d.date).toLocaleDateString()}</div>
          </div>
          <div style="text-align:right">
            <div style="font-family:'JetBrains Mono',monospace;font-size:1.05rem;font-weight:700;color:var(--green)">${(d.amount||0).toLocaleString()} UGX</div>
            <span class="badge ${d.status==='approved'?'badge-success':d.status==='rejected'?'badge-error':'badge-warning'}">${d.status}</span>
          </div>
        </div>
        ${d.screenshotUrl?`<img src="${d.screenshotUrl}" onclick="showImgLightbox('${d.screenshotUrl}')" title="Click to enlarge">`:
          '<div style="font-size:.75rem;color:var(--dim);font-style:italic">No screenshot provided</div>'}
        ${d.status==='pending'?`<div style="display:flex;gap:7px;margin-top:10px">
          <button class="btn btn-green" style="flex:1;padding:9px;font-size:.82rem" onclick="approveDeposit('${doc.id}','${d.userId}',${d.amount})">‚úÖ Approve</button>
          <button class="btn btn-red" style="flex:1;padding:9px;font-size:.82rem" onclick="rejectDeposit('${doc.id}','${d.userId}')">‚ùå Reject</button>
        </div>`:''}
      </div>`;
    }).join('');
  }catch(e){ console.error(e); }
}

async function approveDeposit(depId, uid, amount){
  if(!confirm(`Approve ${amount.toLocaleString()} UGX deposit?`)) return;
  try{
    await db.collection('depositRequests').doc(depId).update({status:'approved',approvedDate:new Date().toISOString()});
    await db.collection('users').doc(uid).update({balance:firebase.firestore.FieldValue.increment(amount)});
    await db.collection('transactions').add({userId:uid,type:'deposit',amount,date:new Date().toISOString()});
    await sendNotif(uid,'activation_approved',`Your deposit of ${amount.toLocaleString()} UGX has been approved! üéâ`);
    toast('Deposit approved','‚úÖ','success');
    loadAdminDeposits(); loadAdminStats();
  }catch(e){ toast('Error: '+e.message,'‚ùå','error'); }
}

async function rejectDeposit(id, uid){
  if(!confirm('Reject this deposit?')) return;
  await db.collection('depositRequests').doc(id).update({status:'rejected'});
  await sendNotif(uid,'withdrawal_rejected','Your deposit request was rejected. Please contact support.');
  toast('Deposit rejected','','warning');
  loadAdminDeposits();
}

// Admin Withdrawals
async function loadAdminWithdrawals(){
  try{
    const snap=await db.collection('withdrawalRequests').orderBy('date','desc').get();
    const el=$('adminWdList');
    if(!el) return;
    if(snap.empty){ el.innerHTML=`<p style="color:var(--muted)">No withdrawal requests</p>`; return; }
    el.innerHTML=snap.docs.map(doc=>{
      const w={id:doc.id,...doc.data()};
      return `<div class="dep-card">
        <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:10px">
          <div>
            <div style="font-weight:700">${w.userName}</div>
            <div style="font-size:.75rem;color:var(--muted)">${w.phone} ¬∑ ${w.category} ¬∑ ${new Date(w.date).toLocaleDateString()}</div>
          </div>
          <div style="text-align:right">
            <div style="font-family:'JetBrains Mono',monospace;font-size:1.05rem;font-weight:700;color:var(--gold)">${(w.amount||0).toLocaleString()} UGX</div>
            <div style="font-size:.75rem;color:var(--green)">Net: ${(w.netAmount||0).toLocaleString()}</div>
            <span class="badge ${w.status==='approved'?'badge-success':w.status==='rejected'?'badge-error':'badge-warning'}">${w.status}</span>
          </div>
        </div>
        <div style="font-size:.75rem;color:var(--muted);margin-bottom:${w.status==='pending'?'10px':'0'}">Send to: <strong style="color:var(--text)">${w.phone}</strong></div>
        ${w.status==='pending'?`<div style="display:flex;gap:7px">
          <button class="btn btn-green" style="flex:1;padding:9px;font-size:.82rem" onclick="approveWithdrawal('${doc.id}','${w.userId}',${w.netAmount||0},${w.adminFee||0})">‚úÖ Approve</button>
          <button class="btn btn-red" style="flex:1;padding:9px;font-size:.82rem" onclick="rejectWithdrawal('${doc.id}','${w.userId}')">‚ùå Reject</button>
        </div>`:''}
      </div>`;
    }).join('');
  }catch(e){ console.error(e); }
}

async function approveWithdrawal(wdId, uid, net, fee){
  if(!confirm(`Approve withdrawal of ${net.toLocaleString()} UGX?`)) return;
  try{
    await db.collection('withdrawalRequests').doc(wdId).update({status:'approved',approvedDate:new Date().toISOString()});
    await db.collection('users').doc(uid).update({balance:firebase.firestore.FieldValue.increment(-(net+fee))});
    await db.collection('transactions').add({userId:uid,type:'withdrawal_approved',amount:net,adminFee:fee,date:new Date().toISOString()});
    await sendNotif(uid,'withdrawal_approved',`Your withdrawal of ${net.toLocaleString()} UGX has been processed! üí∞`);
    // Show success overlay if user is on their dashboard
    if(CU&&CU.id===uid){
      $('successIcon').textContent='üí∞';
      $('successTitle').textContent='Withdrawal Approved!';
      $('successMsg').textContent=`${net.toLocaleString()} UGX has been sent to your mobile money.`;
      $('successOverlay').classList.remove('hidden');
    }
    toast('Withdrawal approved','‚úÖ','success');
    loadAdminWithdrawals(); loadAdminStats();
  }catch(e){ toast('Error: '+e.message,'‚ùå','error'); }
}

async function rejectWithdrawal(id, uid){
  if(!confirm('Reject this withdrawal?')) return;
  await db.collection('withdrawalRequests').doc(id).update({status:'rejected'});
  await sendNotif(uid,'withdrawal_rejected','Your withdrawal request was rejected. Please contact support.');
  toast('Rejection sent','','warning');
  loadAdminWithdrawals();
}

async function loadAdminTransactions(){
  try{
    const snap=await db.collection('transactions').orderBy('date','desc').limit(50).get();
    const tb=$('adminTxList');
    if(!tb) return;
    if(snap.empty){ tb.innerHTML=`<tr><td colspan="4" style="text-align:center;color:var(--muted)">No transactions</td></tr>`; return; }
    tb.innerHTML=snap.docs.map(d=>{const t=d.data();return`<tr><td>${t.userName||'‚Äî'}</td><td>${t.type}</td><td style="font-family:'JetBrains Mono',monospace">${(t.amount||0).toLocaleString()}</td><td>${new Date(t.date).toLocaleDateString()}</td></tr>`;}).join('');
  }catch(e){}
}

// ============================================================
// WITHDRAWAL APPROVAL REALTIME LISTENER FOR USER
// ============================================================
function listenForWithdrawalApproval(){
  if(!CU||CU.isAdmin) return;
  db.collection('withdrawalRequests').where('userId','==',CU.id).where('status','==','approved')
    .onSnapshot(snap=>{
      snap.docChanges().forEach(change=>{
        if(change.type==='modified'||change.type==='added'){
          const w=change.doc.data();
          // Only trigger if recently approved (within 5 min)
          if(w.approvedDate&&(Date.now()-new Date(w.approvedDate).getTime())<300000){
            $('successIcon').textContent='üí∞';
            $('successTitle').textContent='Withdrawal Approved!';
            $('successMsg').textContent=`${(w.netAmount||0).toLocaleString()} UGX has been sent to ${w.phone}.`;
            $('successOverlay').classList.remove('hidden');
            clearStatsCache();
            updateUserStats(true);
          }
        }
      });
    });
}

// ============================================================
// BOOT
// ============================================================
window.addEventListener('load', init);

// Override showUserDashboard to add listeners
const _origSUD = showUserDashboard;
function showUserDashboard(){
  _origSUD();
  listenForWithdrawalApproval();
}
</script>
</body>
</html>
