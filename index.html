<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>VaultPro - Investment Platform</title>
<style>
:root{--primary:#6366f1;--secondary:#8b5cf6;--success:#10b981;--warning:#f59e0b;--error:#ef4444;--dark:#1f2937;--gray:#6b7280;--light:#f9fafb;--white:#ffffff;--text:#111827;--border:#e5e7eb;--shadow:0 4px 6px -1px rgba(0,0,0,0.1);--radius:12px}
body.dark-mode{--light:#1f2937;--white:#111827;--text:#f9fafb;--border:#374151;background:#0f172a;color:var(--text)}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:var(--light);color:var(--text)}
.hidden{display:none!important}
.card{background:var(--white);border-radius:var(--radius);padding:1.5rem;box-shadow:var(--shadow);margin-bottom:1rem}
.btn{padding:.75rem 1.5rem;border-radius:8px;border:none;cursor:pointer;font-weight:600;font-size:1rem;transition:all .2s}
.btn-primary{background:var(--primary);color:white}
.btn-success{background:var(--success);color:white}
.btn-error{background:var(--error);color:white}
.btn:hover{opacity:.9;transform:translateY(-1px)}
.btn:disabled{opacity:.6;cursor:not-allowed;transform:none}
.form-group{margin-bottom:1rem}
.form-group label{display:block;margin-bottom:.5rem;font-weight:600;color:var(--gray);font-size:.875rem}
.form-group input,.form-group select{width:100%;padding:.75rem;border:2px solid var(--border);border-radius:8px;font-size:1rem;background:var(--white);color:var(--text);transition:border-color .2s}
.form-group input:focus,.form-group select:focus{outline:none;border-color:var(--primary)}
.alert{padding:.75rem 1rem;border-radius:8px;margin-bottom:1rem;font-size:.875rem}
.alert-success{background:#d1fae5;color:#065f46;border:1px solid #6ee7b7}
.alert-error{background:#fee2e2;color:#991b1b;border:1px solid #fca5a5}
.alert-warning{background:#fef3c7;color:#92400e;border:1px solid #fcd34d}
.alert-info{background:#dbeafe;color:#1e40af;border:1px solid #93c5fd}
.bottom-nav{position:fixed;bottom:0;left:0;right:0;background:var(--white);border-top:2px solid var(--border);display:flex;z-index:100;max-width:480px;margin:0 auto}
.bottom-nav-item{flex:1;padding:.75rem .5rem;display:flex;flex-direction:column;align-items:center;gap:.25rem;cursor:pointer;color:var(--gray);font-size:.7rem;border:none;background:none}
.bottom-nav-item.active{color:var(--primary)}
.stat-card{background:linear-gradient(135deg,var(--primary),var(--secondary));color:white;border-radius:var(--radius);padding:1.25rem}
.stat-value{font-size:1.5rem;font-weight:800}
.stat-label{font-size:.75rem;opacity:.9;margin-bottom:.25rem}
.spinner{width:40px;height:40px;border:4px solid rgba(99,102,241,.3);border-top-color:var(--primary);border-radius:50%;animation:spin 1s linear infinite;margin:0 auto}
@keyframes spin{to{transform:rotate(360deg)}}
.modal{position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:1000;display:flex;align-items:flex-end;justify-content:center}
.modal-content{background:var(--white);border-radius:16px 16px 0 0;width:100%;max-width:480px;max-height:90vh;overflow-y:auto}
.modal-header{padding:1.5rem;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
.modal-body{padding:1.5rem}
.modal-close{background:none;border:none;font-size:1.5rem;cursor:pointer;color:var(--gray)}
.status-badge{padding:.25rem .75rem;border-radius:20px;font-size:.75rem;font-weight:600}
.status-badge.success,.status-badge.approved{background:#d1fae5;color:#065f46}
.status-badge.error,.status-badge.rejected{background:#fee2e2;color:#991b1b}
.status-badge.warning,.status-badge.pending{background:#fef3c7;color:#92400e}
table{width:100%;border-collapse:collapse}
th,td{padding:.75rem;text-align:left;border-bottom:1px solid var(--border);font-size:.875rem}
th{font-weight:600;color:var(--gray);background:var(--light)}
.plan-card{background:var(--white);border:2px solid var(--border);border-radius:var(--radius);padding:1.5rem;margin-bottom:1rem;cursor:pointer;transition:all .2s}
.plan-card:hover,.plan-card.selected{border-color:var(--primary);box-shadow:0 0 0 4px rgba(99,102,241,.1)}
.plan-card.rainbow-active{border-color:transparent;background:linear-gradient(white,white) padding-box,linear-gradient(135deg,#f59e0b,#ef4444,#ec4899,#8b5cf6,#3b82f6,#10b981,#f59e0b) border-box}
.plan-name{font-size:1.25rem;font-weight:700;color:var(--primary)}
.plan-amount{font-size:1.5rem;font-weight:800;color:var(--dark)}
.plan-details{display:grid;grid-template-columns:1fr 1fr;gap:.5rem;margin-top:1rem}
.plan-detail{background:var(--light);padding:.5rem;border-radius:6px;font-size:.8rem}
.plan-detail strong{display:block;color:var(--primary);font-size:.9rem}
.level-badge{display:inline-flex;align-items:center;gap:.5rem;padding:.5rem 1rem;border-radius:20px;color:white;font-weight:600;font-size:.875rem}
.streak-day{width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:.8rem;font-weight:600;background:var(--light);color:var(--gray);border:2px solid var(--border)}
.streak-day.active{background:var(--success);color:white;border-color:var(--success)}
.streak-day.today{background:var(--primary);color:white;border-color:var(--primary);animation:pulse 1s infinite}
@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.1)}}
@keyframes slideInRight{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}
</style>
</head><body>
<div id="loadingScreen" class="hidden" style="position:fixed;inset:0;background:linear-gradient(135deg,#6366f1,#8b5cf6);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:9999;color:white;text-align:center">
<div style="font-size:4rem">ğŸ¦</div><h2 style="font-size:2rem;font-weight:800">VaultPro</h2>
<p style="opacity:.9;margin:.5rem 0 2rem">Investment Platform</p>
<div class="spinner" style="border-color:rgba(255,255,255,.3);border-top-color:white"></div></div>

<div id="referralLandingPage" class="hidden" style="min-height:100vh;background:linear-gradient(135deg,#6366f1,#8b5cf6);padding:2rem 1rem;display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;color:white">
<div style="font-size:4rem;margin-bottom:1rem">ğŸ¦</div>
<h1 style="font-size:2rem;font-weight:800;margin-bottom:1rem">Welcome to VaultPro!</h1>
<p style="opacity:.9;margin-bottom:2rem">You've been invited to join Uganda's #1 investment platform</p>
<div style="background:rgba(255,255,255,.2);border-radius:12px;padding:1.5rem;margin-bottom:2rem;width:100%;max-width:400px">
<p style="margin-bottom:.5rem;opacity:.9">Your Invitation Code</p>
<div id="landingReferralCode" style="font-size:2rem;font-weight:800;letter-spacing:.1em"></div></div>
<div style="display:flex;flex-direction:column;gap:1rem;width:100%;max-width:400px">
<button class="btn" style="background:white;color:var(--primary);font-size:1.1rem;padding:1rem" onclick="showRegisterFromReferral()">ğŸš€ Create Account</button>
<button class="btn" style="background:rgba(255,255,255,.2);color:white;border:2px solid rgba(255,255,255,.5)" onclick="showLogin()">Already have an account? Login</button></div>
<div style="margin-top:2rem;opacity:.8;font-size:.875rem"><p>âœ… Earn from daily task completion</p><p>âœ… Grow money with vault investment plans</p><p>âœ… Earn 10% referral bonus on vault purchases</p></div></div>

<div id="registerPage" class="hidden" style="min-height:100vh;display:flex;align-items:center;justify-content:center;background:var(--light);padding:1rem">
<div style="width:100%;max-width:440px">
<div style="text-align:center;margin-bottom:2rem"><div style="font-size:3rem">ğŸ¦</div><h1 style="font-size:1.75rem;font-weight:800;color:var(--primary)">Create Account</h1><p style="color:var(--gray)">Join with your invitation code</p></div>
<div class="card"><div id="registerAlert"></div>
<div class="form-group"><label>Invitation Code *</label><input type="text" id="inviteCode" placeholder="Enter your invitation code" style="text-transform:uppercase"></div>
<div class="form-group"><label>Full Name *</label><input type="text" id="fullName" placeholder="Enter your full name"></div>
<div class="form-group"><label>Email Address *</label><input type="email" id="email" placeholder="Enter your email"></div>
<div class="form-group"><label>Password *</label><input type="password" id="password" placeholder="At least 6 characters"></div>
<div class="form-group"><label>Confirm Password *</label><input type="password" id="confirmPassword" placeholder="Confirm your password"></div>
<button class="btn btn-primary" id="registerBtn" onclick="register()" style="width:100%;margin-top:.5rem">Create Account</button>
<p style="text-align:center;margin-top:1rem;color:var(--gray);font-size:.875rem">Already have an account? <a href="#" onclick="showLogin()" style="color:var(--primary)">Login here</a></p></div></div></div>

<div id="loginPage" class="hidden" style="min-height:100vh;display:flex;align-items:center;justify-content:center;background:var(--light);padding:1rem">
<div style="width:100%;max-width:440px">
<div style="text-align:center;margin-bottom:2rem"><div style="font-size:3rem">ğŸ¦</div><h1 style="font-size:1.75rem;font-weight:800;color:var(--primary)">Welcome Back</h1><p style="color:var(--gray)">Sign in to your account</p></div>
<div class="card"><div id="loginAlert"></div>
<div class="form-group"><label>Email</label><input type="email" id="loginEmail" placeholder="Enter your email"></div>
<div class="form-group"><label>Password</label><input type="password" id="loginPassword" placeholder="Enter your password"></div>
<button class="btn btn-primary" id="loginBtn" onclick="login()" style="width:100%">Login</button></div></div></div><div id="userDashboard" class="hidden" style="padding-bottom:80px">
<div style="background:linear-gradient(135deg,var(--primary),var(--secondary));color:white;padding:1rem;position:sticky;top:0;z-index:50">
<div style="max-width:480px;margin:0 auto;display:flex;justify-content:space-between;align-items:center">
<div><div style="font-size:.75rem;opacity:.9">Welcome back,</div><div id="userNameDisplay" style="font-weight:700;font-size:1.1rem">User</div></div>
<div style="display:flex;align-items:center;gap:.75rem">
<span id="activationStatus" style="background:rgba(255,255,255,.2);padding:.25rem .75rem;border-radius:20px;font-size:.75rem;display:none">âœ… Active</span>
<button onclick="showNotificationCenter()" style="background:rgba(255,255,255,.2);border:none;border-radius:50%;width:40px;height:40px;color:white;font-size:1.25rem;cursor:pointer;position:relative">ğŸ””<span id="notificationBadge" style="position:absolute;top:-4px;right:-4px;background:#ef4444;color:white;border-radius:50%;width:18px;height:18px;font-size:11px;display:none;align-items:center;justify-content:center;font-weight:700"></span></button>
<button onclick="toggleDarkMode()" style="background:rgba(255,255,255,.2);border:none;border-radius:50%;width:40px;height:40px;color:white;font-size:1.25rem;cursor:pointer"><span id="darkModeIcon">ğŸŒ™</span></button></div></div></div>
<div style="max-width:480px;margin:0 auto">

<div id="homeSection" class="hidden" style="padding:1rem">
<div id="withdrawalSuccessCard" style="display:none;background:linear-gradient(135deg,#d1fae5,#a7f3d0);border:2px solid #10b981;border-radius:12px;padding:1rem;margin-bottom:1rem;text-align:center">
<div style="font-size:2rem">ğŸ’°</div><h3 style="color:#065f46">Withdrawal Received!</h3>
<p style="color:#047857"><span id="withdrawnAmount">0</span> UGX</p></div>
<div id="streakAlert"></div>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;margin-bottom:1rem">
<div class="stat-card"><div class="stat-label">Total Balance</div><div class="stat-value" id="totalBalance">0</div><div style="font-size:.75rem;opacity:.8">UGX</div></div>
<div class="stat-card" style="background:linear-gradient(135deg,#10b981,#059669)"><div class="stat-label">Referrals</div><div class="stat-value" id="totalReferrals">0</div><div style="font-size:.75rem;opacity:.8">people</div></div>
<div class="stat-card" style="background:linear-gradient(135deg,#f59e0b,#d97706)"><div class="stat-label">Task Earnings</div><div class="stat-value" id="taskEarnings">0</div><div style="font-size:.75rem;opacity:.8">UGX</div></div>
<div class="stat-card" style="background:linear-gradient(135deg,#8b5cf6,#7c3aed)"><div class="stat-label">Referral Earnings</div><div class="stat-value" id="referralEarnings">0</div><div style="font-size:.75rem;opacity:.8">UGX</div></div>
<div class="stat-card" style="background:linear-gradient(135deg,#06b6d4,#0891b2)"><div class="stat-label">Deposits</div><div class="stat-value" id="totalDeposits">0</div><div style="font-size:.75rem;opacity:.8">UGX</div></div>
<div id="userLevelCard" class="stat-card"><div class="stat-label">Your Level</div><div class="stat-value">ğŸŒ±</div><div style="font-size:.75rem;opacity:.8">Newcomer</div></div></div>
<div class="card"><h3 style="margin-bottom:1rem">ğŸ”— Your Referral Link</h3><div id="referralAlert"></div>
<div style="background:var(--light);padding:.75rem;border-radius:8px;margin-bottom:1rem;font-size:.8rem;word-break:break-all;color:var(--gray)" id="userReferralLink"></div>
<div style="display:flex;gap:.5rem">
<button class="btn btn-primary" style="flex:1;font-size:.875rem" onclick="copyReferralLink()">ğŸ“‹ Copy Link</button>
<button class="btn btn-success" style="flex:1;font-size:.875rem" onclick="shareReferralLink()">ğŸ“¤ Share</button></div></div>
<div id="vaultPlanStructureTable" class="card"><h3 style="margin-bottom:1rem">ğŸ“Š Vault Plans Overview</h3>
<div style="overflow-x:auto"><table><thead><tr><th>Plan</th><th>Amount (UGX)</th><th>Tasks/Day</th><th>Reward/Task</th></tr></thead><tbody>
<tr><td>ğŸŒ± Beginner</td><td>45,000</td><td>2</td><td>750</td></tr>
<tr><td>ğŸŒ¿ Seed</td><td>180,000</td><td>3</td><td>2,000</td></tr>
<tr><td>ğŸŒ… Rising</td><td>600,000</td><td>4</td><td>5,000</td></tr>
<tr><td>ğŸ’¡ Nova</td><td>1,350,000</td><td>5</td><td>9,000</td></tr>
<tr><td>ğŸ§  Mastermind</td><td>4,050,000</td><td>6</td><td>22,500</td></tr>
<tr><td>ğŸ’ª Titan</td><td>8,775,000</td><td>7</td><td>42,000</td></tr>
<tr><td>ğŸ‘‘ King</td><td>16,650,000</td><td>8</td><td>69,375</td></tr>
<tr><td>ğŸ¦… Emperor</td><td>29,700,000</td><td>9</td><td>110,000</td></tr>
<tr><td>â­ Icon</td><td>48,600,000</td><td>10</td><td>162,000</td></tr>
<tr><td>ğŸ‘‘ Supreme</td><td>81,000,000</td><td>11</td><td>245,000</td></tr>
<tr><td>ğŸ† Legendary</td><td>110,000,000</td><td>12</td><td>305,556</td></tr>
</tbody></table></div></div>
<div class="card" style="text-align:center;background:linear-gradient(135deg,#25d366,#128c7e);color:white">
<h3 style="margin-bottom:.5rem">ğŸ’¬ Join WhatsApp Group</h3>
<p style="opacity:.9;margin-bottom:1rem;font-size:.875rem">Get updates and connect with other investors</p>
<button class="btn" style="background:white;color:#128c7e" onclick="showWhatsAppGroupModal()">Join Now</button></div>
<div class="card"><h3 style="margin-bottom:.5rem">ğŸ† Weekly Referral Leaderboard</h3>
<p style="color:var(--gray);font-size:.875rem;margin-bottom:.5rem">Top referrer wins <strong>50,000 UGX</strong> every week!</p>
<div style="background:var(--light);padding:.5rem 1rem;border-radius:8px;margin-bottom:1rem;font-size:.875rem">â° Resets in: <strong id="timeUntilReset">--</strong></div>
<div id="leaderboardList"></div></div></div>

<div id="vaultSection" class="hidden" style="padding:1rem">
<div style="background:linear-gradient(135deg,var(--primary),var(--secondary));color:white;border-radius:var(--radius);padding:1.5rem;margin-bottom:1rem">
<div style="font-size:.875rem;opacity:.9;margin-bottom:.5rem">Available Balance</div><div style="font-size:2rem;font-weight:800" id="vaultBalance">0</div><div style="font-size:.875rem;opacity:.9">UGX</div></div>
<div id="vaultAlert"></div><h3 style="margin-bottom:.5rem">ğŸ’ Choose Your Vault Plan</h3>
<p style="color:var(--gray);font-size:.875rem;margin-bottom:1rem">Select a plan to start earning daily task rewards. Your referrer earns 10% bonus on your purchase.</p>
<div class="plan-card" onclick="selectPlan('beginner')"><div style="display:flex;justify-content:space-between;align-items:flex-start"><div><div class="plan-name">ğŸŒ± Beginner</div><div class="plan-amount">45,000 UGX</div></div><div style="background:var(--primary);color:white;padding:.25rem .75rem;border-radius:20px;font-size:.75rem">Starter</div></div><div class="plan-details"><div class="plan-detail"><strong>2</strong>tasks/day</div><div class="plan-detail"><strong>750</strong>UGX/task</div><div class="plan-detail"><strong>45,000</strong>monthly max</div><div class="plan-detail"><strong>30 days</strong>duration</div></div></div>
<div class="plan-card" onclick="selectPlan('seed')"><div style="display:flex;justify-content:space-between;align-items:flex-start"><div><div class="plan-name">ğŸŒ¿ Seed</div><div class="plan-amount">180,000 UGX</div></div><div style="background:#10b981;color:white;padding:.25rem .75rem;border-radius:20px;font-size:.75rem">Popular</div></div><div class="plan-details"><div class="plan-detail"><strong>3</strong>tasks/day</div><div class="plan-detail"><strong>2,000</strong>UGX/task</div><div class="plan-detail"><strong>180,000</strong>monthly max</div><div class="plan-detail"><strong>30 days</strong>duration</div></div></div>
<div class="plan-card" onclick="selectPlan('rising')"><div style="display:flex;justify-content:space-between;align-items:flex-start"><div><div class="plan-name">ğŸŒ… Rising</div><div class="plan-amount">600,000 UGX</div></div><div style="background:#f59e0b;color:white;padding:.25rem .75rem;border-radius:20px;font-size:.75rem">Growth</div></div><div class="plan-details"><div class="plan-detail"><strong>4</strong>tasks/day</div><div class="plan-detail"><strong>5,000</strong>UGX/task</div><div class="plan-detail"><strong>600,000</strong>monthly max</div><div class="plan-detail"><strong>30 days</strong>duration</div></div></div>
<div class="plan-card" onclick="selectPlan('nova')"><div><div class="plan-name">ğŸ’¡ Nova</div><div class="plan-amount">1,350,000 UGX</div></div><div class="plan-details"><div class="plan-detail"><strong>5</strong>tasks/day</div><div class="plan-detail"><strong>9,000</strong>UGX/task</div><div class="plan-detail"><strong>1,350,000</strong>monthly max</div><div class="plan-detail"><strong>30 days</strong>duration</div></div></div>
<div class="plan-card" onclick="selectPlan('mastermind')"><div><div class="plan-name">ğŸ§  Mastermind</div><div class="plan-amount">4,050,000 UGX</div></div><div class="plan-details"><div class="plan-detail"><strong>6</strong>tasks/day</div><div class="plan-detail"><strong>22,500</strong>UGX/task</div><div class="plan-detail"><strong>4,050,000</strong>monthly max</div><div class="plan-detail"><strong>30 days</strong>duration</div></div></div>
<div class="plan-card" onclick="selectPlan('titan')"><div><div class="plan-name">ğŸ’ª Titan</div><div class="plan-amount">8,775,000 UGX</div></div><div class="plan-details"><div class="plan-detail"><strong>7</strong>tasks/day</div><div class="plan-detail"><strong>42,000</strong>UGX/task</div><div class="plan-detail"><strong>8,775,000</strong>monthly max</div><div class="plan-detail"><strong>30 days</strong>duration</div></div></div>
<div class="plan-card" onclick="selectPlan('king')"><div><div class="plan-name">ğŸ‘‘ King</div><div class="plan-amount">16,650,000 UGX</div></div><div class="plan-details"><div class="plan-detail"><strong>8</strong>tasks/day</div><div class="plan-detail"><strong>69,375</strong>UGX/task</div><div class="plan-detail"><strong>16,650,000</strong>monthly max</div><div class="plan-detail"><strong>30 days</strong>duration</div></div></div>
<div class="plan-card" onclick="selectPlan('emperor')"><div><div class="plan-name">ğŸ¦… Emperor</div><div class="plan-amount">29,700,000 UGX</div></div><div class="plan-details"><div class="plan-detail"><strong>9</strong>tasks/day</div><div class="plan-detail"><strong>110,000</strong>UGX/task</div><div class="plan-detail"><strong>29,700,000</strong>monthly max</div><div class="plan-detail"><strong>30 days</strong>duration</div></div></div>
<div class="plan-card" onclick="selectPlan('icon')"><div><div class="plan-name">â­ Icon</div><div class="plan-amount">48,600,000 UGX</div></div><div class="plan-details"><div class="plan-detail"><strong>10</strong>tasks/day</div><div class="plan-detail"><strong>162,000</strong>UGX/task</div><div class="plan-detail"><strong>48,600,000</strong>monthly max</div><div class="plan-detail"><strong>30 days</strong>duration</div></div></div>
<div class="plan-card" onclick="selectPlan('supreme')"><div><div class="plan-name">ğŸ‘‘ Supreme</div><div class="plan-amount">81,000,000 UGX</div></div><div class="plan-details"><div class="plan-detail"><strong>11</strong>tasks/day</div><div class="plan-detail"><strong>245,000</strong>UGX/task</div><div class="plan-detail"><strong>81,000,000</strong>monthly max</div><div class="plan-detail"><strong>30 days</strong>duration</div></div></div>
<div class="plan-card" onclick="selectPlan('legendary')"><div style="display:flex;justify-content:space-between;align-items:flex-start"><div><div class="plan-name">ğŸ† Legendary</div><div class="plan-amount">110,000,000 UGX</div></div><div style="background:linear-gradient(135deg,#f59e0b,#ef4444);color:white;padding:.25rem .75rem;border-radius:20px;font-size:.75rem">Ultimate</div></div><div class="plan-details"><div class="plan-detail"><strong>12</strong>tasks/day</div><div class="plan-detail"><strong>305,556</strong>UGX/task</div><div class="plan-detail"><strong>110,000,000</strong>monthly max</div><div class="plan-detail"><strong>30 days</strong>duration</div></div></div>
<div id="selectedPlanDetails" class="hidden card" style="border:2px solid var(--primary)">
<h3 style="margin-bottom:1rem;color:var(--primary)">ğŸ“‹ Plan Summary</h3>
<div style="display:grid;gap:.75rem">
<div style="display:flex;justify-content:space-between"><span>Plan:</span><strong id="confirmPlanName">-</strong></div>
<div style="display:flex;justify-content:space-between"><span>Amount:</span><strong id="confirmAmount">-</strong> UGX</div>
<div style="display:flex;justify-content:space-between"><span>Duration:</span><strong id="confirmDuration">-</strong></div>
<div style="display:flex;justify-content:space-between"><span>Daily Tasks:</span><strong id="confirmDailyROI">-</strong></div>
<div style="display:flex;justify-content:space-between"><span>Daily Task Earnings:</span><strong id="confirmDailyProfit">-</strong></div>
<div style="display:flex;justify-content:space-between"><span>Monthly Task Earnings:</span><strong id="confirmProfit">-</strong></div>
<div style="display:flex;justify-content:space-between;padding-top:.5rem;border-top:1px solid var(--border)"><span><strong>Total Potential:</strong></span><strong id="confirmTotal" style="color:var(--success)">-</strong></div></div>
<button class="btn btn-primary" id="purchaseBtn" onclick="purchaseVault()" style="width:100%;margin-top:1rem">Confirm Purchase</button></div></div>

<div id="referralsSection" class="hidden" style="padding:1rem">
<h2 style="margin-bottom:1rem">ğŸ‘¥ Referrals</h2><div id="referralsAlert"></div>
<div class="card" style="background:linear-gradient(135deg,var(--primary),var(--secondary));color:white;margin-bottom:1rem">
<div style="font-size:.875rem;opacity:.9">Total Referral Earnings</div><div style="font-size:2rem;font-weight:800" id="totalReferralEarnings">0</div><div style="font-size:.875rem;opacity:.9">UGX</div></div>
<div class="card"><h3 style="margin-bottom:1rem">Your Referral Level</h3><div id="referralLevelInfo"></div><div id="referralLevelProgress" style="margin-top:1rem"></div></div>
<div class="card"><h3 style="margin-bottom:1rem">How Referrals Work</h3>
<div style="background:var(--light);padding:1rem;border-radius:8px;margin-bottom:.75rem"><strong>ğŸ¯ Vault Purchase Bonus</strong><p style="color:var(--gray);font-size:.875rem;margin-top:.5rem">Earn 10% of every vault plan your referral purchases</p></div>
<div style="background:var(--light);padding:1rem;border-radius:8px;margin-bottom:.75rem"><strong>ğŸŒ³ Second-Level Bonus</strong><p style="color:var(--gray);font-size:.875rem;margin-top:.5rem">Earn 2,000 UGX when your referral brings someone new</p></div>
<div style="background:var(--light);padding:1rem;border-radius:8px"><strong>ğŸ† Weekly Prize</strong><p style="color:var(--gray);font-size:.875rem;margin-top:.5rem">Top referrer each week wins 50,000 UGX</p></div></div>
<div class="card"><h3 style="margin-bottom:1rem">Your Referrals</h3><div id="referralsList" style="color:var(--gray);text-align:center;padding:1rem">Loading...</div></div></div>

<div id="streakSection" class="hidden" style="padding:1rem">
<h2 style="margin-bottom:1rem">ğŸ”¥ Daily Streak</h2><div id="streakSectionAlert"></div>
<div class="card" style="text-align:center">
<div style="font-size:4rem;margin-bottom:1rem">ğŸ”¥</div>
<div style="font-size:3rem;font-weight:800;color:var(--primary)" id="currentStreak">0</div>
<div style="color:var(--gray);margin-bottom:1rem">Day Streak</div>
<div style="display:flex;justify-content:center;gap:.5rem;margin-bottom:1rem" id="streakDays"></div>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem">
<div style="background:var(--light);padding:1rem;border-radius:8px"><div style="font-size:1.5rem;font-weight:700" id="streakPoints">0</div><div style="color:var(--gray);font-size:.875rem">Points Balance</div></div>
<div style="background:var(--light);padding:1rem;border-radius:8px"><div style="font-size:1.5rem;font-weight:700" id="longestStreakDisplay">0</div><div style="color:var(--gray);font-size:.875rem">Best Streak</div></div></div></div>
<div class="card"><h3 style="margin-bottom:1rem">ğŸ’± Convert Points</h3>
<p style="color:var(--gray);font-size:.875rem;margin-bottom:1rem">100 points = 1,000 UGX</p>
<div style="display:flex;gap:1rem;margin-bottom:1rem">
<div style="flex:1"><label style="font-size:.875rem;color:var(--gray);display:block;margin-bottom:.25rem">Points to Convert</label><input type="number" id="pointsToConvert" placeholder="Min 100 pts" style="width:100%;padding:.75rem;border:2px solid var(--border);border-radius:8px" oninput="document.getElementById('pointsConversionResult').textContent=((parseInt(this.value)||0)*10).toLocaleString()+' UGX'"></div>
<div style="flex:1"><label style="font-size:.875rem;color:var(--gray);display:block;margin-bottom:.25rem">You Receive</label><div style="padding:.75rem;background:var(--light);border-radius:8px;font-weight:700" id="pointsConversionResult">0 UGX</div></div></div>
<button class="btn btn-success" onclick="convertPoints()" style="width:100%">Convert Points</button></div></div>

<div id="tasksSection" class="hidden" style="padding:1rem">
<h2 style="margin-bottom:1rem">âœ… Daily Tasks</h2><div id="tasksAlert"></div>
<div class="card" style="background:linear-gradient(135deg,var(--primary),var(--secondary));color:white;margin-bottom:1rem">
<div style="font-size:.875rem;opacity:.9">Today's Task Progress</div>
<div id="taskProgressDisplay" style="font-size:1.5rem;font-weight:800">0 / 0 Tasks</div>
<div style="background:rgba(255,255,255,.3);border-radius:4px;height:8px;margin-top:.5rem"><div id="taskProgressBar" style="background:white;height:100%;border-radius:4px;width:0%;transition:width .3s"></div></div></div>
<div id="tasksList"><div style="text-align:center;padding:2rem;color:var(--gray)"><div class="spinner"></div><p style="margin-top:1rem">Loading tasks...</p></div></div></div>

<div id="walletSection" class="hidden" style="padding:1rem">
<h2 style="margin-bottom:1rem">ğŸ’¼ Wallet</h2><div id="walletAlert"></div>
<div class="card" style="background:linear-gradient(135deg,var(--primary),var(--secondary));color:white;margin-bottom:1rem">
<div style="font-size:.875rem;opacity:.9;margin-bottom:.25rem">Total Balance</div>
<div style="font-size:2.5rem;font-weight:800" id="walletBalance">0</div>
<div style="font-size:.875rem;opacity:.9">UGX</div>
<div style="margin-top:.75rem;font-size:.875rem;opacity:.9">Points: <strong id="walletPointsBalance">0</strong></div></div>
<div style="display:flex;background:var(--light);border-radius:8px;padding:.25rem;margin-bottom:1rem">
<button onclick="showWalletTab('deposit')" id="depositTab" class="btn" style="flex:1;background:var(--primary);color:white;border-radius:6px;font-size:.875rem;padding:.5rem">Deposit</button>
<button onclick="showWalletTab('withdraw')" id="withdrawTab" class="btn" style="flex:1;background:none;color:var(--gray);font-size:.875rem;padding:.5rem">Withdraw</button></div>
<div id="depositPanel" class="card"><h3 style="margin-bottom:1rem">ğŸ’° Deposit Funds</h3><div id="depositAlert"></div>
<div class="form-group"><label>Amount (UGX)</label><input type="number" id="depositAmount" placeholder="Enter amount"></div>
<div class="form-group"><label>Payment Method</label><select id="depositMethod"><option value="">Select method</option><option value="mtn">MTN Mobile Money</option><option value="airtel">Airtel Money</option></select></div>
<div class="form-group"><label>Phone Number</label><input type="tel" id="depositPhone" placeholder="07XXXXXXXX"></div>
<div style="background:#fef3c7;border:1px solid #fcd34d;border-radius:8px;padding:1rem;margin-bottom:1rem;font-size:.875rem">
<strong>ğŸ“± Payment Instructions:</strong><br>1. Send money to: <strong onclick="navigator.clipboard.writeText('0785000000')" style="cursor:pointer;color:var(--primary)">0785 000 000</strong><br>2. Enter amount and phone number<br>3. Wait for admin approval</div>
<button class="btn btn-success" onclick="submitDeposit()" style="width:100%">Submit Deposit Request</button></div>
<div id="withdrawPanel" class="hidden card"><h3 style="margin-bottom:1rem">ğŸ’¸ Withdraw Funds</h3><div id="withdrawAlert"></div>
<div class="form-group"><label>Withdrawal Category</label><select id="withdrawCategory"><option value="">Select earnings category</option><option value="referral">Referral Earnings</option><option value="task">Task Earnings (Fri-Sat only)</option><option value="vault">Vault Earnings</option></select></div>
<div class="form-group"><label>Amount (UGX)</label><input type="number" id="withdrawAmount" placeholder="Min 5,000 UGX"></div>
<div class="form-group"><label>Phone Number</label><input type="tel" id="withdrawPhone" placeholder="07XXXXXXXX"></div>
<div style="background:#fef3c7;border:1px solid #fcd34d;border-radius:8px;padding:1rem;margin-bottom:1rem;font-size:.875rem"><strong>âš ï¸ Rules:</strong> Task earnings: Fri &amp; Sat only | Admin fee: 5% | Min: 5,000 UGX</div>
<button class="btn btn-primary" onclick="submitWithdrawal()" style="width:100%">Request Withdrawal</button></div>
<div class="card"><h3 style="margin-bottom:1rem">ğŸ“‹ Transaction History</h3>
<div style="overflow-x:auto"><table><thead><tr><th>Date</th><th>Type</th><th>Amount</th><th>Status</th></tr></thead>
<tbody id="walletTransactionHistory"><tr><td colspan="4" style="text-align:center;color:var(--gray)">No transactions yet</td></tr></tbody></table></div></div></div>

<div id="profileSection" class="hidden" style="padding:1rem">
<div id="profileAlert"></div>
<div class="card" style="text-align:center;background:linear-gradient(135deg,var(--primary),var(--secondary));color:white">
<div style="position:relative;display:inline-block;margin-bottom:1rem">
<div id="profileInitials" style="width:80px;height:80px;border-radius:50%;background:rgba(255,255,255,.2);display:flex;align-items:center;justify-content:center;font-size:2rem;font-weight:700;margin:0 auto">ğŸ‘¤</div>
<img id="profileImage" style="width:80px;height:80px;border-radius:50%;object-fit:cover;display:none;margin:0 auto">
<label style="position:absolute;bottom:0;right:0;background:white;border-radius:50%;width:28px;height:28px;display:flex;align-items:center;justify-content:center;cursor:pointer;color:var(--primary)">ğŸ“·<input type="file" accept="image/*" style="display:none" onchange="uploadProfilePicture(event)"></label></div>
<h2 id="profileUserName" style="color:white;margin-bottom:.25rem">User</h2>
<p id="profileUserEmail" style="opacity:.9;font-size:.875rem">user@example.com</p>
<p id="profileJoinedDate" style="opacity:.75;font-size:.75rem;margin-top:.25rem">Member since N/A</p>
<div id="profileLevelBadge" class="level-badge" style="margin-top:.75rem;background:rgba(255,255,255,.2)">ğŸŒ± Newcomer</div></div>
<div class="card"><h3 style="margin-bottom:1rem">Account Information</h3>
<div style="display:grid;gap:1rem">
<div style="display:flex;justify-content:space-between;align-items:center"><span style="color:var(--gray);font-size:.875rem">Full Name</span>
<div style="display:flex;align-items:center;gap:.5rem"><span id="profileFullNameValue" style="font-weight:600"></span><button id="editNameBtn" onclick="toggleNameEdit()" style="background:none;border:none;color:var(--primary);cursor:pointer">âœï¸</button></div></div>
<div id="nameEditContainer" style="display:none"><input type="text" id="nameEditInput" style="width:100%;padding:.5rem;border:2px solid var(--primary);border-radius:8px;margin-bottom:.5rem">
<div style="display:flex;gap:.5rem"><button onclick="saveNameEdit()" class="btn btn-success" style="flex:1;padding:.5rem">Save</button><button onclick="cancelNameEdit()" class="btn" style="flex:1;padding:.5rem;background:var(--gray);color:white">Cancel</button></div></div>
<div style="display:flex;justify-content:space-between"><span style="color:var(--gray);font-size:.875rem">Email</span><span style="font-weight:600" id="profileEmailValue"></span></div>
<div style="display:flex;justify-content:space-between"><span style="color:var(--gray);font-size:.875rem">Joined</span><span style="font-weight:600" id="profileJoinedValue"></span></div>
<div style="display:flex;justify-content:space-between"><span style="color:var(--gray);font-size:.875rem">Status</span><span style="font-weight:600" id="profileAccountStatusValue"></span></div></div></div>
<div class="card"><h3 style="margin-bottom:1rem">ğŸ“Š Account Statistics</h3>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem">
<div style="background:var(--light);padding:1rem;border-radius:8px;text-align:center"><div style="font-size:1.5rem;font-weight:700" id="profileActiveVaults">0</div><div style="color:var(--gray);font-size:.75rem">Vaults</div></div>
<div style="background:var(--light);padding:1rem;border-radius:8px;text-align:center"><div style="font-size:1.25rem;font-weight:700" id="profileAccountLevel">Newcomer</div><div style="color:var(--gray);font-size:.75rem">Account Level</div></div>
<div style="background:var(--light);padding:1rem;border-radius:8px;text-align:center"><div style="font-size:1.5rem;font-weight:700" id="pointsBalance">0</div><div style="color:var(--gray);font-size:.75rem">Points</div></div>
<div style="background:var(--light);padding:1rem;border-radius:8px;text-align:center"><div style="font-size:1.5rem;font-weight:700" id="profileStreakValue">0</div><div style="color:var(--gray);font-size:.75rem">Day Streak</div></div></div></div>
<div class="card"><h3 style="margin-bottom:1rem">ğŸ”‘ Referral Code</h3>
<div style="background:var(--light);padding:1rem;border-radius:8px;text-align:center;font-size:1.5rem;font-weight:800;letter-spacing:.1em;color:var(--primary);margin-bottom:1rem" id="profileReferralCode">LOADING</div>
<button class="btn btn-primary" onclick="copyReferralCode()" style="width:100%">ğŸ“‹ Copy Code</button></div>
<div class="card"><button class="btn" onclick="logout()" style="width:100%;background:var(--error);color:white">ğŸšª Logout</button></div></div>

</div>

<nav class="bottom-nav" style="display:none">
<button class="bottom-nav-item active" data-section="home" onclick="showSection('home')"><span>ğŸ </span><span>Home</span></button>
<button class="bottom-nav-item" data-section="vault" onclick="showSection('vault')"><span>ğŸ¦</span><span>Vault</span></button>
<button class="bottom-nav-item" data-section="referrals" onclick="showSection('referrals')"><span>ğŸ‘¥</span><span>Referrals</span></button>
<button class="bottom-nav-item" data-section="tasks" onclick="showSection('tasks')"><span>âœ…</span><span>Tasks</span></button>
<button class="bottom-nav-item" data-section="wallet" onclick="showSection('wallet')"><span>ğŸ’¼</span><span>Wallet</span></button>
<button class="bottom-nav-item" data-section="profile" onclick="showSection('profile')"><span>ğŸ‘¤</span><span>Profile</span></button></nav></div><div id="adminDashboard" class="hidden" style="min-height:100vh;background:var(--light)">
<div style="background:linear-gradient(135deg,#1f2937,#374151);color:white;padding:1rem">
<div style="max-width:1200px;margin:0 auto;display:flex;justify-content:space-between;align-items:center">
<h1 style="font-size:1.25rem;font-weight:700">ğŸ¦ VaultPro Admin</h1>
<button onclick="logout()" style="background:rgba(255,255,255,.1);border:none;color:white;padding:.5rem 1rem;border-radius:6px;cursor:pointer">Logout</button></div></div>
<div style="max-width:1200px;margin:0 auto;padding:1rem">
<div style="display:flex;gap:.5rem;margin-bottom:1rem;overflow-x:auto;padding-bottom:.5rem">
<button class="btn btn-primary" style="white-space:nowrap;font-size:.875rem" onclick="showAdminSection('stats')">ğŸ“Š Stats</button>
<button class="btn" style="white-space:nowrap;font-size:.875rem;background:var(--gray);color:white" onclick="showAdminSection('users')">ğŸ‘¥ Users</button>
<button class="btn" style="white-space:nowrap;font-size:.875rem;background:var(--gray);color:white" onclick="showAdminSection('tasks')">âœ… Tasks</button>
<button class="btn" style="white-space:nowrap;font-size:.875rem;background:var(--gray);color:white" onclick="showAdminSection('transactions')">ğŸ“‹ Transactions</button>
<button class="btn" style="white-space:nowrap;font-size:.875rem;background:var(--success);color:white" onclick="showAdminSection('deposits')">ğŸ’° Deposits</button>
<button class="btn" style="white-space:nowrap;font-size:.875rem;background:var(--warning);color:white" onclick="showAdminSection('withdrawals')">ğŸ’¸ Withdrawals</button></div>
<div id="adminStatsSection">
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:1rem;margin-bottom:1rem">
<div class="card" style="text-align:center"><div style="font-size:2rem;font-weight:800;color:var(--primary)" id="adminTotalUsers">0</div><div style="color:var(--gray)">Total Users</div></div>
<div class="card" style="text-align:center"><div style="font-size:2rem;font-weight:800;color:var(--success)" id="adminTotalBalance">0</div><div style="color:var(--gray)">Total Balance (UGX)</div></div>
<div class="card" style="text-align:center"><div style="font-size:2rem;font-weight:800;color:var(--warning)" id="adminTotalDeposits">0</div><div style="color:var(--gray)">Total Deposits</div></div>
<div class="card" style="text-align:center"><div style="font-size:2rem;font-weight:800;color:var(--error)" id="adminTotalWithdrawals">0</div><div style="color:var(--gray)">Total Withdrawals</div></div>
<div class="card" style="text-align:center"><div style="font-size:2rem;font-weight:800;color:var(--secondary)" id="adminActivatedUsers">0</div><div style="color:var(--gray)">Active Users</div></div>
<div class="card" style="text-align:center"><div style="font-size:2rem;font-weight:800;color:var(--primary)" id="adminPendingWithdrawals">0</div><div style="color:var(--gray)">Pending Withdrawals</div></div></div>
<div class="card"><h3 style="margin-bottom:1rem">Award Weekly Prize</h3><p style="color:var(--gray);font-size:.875rem;margin-bottom:1rem">Award 50,000 UGX to the top referrer this week (min 8 referrals)</p>
<button class="btn btn-primary" onclick="awardWeeklyWinner().then(w=>alert(w?'Winner: '+w.userData.fullName:'No winner - min 8 referrals required'))">ğŸ† Award Weekly Winner</button></div></div>
<div id="adminUsersSection" class="hidden"><div class="card"><h3 style="margin-bottom:1rem">All Users</h3><div id="adminUsersList">Loading...</div></div></div>
<div id="adminTasksSection" class="hidden">
<div class="card" style="margin-bottom:1rem"><h3 style="margin-bottom:1rem">Add YouTube Task</h3>
<div class="form-group"><label>YouTube URL</label><input type="url" id="newTaskUrl" placeholder="https://youtube.com/watch?v=..."></div>
<div class="form-group"><label>Task Title</label><input type="text" id="newTaskTitle" placeholder="Task title"></div>
<div class="form-group"><label>Description</label><input type="text" id="newTaskDescription" placeholder="Watch and like this video"></div>
<div class="form-group"><label>Reward (UGX)</label><input type="number" id="newTaskReward" placeholder="1000"></div>
<button class="btn btn-success" onclick="addTask()" style="width:100%">Add Task</button></div>
<div class="card" style="margin-bottom:1rem"><h3 style="margin-bottom:1rem">Add External Link Task</h3>
<div class="form-group"><label>URL</label><input type="url" id="newExternalTaskUrl" placeholder="https://..."></div>
<div class="form-group"><label>Title</label><input type="text" id="newExternalTaskTitle" placeholder="Task title"></div>
<div class="form-group"><label>Description</label><input type="text" id="newExternalTaskDescription" placeholder="Visit this website"></div>
<div class="form-group"><label>Reward (UGX)</label><input type="number" id="newExternalTaskReward" placeholder="1000"></div>
<button class="btn btn-success" onclick="addExternalTask()" style="width:100%">Add External Task</button></div>
<div class="card"><h3 style="margin-bottom:1rem">YouTube Tasks</h3><div id="adminTasksList">Loading...</div></div>
<div class="card"><h3 style="margin-bottom:1rem">External Tasks</h3><div id="adminExternalTasksList">Loading...</div></div></div>
<div id="adminTransactionsSection" class="hidden"><div class="card"><h3 style="margin-bottom:1rem">All Transactions</h3>
<div style="overflow-x:auto"><table><thead><tr><th>User</th><th>Type</th><th>Amount</th><th>Date</th></tr></thead><tbody id="adminTransactionsList"><tr><td colspan="4" style="text-align:center">Loading...</td></tr></tbody></table></div></div></div>
<div id="adminDepositsSection" class="hidden"><div class="card"><h3 style="margin-bottom:1rem">Deposit Requests</h3><div id="adminDepositsList">Loading...</div></div></div>
<div id="adminWithdrawalsSection" class="hidden"><div class="card"><h3 style="margin-bottom:1rem">Withdrawal Requests</h3><div id="adminWithdrawalsList">Loading...</div></div></div>
</div></div>

<div id="whatsappGroupModal" class="modal hidden">
<div class="modal-content"><div class="modal-header" style="background:linear-gradient(135deg,#25d366,#128c7e);color:white;border-radius:16px 16px 0 0;border:none">
<h3>ğŸ’¬ Join WhatsApp Group</h3><button class="modal-close" onclick="document.getElementById('whatsappGroupModal').classList.add('hidden')" style="color:white">Ã—</button></div>
<div class="modal-body"><p style="margin-bottom:1.5rem;color:var(--gray)">Join our community to get updates and connect with other investors!</p>
<a href="https://chat.whatsapp.com/KBvY0dutPIcHPLNzjBcJZQ" target="_blank" class="btn btn-success" style="width:100%;display:block;text-align:center;text-decoration:none;margin-bottom:1rem">ğŸ“± Join WhatsApp Group</a>
<button onclick="document.getElementById('whatsappGroupModal').classList.add('hidden')" class="btn" style="width:100%;background:var(--gray);color:white">Close</button></div></div></div>

<div id="categorySelectionModal" class="modal hidden">
<div class="modal-content"><div class="modal-header">
<h3>ğŸ’° Select Payment Source</h3><button class="modal-close" onclick="closeCategorySelectionModal()">Ã—</button></div>
<div class="modal-body"><p style="color:var(--gray);margin-bottom:1rem" id="categorySelectionDescription">Select which earnings to use:</p>
<div id="categoryOptions"></div></div></div></div>

<div id="notificationContainer" style="position:fixed;top:20px;right:20px;z-index:10000;pointer-events:none;display:flex;flex-direction:column;gap:10px"></div>
<div id="notificationCenter" style="display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:white;border-radius:12px;box-shadow:0 20px 60px rgba(0,0,0,.3);width:90%;max-width:500px;max-height:80vh;z-index:10001;overflow:hidden">
<div style="background:linear-gradient(135deg,#667eea,#764ba2);color:white;padding:16px 20px;display:flex;justify-content:space-between;align-items:center">
<h3 style="margin:0">ğŸ”” Notifications</h3><button onclick="hideNotificationCenter()" style="background:none;border:none;color:white;font-size:24px;cursor:pointer">Ã—</button></div>
<div style="max-height:60vh;overflow-y:auto" id="notificationList"></div></div>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script>
// ===== FIREBASE CONFIG =====
const firebaseConfig={apiKey:"AIzaSyCnMj0_eJEaD2dZNSoeZ_ijsl8ETt4BFhY",authDomain:"vaultpro-app.firebaseapp.com",projectId:"vaultpro-app",storageBucket:"vaultpro-app.appspot.com",messagingSenderId:"123456789",appId:"1:123456789:web:abcdef123456"};
let db,auth,firebaseInitialized=false;
try{firebase.initializeApp(firebaseConfig);db=firebase.firestore();auth=firebase.auth();firebaseInitialized=true;console.log("Firebase OK")}catch(e){console.error("Firebase init:",e)}

// ===== GLOBALS =====
let currentUser=null,selectedPlan=null,isProcessingVaultPurchase=false,allowManualRegistration=false;
let userStatsCache={data:null,timestamp:0,ttl:30000};
let categorySelectionCallback=null;

// ===== VAULT PLANS =====
const vaultPlans={
beginner:{name:"Beginner",amount:45000,days:30,dailyTasks:2,taskReward:750,level:1},
seed:{name:"Seed",amount:180000,days:30,dailyTasks:3,taskReward:2000,level:2},
rising:{name:"Rising",amount:600000,days:30,dailyTasks:4,taskReward:5000,level:3},
nova:{name:"Nova",amount:1350000,days:30,dailyTasks:5,taskReward:9000,level:4},
mastermind:{name:"Mastermind",amount:4050000,days:30,dailyTasks:6,taskReward:22500,level:5},
titan:{name:"Titan",amount:8775000,days:30,dailyTasks:7,taskReward:42000,level:6},
king:{name:"King",amount:16650000,days:30,dailyTasks:8,taskReward:69375,level:7},
emperor:{name:"Emperor",amount:29700000,days:30,dailyTasks:9,taskReward:110000,level:8},
icon:{name:"Icon",amount:48600000,days:30,dailyTasks:10,taskReward:162000,level:9},
supreme:{name:"Supreme",amount:81000000,days:30,dailyTasks:11,taskReward:245000,level:10},
legendary:{name:"Legendary",amount:110000000,days:30,dailyTasks:12,taskReward:305556,level:11}};

// ===== REFERRAL LEVELS =====
const referralLevels=[
{title:"Member",icon:"ğŸŒ±",color:"#10b981",minRefs:0},
{title:"Ambassador",icon:"â­",color:"#f59e0b",minRefs:10},
{title:"Executive",icon:"ğŸ’¼",color:"#6366f1",minRefs:50},
{title:"Director",icon:"ğŸ¯",color:"#8b5cf6",minRefs:100},
{title:"VP",icon:"ğŸ¦…",color:"#ec4899",minRefs:500},
{title:"Admin",icon:"ğŸ‘‘",color:"#f59e0b",minRefs:1000},
{title:"Shareholder",icon:"ğŸ’",color:"#06b6d4",minRefs:5000}];

function getUserReferralLevel(refs){for(let i=referralLevels.length-1;i>=0;i--)if(refs>=referralLevels[i].minRefs)return referralLevels[i];return referralLevels[0]}

// ===== REFERRAL CODE =====
function storeReferralCode(code){if(!code)return;const expiry=Date.now()+86400000;localStorage.setItem("vp_ref",JSON.stringify({code,expiry}));sessionStorage.setItem("vp_ref_s",code)}
function getStoredReferralCode(){const s=sessionStorage.getItem("vp_ref_s");if(s)return s;const stored=localStorage.getItem("vp_ref");if(!stored)return null;try{const{code,expiry}=JSON.parse(stored);if(Date.now()<expiry)return code;localStorage.removeItem("vp_ref")}catch(e){}return null}
function clearStoredReferralCode(){localStorage.removeItem("vp_ref");sessionStorage.removeItem("vp_ref_s")}
function captureReferralCode(){const p=new URLSearchParams(window.location.search).get("ref");if(p){storeReferralCode(p);sessionStorage.setItem("pending_ref",p)}}

// ===== CATEGORY BALANCES =====
async function getUserCategoryBalances(uid){
try{const snap=await db.collection("transactions").where("userId","==",uid).get();
const b={taskEarnings:0,referralEarnings:0,vaultEarnings:0,depositEarnings:0};
snap.docs.forEach(d=>{const t=d.data(),a=t.amount||0;
switch(t.type){case"task_completion":b.taskEarnings+=a;break;case"referral":b.referralEarnings+=a;break;case"vault_maturity":b.vaultEarnings+=a;break;case"deposit":b.depositEarnings+=a;break;case"withdrawal":case"withdrawal_approved":{const c=t.sourceCategory||"depositEarnings";b[c]=(b[c]||0)-Math.abs(a);break}}});
Object.keys(b).forEach(k=>{b[k]=Math.max(0,b[k])});return b}catch(e){return{taskEarnings:0,referralEarnings:0,vaultEarnings:0,depositEarnings:0}}}

async function getUserActualBalance(uid){try{const d=await db.collection("users").doc(uid).get();return d.exists?(d.data().balance||0):0}catch(e){return 0}}

async function getUserVaultLevel(uid){
try{const snap=await db.collection("users").doc(uid).collection("vaults").get();
const vaults=snap.docs.map(d=>({id:d.id,...d.data()})).filter(v=>v.status==="active");
if(!vaults.length)return{planName:"None",level:0,dailyTasks:0,taskReward:0};
const top=vaults.sort((a,b)=>b.amount-a.amount)[0];
const pk=Object.keys(vaultPlans).find(k=>vaultPlans[k].name===top.planName);
if(!pk)return{planName:"None",level:0,dailyTasks:0,taskReward:0};
const p=vaultPlans[pk];return{planName:p.name,level:p.level,dailyTasks:p.dailyTasks,taskReward:p.taskReward}}
catch(e){return{planName:"None",level:0,dailyTasks:0,taskReward:0}}}

// ===== CATEGORY SELECTION MODAL =====
async function showCategorySelectionModal(amount,callback){
categorySelectionCallback=callback;
const b=await getUserCategoryBalances(currentUser.id);
const cats=[{key:"depositEarnings",label:"ğŸ’° Deposits",bal:b.depositEarnings},{key:"referralEarnings",label:"ğŸ‘¥ Referral",bal:b.referralEarnings},{key:"taskEarnings",label:"âœ… Task",bal:b.taskEarnings},{key:"vaultEarnings",label:"ğŸ¦ Vault",bal:b.vaultEarnings}];
document.getElementById("categorySelectionDescription").textContent=`Select which earnings to use for ${amount.toLocaleString()} UGX:`;
document.getElementById("categoryOptions").innerHTML=cats.map(c=>{const ok=c.bal>=amount;return`<div style="padding:1rem;border:2px solid ${ok?"var(--border)":"#f3f4f6"};border-radius:8px;margin-bottom:.75rem;cursor:${ok?"pointer":"not-allowed"};opacity:${ok?1:.5}" ${ok?`onclick="selectCategory('${c.key}','${c.label}')"`:""}><div style="display:flex;justify-content:space-between;align-items:center"><div><div style="font-weight:600">${c.label}</div><div style="font-size:.875rem;color:var(--gray)">Available: ${c.bal.toLocaleString()} UGX</div></div><div style="color:${ok?"var(--success)":"var(--error)"}">${ok?"âœ“":"âœ—"}</div></div></div>`}).join("");
document.getElementById("categorySelectionModal").classList.remove("hidden")}
function selectCategory(k,n){closeCategorySelectionModal();if(categorySelectionCallback)categorySelectionCallback(k,n)}
function closeCategorySelectionModal(){document.getElementById("categorySelectionModal").classList.add("hidden");categorySelectionCallback=null}

// ===== AUTH =====
function setupAuthStateListener(){auth.onAuthStateChanged(async user=>{if(user){try{const d=await db.collection("users").doc(user.uid).get();if(d.exists){currentUser={id:user.uid,...d.data()};document.getElementById("loadingScreen").classList.add("hidden");if(currentUser.isAdmin)showAdminDashboard();else{showUserDashboard();initializeNotificationSystem()}}}catch(e){console.error(e)}}else{document.getElementById("loadingScreen").classList.add("hidden")}})}

async function init(){
document.getElementById("loadingScreen").classList.remove("hidden");
if(!firebaseInitialized){document.getElementById("loadingScreen").classList.add("hidden");return}
setupAuthStateListener();
const urlRef=new URLSearchParams(window.location.search).get("ref");
if(urlRef){storeReferralCode(urlRef);sessionStorage.setItem("pending_ref",urlRef);window.history.replaceState({},"",window.location.origin+window.location.pathname);await new Promise(r=>setTimeout(r,800));await showReferralLanding(urlRef);return}
const stored=getStoredReferralCode()||sessionStorage.getItem("pending_ref");
if(stored){await showReferralLanding(stored);return}
document.getElementById("loadingScreen").classList.add("hidden");
if(!auth.currentUser)showLogin();
const nav=document.querySelector(".bottom-nav");if(nav)nav.style.display="none"}

async function showReferralLanding(code){
document.getElementById("loadingScreen").classList.add("hidden");
document.getElementById("referralLandingPage").classList.remove("hidden");
document.getElementById("landingReferralCode").textContent=code;
storeReferralCode(code)}

// ===== REGISTER =====
async function register(){
const btn=document.getElementById("registerBtn");btn.disabled=true;btn.textContent="Processing...";
try{
if(!firebaseInitialized){showAlert("registerAlert","Firebase not initialized","error");btn.disabled=false;btn.textContent="Create Account";return}
const code=document.getElementById("inviteCode").value.trim(),name=document.getElementById("fullName").value.trim(),
email=document.getElementById("email").value.trim(),pwd=document.getElementById("password").value,cpwd=document.getElementById("confirmPassword").value;
if(!code||!name||!email||!pwd){showAlert("registerAlert","Please fill all fields","error");btn.disabled=false;btn.textContent="Create Account";return}
if(pwd.length<6){showAlert("registerAlert","Password must be at least 6 characters","error");btn.disabled=false;btn.textContent="Create Account";return}
if(pwd!==cpwd){showAlert("registerAlert","Passwords do not match","error");btn.disabled=false;btn.textContent="Create Account";return}
const refQ=await db.collection("users").where("referralCode","==",code.toUpperCase()).get();
if(refQ.empty){showAlert("registerAlert","Invalid invitation code","error");btn.disabled=false;btn.textContent="Create Account";return}
const refId=refQ.docs[0].id;
const uc=await auth.createUserWithEmailAndPassword(email,pwd);const uid=uc.user.uid;
const newUser={id:uid,fullName:name,email,balance:0,referredBy:refId,
referralCode:Math.random().toString(36).substring(2,8).toUpperCase(),
joinedDate:new Date().toISOString(),isAdmin:false,isActivated:true,
activationDate:new Date().toISOString(),currentStreak:0,longestStreak:0,
lastLoginDate:null,totalPoints:0,pointsBalance:0,totalTaskEarnings:0};
await db.collection("users").doc(uid).set(newUser);
await db.collection("users").doc(refId).collection("referrals").doc(uid).set({userId:uid,name,email,date:new Date().toISOString(),earnings:0});
clearStoredReferralCode();
showAlert("registerAlert","Account created! Welcome to VaultPro!","success");
setTimeout(()=>showLogin(),2000)}
catch(e){let msg="Registration failed: "+e.message;
if(e.code==="auth/email-already-in-use")msg="Email already registered";
else if(e.code==="auth/weak-password")msg="Password too weak";
showAlert("registerAlert",msg,"error");btn.disabled=false;btn.textContent="Create Account"}}

// ===== LOGIN =====
async function login(){
const btn=document.getElementById("loginBtn");btn.disabled=true;btn.textContent="Logging in...";
try{
const email=document.getElementById("loginEmail").value.trim(),pwd=document.getElementById("loginPassword").value;
if(!email||!pwd){showAlert("loginAlert","Please enter email and password","error");btn.disabled=false;btn.textContent="Login";return}
const uc=await auth.signInWithEmailAndPassword(email,pwd);
const d=await db.collection("users").doc(uc.user.uid).get();
if(!d.exists){showAlert("loginAlert","Account not found","error");await auth.signOut();btn.disabled=false;btn.textContent="Login";return}
currentUser={id:uc.user.uid,...d.data()};
await updateUserStreak(uc.user.uid,currentUser);
if(currentUser.isAdmin)showAdminDashboard();else{showUserDashboard();initializeNotificationSystem()}}
catch(e){let msg="Login failed";
if(e.code==="auth/user-not-found")msg="No account with this email";
else if(e.code==="auth/wrong-password")msg="Incorrect password";
else if(e.code==="auth/too-many-requests")msg="Too many attempts, try later";
else msg="Login failed: "+e.message;
showAlert("loginAlert",msg,"error");btn.disabled=false;btn.textContent="Login"}}

// ===== STREAK =====
async function updateUserStreak(uid,user){
try{if(user.isAdmin){await db.collection("users").doc(uid).update({lastLoginDate:new Date().toISOString()});return}
const today=new Date().toISOString().split("T")[0],last=user.lastLoginDate?new Date(user.lastLoginDate).toISOString().split("T")[0]:null;
if(last===today)return;
let streak=user.currentStreak||0,longest=user.longestStreak||0,pts=user.totalPoints||0,bal=user.pointsBalance||0;
const yest=new Date();yest.setDate(yest.getDate()-1);const yestStr=yest.toISOString().split("T")[0];
streak=last===yestStr?streak+1:1;if(streak>longest)longest=streak;
const award=streak>=30?100:streak>=21?75:streak>=14?50:streak>=7?25:streak>=3?15:streak>=2?10:5;
pts+=award;bal+=award;
await db.collection("users").doc(uid).update({currentStreak:streak,longestStreak:longest,lastLoginDate:new Date().toISOString(),totalPoints:pts,pointsBalance:bal});
if(currentUser)Object.assign(currentUser,{currentStreak:streak,longestStreak:longest,pointsBalance:bal});
if(award>0)setTimeout(()=>showAlert("streakAlert",`ğŸ”¥ ${streak} Day Streak! +${award} Points!`,"success"),1000)}
catch(e){console.error("Streak:",e)}}

// ===== NAVIGATION =====
function showRegisterFromReferral(){
["loginPage","referralLandingPage"].forEach(id=>{const e=document.getElementById(id);if(e)e.classList.add("hidden")});
document.getElementById("registerPage").classList.remove("hidden");
const code=getStoredReferralCode();if(code){const f=document.getElementById("inviteCode");f.value=code;f.readOnly=true;f.style.borderColor="var(--success)"}}

function showLogin(){
["registerPage","userDashboard","adminDashboard","referralLandingPage"].forEach(id=>{const e=document.getElementById(id);if(e)e.classList.add("hidden")});
document.getElementById("loginPage").classList.remove("hidden");
const nav=document.querySelector(".bottom-nav");if(nav)nav.style.display="none"}

function showUserDashboard(){
["registerPage","loginPage","referralLandingPage"].forEach(id=>{const e=document.getElementById(id);if(e)e.classList.add("hidden")});
document.getElementById("userDashboard").classList.remove("hidden");
document.getElementById("adminDashboard").classList.add("hidden");
const nav=document.querySelector(".bottom-nav");if(nav)nav.style.display="flex";
setTimeout(()=>showSection("home"),50);
updateUserStats();updateLeaderboard();scheduleWeeklyAward();
if(currentUser){updateProfileSection();updateReferralLevelProgress()}
setInterval(updateWeekResetTimer,60000)}

function showAdminDashboard(){
["registerPage","loginPage","userDashboard"].forEach(id=>{const e=document.getElementById(id);if(e)e.classList.add("hidden")});
document.getElementById("adminDashboard").classList.remove("hidden");
updateAdminStats();showAdminSection("stats")}

function showSection(s){
if(!currentUser)return;
["home","vault","referrals","streak","tasks","wallet","profile"].forEach(x=>{const e=document.getElementById(x+"Section");if(e)e.classList.add("hidden")});
const el=document.getElementById(s+"Section");if(el){el.classList.remove("hidden");el.style.display="block"}
document.querySelectorAll(".bottom-nav-item").forEach(i=>i.classList.remove("active"));
const nav=document.querySelector(`[data-section="${s}"]`);if(nav)nav.classList.add("active");
const tbl=document.getElementById("vaultPlanStructureTable");if(tbl)tbl.style.display=s==="home"?"block":"none";
if(s==="home"){updateUserStats();displayUserTaskAllocation()}
else if(s==="referrals")updateReferralsSection();
else if(s==="wallet")updateWalletSection();
else if(s==="vault")updateVaultSection();
else if(s==="streak")updateStreakSection();
else if(s==="tasks")updateTasksSection();
else if(s==="profile")refreshUserData().then(()=>updateProfileSection())}

function showAdminSection(s){
["Stats","Users","Tasks","Transactions","Deposits","Withdrawals"].forEach(x=>{const e=document.getElementById("admin"+x+"Section");if(e)e.classList.add("hidden")});
const e=document.getElementById("admin"+s.charAt(0).toUpperCase()+s.slice(1)+"Section");if(e)e.classList.remove("hidden");
if(s==="users")updateAdminUsers();else if(s==="tasks"){updateAdminTasks();updateAdminExternalTasks()}
else if(s==="transactions")updateAdminTransactions();else if(s==="deposits")updateAdminDeposits();
else if(s==="withdrawals")updateAdminWithdrawals()}

// ===== USER STATS =====
async function updateUserStats(force=false){
try{const now=Date.now();
if(!force&&userStatsCache.data&&(now-userStatsCache.timestamp)<userStatsCache.ttl){updateUserStatsDisplay(userStatsCache.data);return}
const ud=await db.collection("users").doc(currentUser.id).get();currentUser={id:currentUser.id,...ud.data()};
const[vs,rs,cb]=await Promise.all([db.collection("users").doc(currentUser.id).collection("vaults").get(),db.collection("users").doc(currentUser.id).collection("referrals").get(),getUserCategoryBalances(currentUser.id)]);
const vaults=vs.docs.map(d=>({id:d.id,...d.data()}));
const total=await getUserActualBalance(currentUser.id);
const data={total,refs:rs.size,cb,currentUser,vaults};
userStatsCache={data,timestamp:now,ttl:30000};updateUserStatsDisplay(data);
document.getElementById("userNameDisplay").textContent=currentUser.fullName;
if(currentUser.isActivated)document.getElementById("activationStatus").style.display="inline";
const link=document.getElementById("userReferralLink");
if(link)link.textContent=`${window.location.href.split("?")[0]}?ref=${currentUser.referralCode}`}
catch(e){console.error("Stats:",e)}}

function updateUserStatsDisplay({total,refs,cb,currentUser,vaults}){
document.getElementById("totalBalance").textContent=total.toLocaleString();
document.getElementById("totalReferrals").textContent=refs;
document.getElementById("referralEarnings").textContent=cb.referralEarnings.toLocaleString();
document.getElementById("totalDeposits").textContent=cb.depositEarnings.toLocaleString();
const te=document.getElementById("taskEarnings");if(te)te.textContent=cb.taskEarnings.toLocaleString();
if(currentUser){const cs=document.getElementById("currentStreak");if(cs)cs.textContent=currentUser.currentStreak||0;
const pb=document.getElementById("pointsBalance");if(pb)pb.textContent=currentUser.pointsBalance||0}
const lc=document.getElementById("userLevelCard");
if(lc){const l=calcVaultLevel(vaults.filter(v=>v.status==="active"));lc.style.background=`linear-gradient(135deg,${l.color},${l.color}dd)`;lc.querySelector(".stat-value").textContent=l.icon;lc.querySelector("div:last-child").textContent=l.level}}

function calcVaultLevel(vaults){
const t=vaults.reduce((s,v)=>s+v.amount,0);
if(t>=110000000)return{level:"Legendary",icon:"ğŸ†",color:"#9333ea"};
if(t>=81000000)return{level:"Supreme",icon:"ğŸ‘‘",color:"#7c3aed"};
if(t>=48600000)return{level:"Icon",icon:"â­",color:"#6366f1"};
if(t>=29700000)return{level:"Emperor",icon:"ğŸ¦…",color:"#8b5cf6"};
if(t>=16650000)return{level:"King",icon:"ğŸ‘‘",color:"#a855f7"};
if(t>=8775000)return{level:"Titan",icon:"ğŸ’ª",color:"#c026d3"};
if(t>=4050000)return{level:"Mastermind",icon:"ğŸ§ ",color:"#d946ef"};
if(t>=1350000)return{level:"Nova",icon:"ğŸ’¡",color:"#e879f9"};
if(t>=600000)return{level:"Rising",icon:"ğŸŒ…",color:"#f0abfc"};
if(t>=180000)return{level:"Seed",icon:"ğŸŒ¿",color:"#10b981"};
if(t>=45000)return{level:"Beginner",icon:"ğŸŒ±",color:"#10b981"};
return{level:"Newcomer",icon:"ğŸŒ±",color:"#6b7280"}}

function clearUserStatsCache(){userStatsCache={data:null,timestamp:0,ttl:30000}}

async function displayUserTaskAllocation(){
try{if(!currentUser?.id)return;
const vi=await getUserVaultLevel(currentUser.id);
const today=new Date().toDateString();
const[yt,et]=await Promise.all([db.collection("taskSubmissions").where("userId","==",currentUser.id).where("date","==",today).get(),db.collection("externalTaskSubmissions").where("userId","==",currentUser.id).where("date","==",today).get()]);
const done=yt.size+et.size,rem=vi.dailyTasks-done;
const div=document.createElement("div");div.id="taskAllocationInfo";
if(vi.dailyTasks===0){div.style.cssText="background:linear-gradient(135deg,#fef2f2,#fee2e2);border:2px solid #ef4444;border-radius:12px;padding:1rem;margin-bottom:1rem";
div.innerHTML=`<div style="text-align:center"><h4 style="color:#dc2626">ğŸš« No Tasks Available</h4><p style="color:#991b1b;font-size:.875rem">Purchase a vault plan to access daily tasks!</p><button class="btn btn-primary" style="margin-top:.5rem" onclick="showSection('vault')">View Vault Plans</button></div>`}
else{div.style.cssText="background:linear-gradient(135deg,#f0fdf4,#dcfce7);border:2px solid #22c55e;border-radius:12px;padding:1rem;margin-bottom:1rem";
div.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center"><div><h4 style="color:#166534">ğŸ“‹ Task Allocation</h4><p style="color:#15803d;font-size:.875rem">Plan: <strong>${vi.planName}</strong> | Progress: <strong>${done}/${vi.dailyTasks}</strong> | Reward: <strong>${vi.taskReward.toLocaleString()} UGX</strong></p>${rem>0?`<p style="color:#059669;font-size:.875rem">âš¡ ${rem} task${rem>1?"s":""} remaining</p>`:`<p style="color:#f59e0b;font-size:.875rem">âœ… All tasks completed!</p>`}</div><button class="btn btn-success" style="padding:.5rem 1rem;font-size:.875rem" onclick="showSection('vault')">Upgrade</button></div>`}
const hs=document.getElementById("homeSection");if(hs){const ex=document.getElementById("taskAllocationInfo");if(ex)ex.remove();hs.insertBefore(div,hs.firstChild)}}
catch(e){console.error("Task alloc:",e)}}

// ===== VAULT =====
async function updateVaultSection(){
try{if(!currentUser?.id)return;
const bal=await getUserActualBalance(currentUser.id);document.getElementById("vaultBalance").textContent=bal.toLocaleString();
const vi=await getUserVaultLevel(currentUser.id);
document.querySelectorAll(".plan-card").forEach(c=>{
c.classList.remove("rainbow-active");const ex=c.querySelector(".plan-status");if(ex)ex.remove();
const pn=c.querySelector(".plan-name");if(!pn)return;
const pk=Object.keys(vaultPlans).find(k=>pn.textContent.toLowerCase().includes(vaultPlans[k].name.toLowerCase()));
if(pk){const pd=vaultPlans[pk];
if(vi.planName===pd.name){const s=document.createElement("div");s.className="plan-status";s.style.cssText="background:#10b981;color:white;padding:.25rem .5rem;border-radius:4px;font-size:.75rem;font-weight:600;margin-top:.5rem;text-align:center";s.textContent="âœ“ You Own This Plan";c.appendChild(s);c.classList.add("rainbow-active")}
else if(vi.level>0&&pd.level>vi.level){const s=document.createElement("div");s.className="plan-status";s.style.cssText="background:#3b82f6;color:white;padding:.25rem .5rem;border-radius:4px;font-size:.75rem;font-weight:600;margin-top:.5rem;text-align:center";s.textContent="â¬†ï¸ Upgrade Available";c.appendChild(s)}}})}
catch(e){console.error("Vault:",e)}}

async function selectPlan(plan){
if(isProcessingVaultPurchase)return;
if(currentUser){try{const vi=await getUserVaultLevel(currentUser.id);const pd=vaultPlans[plan];
if(vi.planName===pd.name){alert(`You already have the ${pd.name} plan!`);return}
if(vi.level>pd.level){alert(`You already have a higher-level plan (${vi.planName}).`);return}}catch(e){}}
selectedPlan=plan;const pd=vaultPlans[plan];
const monthEarnings=pd.dailyTasks*pd.taskReward*30;
document.getElementById("confirmPlanName").textContent=pd.name;
document.getElementById("confirmAmount").textContent=pd.amount.toLocaleString();
document.getElementById("confirmDuration").textContent=pd.days+" days";
document.getElementById("confirmDailyROI").textContent=pd.dailyTasks+" tasks/day";
document.getElementById("confirmDailyProfit").textContent=(pd.dailyTasks*pd.taskReward).toLocaleString()+" UGX";
document.getElementById("confirmProfit").textContent=monthEarnings.toLocaleString()+" UGX";
document.getElementById("confirmTotal").textContent=(pd.amount+monthEarnings).toLocaleString()+" UGX";
document.getElementById("selectedPlanDetails").classList.remove("hidden");
document.querySelectorAll(".plan-card").forEach(c=>c.classList.remove("selected"));
const card=event.target.closest(".plan-card");if(card)card.classList.add("selected")}

async function purchaseVault(){
if(!selectedPlan||isProcessingVaultPurchase)return;
const pd=vaultPlans[selectedPlan];
try{const vi=await getUserVaultLevel(currentUser.id);
if(vi.planName===pd.name){alert("You already have this plan.");return}
if(vi.level>pd.level){alert("You have a higher plan already.");return}}catch(e){}
showVaultPaymentModal(pd.amount,pd.name)}

function showVaultPaymentModal(amount,planName){
const m=document.createElement("div");m.className="modal show";m.style.display="flex";
m.innerHTML=`<div class="modal-content"><div class="modal-header" style="background:linear-gradient(135deg,#667eea,#764ba2);color:white;border-radius:16px 16px 0 0;border:none"><h3>ğŸ’³ Payment Method</h3><button class="modal-close" onclick="this.closest('.modal').remove()" style="color:white">Ã—</button></div><div class="modal-body"><div style="background:#f0f9ff;border:2px solid #0ea5e9;border-radius:12px;padding:1rem;margin-bottom:1rem"><div style="display:flex;justify-content:space-between"><span style="font-weight:600">Amount:</span><span style="font-weight:700;font-size:1.2rem">${amount.toLocaleString()} UGX</span></div></div><div id="payOpts"></div></div></div>`;
document.body.appendChild(m);m.addEventListener("click",e=>{if(e.target===m)m.remove()});
populateVaultPaymentOptions(amount,planName,m)}

async function populateVaultPaymentOptions(amount,planName,modal){
const opts=modal.querySelector("#payOpts");
const bal=await getUserActualBalance(currentUser.id);const ok=bal>=amount;
opts.innerHTML=`<div style="padding:1rem;border:2px solid ${ok?"var(--border)":"#f3f4f6"};border-radius:12px;background:${ok?"#fff":"#f9fafb"};cursor:${ok?"pointer":"not-allowed"};margin-bottom:.75rem" ${ok?`onclick="this.closest('.modal').remove();processVaultPurchaseWithWallet(${amount},'${planName}')"`:""}><div style="display:flex;align-items:center;gap:1rem"><div style="font-size:2rem">ğŸ’°</div><div style="flex:1"><div style="font-weight:600">Wallet Balance</div><div style="font-size:.875rem;color:var(--gray)">Available: ${bal.toLocaleString()} UGX</div>${!ok?"<div style="font-size:.8rem;color:#ef4444">Insufficient funds</div>":""}</div><div style="color:${ok?"var(--success)":"#9ca3af"}">${ok?"âœ“":"âœ—"}</div></div></div>
<div style="padding:1rem;border:2px solid var(--border);border-radius:12px;cursor:pointer;margin-bottom:.75rem" onclick="this.closest('.modal').remove();showSection('wallet')"><div style="display:flex;align-items:center;gap:1rem"><div style="font-size:2rem">ğŸ“±</div><div style="flex:1"><div style="font-weight:600">Mobile Money</div><div style="font-size:.875rem;color:var(--gray)">Deposit then purchase</div></div><div>â†’</div></div></div>`}

async function processVaultPurchaseWithWallet(amount,planName){
const bal=await getUserActualBalance(currentUser.id);
if(bal<amount){alert("Insufficient funds. Please deposit more.");return}
await showCategorySelectionModal(amount,(cat,catName)=>processVaultPurchase(cat,catName))}

async function processVaultPurchase(sourceCategory,categoryName){
if(isProcessingVaultPurchase)return;isProcessingVaultPurchase=true;
const btn=document.getElementById("purchaseBtn");const orig=btn.textContent;btn.disabled=true;btn.textContent="Processing...";
try{const pd=vaultPlans[selectedPlan];
const bal=await getUserActualBalance(currentUser.id);
if(bal<pd.amount){alert("Insufficient funds.");btn.disabled=false;btn.textContent=orig;isProcessingVaultPurchase=false;return}
const ud=await db.collection("users").doc(currentUser.id).get();
await db.collection("users").doc(currentUser.id).update({balance:(ud.data().balance||0)-pd.amount});
const start=new Date(),end=new Date(start.getTime()+pd.days*86400000);
await db.collection("users").doc(currentUser.id).collection("vaults").add({planName:pd.name,amount:pd.amount,duration:pd.days,startDate:start.toISOString(),maturityDate:end.toISOString(),status:"active",isMatured:false});
await db.collection("transactions").add({userId:currentUser.id,userName:currentUser.fullName,type:"vault_purchase",amount:pd.amount,sourceCategory,categoryName,planName:pd.name,date:new Date().toISOString()});
// 10% referral bonus on vault purchase
if(currentUser.referredBy){const bonus=Math.floor(pd.amount*0.10);
const rd=await db.collection("users").doc(currentUser.referredBy).get();
if(rd.exists){await db.collection("users").doc(currentUser.referredBy).update({balance:(rd.data().balance||0)+bonus});
await db.collection("transactions").add({userId:currentUser.referredBy,userName:rd.data().fullName,type:"referral",amount:bonus,description:`10% vault purchase bonus from ${currentUser.fullName} - ${pd.name}`,date:new Date().toISOString()});
await sendNotification(currentUser.referredBy,"referral_bonus",null,bonus)}}
btn.textContent="âœ… Success!";btn.style.background="#10b981";
alert(`ğŸ‰ "${pd.name}" vault purchased! You can now complete ${pd.dailyTasks} tasks/day earning ${pd.taskReward.toLocaleString()} UGX each.`);
setTimeout(()=>{document.getElementById("selectedPlanDetails").classList.add("hidden");selectedPlan=null;
document.querySelectorAll(".plan-card").forEach(c=>c.classList.remove("selected"));
clearUserStatsCache();updateUserStats();updateVaultSection();showSection("home");
setTimeout(()=>{btn.disabled=false;btn.textContent=orig;btn.style.background="";isProcessingVaultPurchase=false},2000)},2000)}
catch(e){alert("Purchase failed: "+e.message);isProcessingVaultPurchase=false;btn.disabled=false;btn.textContent=orig;btn.style.background=""}}

// ===== REFERRALS =====
async function updateReferralsSection(){
try{const snap=await db.collection("users").doc(currentUser.id).collection("referrals").get();
const refs=snap.docs.map(d=>d.data());const total=refs.reduce((s,r)=>s+(r.earnings||0),0);
const te=document.getElementById("totalReferralEarnings");if(te)te.textContent=total.toLocaleString();
updateReferralLevelProgress();
const el=document.getElementById("referralsList");if(!el)return;
if(!refs.length){el.innerHTML="<p style='text-align:center;color:var(--gray)'>No referrals yet. Share your link!</p>";return}
el.innerHTML=refs.map(r=>`<div style="display:flex;justify-content:space-between;padding:.75rem;background:var(--light);border-radius:8px;margin-bottom:.5rem"><div><strong>${r.name}</strong><br><small style="color:var(--gray)">${new Date(r.date).toLocaleDateString()}</small></div><div style="color:var(--success);font-weight:700">+${(r.earnings||0).toLocaleString()} UGX</div></div>`).join("")}
catch(e){console.error("Refs:",e)}}

async function updateReferralLevelProgress(){
try{const snap=await db.collection("users").doc(currentUser.id).collection("referrals").get();
const total=snap.size;const lvl=getUserReferralLevel(total);
const ni=referralLevels.findIndex(l=>l.title===lvl.title)+1;const next=ni<referralLevels.length?referralLevels[ni]:null;
const ie=document.getElementById("referralLevelInfo");if(ie)ie.innerHTML=`<div class="level-badge" style="background:linear-gradient(135deg,${lvl.color},${lvl.color}dd);margin-bottom:.5rem">${lvl.icon} ${lvl.title}</div><div style="color:var(--gray);font-size:.875rem">${total} total referrals</div>`;
const pe=document.getElementById("referralLevelProgress");if(pe&&next){const pct=Math.min(100,((total-lvl.minRefs)/(next.minRefs-lvl.minRefs))*100);pe.innerHTML=`<div style="font-size:.875rem;color:var(--gray);margin-bottom:.5rem">Progress to ${next.icon} ${next.title}: ${total}/${next.minRefs}</div><div style="background:var(--border);border-radius:4px;height:8px"><div style="background:var(--primary);height:100%;border-radius:4px;width:${pct}%;transition:width .3s"></div></div>`}}
catch(e){}}

// ===== TASKS =====
async function updateTasksSection(){
try{const vi=await getUserVaultLevel(currentUser.id);const today=new Date().toDateString();
const[yt,et]=await Promise.all([db.collection("taskSubmissions").where("userId","==",currentUser.id).where("date","==",today).get(),db.collection("externalTaskSubmissions").where("userId","==",currentUser.id).where("date","==",today).get()]);
const done=yt.size+et.size,limit=vi.dailyTasks;
const pd=document.getElementById("taskProgressDisplay");const pb=document.getElementById("taskProgressBar");
if(pd)pd.textContent=`${done} / ${limit} Tasks`;
if(pb)pb.style.width=limit>0?`${Math.min(100,(done/limit)*100)}%`:"0%";
if(limit===0){document.getElementById("tasksList").innerHTML=`<div class="card" style="text-align:center"><h3>No Tasks Available</h3><p style="color:var(--gray)">Purchase a vault plan to access daily tasks!</p><button class="btn btn-primary" onclick="showSection('vault')" style="margin-top:1rem">View Plans</button></div>`;return}
const[ytasks,etasks]=await Promise.all([db.collection("tasks").where("isActive","==",true).get(),db.collection("externalTasks").where("isActive","==",true).get()]);
const doneYt=yt.docs.map(d=>d.data().taskId),doneEt=et.docs.map(d=>d.data().taskId);
let html="";
ytasks.docs.forEach(doc=>{const t=doc.data();const comp=doneYt.includes(doc.id);const can=done<limit&&!comp;
html+=`<div class="card" style="border:2px solid ${comp?"var(--success)":"var(--border)"};opacity:${comp?".7":"1"}">
<div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:.75rem">
<div><strong>${t.title||"YouTube Task"}</strong><p style="color:var(--gray);font-size:.875rem">${t.description||""}</p></div>
<div style="color:var(--success);font-weight:700;white-space:nowrap">+${(t.reward||vi.taskReward).toLocaleString()} UGX</div></div>
${comp?"<div style='color:var(--success);font-weight:600'>âœ… Completed</div>":can?`<a href="${t.url}" target="_blank" onclick="markTaskComplete('${doc.id}','youtube',${t.reward||vi.taskReward})" class="btn btn-primary" style="display:block;text-align:center">â–¶ï¸ Watch & Complete</a>`:"<div style='color:var(--gray)'>Daily limit reached</div>"}</div>`});
etasks.docs.forEach(doc=>{const t=doc.data();const comp=doneEt.includes(doc.id);const can=done<limit&&!comp;
html+=`<div class="card" style="border:2px solid ${comp?"var(--success)":"var(--border)"};opacity:${comp?".7":"1"}">
<div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:.75rem">
<div><strong>${t.title||"External Task"}</strong><p style="color:var(--gray);font-size:.875rem">${t.description||""}</p></div>
<div style="color:var(--success);font-weight:700;white-space:nowrap">+${(t.reward||vi.taskReward).toLocaleString()} UGX</div></div>
${comp?"<div style='color:var(--success);font-weight:600'>âœ… Completed</div>":can?`<a href="${t.url}" target="_blank" onclick="markTaskComplete('${doc.id}','external',${t.reward||vi.taskReward})" class="btn btn-success" style="display:block;text-align:center">ğŸ”— Visit & Complete</a>`:"<div style='color:var(--gray)'>Daily limit reached</div>"}</div>`});
if(!html)html=`<div class="card" style="text-align:center;color:var(--gray)">No tasks available right now. Check back later!</div>`;
document.getElementById("tasksList").innerHTML=html}
catch(e){console.error("Tasks:",e);document.getElementById("tasksList").innerHTML=`<div class="card" style="text-align:center;color:var(--error)">Error loading tasks</div>`}}

async function markTaskComplete(taskId,type,reward){
try{const today=new Date().toDateString();const col=type==="youtube"?"taskSubmissions":"externalTaskSubmissions";
await db.collection(col).add({userId:currentUser.id,userName:currentUser.fullName,taskId,date:today,reward,completedAt:new Date().toISOString(),type});
const ud=await db.collection("users").doc(currentUser.id).get();
await db.collection("users").doc(currentUser.id).update({balance:(ud.data().balance||0)+reward});
await db.collection("transactions").add({userId:currentUser.id,userName:currentUser.fullName,type:"task_completion",amount:reward,date:new Date().toISOString()});
clearUserStatsCache();showAlert("tasksAlert",`+${reward.toLocaleString()} UGX earned!`,"success");setTimeout(()=>updateTasksSection(),500)}
catch(e){showAlert("tasksAlert","Failed to complete task","error")}}

// ===== WALLET =====
async function updateWalletSection(){
try{const bal=await getUserActualBalance(currentUser.id);const ud=await db.collection("users").doc(currentUser.id).get();
document.getElementById("walletBalance").textContent=bal.toLocaleString();
const pe=document.getElementById("walletPointsBalance");if(pe)pe.textContent=(ud.data().pointsBalance||0).toLocaleString();
await loadWalletTransactionHistory()}catch(e){}}

function showWalletTab(tab){
const dp=document.getElementById("depositPanel"),wp=document.getElementById("withdrawPanel");
const dt=document.getElementById("depositTab"),wt=document.getElementById("withdrawTab");
if(tab==="deposit"){dp.classList.remove("hidden");wp.classList.add("hidden");dt.style.background="var(--primary)";dt.style.color="white";wt.style.background="none";wt.style.color="var(--gray)"}
else{dp.classList.add("hidden");wp.classList.remove("hidden");wt.style.background="var(--primary)";wt.style.color="white";dt.style.background="none";dt.style.color="var(--gray)"}}

async function submitDeposit(){
const amt=parseInt(document.getElementById("depositAmount").value),meth=document.getElementById("depositMethod").value,phone=document.getElementById("depositPhone").value.trim();
if(!amt||amt<1000){showAlert("depositAlert","Minimum deposit is 1,000 UGX","error");return}
if(!meth){showAlert("depositAlert","Please select payment method","error");return}
if(!phone){showAlert("depositAlert","Please enter phone number","error");return}
try{await db.collection("depositRequests").add({userId:currentUser.id,userName:currentUser.fullName,userEmail:currentUser.email,amount:amt,method:meth,phone,status:"pending",date:new Date().toISOString()});
showAlert("depositAlert","Deposit request submitted! Admin will approve within 1 hour.","success");
document.getElementById("depositAmount").value="";document.getElementById("depositPhone").value=""}
catch(e){showAlert("depositAlert","Failed: "+e.message,"error")}}

async function submitWithdrawal(){
const amt=parseInt(document.getElementById("withdrawAmount").value),phone=document.getElementById("withdrawPhone").value.trim(),cat=document.getElementById("withdrawCategory").value;
if(!amt||amt<5000){showAlert("withdrawAlert","Minimum withdrawal is 5,000 UGX","error");return}
if(!phone){showAlert("withdrawAlert","Please enter phone number","error");return}
if(!cat){showAlert("withdrawAlert","Please select a category","error");return}
if(cat==="task"){const d=new Date().getDay();if(d!==5&&d!==6){showAlert("withdrawAlert","Task earnings can only be withdrawn on Friday and Saturday.","error");return}}
const b=await getUserCategoryBalances(currentUser.id);
const ck=cat==="referral"?"referralEarnings":cat==="task"?"taskEarnings":"vaultEarnings";
if(b[ck]<amt){showAlert("withdrawAlert",`Insufficient ${cat} earnings.`,"error");return}
const fee=Math.floor(amt*0.05),net=amt-fee;
try{await db.collection("withdrawalRequests").add({userId:currentUser.id,userName:currentUser.fullName,amount:amt,netAmount:net,adminFee:fee,phone,category:cat,status:"pending",date:new Date().toISOString()});
showAlert("withdrawAlert",`Withdrawal of ${net.toLocaleString()} UGX submitted (after 5% fee).`,"success");document.getElementById("withdrawAmount").value=""}
catch(e){showAlert("withdrawAlert","Failed: "+e.message,"error")}}

async function loadWalletTransactionHistory(){
if(!currentUser)return;try{const snap=await db.collection("transactions").where("userId","==",currentUser.id).orderBy("date","desc").limit(20).get();
const tb=document.getElementById("walletTransactionHistory");if(!tb)return;if(snap.empty){tb.innerHTML=`<tr><td colspan="4" style="text-align:center;color:var(--gray)">No transactions yet</td></tr>`;return}
const types={deposit:"ğŸ’° Deposit",withdrawal:"ğŸ’¸ Withdrawal",referral:"ğŸ‘¥ Referral",task_completion:"âœ… Task",vault_purchase:"ğŸ¦ Vault",vault_maturity:"ğŸ¦ Maturity",points_conversion:"ğŸ”„ Points",withdrawal_approved:"ğŸ’¸ Withdrawal"};
tb.innerHTML=snap.docs.map(d=>{const t=d.data();const a=t.netAmount||t.amount||0;const out=["withdrawal","vault_purchase","withdrawal_approved"].includes(t.type);
return`<tr><td>${new Date(t.date).toLocaleDateString()}</td><td>${types[t.type]||t.type}</td><td style="color:${out?"var(--error)":"var(--success)"};font-weight:600">${out?"-":"+"} ${Math.abs(a).toLocaleString()} UGX</td><td><span class="status-badge success">Done</span></td></tr>`}).join("")}
catch(e){}}

// ===== STREAK =====
async function updateStreakSection(){
try{const ud=await db.collection("users").doc(currentUser.id).get();const u=ud.data();
const s=u.currentStreak||0,lng=u.longestStreak||0,pts=u.pointsBalance||0;
const se=document.querySelector("#streakSection #currentStreak");if(se)se.textContent=s;
const spe=document.getElementById("streakPoints");if(spe)spe.textContent=pts;
const le=document.getElementById("longestStreakDisplay");if(le)le.textContent=lng;
const de=document.getElementById("streakDays");if(de){let h="";for(let i=0;i<7;i++){const a=i<Math.min(s,7),t=i===Math.min(s-1,6)&&s>0;h+=`<div class="streak-day ${t?"today":a?"active":""}">${i+1}</div>`}de.innerHTML=h}}
catch(e){}}

async function convertPoints(){
const pts=parseInt(document.getElementById("pointsToConvert").value);
if(!pts||pts<100){showAlert("streakSectionAlert","Minimum 100 points","error");return}
const ud=await db.collection("users").doc(currentUser.id).get();const cur=ud.data().pointsBalance||0;
if(cur<pts){showAlert("streakSectionAlert",`Insufficient points (have ${cur})`,"error");return}
const ugx=pts*10;const bal=ud.data().balance||0;
await db.collection("users").doc(currentUser.id).update({pointsBalance:cur-pts,balance:bal+ugx});
await db.collection("transactions").add({userId:currentUser.id,type:"points_conversion",amount:ugx,description:`${pts} points converted`,date:new Date().toISOString()});
if(currentUser)currentUser.pointsBalance=cur-pts;clearUserStatsCache();
showAlert("streakSectionAlert",`Converted ${pts} points to ${ugx.toLocaleString()} UGX!`,"success");updateStreakSection()}

// ===== PROFILE =====
async function updateProfileSection(){
try{
const pi=document.getElementById("profileInitials"),img=document.getElementById("profileImage");
if(currentUser.profilePicture){img.src=currentUser.profilePicture;img.style.display="block";pi.style.display="none"}
else{pi.textContent=(currentUser.fullName||"U").split(" ").map(n=>n[0]).join("").toUpperCase().substring(0,2)||"ğŸ‘¤";pi.style.display="flex";img.style.display="none"}
document.getElementById("profileUserName").textContent=currentUser.fullName||"User";
document.getElementById("profileUserEmail").textContent=currentUser.email||"";
document.getElementById("profileJoinedDate").textContent=`Member since ${currentUser.joinedDate?new Date(currentUser.joinedDate).toLocaleDateString():"N/A"}`;
const pfn=document.getElementById("profileFullNameValue");if(pfn)pfn.textContent=currentUser.fullName||"";
const pev=document.getElementById("profileEmailValue");if(pev)pev.textContent=currentUser.email||"";
const pjv=document.getElementById("profileJoinedValue");if(pjv)pjv.textContent=currentUser.joinedDate?new Date(currentUser.joinedDate).toLocaleDateString():"N/A";
const psv=document.getElementById("profileAccountStatusValue");if(psv){psv.textContent=currentUser.isActivated?"Active":"Pending";psv.style.color=currentUser.isActivated?"var(--success)":"var(--error)"}
const rc=document.getElementById("profileReferralCode");if(rc)rc.textContent=currentUser.referralCode||"N/A";
const lb=document.getElementById("profileLevelBadge");if(lb){const l=getUserReferralLevel(currentUser.totalReferrals||0);lb.innerHTML=`${l.icon} ${l.title}`;lb.style.background=`linear-gradient(135deg,${l.color},${l.color}dd)`}
const sv=document.getElementById("profileStreakValue");if(sv)sv.textContent=currentUser.currentStreak||0;
const vs=await db.collection("users").doc(currentUser.id).collection("vaults").get();
const pav=document.getElementById("profileActiveVaults");if(pav)pav.textContent=vs.size;
const actV=vs.docs.map(d=>d.data()).filter(v=>v.status==="active");
const pal=document.getElementById("profileAccountLevel");if(pal)pal.textContent=calcVaultLevel(actV).level}
catch(e){console.error("Profile:",e)}}

async function uploadProfilePicture(ev){
const f=ev.target.files[0];if(!f)return;
if(f.size>5*1024*1024){showAlert("profileAlert","Max 5MB","error");return}
if(!f.type.startsWith("image/")){showAlert("profileAlert","Select an image","error");return}
const reader=new FileReader();
reader.onload=async e=>{try{const b64=e.target.result;await db.collection("users").doc(currentUser.id).update({profilePicture:b64});currentUser.profilePicture=b64;document.getElementById("profileImage").src=b64;document.getElementById("profileImage").style.display="block";document.getElementById("profileInitials").style.display="none";showAlert("profileAlert","Profile picture updated!","success")}catch(err){showAlert("profileAlert","Upload failed","error")}};
reader.readAsDataURL(f)}

function toggleNameEdit(){const c=document.getElementById("nameEditContainer"),b=document.getElementById("editNameBtn");if(!c.style.display||c.style.display==="none"){c.style.display="block";b.style.display="none";document.getElementById("nameEditInput").value=currentUser.fullName||""}else{c.style.display="none";b.style.display="inline"}}
function cancelNameEdit(){document.getElementById("nameEditContainer").style.display="none";document.getElementById("editNameBtn").style.display="inline"}
async function saveNameEdit(){const n=document.getElementById("nameEditInput").value.trim();if(!n||n.length<2){showAlert("profileAlert","Invalid name","error");return}
await db.collection("users").doc(currentUser.id).update({fullName:n});currentUser.fullName=n;
document.getElementById("profileUserName").textContent=n;const pfn=document.getElementById("profileFullNameValue");if(pfn)pfn.textContent=n;cancelNameEdit();showAlert("profileAlert","Name updated!","success")}
function copyReferralCode(){navigator.clipboard.writeText(currentUser.referralCode||"").then(()=>showAlert("profileAlert","Code copied!","success"))}
function copyReferralLink(){const l=document.getElementById("userReferralLink")?.textContent;if(l)navigator.clipboard.writeText(l).then(()=>alert("Link copied!"))}
function shareReferralLink(){const l=document.getElementById("userReferralLink")?.textContent;if(navigator.share&&l)navigator.share({title:"Join VaultPro",text:"Join Uganda\'s #1 investment platform!",url:l});else if(l)navigator.clipboard.writeText(l).then(()=>alert("Link copied!"))}
async function refreshUserData(){if(!currentUser?.id)return;try{const d=await db.collection("users").doc(currentUser.id).get();if(d.exists)currentUser={id:currentUser.id,...d.data()}}catch(e){}}
async function logout(){if(confirm("Are you sure you want to logout?")){await auth.signOut();currentUser=null;showLogin()}}

// ===== LEADERBOARD =====
async function updateLeaderboard(){
try{const now=new Date();const dow=now.getDay();const d2m=dow===0?6:dow-1;const ws=new Date(now);ws.setDate(now.getDate()-d2m);ws.setHours(0,0,0,0);
const snap=await db.collection("users").where("isAdmin","==",false).get();
const data=await Promise.all(snap.docs.map(async d=>{const u=d.data();const rs=await db.collection("users").doc(d.id).collection("referrals").get();let wk=0;rs.docs.forEach(r=>{if(new Date(r.data().date)>=ws)wk++});return{n:u.fullName,wk,tot:rs.size}}));
data.sort((a,b)=>b.wk-a.wk);const top=data.slice(0,10);const el=document.getElementById("leaderboardList");if(!el)return;
if(!top.length||top[0].wk===0){el.innerHTML=`<p style="text-align:center;color:var(--gray);padding:2rem">No referrals this week yet. Be the first!</p>`;return}
const tr=["ğŸ¥‡","ğŸ¥ˆ","ğŸ¥‰"];
el.innerHTML=top.map((u,i)=>`<div style="background:${i===0?"linear-gradient(135deg,#fef3c7,#fde68a)":"#f9fafb"};border:2px solid ${i===0?"#f59e0b":"#e5e7eb"};border-radius:12px;padding:1rem;margin-bottom:.75rem;display:flex;justify-content:space-between;align-items:center">
<div style="display:flex;align-items:center;gap:1rem"><div style="font-size:2rem">${i<3?tr[i]:i+1+"."}</div><div><div style="font-weight:700">${u.n}</div><div style="font-size:.875rem;color:var(--gray)">Total: ${u.tot}</div></div></div>
<div style="text-align:right"><div style="font-size:1.5rem;font-weight:700;color:${i===0?"#f59e0b":"var(--primary)"}">${u.wk}</div><div style="font-size:.75rem;color:var(--gray)">this week</div></div></div>`).join("");
updateWeekResetTimer()}catch(e){console.error("Leaderboard:",e)}}

function updateWeekResetTimer(){const now=new Date();const d=now.getDay();const su=d===0?7:7-d;const nxt=new Date(now);nxt.setDate(now.getDate()+su);nxt.setHours(23,59,59,999);const rem=nxt-now;const days=Math.floor(rem/86400000);const hrs=Math.floor((rem%86400000)/3600000);const mins=Math.floor((rem%3600000)/60000);const el=document.getElementById("timeUntilReset");if(el)el.textContent=`${days}d ${hrs}h ${mins}m`}

async function awardWeeklyWinner(){
try{const now=new Date();const d=now.getDay();const d2m=d===0?6:d-1;const ws=new Date(now);ws.setDate(now.getDate()-d2m);ws.setHours(0,0,0,0);
const snap=await db.collection("users").where("isAdmin","==",false).get();let top=null,max=0;
for(const doc of snap.docs){const rs=await db.collection("users").doc(doc.id).collection("referrals").get();const wk=rs.docs.filter(r=>new Date(r.data().date)>=ws).length;if(wk>max){max=wk;top={userId:doc.id,userData:doc.data(),wk}}}
if(top&&top.wk>=8){const prize=50000;const ud=await db.collection("users").doc(top.userId).get();await db.collection("users").doc(top.userId).update({balance:(ud.data().balance||0)+prize});await db.collection("transactions").add({userId:top.userId,type:"referral",amount:prize,description:"Weekly Top Referrer Prize",date:new Date().toISOString()});await sendNotification(top.userId,"referral_bonus","ğŸ† You won the weekly referral prize of 50,000 UGX!",prize);return top}return null}
catch(e){console.error("Award:",e);return null}}

function scheduleWeeklyAward(){setInterval(async()=>{const n=new Date();if(n.getDay()===0&&n.getHours()===0&&n.getMinutes()===0)await awardWeeklyWinner()},60000)}

function showWhatsAppGroupModal(){document.getElementById("whatsappGroupModal").classList.remove("hidden")}

// ===== ADMIN =====
async function updateAdminStats(){
try{const[us,ts,ds,ws]=await Promise.all([db.collection("users").where("isAdmin","==",false).get(),db.collection("transactions").get(),db.collection("depositRequests").where("status","==","pending").get(),db.collection("withdrawalRequests").where("status","==","pending").get()]);
const users=us.docs.map(d=>d.data());const tb=users.reduce((s,u)=>s+(u.balance||0),0);const act=users.filter(u=>u.isActivated).length;
const dep=ts.docs.filter(d=>d.data().type==="deposit").reduce((s,d)=>s+(d.data().amount||0),0);
const wd=ts.docs.filter(d=>["withdrawal","withdrawal_approved"].includes(d.data().type)).reduce((s,d)=>s+(d.data().amount||0),0);
document.getElementById("adminTotalUsers").textContent=users.length;document.getElementById("adminTotalBalance").textContent=tb.toLocaleString();
document.getElementById("adminTotalDeposits").textContent=dep.toLocaleString();document.getElementById("adminTotalWithdrawals").textContent=wd.toLocaleString();
document.getElementById("adminActivatedUsers").textContent=act;document.getElementById("adminPendingWithdrawals").textContent=ws.size}
catch(e){}}

async function updateAdminUsers(){
try{const snap=await db.collection("users").where("isAdmin","==",false).get();const el=document.getElementById("adminUsersList");if(!el)return;
if(snap.empty){el.innerHTML=`<p style="color:var(--gray)">No users</p>`;return}
el.innerHTML=`<div style="overflow-x:auto"><table><thead><tr><th>Name</th><th>Email</th><th>Balance</th><th>Status</th><th>Joined</th></tr></thead><tbody>${snap.docs.map(d=>{const u=d.data();return`<tr><td>${u.fullName}</td><td>${u.email}</td><td>${(u.balance||0).toLocaleString()} UGX</td><td><span class="status-badge ${u.isActivated?"success":"warning"}">${u.isActivated?"Active":"Pending"}</span></td><td>${u.joinedDate?new Date(u.joinedDate).toLocaleDateString():"N/A"}</td></tr>`}).join("")}</tbody></table></div>`}
catch(e){}}

async function updateAdminTasks(){try{const snap=await db.collection("tasks").get();const el=document.getElementById("adminTasksList");if(!el)return;if(snap.empty){el.innerHTML=`<p style="color:var(--gray)">No tasks</p>`;return}el.innerHTML=snap.docs.map(d=>{const t={id:d.id,...d.data()};return`<div class="card" style="margin-bottom:.5rem;display:flex;justify-content:space-between;align-items:center"><div><strong>${t.title}</strong><br><small style="color:var(--gray)">${t.url}</small></div><div style="display:flex;gap:.5rem"><span style="color:var(--success)">${(t.reward||0).toLocaleString()} UGX</span><button class="btn" style="background:var(--error);color:white;padding:.25rem .5rem;font-size:.75rem" onclick="deleteTask('${d.id}')">Del</button></div></div>`}).join("")}catch(e){}}

async function updateAdminExternalTasks(){try{const snap=await db.collection("externalTasks").get();const el=document.getElementById("adminExternalTasksList");if(!el)return;if(snap.empty){el.innerHTML=`<p style="color:var(--gray)">No external tasks</p>`;return}el.innerHTML=snap.docs.map(d=>{const t={id:d.id,...d.data()};return`<div class="card" style="margin-bottom:.5rem;display:flex;justify-content:space-between;align-items:center"><div><strong>${t.title}</strong><br><small style="color:var(--gray)">${t.url}</small></div><div style="display:flex;gap:.5rem"><span style="color:var(--success)">${(t.reward||0).toLocaleString()} UGX</span><button class="btn" style="background:var(--error);color:white;padding:.25rem .5rem;font-size:.75rem" onclick="deleteExternalTask('${d.id}')">Del</button></div></div>`}).join("")}catch(e){}}

async function addTask(){const url=document.getElementById("newTaskUrl").value.trim(),title=document.getElementById("newTaskTitle").value.trim(),desc=document.getElementById("newTaskDescription").value.trim(),reward=parseInt(document.getElementById("newTaskReward").value);if(!url||!title||!reward){alert("Fill all fields");return}await db.collection("tasks").add({url,title,description:desc,reward,isActive:true,createdAt:new Date().toISOString()});alert("Task added!");["newTaskUrl","newTaskTitle","newTaskDescription","newTaskReward"].forEach(id=>document.getElementById(id).value="");updateAdminTasks()}
async function addExternalTask(){const url=document.getElementById("newExternalTaskUrl").value.trim(),title=document.getElementById("newExternalTaskTitle").value.trim(),desc=document.getElementById("newExternalTaskDescription").value.trim(),reward=parseInt(document.getElementById("newExternalTaskReward").value);if(!url||!title||!reward){alert("Fill all fields");return}await db.collection("externalTasks").add({url,title,description:desc,reward,isActive:true,createdAt:new Date().toISOString()});alert("External task added!");["newExternalTaskUrl","newExternalTaskTitle","newExternalTaskDescription","newExternalTaskReward"].forEach(id=>document.getElementById(id).value="");updateAdminExternalTasks()}
async function deleteTask(id){if(!confirm("Delete?"))return;await db.collection("tasks").doc(id).delete();updateAdminTasks()}
async function deleteExternalTask(id){if(!confirm("Delete?"))return;await db.collection("externalTasks").doc(id).delete();updateAdminExternalTasks()}

async function updateAdminTransactions(){try{const snap=await db.collection("transactions").orderBy("date","desc").limit(50).get();const tb=document.getElementById("adminTransactionsList");if(!tb)return;if(snap.empty){tb.innerHTML=`<tr><td colspan="4" style="text-align:center">No transactions</td></tr>`;return}tb.innerHTML=snap.docs.map(d=>{const t=d.data();return`<tr><td>${t.userName||"Admin"}</td><td>${t.type}</td><td>${(t.amount||0).toLocaleString()} UGX</td><td>${new Date(t.date).toLocaleDateString()}</td></tr>`}).join("")}catch(e){}}

async function updateAdminDeposits(){
try{const snap=await db.collection("depositRequests").orderBy("date","desc").get();const el=document.getElementById("adminDepositsList");if(!el)return;if(snap.empty){el.innerHTML=`<p style="text-align:center;color:var(--gray)">No deposit requests</p>`;return}
el.innerHTML=snap.docs.map(doc=>{const d={id:doc.id,...doc.data()};return`<div class="card" style="margin-bottom:.75rem"><div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:.75rem"><div><strong>${d.userName}</strong><br><small style="color:var(--gray)">${d.userEmail||""} | ${d.phone}</small><br><small>${d.method} | ${new Date(d.date).toLocaleDateString()}</small></div><div style="text-align:right"><div style="font-size:1.25rem;font-weight:700;color:var(--success)">${(d.amount||0).toLocaleString()} UGX</div><span class="status-badge ${d.status==="approved"?"success":d.status==="rejected"?"error":"warning"}">${d.status}</span></div></div>${d.status==="pending"?`<div style="display:flex;gap:.5rem"><button class="btn btn-success" style="flex:1" onclick="approveDeposit('${doc.id}','${d.userId}',${d.amount})">Approve</button><button class="btn" style="flex:1;background:var(--error);color:white" onclick="rejectDeposit('${doc.id}')">Reject</button></div>`:""}</div>`}).join("")}
catch(e){}}

async function approveDeposit(depId,uid,amount){if(!confirm(`Approve ${amount.toLocaleString()} UGX?`))return;try{await db.collection("depositRequests").doc(depId).update({status:"approved",approvedDate:new Date().toISOString()});const ud=await db.collection("users").doc(uid).get();await db.collection("users").doc(uid).update({balance:(ud.data().balance||0)+amount});await db.collection("transactions").add({userId:uid,userName:ud.data().fullName,type:"deposit",amount,date:new Date().toISOString()});await sendNotification(uid,"withdrawal_approved",`Your deposit of ${amount.toLocaleString()} UGX has been approved!`);alert("Deposit approved!");updateAdminDeposits();updateAdminStats()}catch(e){alert("Error: "+e.message)}}
async function rejectDeposit(id){if(!confirm("Reject?"))return;await db.collection("depositRequests").doc(id).update({status:"rejected"});alert("Rejected");updateAdminDeposits()}

async function updateAdminWithdrawals(){
try{const snap=await db.collection("withdrawalRequests").orderBy("date","desc").get();const el=document.getElementById("adminWithdrawalsList");if(!el)return;if(snap.empty){el.innerHTML=`<p style="text-align:center;color:var(--gray)">No withdrawal requests</p>`;return}
el.innerHTML=snap.docs.map(doc=>{const w={id:doc.id,...doc.data()};return`<div class="card" style="margin-bottom:.75rem"><div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:.75rem"><div><strong>${w.userName}</strong><br><small style="color:var(--gray)">${w.phone} | ${w.category}</small><br><small>${new Date(w.date).toLocaleDateString()}</small></div><div style="text-align:right"><div style="font-size:1.25rem;font-weight:700;color:var(--warning)">${(w.amount||0).toLocaleString()} UGX</div><div style="font-size:.875rem;color:var(--success)">Net: ${(w.netAmount||0).toLocaleString()} UGX</div><span class="status-badge ${w.status==="approved"?"success":w.status==="rejected"?"error":"warning"}">${w.status}</span></div></div>${w.status==="pending"?`<div style="display:flex;gap:.5rem"><button class="btn btn-success" style="flex:1" onclick="approveWithdrawal('${doc.id}','${w.userId}',${w.netAmount||0},${w.adminFee||0})">Approve</button><button class="btn" style="flex:1;background:var(--error);color:white" onclick="rejectWithdrawal('${doc.id}','${w.userId}')">Reject</button></div>`:""}</div>`}).join("")}
catch(e){}}

async function approveWithdrawal(wdId,uid,net,fee){if(!confirm(`Approve ${net.toLocaleString()} UGX?`))return;try{await db.collection("withdrawalRequests").doc(wdId).update({status:"approved",approvedDate:new Date().toISOString()});const ud=await db.collection("users").doc(uid).get();await db.collection("users").doc(uid).update({balance:Math.max(0,(ud.data().balance||0)-(net+fee))});await db.collection("transactions").add({userId:uid,userName:ud.data().fullName,type:"withdrawal_approved",amount:net,adminFee:fee,date:new Date().toISOString()});await sendNotification(uid,"withdrawal_approved",`Your withdrawal of ${net.toLocaleString()} UGX has been approved!`,net);alert("Withdrawal approved!");updateAdminWithdrawals();updateAdminStats()}catch(e){alert("Error: "+e.message)}}
async function rejectWithdrawal(id,uid){if(!confirm("Reject?"))return;await db.collection("withdrawalRequests").doc(id).update({status:"rejected"});await sendNotification(uid,"withdrawal_rejected");alert("Rejected");updateAdminWithdrawals()}

// ===== NOTIFICATIONS =====
const NTYPES={activation_approved:{icon:"ğŸ‰",title:"Account Activated!",message:"Your account is now active.",color:"linear-gradient(135deg,#10b981,#059669)"},withdrawal_approved:{icon:"ğŸ’°",title:"Withdrawal Approved!",message:"Your withdrawal has been approved.",color:"linear-gradient(135deg,#3b82f6,#1d4ed8)"},withdrawal_rejected:{icon:"âŒ",title:"Withdrawal Rejected",message:"Your withdrawal was rejected.",color:"linear-gradient(135deg,#ef4444,#dc2626)"},new_earnings:{icon:"ğŸ’µ",title:"New Earnings!",message:"You earned money!",color:"linear-gradient(135deg,#f59e0b,#d97706)"},referral_bonus:{icon:"ğŸ‘¥",title:"Referral Bonus!",message:"You received a referral bonus!",color:"linear-gradient(135deg,#8b5cf6,#7c3aed)"},vault_matured:{icon:"ğŸ¦",title:"Vault Matured!",message:"Your vault has matured!",color:"linear-gradient(135deg,#06b6d4,#0891b2)"}};

async function sendNotification(uid,type,msg=null,amt=null){try{if(!NTYPES[type])return;const c=NTYPES[type];const m=msg||c.message;await db.collection("notifications").add({userId:uid,type,title:c.title,message:m,icon:c.icon,read:false,timestamp:new Date(),createdAt:new Date().toISOString()});if(currentUser&&currentUser.id===uid)showNotificationPopup({...c,message:m})}catch(e){}}

function showNotificationPopup(n){const cont=document.getElementById("notificationContainer");if(!cont)return;const p=document.createElement("div");p.style.cssText=`background:${n.color};color:white;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.3);padding:16px;display:flex;align-items:flex-start;gap:12px;animation:slideInRight .3s ease-out;pointer-events:auto;min-width:280px;max-width:380px`;p.innerHTML=`<div style="font-size:24px">${n.icon}</div><div style="flex:1"><div style="font-weight:600;margin-bottom:4px">${n.title}</div><div style="font-size:14px;opacity:.9">${n.message}</div></div><button onclick="this.parentElement.remove()" style="background:none;border:none;color:white;font-size:20px;cursor:pointer;opacity:.7">Ã—</button>`;cont.appendChild(p);setTimeout(()=>{if(p.parentNode)p.remove()},5000)}

async function updateNotificationBadge(){if(!currentUser)return;try{const snap=await db.collection("notifications").where("userId","==",currentUser.id).where("read","==",false).get();const b=document.getElementById("notificationBadge");if(b){if(snap.size>0){b.textContent=snap.size>99?"99+":snap.size.toString();b.style.display="flex"}else b.style.display="none"}}catch(e){}}

function showNotificationCenter(){const c=document.getElementById("notificationCenter");if(c){c.style.display="block";loadNotifications()}}
function hideNotificationCenter(){const c=document.getElementById("notificationCenter");if(c)c.style.display="none"}

async function loadNotifications(){if(!currentUser)return;try{const snap=await db.collection("notifications").where("userId","==",currentUser.id).orderBy("timestamp","desc").limit(50).get();const el=document.getElementById("notificationList");if(!el)return;if(snap.empty){el.innerHTML=`<div style="padding:20px;text-align:center;color:#6b7280">No notifications yet</div>`;return}el.innerHTML=snap.docs.map(doc=>{const n={id:doc.id,...doc.data()};const t=n.timestamp?.toDate?n.timestamp.toDate():new Date(n.createdAt||Date.now());const m=Math.floor((Date.now()-t)/60000);const time=m<1?"Just now":m<60?`${m}m ago`:m<1440?`${Math.floor(m/60)}h ago`:`${Math.floor(m/1440)}d ago`;return`<div style="padding:16px 20px;border-bottom:1px solid #f0f0f0;display:flex;align-items:flex-start;background:${n.read?"":"#f0f9ff"};border-left:${n.read?"none":"4px solid #3b82f6"};cursor:pointer" onclick="db.collection('notifications').doc('${n.id}').update({read:true});this.style.background='';this.style.borderLeft='none';updateNotificationBadge()"><div style="font-size:20px;margin-right:12px">${n.icon||"ğŸ””"}</div><div><div style="font-size:14px;font-weight:600">${n.title}</div><div style="font-size:13px;color:#6b7280">${n.message}</div><div style="font-size:12px;color:#9ca3af">${time}</div></div></div>`}).join("")}catch(e){}}

function setupNotificationListener(){if(!currentUser)return;db.collection("notifications").where("userId","==",currentUser.id).where("read","==",false).orderBy("timestamp","desc").onSnapshot(snap=>{updateNotificationBadge();snap.docChanges().forEach(c=>{if(c.type==="added"){const n=c.doc.data();showNotificationPopup({...NTYPES[n.type],message:n.message,icon:n.icon})}})})}
function initializeNotificationSystem(){if(currentUser){setupNotificationListener();updateNotificationBadge()}}

// ===== UTILS =====
function showAlert(id,msg,type){const el=document.getElementById(id);if(!el)return;el.innerHTML=`<div class="alert alert-${type}">${msg}</div>`;setTimeout(()=>{if(el)el.innerHTML=""},5000)}

function toggleDarkMode(){const body=document.body,icon=document.getElementById("darkModeIcon");if(body.classList.contains("dark-mode")){body.classList.remove("dark-mode");if(icon)icon.textContent="ğŸŒ™";localStorage.setItem("darkMode","false")}else{body.classList.add("dark-mode");if(icon)icon.textContent="â˜€ï¸";localStorage.setItem("darkMode","true")}}

window.addEventListener("load",()=>{captureReferralCode();if(localStorage.getItem("darkMode")==="true"){document.body.classList.add("dark-mode");const i=document.getElementById("darkModeIcon");if(i)i.textContent="â˜€ï¸"}init()});

setInterval(()=>{const r=document.getElementById("registerPage");if(r&&!r.classList.contains("hidden")&&!document.getElementById("inviteCode")?.value&&!allowManualRegistration)showLogin()},1000);

window.adminLogin=async()=>{try{const r=await auth.signInWithEmailAndPassword("admin@vaultpro.com","Admin@123");console.log("Admin:",r.user.email)}catch(e){console.error("Admin login failed:",e)}};
</script>
</body>
</html>
